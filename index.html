<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>더홈점검 - 하자관리 시스템</title>
    
    <!-- Google Lens 자동 실행 방지 -->
    <meta name="google" content="notranslate">
    <meta name="google" content="nositelinkssearchbox">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="더홈점검">
    
    <!-- PWA Manifest -->
    <!-- manifest.json 제거 (CORS 에러 방지) -->
    
    <!-- jsPDF + html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- JSZip for ZIP download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- ExcelJS for Excel with images (안정적인 버전) -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <!-- Google API Client Library -->
    <!-- Google API (광고차단기로 인해 주석 처리) -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <!-- <script src="https://accounts.google.com/gsi/client" async defer></script> -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #fbbf24;
            --danger: #ef4444;
            --bg-dark: #1a202c;
            --bg-darker: #111827;
            --card-bg: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 5px;
            margin: 20px 0;
            gap: 5px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        /* 평면도 관리 */
        .floorplan-container {
            text-align: center;
        }

        .floorplan-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid var(--border);
        }

        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-action-btn {
            padding: 14px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .photo-action-btn.camera {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .photo-action-btn:active {
            transform: scale(0.98);
        }

        /* 하자 목록 */
        .defect-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .defect-number {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .defect-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 공기질 측정 */
        .air-quality-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        .air-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .air-room-name-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
        }

        .air-room-delete {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .air-inputs {
            display: grid;
            gap: 12px;
        }

        .air-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .air-input-group label {
            min-width: 100px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .air-input-group input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            text-align: center;
        }

        .air-input-group span {
            color: var(--text-secondary);
            font-size: 12px;
            min-width: 80px;
        }

        .air-add-btn {
            width: 100%;
            padding: 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .air-add-btn:active {
            transform: scale(0.98);
        }

        .reference-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* 데이터 관리 */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .saved-info {
            flex: 1;
        }

        .saved-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .saved-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saved-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .icon-btn.load {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
        }

        .icon-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Toast 알림 */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 카메라 모달 */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .camera-modal.active {
            display: flex;
        }

        #cameraPreview {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            /* Google Lens 자동 실행 방지 */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            pointer-events: auto;
        }

        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: var(--primary);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .camera-btn.close {
            background: var(--danger);
        }

        /* 플로팅 버튼 */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .floating-btn:active {
            transform: scale(0.95);
        }

        .floating-btn:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        /* 로딩 */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 40px;
            border-radius: 16px;
            z-index: 2000;
            text-align: center;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 반응형 */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* 선택 박스 스타일 */
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* 입력 필드 비활성화 스타일 */
        .form-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 터치 버튼 스타일 */
        .touch-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .touch-btn {
            padding: 10px 8px;
            border: 2px solid var(--border);
            background: rgba(30, 41, 59, 0.3);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .touch-btn:active {
            transform: scale(0.95);
        }

        .touch-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .touch-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
    </style>

</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <h1>🏠 더홈점검</h1>
        <p>하자관리 시스템 v3.2 (사진 2장 촬영)</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <div class="container">
        <!-- 탭 메뉴 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">📝 프로젝트</button>
            <button class="tab" onclick="switchTab('defects', event)">🔍 하자점검</button>
            <button class="tab" onclick="switchTab('equipment', event)">📸 장비점검</button>
            <button class="tab" onclick="switchTab('airquality', event)">🌬️ 공기질</button>
            <button class="tab" onclick="switchTab('data', event)">💾 데이터</button>
            <button class="tab" onclick="switchTab('contract', event)">📄 계약서</button>
        </div>

        <!-- 프로젝트 정보 섹션 -->
        <div id="project" class="section active">
            <!-- 프로젝트 목록 카드 -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <h2 style="color: white; margin-bottom: 15px;">📋 프로젝트 목록</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="addNewProject()" class="btn" style="background: white; color: #667eea; flex: 1; min-width: 120px;">
                        ➕ 새 프로젝트
                    </button>
                    <button onclick="deleteCurrentProject()" class="btn" style="background: rgba(255,255,255,0.2); color: white; flex: 1; min-width: 120px;">
                        🗑️ 현재 삭제
                    </button>
                </div>

                <div id="projectList" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- 프로젝트 목록이 여기 표시됩니다 -->
                </div>

                <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                    💡 팁: 하루에 여러 프로젝트를 작업할 수 있습니다. 프로젝트를 클릭하면 전환됩니다.
                </div>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📝 프로젝트 정보</h2>
                
                <div class="form-field">
                    <label class="form-label">아파트명</label>
                    <input type="text" class="form-input" id="apartmentName" placeholder="예: 래미안 아파트" oninput="autoSaveProjectData()">
                </div>

                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">동</label>
                        <input type="text" class="form-input" id="dong" placeholder="예: 101동" oninput="autoSaveProjectData()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">호수</label>
                        <input type="text" class="form-input" id="ho" placeholder="예: 502호" oninput="autoSaveProjectData()">
                    </div>
                </div>

                <div class="form-field">
                    <label class="form-label">점검일자</label>
                    <input type="date" class="form-input" id="inspectionDate" onchange="autoSaveProjectData()">
                </div>

                <div class="form-field">
                    <label class="form-label">고객명</label>
                    <input type="text" class="form-input" id="customerName" placeholder="고객 이름" oninput="autoSaveProjectData()">
                </div>

                <div class="form-field">
                    <label class="form-label">연락처</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="010-0000-0000" oninput="autoSaveProjectData()">
                </div>

                <div class="form-field">
                    <label class="form-label">점검 작성자</label>
                    <input type="text" class="form-input" id="author" placeholder="작성자 이름" oninput="autoSaveProjectData()">
                </div>

                <button class="btn btn-primary" onclick="saveProject()">✅ 프로젝트 정보 저장</button>
            </div>

            <!-- 평면도 섹션 통합 -->
            <div class="card" style="margin-top: 20px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📐 평면도 관리</h2>
                
                <div class="floorplan-container">
                    <img id="floorplanPreview" class="floorplan-preview" style="display: none;">
                    <p id="floorplanPlaceholder" style="color: var(--text-secondary); padding: 60px 0;">
                        평면도를 추가해주세요
                    </p>
                    
                    <div class="photo-actions">
                        <button class="photo-action-btn camera" onclick="openFloorplanCamera()">
                            📷 촬영하기
                        </button>
                        <button class="photo-action-btn" onclick="openFloorplanGallery()">
                            🖼️ 갤러리
                        </button>
                    </div>

                    <button class="btn btn-danger" onclick="deleteFloorplan()" style="margin-top: 15px;">
                        🗑️ 평면도 삭제
                    </button>
                </div>
            </div>
        </div>

        <!-- 하자 점검 섹션 -->
        <div id="defects" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🔍 하자 점검</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    우측 하단의 ➕ 버튼을 눌러 하자를 추가하세요
                </p>
            </div>

            <div id="defectsList"></div>
        </div>

        <!-- 장비점검 섹션 -->
        <div id="equipment" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📸 장비 점검 LIST</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    열화상 카메라 및 실물 사진 촬영 (우측 하단 ➕ 버튼)
                </p>
            </div>

            <div id="equipmentList"></div>
        </div>

        <!-- 공기질 측정 섹션 -->
        <div id="airquality" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🌬️ 공기질 측정</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    실내 공기질을 측정하고 기록하세요
                </p>
            </div>

            <div id="airQualityList"></div>

            <button class="air-add-btn" onclick="addAirQualityRoom()">
                ➕ 방 추가
            </button>

            <div class="card reference-info">
                <strong>📋 권고기준</strong><br>
                라돈: 148 Bq/m³ 이하<br>
                포름알데히드: 0.210 mg/m³ 이하<br>
                총휘발성유기화합물: 0.500 mg/m³ 이하
            </div>
        </div>

        <!-- 데이터 관리 섹션 -->
        <div id="data" class="section">
            <!-- Google Drive 연동 카드 -->
            <!-- Google Drive 연동 (기본 숨김) -->
            <div class="card" id="googleDriveCard" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; margin-bottom: 20px; display: none;">
                <h2 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <path d="M6.5 12L1 21h11l5.5-9H6.5zM19 12l-5.5-9L8 12h11zM7.5 3l-6 9h11l-5-9z"/>
                        </svg>
                        Google Drive 연동 (선택 기능)
                    </div>
                    <button onclick="toggleGoogleDrive()" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 4px 12px; border-radius: 12px; cursor: pointer; font-size: 14px;">
                        ✕ 닫기
                    </button>
                </h2>
                
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 13px;">
                    💡 <strong>팀 공유 기능:</strong> Google Client ID를 설정하면 팀원들과 데이터를 실시간으로 공유할 수 있습니다. 혼자 사용하신다면 이 기능은 필요 없습니다.
                </div>
                
                <div id="googleDriveStatus" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px;">
                    <div id="notSignedIn" style="display: block;">
                        ⚠️ 로그인이 필요합니다.
                    </div>
                    <div id="signedIn" style="display: none;">
                        ✅ <span id="userEmail"></span>님 로그인됨
                    </div>
                </div>
                
                <!-- Google Client ID 설정 -->
                <div id="clientIdSetup" style="margin-bottom: 15px; padding: 10px; background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 8px; display: none;">
                    <div style="font-size: 13px; color: #fbbf24; margin-bottom: 8px;">
                        🔑 Google Client ID를 입력하세요
                    </div>
                    <input type="text" id="clientIdInput" placeholder="123456789-abcdef.apps.googleusercontent.com" 
                           style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 8px; font-size: 12px;">
                    <button onclick="saveClientId()" class="btn" style="width: 100%; background: #fbbf24; color: #1a202c; font-weight: bold;">
                        💾 저장
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="signInBtn" class="btn" onclick="handleGoogleSignIn()" style="flex: 1; background: white; color: #4285f4; font-weight: bold;">
                        🔐 Google 로그인
                    </button>
                    <button id="signOutBtn" class="btn" onclick="handleGoogleSignOut()" style="flex: 1; background: rgba(255,255,255,0.2); color: white; display: none;">
                        🚪 로그아웃
                    </button>
                    <button onclick="toggleClientIdSetup()" class="btn" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 0 15px;">
                        ⚙️
                    </button>
                </div>
                
                <!-- 동기화 버튼 (오프라인 작업 시 표시) -->
                <button id="syncBtn" class="btn" onclick="syncPendingProjects()" style="display: none; margin-top: 10px; background: #fbbf24; color: #1a202c; font-weight: bold; position: relative;">
                    <span id="syncBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
                    📤 대기 프로젝트 동기화
                </button>
            </div>

            <!-- 클라우드 저장/불러오기 -->
            <div class="card" id="cloudActionsCard" style="display: none;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">☁️ 클라우드 저장소</h3>
                
                <button class="btn btn-primary" onclick="uploadProjectToDrive()" style="margin-bottom: 10px;">
                    ☁️ Drive에 저장
                </button>
                
                <button class="btn btn-secondary" onclick="loadFromDrive()" style="margin-bottom: 10px;">
                    📥 Drive에서 불러오기
                </button>

                <button class="btn" onclick="showDriveProjects()" style="background: #34a853; color: white;">
                    📂 프로젝트 목록 보기
                </button>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span>💾 다운로드 & 관리</span>
                    <button onclick="toggleGoogleDrive()" class="btn" style="background: rgba(66, 133, 244, 0.1); color: #4285f4; padding: 8px 16px; font-size: 13px;">
                        ☁️ 팀 공유 기능
                    </button>
                </h2>
                
                <button class="btn btn-primary" onclick="generatePDF()">📄 PDF 보고서 생성</button>
                
                <div style="height: 10px;"></div>
                
                <button class="btn" onclick="downloadAllData()" style="background: #3b82f6; color: white; font-weight: bold;">
                    📦 모든 자료 다운로드 (엑셀 + 사진 ZIP)
                </button>
                
                <div style="height: 20px;"></div>
                
                <details style="margin-bottom: 20px;">
                    <summary style="cursor: pointer; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; color: #ef4444; font-weight: bold;">
                        ⚠️ 고급 기능 (일반 사용자는 필요 없음)
                    </summary>
                    <div style="padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px; margin-top: 10px;">
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                            💡 <strong>자동 저장:</strong> 데이터는 입력과 동시에 자동으로 저장됩니다.<br>
                            💡 <strong>데이터 삭제:</strong> 브라우저 데이터를 완전히 지우고 싶을 때만 사용하세요.
                        </p>
                        <button class="btn btn-secondary" onclick="saveCurrentData()" style="width: 100%; margin-bottom: 10px;">
                            💾 수동 저장 (자동 저장되므로 불필요)
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">
                            🗑️ 모든 데이터 삭제 (복구 불가)
                        </button>
                    </div>
                </details>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">📦 저장된 프로젝트 목록</h3>
                <div id="savedList" class="saved-list"></div>
            </div>
        </div>
    </div>

    <!-- 카메라 모달 -->
    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="camera-btn" onclick="capturePhoto()" ontouchstart="">📸</button>
            <button class="camera-btn close" onclick="closeCameraModal()" ontouchstart="">✕</button>
        </div>
    </div>

        <!-- 계약서 관리 섹션 (숨김) -->
        <div id="contract" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📄 프리랜서 계약서 관리</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 14px;">
                    프리랜서 고용계약서를 디지털로 작성하고 관리합니다
                </p>

                <!-- 계약서 작성 안내 -->
                <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 15px;">
                    <p style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 12px;">
                        ✨ 간편한 계약서 작성
                    </p>
                    <p style="color: white; font-size: 15px; margin-bottom: 20px; opacity: 0.95;">
                        작성 → 서명 → PDF 다운로드 → 카톡/이메일 공유
                    </p>
                    <button class="btn" onclick="showContractForm()" 
                        style="background: white; color: #10b981; font-size: 17px; padding: 14px 35px; font-weight: bold; border: none;">
                        ➕ 계약서 작성하기
                    </button>
                </div>

                <!-- 계약서 작성 폼 -->
                <div id="contractForm" style="display: block;">
                    <div class="form-group">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">👤 프리랜서 정보</h3>
                        
                        <div class="form-field">
                            <label class="form-label">성명 *</label>
                            <input type="text" class="form-input" id="contractName" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">주소 *</label>
                            <input type="text" class="form-input" id="contractAddress" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">주민등록번호 *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="contractJumin1" placeholder="생년월일 6자리" 
                                    maxlength="6" style="width: 150px;" required>
                                <span>-</span>
                                <input type="text" class="form-input" id="contractJumin2" placeholder="뒷자리 1자리" 
                                    maxlength="1" style="width: 60px;" required>
                                <span>******</span>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">연락처 *</label>
                            <input type="tel" class="form-input" id="contractPhone" placeholder="010-0000-0000" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">이메일 *</label>
                            <input type="email" class="form-input" id="contractEmail" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">사업자등록번호 (선택)</label>
                            <input type="text" class="form-input" id="contractBusiness" placeholder="000-00-00000">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">📋 계약 조건</h3>
                        
                        <div class="form-field">
                            <label class="form-label">계약 시작일 *</label>
                            <input type="date" class="form-input" id="contractStartDate" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">계약 종료일 *</label>
                            <input type="date" class="form-input" id="contractEndDate" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">계약금액 안내</label>
                            <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <p style="color: var(--text-primary); margin-bottom: 8px;">
                                    <strong>일당: 1만원 ~ 50만원</strong>
                                </p>
                                <p style="color: var(--text-secondary); font-size: 13px;">
                                    ※ 업무에 따라 지급비용이 다르게 지급됩니다
                                </p>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">지급일 안내</label>
                            <div style="padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid var(--secondary);">
                                <p style="color: var(--text-primary); margin-bottom: 8px;">
                                    <strong>업무 완료 후 1개월 이내 지급</strong>
                                </p>
                                <p style="color: var(--text-secondary); font-size: 13px;">
                                    ※ 사업소득세 3.3% 원천징수 후 지급
                                </p>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">특이사항 (선택)</label>
                            <textarea class="form-input" id="contractNotes" rows="3" 
                                placeholder="추가 계약 조건이나 특이사항을 입력하세요"></textarea>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">✍️ 전자 서명</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label class="form-label">대표 서명 (박지현)</label>
                            <div style="border: 2px solid var(--border); border-radius: 8px; background: white; position: relative;">
                                <canvas id="signatureCEO" width="600" height="200" 
                                    style="display: block; width: 100%; cursor: crosshair; touch-action: none;"></canvas>
                            </div>
                            <button class="btn" onclick="clearSignature('CEO')" style="margin-top: 10px; background: var(--danger);">
                                🗑️ 서명 지우기
                            </button>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="form-label">프리랜서 서명</label>
                            <div style="border: 2px solid var(--border); border-radius: 8px; background: white; position: relative;">
                                <canvas id="signatureFreelancer" width="600" height="200" 
                                    style="display: block; width: 100%; cursor: crosshair; touch-action: none;"></canvas>
                            </div>
                            <button class="btn" onclick="clearSignature('Freelancer')" style="margin-top: 10px; background: var(--danger);">
                                🗑️ 서명 지우기
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="previewContract()" style="flex: 1;">
                            👁️ 미리보기
                        </button>
                        <button class="btn btn-primary" onclick="downloadContractPDF()" style="flex: 1;">
                            📥 PDF 다운로드
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 15px; color: var(--text-secondary); font-size: 14px;">
                        💡 서명 후 PDF 다운로드 → 카톡/이메일로 공유하세요
                    </p>
                </div>

                <!-- 계약서 미리보기 모달 -->
                <div id="contractPreviewModal" style="display: none; position: fixed; top: 0; left: 0; 
                    width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; 
                    overflow: auto; padding: 20px;">
                    <div style="max-width: 800px; margin: 0 auto; background: white; 
                        border-radius: 15px; padding: 30px; position: relative; color: #333;">
                        <button onclick="closePreview()" 
                            style="position: absolute; top: 15px; right: 15px; 
                            background: #dc3545; color: white; border: none; 
                            border-radius: 50%; width: 40px; height: 40px; 
                            font-size: 20px; cursor: pointer;">✕</button>
                        
                        <div id="contractPreviewContent"></div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="closePreview()" style="padding: 12px 40px; font-size: 16px;">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    <!-- 플로팅 하자/장비 추가 버튼 -->
    <button id="floatingAddBtn" class="floating-btn" onclick="handleFloatingBtnClick()" style="display: none;">
        ➕
    </button>

    <!-- 로딩 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>처리 중...</p>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Drive 프로젝트 목록 모달 -->
    <div id="driveProjectsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-dark); border-radius: 12px; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary);">📂 Drive 프로젝트 목록</h2>
                <button onclick="closeDriveProjectsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
            </div>
            <div id="driveProjectsList" style="max-height: 60vh; overflow-y: auto;">
                <!-- 프로젝트 목록이 여기 표시됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // ==================== 전역 에러 핸들러 (크로스 플랫폼 안정성) ====================
        window.addEventListener('error', (event) => {
            console.error('전역 오류:', event.error);
            
            // 사용자에게 친절한 메시지 표시
            if (event.error && event.error.message) {
                const errorMsg = event.error.message.toLowerCase();
                
                // 메모리 오류 (iOS에서 흔함)
                if (errorMsg.includes('memory') || errorMsg.includes('quota')) {
                    showToast('⚠️ 메모리 부족. 사진을 압축하여 재시도합니다.', 'warning');
                }
                // 네트워크 오류
                else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                    showToast('📶 네트워크 오류. 연결 상태를 확인해주세요.', 'error');
                }
            }
            
            // 에러 로그 (개발용)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('에러 상세:', {
                    message: event.error?.message,
                    stack: event.error?.stack,
                    filename: event.filename,
                    lineno: event.lineno
                });
            }
        });
        
        // Promise rejection 핸들러
        window.addEventListener('unhandledrejection', (event) => {
            console.error('처리되지 않은 Promise 거부:', event.reason);
            
            // 네트워크 관련 에러는 조용히 처리
            if (event.reason && event.reason.message && 
                event.reason.message.includes('NetworkError')) {
                event.preventDefault();
                showToast('📶 일시적인 네트워크 오류입니다.', 'warning');
            }
        });
        
        // ==================== 디바이스 및 브라우저 감지 ====================
        const deviceInfo = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isAndroid: /Android/.test(navigator.userAgent),
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            isChrome: /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor),
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            version: navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/) || []
        };
        
        // iOS 버전 확인
        deviceInfo.iOSVersion = deviceInfo.isIOS && deviceInfo.version.length > 1 
            ? parseInt(deviceInfo.version[1]) 
            : 0;
        
        console.log('디바이스 정보:', deviceInfo);
        
        // 디바이스별 경고 표시
        if (deviceInfo.isIOS && deviceInfo.iOSVersion < 13) {
            alert('⚠️ iOS 13 이상 권장\n일부 기능이 제한될 수 있습니다.');
        }
        
        // ==================== 온라인/오프라인 상태 관리 ====================
        let isOnline = navigator.onLine;
        let pendingSyncProjects = []; // 동기화 대기 프로젝트
        
        // Service Worker는 환경 제약으로 제거
        // localStorage를 사용한 데이터 저장으로 대체
        
        // 온라인/오프라인 상태 감지
        window.addEventListener('online', () => {
            isOnline = true;
            updateOnlineStatus();
            showToast('✅ 온라인 연결됨', 'success');
            
            // 동기화 대기 중인 프로젝트 확인
            loadPendingSyncProjects();
            if (pendingSyncProjects.length > 0) {
                setTimeout(() => {
                    if (confirm(`동기화 대기 중인 프로젝트가 ${pendingSyncProjects.length}건 있습니다.\n지금 드라이브에 업로드하시겠습니까?`)) {
                        syncPendingProjects();
                    }
                }, 1000);
            }
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateOnlineStatus();
            showToast('📶 오프라인 모드 - 작업 내용은 로컬에 저장됩니다', 'warning');
        });
        
        // 온라인 상태 표시 업데이트
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.innerHTML = '🟢 온라인';
                    statusIndicator.style.color = '#10b981';
                } else {
                    statusIndicator.innerHTML = '🔴 오프라인';
                    statusIndicator.style.color = '#ef4444';
                }
            }
        }
        
        // localStorage 기반 동기화 대기 관리
        function loadPendingSyncProjects() {
            try {
                const saved = localStorage.getItem('pendingSyncProjects');
                if (saved) {
                    pendingSyncProjects = JSON.parse(saved);
                    updateSyncBadge();
                }
            } catch (error) {
                console.error('동기화 목록 로드 실패:', error);
                pendingSyncProjects = [];
            }
        }
        
        function savePendingSyncProjects() {
            try {
                localStorage.setItem('pendingSyncProjects', JSON.stringify(pendingSyncProjects));
                updateSyncBadge();
            } catch (error) {
                console.error('동기화 목록 저장 실패:', error);
            }
        }
        
        function addToPendingSync(projectData) {
            projectData.syncTimestamp = Date.now();
            pendingSyncProjects.push(projectData);
            savePendingSyncProjects();
            
            // 동기화 버튼 표시
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) syncBtn.style.display = 'block';
        }
        
        function removePendingSyncProject(index) {
            pendingSyncProjects.splice(index, 1);
            savePendingSyncProjects();
        }
        
        // 동기화 뱃지 업데이트
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (pendingSyncProjects.length > 0) {
                    badge.textContent = pendingSyncProjects.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // 대기 중인 프로젝트 동기화
        window.syncPendingProjects = async function() {
            if (!isOnline) {
                showToast('❌ 인터넷 연결이 필요합니다', 'error');
                return;
            }
            
            if (pendingSyncProjects.length === 0) {
                showToast('✅ 동기화할 프로젝트가 없습니다', 'success');
                return;
            }
            
            showLoading('동기화 중...');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = pendingSyncProjects.length - 1; i >= 0; i--) {
                try {
                    const project = pendingSyncProjects[i];
                    await uploadProjectToDrive(project);
                    removePendingSyncProject(i);
                    successCount++;
                } catch (error) {
                    console.error('동기화 실패:', error);
                    failCount++;
                }
            }
            
            hideLoading();
            
            if (failCount === 0) {
                showToast(`✅ 모든 프로젝트(${successCount}건)가 동기화되었습니다`, 'success');
            } else {
                showToast(`⚠️ ${successCount}건 성공, ${failCount}건 실패`, 'warning');
            }
            
            // 동기화 버튼 숨기기
            if (pendingSyncProjects.length === 0) {
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) syncBtn.style.display = 'none';
            }
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            loadPendingSyncProjects();
            updateOnlineStatus();
        });
        
        // ==================== Google 로그인 비활성화 (보안) ====================
        // ⚠️ API 키가 GitHub에 노출되어 비활성화되었습니다
        // 다시 사용하려면 새로운 Client ID를 발급받아 설정하세요
        
        let GOOGLE_CLIENT_ID = localStorage.getItem('google_client_id') || '';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        
        let accessToken = null;
        let currentUser = null;
        
        const GOOGLE_DRIVE_DISABLED = true; // Google Drive 기능 비활성화
        
        // 설정 저장
        function saveGoogleClientId(clientId) {
            GOOGLE_CLIENT_ID = clientId;
            localStorage.setItem('google_client_id', clientId);
            showToast('✅ Client ID 저장 완료');
        }
        
        // Client ID 설정 토글
        window.toggleClientIdSetup = function() {
            const setup = document.getElementById('clientIdSetup');
            if (setup.style.display === 'none') {
                setup.style.display = 'block';
                document.getElementById('clientIdInput').value = GOOGLE_CLIENT_ID;
            } else {
                setup.style.display = 'none';
            }
        }
        
        // Client ID 저장
        window.saveClientId = function() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) {
                showToast('❌ Client ID를 입력하세요');
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                showToast('❌ 올바른 Client ID 형식이 아닙니다');
                return;
            }
            
            saveGoogleClientId(clientId);
            toggleClientIdSetup();
        }
        
        // Google Drive 카드 토글
        window.toggleGoogleDrive = function() {
            const card = document.getElementById('googleDriveCard');
            if (card.style.display === 'none') {
                card.style.display = 'block';
                showToast('💡 팀 공유가 필요하면 Client ID를 설정하세요');
            } else {
                card.style.display = 'none';
            }
        }

        // ==================== 프로젝트 목록 관리 ====================
        let projects = []; // 모든 프로젝트 목록
        let currentProjectId = null; // 현재 작업 중인 프로젝트 ID

        // 프로젝트 템플릿
        function createNewProject() {
            return {
                id: Date.now(),
                apartmentName: '',
                dong: '',
                ho: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                customerName: '',
                customerPhone: '',
                author: '', // ✅ 점검 작성자 추가
                floorplan: null,
                defects: [],
                equipment: [],
                airQuality: [],
                createdAt: new Date().toISOString(),
                isUploaded: false,
                // ✅ 프로젝트별 ID 카운터 추가
                lastDefectId: 0,
                lastEquipmentId: 0,
                lastAirQualityId: 0
            };
        }

        // 현재 프로젝트 가져오기
        function getCurrentProject() {
            if (projects.length === 0) {
                const newProject = createNewProject();
                projects.push(newProject);
                currentProjectId = newProject.id;
            }
            return projects.find(p => p.id === currentProjectId) || projects[0];
        }

        // ✅ projectData를 Proxy로 변경 - 항상 현재 프로젝트를 참조
        const projectData = new Proxy({}, {
            get(target, prop) {
                const project = getCurrentProject();
                return project[prop];
            },
            set(target, prop, value) {
                const project = getCurrentProject();
                project[prop] = value;
                return true;
            }
        });

        // ✅ ID 카운터를 프로젝트별로 관리하도록 변경
        // 이제 각 프로젝트가 독립적인 ID 체계를 가짐
        // let defectIdCounter = 1; // 제거됨
        // let equipmentIdCounter = 1; // 제거됨  
        // let airQualityIdCounter = 1; // 제거됨
        let cameraStream = null;
        let currentPhotoTarget = null;

        // ==================== Google API 초기화 ====================
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // ==================== OAuth2 팝업 로그인 ====================
        window.handleGoogleSignIn = async function() {
            // Client ID 확인
            if (!GOOGLE_CLIENT_ID) {
                showToast('❌ Client ID를 먼저 설정하세요 (⚙️ 버튼)');
                toggleClientIdSetup();
                return;
            }
            
            console.log('🔵 OAuth2 팝업 로그인 시작...');
            
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams({
                client_id: GOOGLE_CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: SCOPES,
                prompt: 'consent'
            });
            
            // 팝업으로 로그인
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popup = window.open(
                authUrl,
                'Google Login',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!popup) {
                showToast('❌ 팝업이 차단되었습니다');
                return;
            }
        }
        
        // 메시지 수신 (팝업에서 토큰 전달)
        window.addEventListener('message', async (event) => {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'GOOGLE_AUTH') {
                const token = event.data.accessToken;
                if (token) {
                    accessToken = token;
                    localStorage.setItem('google_access_token', accessToken);
                    console.log('✅ 토큰 저장 완료');
                    
                    // 사용자 정보 가져오기
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                        if (!response.ok) throw new Error('Failed');
                        
                        currentUser = await response.json();
                        console.log('✅ 로그인 성공:', currentUser.email);
                        
                        updateSignInStatus(true);
                        showToast('✅ ' + currentUser.email + ' 로그인 성공!');
                        
                    } catch (error) {
                        console.error('❌ 사용자 정보 가져오기 실패:', error);
                        showToast('❌ 로그인 오류');
                        accessToken = null;
                        localStorage.removeItem('google_access_token');
                    }
                }
            }
        });
        
        // URL에서 토큰 추출 (리다이렉트 콜백)
        function checkUrlForToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token && window.opener) {
                // 부모 창으로 토큰 전달
                window.opener.postMessage({
                    type: 'GOOGLE_AUTH',
                    accessToken: token
                }, window.location.origin);
                window.close();
            }
        }
        
        // 페이지 로드 시 토큰 체크
        checkUrlForToken();
        
        // 저장된 토큰으로 자동 로그인
        async function checkIfSignedIn() {
            const token = localStorage.getItem('google_access_token');
            if (token) {
                accessToken = token;
                
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                    if (!response.ok) throw new Error('Token expired');
                    
                    currentUser = await response.json();
                    updateSignInStatus(true);
                    console.log('✅ 자동 로그인:', currentUser.email);
                } catch (error) {
                    console.log('❌ 토큰 만료');
                    accessToken = null;
                    localStorage.removeItem('google_access_token');
                }
            }
        }

        window.handleGoogleSignOut = function() {
            if (accessToken) {
                // Google OAuth2 토큰 해지
                fetch('https://accounts.google.com/o/oauth2/revoke?token=' + accessToken);
                
                accessToken = null;
                currentUser = null;
                localStorage.removeItem('google_access_token');
                updateSignInStatus(false);
                showToast('로그아웃되었습니다');
            }
        }

        function updateSignInStatus(isSignedIn) {
            try {
                if (isSignedIn) {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const userEmail = document.getElementById('userEmail');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'none';
                    if (signedIn) signedIn.style.display = 'block';
                    if (userEmail) userEmail.textContent = currentUser?.email || '사용자';
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (signOutBtn) signOutBtn.style.display = 'block';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'block';
                } else {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'block';
                    if (signedIn) signedIn.style.display = 'none';
                    if (signInBtn) signInBtn.style.display = 'block';
                    if (signOutBtn) signOutBtn.style.display = 'none';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'none';
                }
                console.log('✅ UI 업데이트 완료:', isSignedIn ? '로그인' : '로그아웃');
            } catch (e) {
                console.error('UI 업데이트 오류:', e);
            }
        }

        // ==================== Drive 폴더 관리 ====================
        async function getOrCreateAppFolder() {
            try {
                // "더홈점검" 폴더 찾기
                const response = await gapi.client.drive.files.list({
                    q: "name='더홈점검' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // 폴더가 없으면 생성
                const folderMetadata = {
                    name: '더홈점검',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('폴더 생성/찾기 오류:', error);
                throw error;
            }
        }

        // ==================== Drive 저장 ====================
        

        // ==================== Drive 불러오기 ====================
                async function createProjectFolder(appFolderId, projectName) {
            try {
                const folderMetadata = {
                    name: projectName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [appFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id, name'
                });

                return folder.result.id;
            } catch (error) {
                console.error('프로젝트 폴더 생성 오류:', error);
                throw error;
            }
        }

        // 하자사진 폴더 생성

        async function createPhotosFolder(projectFolderId) {
            try {
                const folderMetadata = {
                    name: '하자사진',
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [projectFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('사진 폴더 생성 오류:', error);
                throw error;
            }
        }

        // Base64 이미지를 Blob으로 변환

        function base64ToBlob(base64, mimeType) {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeType });
        }

        async function uploadPhoto(photosFolderId, photoData, fileName) {
            try {
                const blob = base64ToBlob(photoData, 'image/jpeg');
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: fileName,
                    mimeType: 'image/jpeg',
                    parents: [photosFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('사진 업로드 실패');
                }

                const result = await response.json();
                return result.id;
            } catch (error) {
                console.error('사진 업로드 오류:', error);
                throw error;
            }
        }

        // Google Sheets 생성 (하자 리스트)

        async function createDefectSpreadsheet(projectFolderId, projectName, defects) {
            try {
                // 스프레드시트 생성
                const spreadsheetBody = {
                    properties: {
                        title: `${projectName}_하자점검_리스트`
                    },
                    sheets: [{
                        properties: {
                            title: '하자목록'
                        }
                    }]
                };

                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    resource: spreadsheetBody
                });

                const spreadsheetId = createResponse.result.spreadsheetId;

                // 스프레드시트를 프로젝트 폴더로 이동
                await gapi.client.drive.files.update({
                    fileId: spreadsheetId,
                    addParents: projectFolderId,
                    fields: 'id, parents'
                });

                // 데이터 입력 준비
                const headers = [['No', '공간', '위치', '하자종류', '상세설명']];
                const rows = defects.map((defect, index) => {
                    // 상세설명만 사용 (이미 모든 정보 포함)
                    const description = defect.description || '';
                    
                    return [
                        index + 1,
                        defect.spaces.join(', '),
                        defect.locations.join(', '),
                        defect.types.join(', '),
                        description || '-'
                    ];
                });

                const allData = [...headers, ...rows];

                // 데이터 입력
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: allData
                    }
                });

                // 헤더 스타일 적용
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [
                            // 헤더 배경색 및 글자색
                            {
                                repeatCell: {
                                    range: {
                                        sheetId: 0,
                                        startRowIndex: 0,
                                        endRowIndex: 1
                                    },
                                    cell: {
                                        userEnteredFormat: {
                                            backgroundColor: {
                                                red: 0.06,
                                                green: 0.73,
                                                blue: 0.51
                                            },
                                            textFormat: {
                                                foregroundColor: {
                                                    red: 1,
                                                    green: 1,
                                                    blue: 1
                                                },
                                                bold: true
                                            }
                                        }
                                    },
                                    fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                }
                            },
                            // 컬럼 너비 조정
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 0,
                                        endIndex: 1
                                    },
                                    properties: {
                                        pixelSize: 50
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 1,
                                        endIndex: 2
                                    },
                                    properties: {
                                        pixelSize: 100
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 2,
                                        endIndex: 3
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 3,
                                        endIndex: 4
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 4,
                                        endIndex: 5
                                    },
                                    properties: {
                                        pixelSize: 300
                                    },
                                    fields: 'pixelSize'
                                }
                            }
                        ]
                    }
                });

                return spreadsheetId;
            } catch (error) {
                console.error('스프레드시트 생성 오류:', error);
                throw error;
            }
        }

        // 프로젝트 정보 JSON 업로드

        async function uploadProjectInfo(projectFolderId, projectData) {
            try {
                const projectInfo = {
                    apartmentName: projectData.apartmentName,
                    dong: projectData.dong,
                    ho: projectData.ho,
                    inspectionDate: projectData.inspectionDate,
                    customerName: projectData.customerName,
                    customerPhone: projectData.customerPhone,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: currentUser?.email
                };

                const blob = new Blob([JSON.stringify(projectInfo, null, 2)], { type: 'application/json' });

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: '프로젝트_정보.json',
                    mimeType: 'application/json',
                    parents: [projectFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('프로젝트 정보 업로드 실패');
                }

                return true;
            } catch (error) {
                console.error('프로젝트 정보 업로드 오류:', error);
                throw error;
            }
        }

        // 메인 업로드 함수

        window.uploadProjectToDrive = async function(projectToUpload = null) {
            // projectToUpload가 있으면 그것 사용 (동기화용), 없으면 현재 프로젝트
            const project = projectToUpload || getCurrentProject();
            
            // 오프라인 체크
            if (!isOnline) {
                // 오프라인일 때 로컬 저장
                try {
                    addToPendingSync(project);
                    showToast('📶 오프라인 - 프로젝트가 저장되었습니다. 온라인 연결 시 동기화하세요.', 'warning');
                    return;
                } catch (error) {
                    alert('로컬 저장 실패: ' + error.message);
                    return;
                }
            }
            
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            // 필수 정보 확인
            if (!project.apartmentName || !project.dong || !project.ho) {
                alert('프로젝트 정보(아파트명, 동, 호)를 먼저 입력해주세요');
                return;
            }

            if (project.defects.length === 0) {
                alert('최소 1개 이상의 하자를 등록해주세요');
                return;
            }

            // projectToUpload가 있으면 동기화 중이므로 confirm 스킵
            if (!projectToUpload && !confirm(`"${project.apartmentName} ${project.dong} ${project.ho}"를 Google Drive에 업로드하시겠습니까?`)) {
                return;
            }

            showLoading();

            try {
                // 1. 앱 루트 폴더 가져오기/생성
                const appFolderId = await getOrCreateAppFolder();
                
                // 2. 프로젝트 폴더 생성
                const projectName = `${project.inspectionDate}_${project.apartmentName}_${project.dong}_${project.ho}`;
                const projectFolderId = await createProjectFolder(appFolderId, projectName);
                
                // 3. 하자사진 폴더 생성
                const photosFolderId = await createPhotosFolder(projectFolderId);
                
                // 4. 사진 업로드 (찍은 순서대로 1.jpg, 2.jpg...)
                let photoIndex = 1;
                const totalPhotos = project.defects.reduce((sum, defect) => sum + (defect.photos?.length || 0), 0);
                
                for (const defect of project.defects) {
                    if (defect.photos && defect.photos.length > 0) {
                        for (const photo of defect.photos) {
                            await uploadPhoto(photosFolderId, photo, `${photoIndex}.jpg`);
                            photoIndex++;
                        }
                    }
                }
                
                // 5. 하자 리스트 스프레드시트 생성
                await createDefectSpreadsheet(projectFolderId, projectName, project.defects);
                
                // 6. 프로젝트 정보 JSON 업로드
                await uploadProjectInfo(projectFolderId, project);
                
                // 7. 프로젝트 상태 업데이트
                project.isUploaded = true;
                project.uploadedAt = new Date().toISOString();
                project.driveFolderId = projectFolderId;
                
                // 8. 로컬 저장
                saveProjectsToLocalStorage();
                renderProjectList();
                
                hideLoading();
                showToast(`✅ 업로드 완료! (사진 ${totalPhotos}장)`);
                
                // 동기화 중이 아닐 때만 alert 표시
                if (!projectToUpload) {
                    alert(`✅ 업로드 완료!\n\n프로젝트: ${projectName}\n사진: ${totalPhotos}장\n하자: ${project.defects.length}개\n\nGoogle Drive에서 확인하세요!`);
                }
                
            } catch (error) {
                console.error('업로드 오류:', error);
                hideLoading();
                alert('업로드 중 오류가 발생했습니다:\n' + error.message);
            }
        }

        // ==================== Drive 불러오기 (삭제 예정) ====================


        window.loadFromDrive = async function() {
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('불러올 프로젝트 정보(아파트명, 동, 호)를 먼저 입력해주세요');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();
                const fileName = `${projectData.apartmentName}_${projectData.dong}동_${projectData.ho}호.json`;

                // 파일 검색
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (!response.result.files || response.result.files.length === 0) {
                    hideLoading();
                    alert('해당 프로젝트를 찾을 수 없습니다');
                    return;
                }

                const fileId = response.result.files[0].id;

                // 파일 내용 다운로드
                const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!fileResponse.ok) {
                    throw new Error('파일 다운로드 실패');
                }

                const data = await fileResponse.json();

                // 현재 프로젝트에 데이터 로드
                const project = getCurrentProject();
                project.apartmentName = data.apartmentName || '';
                project.dong = data.dong || '';
                project.ho = data.ho || '';
                project.inspectionDate = data.inspectionDate || '';
                project.customerName = data.customerName || '';
                project.customerPhone = data.customerPhone || '';
                project.author = data.author || ''; // ✅ 작성자 추가
                project.floorplan = data.floorplan || null;
                project.defects = data.defects || [];
                project.equipment = data.equipment || [];
                project.airQuality = data.airQuality || [];

                // ID 카운터 업데이트
                if (project.defects.length > 0) {
                    defectIdCounter = Math.max(...project.defects.map(d => d.id)) + 1;
                }
                if (project.equipment && project.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...project.equipment.map(e => e.id)) + 1;
                }
                if (project.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...project.airQuality.map(a => a.id)) + 1;
                }

                // UI 업데이트
                renderAll();
                saveProjectsToLocalStorage();

                hideLoading();
                showToast('✅ Drive에서 불러왔습니다!');
            } catch (error) {
                console.error('Drive 불러오기 오류:', error);
                hideLoading();
                alert('불러오기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // ==================== Drive 프로젝트 목록 ====================
        window.showDriveProjects = async function() {
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();

                // 폴더 내 모든 JSON 파일 검색
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and mimeType='application/json' and trashed=false`,
                    fields: 'files(id, name, modifiedTime)',
                    orderBy: 'modifiedTime desc',
                    spaces: 'drive'
                });

                const files = response.result.files || [];

                hideLoading();

                if (files.length === 0) {
                    alert('저장된 프로젝트가 없습니다');
                    return;
                }

                // 모달에 목록 표시
                const listContainer = document.getElementById('driveProjectsList');
                listContainer.innerHTML = files.map(file => `
                    <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" 
                         onclick="loadDriveProjectById('${file.id}')"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'"
                         onmouseout="this.style.background='var(--card-bg)'">
                        <div style="font-weight: bold; margin-bottom: 5px;">📄 ${file.name.replace('.json', '')}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            마지막 수정: ${new Date(file.modifiedTime).toLocaleString('ko-KR')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('driveProjectsModal').style.display = 'block';
            } catch (error) {
                console.error('프로젝트 목록 불러오기 오류:', error);
                hideLoading();
                alert('목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        window.loadDriveProjectById = async function(fileId) {
            showLoading();
            closeDriveProjectsModal();

            try {
                // 파일 내용 다운로드
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error('파일 다운로드 실패');
                }

                const data = await response.json();

                // 현재 프로젝트에 데이터 로드
                const project = getCurrentProject();
                project.apartmentName = data.apartmentName || '';
                project.dong = data.dong || '';
                project.ho = data.ho || '';
                project.inspectionDate = data.inspectionDate || '';
                project.customerName = data.customerName || '';
                project.customerPhone = data.customerPhone || '';
                project.author = data.author || ''; // ✅ 작성자 추가
                project.floorplan = data.floorplan || null;
                project.defects = data.defects || [];
                project.equipment = data.equipment || [];
                project.airQuality = data.airQuality || [];

                // ID 카운터 업데이트
                if (project.defects.length > 0) {
                    defectIdCounter = Math.max(...project.defects.map(d => d.id)) + 1;
                }
                if (project.equipment && project.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...project.equipment.map(e => e.id)) + 1;
                }
                if (project.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...project.airQuality.map(a => a.id)) + 1;
                }

                // UI 업데이트
                renderAll();
                saveProjectsToLocalStorage();

                hideLoading();
                showToast('✅ 프로젝트를 불러왔습니다!');
            } catch (error) {
                console.error('프로젝트 불러오기 오류:', error);
                hideLoading();
                alert('불러오기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        window.closeDriveProjectsModal = function() {
            document.getElementById('driveProjectsModal').style.display = 'none';
        }

        // ==================== 프로젝트 목록 관리 함수 ====================
        
        // 프로젝트 목록 렌더링
        function renderProjectList() {
            const listContainer = document.getElementById('projectList');
            
            if (projects.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">프로젝트가 없습니다. "새 프로젝트"를 추가하세요.</div>';
                return;
            }

            listContainer.innerHTML = projects.map((project, index) => {
                const isActive = project.id === currentProjectId;
                const projectName = project.apartmentName && project.dong && project.ho 
                    ? `${project.apartmentName} ${project.dong} ${project.ho}`
                    : `프로젝트 ${index + 1} (정보 미입력)`;
                
                const uploadStatus = project.isUploaded 
                    ? '<span style="color: #10b981;">✅ 업로드 완료</span>' 
                    : '<span style="color: #fbbf24;">⏳ 작업중</span>';
                
                const authorInfo = project.author 
                    ? `작성자: ${project.author} | ` 
                    : ''; // ✅ 작성자 정보 추가

                return `
                    <div onclick="switchProject(${project.id})" 
                         style="background: ${isActive ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)'}; 
                                padding: 12px; 
                                border-radius: 6px; 
                                margin-bottom: 8px; 
                                cursor: pointer;
                                border: ${isActive ? '2px solid white' : '2px solid transparent'};
                                transition: all 0.3s;"
                         onmouseover="if(!${isActive}) this.style.background='rgba(255,255,255,0.2)'"
                         onmouseout="if(!${isActive}) this.style.background='rgba(255,255,255,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${isActive ? '▶ ' : ''}${projectName}
                                </div>
                                <div style="font-size: 11px; opacity: 0.8;">
                                    ${authorInfo}하자: ${project.defects.length}개 | 
                                    장비: ${project.equipment ? project.equipment.length : 0}개 | 
                                    공기질: ${project.airQuality.length}개
                                </div>
                            </div>
                            <div style="font-size: 12px;">
                                ${uploadStatus}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 새 프로젝트 추가
        window.addNewProject = function() {
            const newProject = createNewProject();
            projects.push(newProject);
            currentProjectId = newProject.id;
            
            console.log('➕ 새 프로젝트 생성:', {
                newProjectId: newProject.id,
                totalProjects: projects.length,
                hasFloorplan: !!newProject.floorplan
            });
            
            // UI 새로고침
            renderProjectList();
            loadProjectToUI();
            updateProgress();
            
            showToast('✨ 새 프로젝트가 추가되었습니다!');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // 프로젝트 전환
        window.switchProject = function(projectId) {
            if (projectId === currentProjectId) return;
            
            console.log('🔄 프로젝트 전환:', {
                from: currentProjectId,
                to: projectId
            });
            
            // 현재 프로젝트 UI 데이터 저장
            saveCurrentProjectFromUI();
            
            // 프로젝트 전환 (Proxy가 자동으로 새 프로젝트 참조)
            currentProjectId = projectId;
            
            console.log('📂 전환 후 프로젝트:', {
                id: projectId,
                hasFloorplan: !!getCurrentProject().floorplan
            });
            
            // 새 프로젝트 UI 로드
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('📂 프로젝트가 전환되었습니다');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // 현재 프로젝트 삭제
        window.deleteCurrentProject = function() {
            if (projects.length <= 1) {
                alert('❌ 마지막 프로젝트는 삭제할 수 없습니다');
                return;
            }

            const project = getCurrentProject();
            const projectName = project.apartmentName && project.dong && project.ho 
                ? `${project.apartmentName} ${project.dong} ${project.ho}`
                : '현재 프로젝트';

            if (!confirm(`"${projectName}"를 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }

            // 프로젝트 삭제
            projects = projects.filter(p => p.id !== currentProjectId);
            
            // 첫 번째 프로젝트로 전환
            currentProjectId = projects[0].id;
            
            // UI 업데이트
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('🗑️ 프로젝트가 삭제되었습니다');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // UI에서 현재 프로젝트로 데이터 저장
        function saveCurrentProjectFromUI() {
            const project = getCurrentProject();
            
            project.apartmentName = document.getElementById('apartmentName').value;
            project.dong = document.getElementById('dong').value;
            project.ho = document.getElementById('ho').value;
            project.inspectionDate = document.getElementById('inspectionDate').value;
            project.customerName = document.getElementById('customerName').value;
            project.customerPhone = document.getElementById('customerPhone').value;
            project.author = document.getElementById('author').value; // ✅ 작성자 저장
            
            // floorplan, defects, equipment, airQuality는 이미 projectData 참조로 실시간 업데이트됨
        }

        // 프로젝트 데이터를 UI에 로드
        function loadProjectToUI() {
            const project = getCurrentProject();
            
            document.getElementById('apartmentName').value = project.apartmentName || '';
            document.getElementById('dong').value = project.dong || '';
            document.getElementById('ho').value = project.ho || '';
            document.getElementById('inspectionDate').value = project.inspectionDate || '';
            document.getElementById('customerName').value = project.customerName || '';
            document.getElementById('customerPhone').value = project.customerPhone || '';
            document.getElementById('author').value = project.author || ''; // ✅ 작성자 로드
            
            // 평면도 표시 - displayFloorplan() 함수 사용
            displayFloorplan();
            
            // 하자, 장비, 공기질 목록 렌더링
            renderDefects();
            renderEquipment();
            renderAirQuality();
        }

        // ==================== 자동 저장 최적화 ====================
        let saveTimer = null;
        let isSaving = false;
        
        // Debounced 저장 (텍스트 입력 등 빈번한 변경용)
        function saveWithDebounce(delay = 1000) {
            // 기존 타이머 취소
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            
            // 새 타이머 설정
            saveTimer = setTimeout(() => {
                saveProjectsToLocalStorage();
                saveTimer = null;
            }, delay);
        }
        
        // 즉시 저장 (중요한 작업용)
        function saveImmediately() {
            // Debounce 타이머 취소
            if (saveTimer) {
                clearTimeout(saveTimer);
                saveTimer = null;
            }
            
            // 즉시 저장
            saveProjectsToLocalStorage();
        }
        
        // 페이지 종료시 pending 저장 처리
        window.addEventListener('beforeunload', (e) => {
            if (saveTimer) {
                // pending 저장이 있으면 즉시 실행
                clearTimeout(saveTimer);
                saveTimer = null;
                
                // 동기적으로 세션스토리지에 임시 저장
                try {
                    const backupData = {
                        projects: projects,
                        currentProjectId: currentProjectId,
                        timestamp: new Date().toISOString()
                    };
                    sessionStorage.setItem('thehomein_temp_backup', JSON.stringify(backupData));
                    console.log('📦 종료 전 임시 백업 완료');
                } catch (error) {
                    console.error('임시 백업 실패:', error);
                }
            }
        });
        
        // 프로젝트 목록을 로컬 스토리지에 저장 (기존 함수 수정)
        async function saveProjectsToLocalStorage() {
            // 중복 저장 방지
            if (isSaving) {
                console.log('⏳ 저장 중... 건너뜀');
                return;
            }
            
            isSaving = true;
            
            try {
                console.log('💾 저장 시작:', {
                    totalProjects: projects.length,
                    currentProjectId: currentProjectId,
                    projects: projects.map(p => ({
                        id: p.id,
                        name: `${p.apartmentName} ${p.dong} ${p.ho}`.trim() || '(이름없음)',
                        hasFloorplan: !!p.floorplan,
                        floorplanSize: p.floorplan ? p.floorplan.length : 0
                    }))
                });
                
                // 프로젝트 목록 저장
                await saveToIndexedDB('projects_list', { projects, currentProjectId });
                
                // ✅ 현재 작업 중인 프로젝트도 별도로 저장 (새로고침 시 복구용)
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    await saveToIndexedDB('thehomein_current', currentProject);
                    console.log('✅ 현재 프로젝트 저장 완료');
                }
                
                console.log('✅ 프로젝트 목록 저장 완료');
            } catch (e) {
                console.error('프로젝트 목록 저장 실패:', e);
                
                // ✅ 사용자 알림 추가
                if (e.name === 'QuotaExceededError') {
                    // 저장 공간 부족
                    showToast('⚠️ 저장 공간이 부족합니다! 불필요한 사진을 삭제해주세요', 'error');
                    
                    // 공간 사용량 체크 (가능한 경우)
                    if (navigator.storage && navigator.storage.estimate) {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = Math.round(estimate.usage / 1024 / 1024);
                        const quotaMB = Math.round(estimate.quota / 1024 / 1024);
                        console.log(`📊 저장공간: ${usedMB}MB / ${quotaMB}MB 사용 중`);
                    }
                } else if (e.name === 'InvalidStateError' || e.name === 'TransactionInactiveError') {
                    // 트랜잭션 오류
                    showToast('⚠️ 저장 중 오류 발생! 자동으로 다시 시도합니다', 'warning');
                    
                    // 1초 후 재시도
                    setTimeout(async () => {
                        try {
                            await saveToIndexedDB('projects_list', { projects, currentProjectId });
                            showToast('✅ 재시도 성공! 데이터가 저장되었습니다', 'success');
                        } catch (retryError) {
                            showToast('❌ 저장 실패! 앱을 새로고침 해주세요', 'error');
                        }
                    }, 1000);
                } else {
                    // 기타 오류
                    showToast('⚠️ 저장 실패! 잠시 후 다시 시도해주세요', 'error');
                }
                
                // 임시 백업 (세션 스토리지)
                try {
                    const backupData = {
                        projects: projects,
                        currentProjectId: currentProjectId,
                        timestamp: new Date().toISOString()
                    };
                    sessionStorage.setItem('thehomein_temp_backup', JSON.stringify(backupData));
                    console.log('📦 임시 백업 완료 (세션 스토리지)');
                } catch (backupError) {
                    console.error('임시 백업도 실패:', backupError);
                }
            } finally {
                isSaving = false;
            }
        }

        // 프로젝트 목록을 IndexedDB에서 불러오기
        async function loadProjectsFromLocalStorage() {
            try {
                const saved = await loadFromIndexedDB('projects_list');
                
                if (saved && saved.projects) {
                    projects = saved.projects;
                    currentProjectId = saved.currentProjectId;
                    
                    console.log('✅ 프로젝트 목록 불러오기 완료:', projects.length + '개');
                    
                    // ✅ 현재 프로젝트의 데이터를 UI에 반영
                    const currentProject = getCurrentProject();
                    if (currentProject) {
                        document.getElementById('apartmentName').value = currentProject.apartmentName || '';
                        document.getElementById('dong').value = currentProject.dong || '';
                        document.getElementById('ho').value = currentProject.ho || '';
                        document.getElementById('inspectionDate').value = currentProject.inspectionDate || '';
                        document.getElementById('customerName').value = currentProject.customerName || '';
                        document.getElementById('customerPhone').value = currentProject.customerPhone || '';
                        document.getElementById('author').value = currentProject.author || '';
                        
                        // ✅ ID 카운터 초기화 제거 (이제 프로젝트별로 관리됨)
                        // 기존 코드 제거됨 - 프로젝트별 lastDefectId, lastEquipmentId, lastAirQualityId 사용
                        
                        // 렌더링
                        displayFloorplan();
                        renderDefects();
                        renderEquipment();
                        renderAirQuality();
                    }
                } else {
                    // ✅ IndexedDB 실패 시 임시 백업 확인
                    const tempBackup = sessionStorage.getItem('thehomein_temp_backup');
                    if (tempBackup) {
                        try {
                            const backupData = JSON.parse(tempBackup);
                            projects = backupData.projects;
                            currentProjectId = backupData.currentProjectId;
                            
                            console.log('📦 임시 백업에서 복구:', projects.length + '개');
                            showToast('📦 임시 백업에서 데이터를 복구했습니다', 'info');
                            
                            // 복구 후 다시 저장 시도
                            saveProjectsToLocalStorage();
                        } catch (backupError) {
                            console.error('임시 백업 복구 실패:', backupError);
                            // 새 프로젝트 생성
                            const newProject = createNewProject();
                            projects.push(newProject);
                            currentProjectId = newProject.id;
                        }
                    } else {
                        // 첫 실행 시 빈 프로젝트 생성
                        const newProject = createNewProject();
                        projects.push(newProject);
                        currentProjectId = newProject.id;
                        console.log('✅ 새 프로젝트 생성 완료');
                    }
                }
                
                renderProjectList();
            } catch (e) {
                console.error('프로젝트 목록 불러오기 실패:', e);
                
                // ✅ 로드 실패 시 사용자 알림
                showToast('⚠️ 데이터 로드 실패! 임시 백업을 확인합니다', 'warning');
                
                // 임시 백업 시도
                const tempBackup = sessionStorage.getItem('thehomein_temp_backup');
                if (tempBackup) {
                    try {
                        const backupData = JSON.parse(tempBackup);
                        projects = backupData.projects;
                        currentProjectId = backupData.currentProjectId;
                        showToast('✅ 임시 백업에서 복구 성공!', 'success');
                    } catch (backupError) {
                        // 실패 시 새 프로젝트 생성
                        const newProject = createNewProject();
                        projects.push(newProject);
                        currentProjectId = newProject.id;
                        showToast('📝 새 프로젝트로 시작합니다', 'info');
                    }
                } else {
                    // 실패 시 새 프로젝트 생성
                    const newProject = createNewProject();
                    projects.push(newProject);
                    currentProjectId = newProject.id;
                }
                renderProjectList();
            }
        }

        // ==================== 초기화 ====================
        // Google API 로드
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        }
        if (typeof google !== 'undefined') {
            gisLoaded();
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
        
        // IndexedDB 초기화
        try {
            await initDB();
            console.log('IndexedDB 초기화 완료');
        } catch (e) {
            console.error('IndexedDB 초기화 실패:', e);
        }
        
        
        // 자동 로그인 체크
        checkIfSignedIn();
        
        // 프로젝트 목록 불러오기 (UI 반영 포함)
        await loadProjectsFromLocalStorage();
        
        // 저장된 프로젝트 목록 렌더링
        await renderSavedList();
        
        // 진행률 업데이트
        updateProgress();
            
            // 점검일자 기본값 설정 (저장된 값이 없을 때만)
            if (!document.getElementById('inspectionDate').value) {
                document.getElementById('inspectionDate').valueAsDate = new Date();
            }
            
            console.log('✅ 앱 초기화 완료');
        });

        // 탭 전환
        window.switchTab = function(tabName, evt) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            // 하자점검 또는 장비점검 탭에서만 플로팅 버튼 표시
            const floatingBtn = document.getElementById('floatingAddBtn');
            if (tabName === 'defects' || tabName === 'equipment') {
                floatingBtn.style.display = 'flex';
            } else {
                floatingBtn.style.display = 'none';
            }
            
            updateProgress();
        }

        // 진행률 업데이트
        function updateProgress() {
            let progress = 0;
            const weights = {
                project: 20,
                floorplan: 15,
                defects: 25,
                equipment: 20,
                airquality: 20
            };

            if (projectData.apartmentName && projectData.dong && projectData.ho) {
                progress += weights.project;
            }

            if (projectData.floorplan) {
                progress += weights.floorplan;
            }

            if (projectData.defects.length > 0) {
                progress += weights.defects;
            }

            if (projectData.equipment && projectData.equipment.length > 0) {
                progress += weights.equipment;
            }

            if (projectData.airQuality.length > 0) {
                progress += weights.airquality;
            }

            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Toast 메시지
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // ==================== 프로젝트 정보 ====================
        window.saveProject = function() {
            const newApartmentName = document.getElementById('apartmentName').value;
            const newDong = document.getElementById('dong').value;
            const newHo = document.getElementById('ho').value;
            
            const isNewProject = (
                projectData.apartmentName !== newApartmentName ||
                projectData.dong !== newDong ||
                projectData.ho !== newHo
            ) && (projectData.apartmentName || projectData.dong || projectData.ho);

            if (isNewProject && (projectData.defects.length > 0 || projectData.floorplan || projectData.airQuality.some(r => r.radon || r.formaldehyde || r.vocs))) {
                if (confirm('새로운 프로젝트를 시작하시겠습니까?\n\n현재 하자 점검 및 공기질 데이터가 초기화됩니다.\n(이전 프로젝트는 "데이터" 탭에서 저장하세요)')) {
                    projectData.defects = [];
                    projectData.floorplan = null;
                    projectData.equipment = [];
                    projectData.airQuality = [
                        { id: 1, name: '거실', radon: '', formaldehyde: '', vocs: '' },
                        { id: 2, name: '침실1', radon: '', formaldehyde: '', vocs: '' },
                        { id: 3, name: '침실2', radon: '', formaldehyde: '', vocs: '' },
                        { id: 4, name: '침실3', radon: '', formaldehyde: '', vocs: '' },
                        { id: 5, name: '공용욕실', radon: '', formaldehyde: '', vocs: '' },
                        { id: 6, name: '부부욕실', radon: '', formaldehyde: '', vocs: '' }
                    ];
                    // 프로젝트별 카운터 초기화
                    const project = getCurrentProject();
                    project.lastAirQualityId = 6;
                    
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    displayFloorplan();
                    showToast('새 프로젝트를 시작합니다');
                } else {
                    return;
                }
            }

            projectData.apartmentName = newApartmentName;
            projectData.dong = newDong;
            projectData.ho = newHo;
            projectData.inspectionDate = document.getElementById('inspectionDate').value;
            projectData.customerName = document.getElementById('customerName').value;
            projectData.customerPhone = document.getElementById('customerPhone').value;

            saveProjectsToLocalStorage();
            updateProgress();
            showToast('프로젝트 정보가 저장되었습니다');
        }

        // ==================== 평면도 관리 ====================
        window.openFloorplanCamera = function() {
            currentPhotoTarget = 'floorplan';
            openCamera();
        }

        window.openFloorplanGallery = async function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const project = getCurrentProject(); // ✅ 현재 프로젝트 가져오기
                    
                    console.log('🔵 평면도 저장 전:', {
                        projectId: project.id,
                        projectName: `${project.apartmentName} ${project.dong} ${project.ho}`,
                        currentProjectId: currentProjectId,
                        hasFloorplan: !!project.floorplan
                    });
                    
                    project.floorplan = compressed; // ✅ 현재 프로젝트에 저장
                    
                    console.log('🟢 평면도 저장 후:', {
                        projectId: project.id,
                        hasFloorplan: !!project.floorplan,
                        totalProjects: projects.length
                    });
                    
                    displayFloorplan();
                    saveProjectsToLocalStorage(); // ✅ 프로젝트 배열 저장
                    updateProgress();
                    showToast('평면도가 추가되었습니다');
                }
            };
            input.click();
        }

        function displayFloorplan() {
            const preview = document.getElementById('floorplanPreview');
            const placeholder = document.getElementById('floorplanPlaceholder');
            const project = getCurrentProject(); // ✅ 현재 프로젝트 가져오기
            
            console.log('🖼️ displayFloorplan 호출:', {
                projectId: project.id,
                hasFloorplan: !!project.floorplan,
                floorplanLength: project.floorplan ? project.floorplan.length : 0
            });
            
            if (project.floorplan) {
                preview.src = project.floorplan;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.src = '';
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        window.deleteFloorplan = function() {
            if (confirm('평면도를 삭제하시겠습니까?')) {
                const project = getCurrentProject(); // ✅ 현재 프로젝트 가져오기
                project.floorplan = null; // ✅ 현재 프로젝트에서 삭제
                displayFloorplan();
                saveProjectsToLocalStorage(); // ✅ 프로젝트 배열 저장
                updateProgress();
                showToast('평면도가 삭제되었습니다');
            }
        }

        // ==================== 하자 점검 ====================
        window.handleFloatingBtnClick = function() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection.id === 'defects') {
                addDefect();
            } else if (activeSection.id === 'equipment') {
                addEquipment();
            }
        }

        function addDefect() {
            // ✅ 기존 하자 중 사진이 2장 미만인 것이 있는지 확인
            if (projectData.defects.length > 0) {
                const lastDefect = projectData.defects[projectData.defects.length - 1];
                
                // 사진 검증 (필수 2장)
                if (!lastDefect.photos || lastDefect.photos.length < 2) {
                    alert('⚠️ 바로 이전 하자의 사진을 2장 모두 촬영해주세요!\n\n📷 필수: 원경(멀리서) + 근접(가까이서) 사진');
                    // 해당 하자로 스크롤
                    setTimeout(() => {
                        const defectsList = document.getElementById('defectsList');
                        if (defectsList.lastElementChild) {
                            defectsList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                    return;
                }
            }
            
            // ✅ 프로젝트별 ID 카운터 사용
            const project = getCurrentProject();
            
            // 기존 최대 ID 확인 (호환성 보장)
            const maxExistingId = project.defects.length > 0 
                ? Math.max(...project.defects.map(d => d.id))
                : 0;
            
            // 프로젝트별 카운터 업데이트
            project.lastDefectId = Math.max(
                project.lastDefectId || 0,
                maxExistingId
            ) + 1;
            
            // ✅ 모든 검증 통과 → 새 하자 추가
            const newDefect = {
                id: project.lastDefectId,
                spaces: [],      // 배열로 변경
                locations: [],   // 배열로 변경
                types: [],       // 배열로 변경
                detailLocation: '',
                description: '',
                photos: [],
                status: 'pending'
            };
            projectData.defects.push(newDefect);
            renderDefects();
            saveImmediately(); // ✅ 중요: 즉시 저장
            updateProgress();
            showToast('✅ 새 하자가 추가되었습니다');
            
            // 새로 추가된 하자로 스크롤
            setTimeout(() => {
                const defectsList = document.getElementById('defectsList');
                if (defectsList.lastElementChild) {
                    defectsList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function renderDefects() {
            const container = document.getElementById('defectsList');
            
            if (projectData.defects.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">등록된 하자가 없습니다</div>';
                return;
            }

            container.innerHTML = projectData.defects.map((defect, index) => {
                // 배열이 없으면 초기화
                if (!defect.spaces) defect.spaces = [];
                if (!defect.locations) defect.locations = [];
                if (!defect.types) defect.types = [];
                
                return `
                <div class="defect-card">
                    <div class="defect-header">
                        <span class="defect-number">하자 ${index + 1}</span>
                        <select class="defect-status ${defect.status === 'completed' ? 'status-completed' : 'status-pending'}" 
                                onchange="updateDefectStatus(${defect.id}, this.value)">
                            <option value="pending" ${defect.status === 'pending' ? 'selected' : ''}>미완료</option>
                            <option value="completed" ${defect.status === 'completed' ? 'selected' : ''}>완료</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">📷 사진 촬영/첨부 (필수 2장: 멀리서 → 가까이서)</label>
                        
                        ${defect.photos.length === 0 ? `
                            <div style="text-align: center; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 2px dashed var(--primary); border-radius: 12px;">
                                <div style="font-size: 30px; margin-bottom: 6px;">📷</div>
                                <div style="font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px;">
                                    1단계: 멀리서 촬영/첨부
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button class="btn btn-primary" onclick="startDefectPhotoSequence(${defect.id})" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        📷 촬영
                                    </button>
                                    <button class="btn btn-primary" onclick="uploadDefectPhotoFromGallery(${defect.id}, 'far')" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        🖼️ 갤러리
                                    </button>
                                </div>
                            </div>
                        ` : defect.photos.length === 1 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="position: relative; width: 100%;">
                                    <img src="${defect.photos[0]}" alt="멀리서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(16, 185, 129, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 멀리서
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(251, 191, 36, 0.1); border: 2px dashed var(--secondary); border-radius: 12px;">
                                <div style="font-size: 30px; margin-bottom: 6px;">📷</div>
                                <div style="font-size: 14px; font-weight: bold; color: var(--secondary); margin-bottom: 8px;">
                                    2단계: 가까이서 촬영/첨부
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button class="btn btn-secondary" onclick="continueDefectPhotoSequence(${defect.id})" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        📷 촬영
                                    </button>
                                    <button class="btn btn-secondary" onclick="uploadDefectPhotoFromGallery(${defect.id}, 'close')" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        🖼️ 갤러리
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div style="position: relative;">
                                    <img src="${defect.photos[0]}" alt="멀리서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(16, 185, 129, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 멀리서
                                    </div>
                                </div>
                                <div style="position: relative;">
                                    <img src="${defect.photos[1]}" alt="가까이서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--secondary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(251, 191, 36, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 가까이서
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="retakeDefectPhotos(${defect.id})" style="padding: 8px; font-size: 13px;">
                                🔄 다시 촬영
                            </button>
                        `}
                    </div>

                    <div class="form-field">
                        <label class="form-label">공간 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.spaces.length}/4 선택됨</div>
                        <div class="touch-button-grid">
                            ${['현관','안방','침실1','침실2','침실3','침실4','복도','거실','주방','팬트리','외부','알파룸','발코니','대피공간','실외기실','파우더룸','드레스룸','공용욕실','부부욕실'].map(space => `
                                <button type="button" class="touch-btn ${defect.spaces.includes(space) ? 'selected' : ''}" 
                                        ${defect.spaces.length >= 4 && !defect.spaces.includes(space) ? 'disabled' : ''}
                                        onclick="toggleDefectSelection(${defect.id}, 'spaces', '${space}')">
                                    ${space}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">위치 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.locations.length}/4 선택됨</div>
                        <div class="touch-button-grid">
                            ${['벽','바닥','천장','도배','가구','창','문','짝','틀','마감판','수전','타일','도장','줄눈','코킹'].map(location => `
                                <button type="button" class="touch-btn ${defect.locations.includes(location) ? 'selected' : ''}" 
                                        ${defect.locations.length >= 4 && !defect.locations.includes(location) ? 'disabled' : ''}
                                        onclick="toggleDefectSelection(${defect.id}, 'locations', '${location}')">
                                    ${location}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">📝 상세위치 (선택사항)</label>
                        <input type="text" class="form-input" value="${defect.detailLocation || ''}" 
                               onchange="updateDefect(${defect.id}, 'detailLocation', this.value)" 
                               placeholder="예: 거실 창문 우측 하단, 주방 싱크대 좌측 벽 등">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            💡 위치를 더 구체적으로 설명하고 싶을 때 입력하세요
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">하자내용 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.types.length}/4 선택됨</div>
                        
                        <!-- 상단 그룹: 하자 유형 -->
                        <div style="margin-bottom: 8px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">
                                하자 유형
                            </div>
                            <div class="touch-button-grid">
                                ${['유격','틈새','단차','파손','긁힘','찍힘','들뜸','오염','마감','고정','수평/수직'].map(type => `
                                    <button type="button" class="touch-btn ${defect.types.includes(type) ? 'selected' : ''}" 
                                            ${defect.types.length >= 4 && !defect.types.includes(type) ? 'disabled' : ''}
                                            onclick="toggleDefectSelection(${defect.id}, 'types', '${type}')">
                                        ${type}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- 구분선 -->
                        <div style="border-top: 1px solid var(--border); margin: 12px 0;"></div>
                        
                        <!-- 하단 그룹: 상태/정도 -->
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">
                                상태 / 정도
                            </div>
                            <div class="touch-button-grid">
                                ${['전체','다수','작동','불량','미시공','오시공'].map(type => `
                                    <button type="button" class="touch-btn ${defect.types.includes(type) ? 'selected' : ''}" 
                                            ${defect.types.length >= 4 && !defect.types.includes(type) ? 'disabled' : ''}
                                            onclick="toggleDefectSelection(${defect.id}, 'types', '${type}')">
                                        ${type}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">상세설명 (자동 생성)</label>
                        <textarea class="form-input" rows="3" 
                                  readonly
                                  style="background: rgba(16, 185, 129, 0.05); cursor: default;"
                                  placeholder="공간, 위치, 하자내용을 선택하면 자동으로 생성됩니다">${defect.description || ''}</textarea>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                            💡 공간, 위치, 하자내용, 상세위치를 선택하면 자동으로 생성됩니다
                        </div>
                    </div>

                    <button class="btn btn-danger" onclick="deleteDefect(${defect.id})">
                        🗑️ 하자 삭제
                    </button>
                </div>
            `;
            }).join('');
        }

        window.startDefectPhotoSequence = function(defectId) {
            currentPhotoTarget = { defectId: defectId, step: 'far' };
            openCamera();
        }

        window.continueDefectPhotoSequence = function(defectId) {
            currentPhotoTarget = { defectId: defectId, step: 'close' };
            openCamera();
        }

        window.retakeDefectPhotos = function(defectId) {
            if (confirm('사진을 다시 촬영하시겠습니까?\n(기존 사진 2장이 삭제됩니다)')) {
                const defect = projectData.defects.find(d => d.id === defectId);
                if (defect) {
                    defect.photos = [];
                    renderDefects();
                    saveProjectsToLocalStorage();
                    showToast('사진이 초기화되었습니다. 다시 촬영해주세요.');
                }
            }
        }

        window.uploadDefectPhotoFromGallery = async function(defectId, step) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const defect = projectData.defects.find(d => d.id === defectId);
                    if (defect) {
                        defect.photos.push(compressed);
                        
                        if (step === 'far') {
                            showToast('✓ 멀리서 사진 추가 완료! 이제 가까이서 촬영/첨부해주세요.');
                        } else if (step === 'close') {
                            showToast('✓ 가까이서 사진 추가 완료! 하자 사진이 모두 등록되었습니다.');
                        }
                        
                        renderDefects();
                        saveProjectsToLocalStorage();
                        updateProgress();
                    }
                }
            };
            input.click();
        }

        // ==================== 장비점검 ====================
        function addEquipment() {
            // ✅ 프로젝트별 ID 카운터 사용
            const project = getCurrentProject();
            
            // 기존 최대 ID 확인 (호환성 보장)
            const maxExistingId = project.equipment && project.equipment.length > 0 
                ? Math.max(...project.equipment.map(e => e.id))
                : 0;
            
            // 프로젝트별 카운터 업데이트
            project.lastEquipmentId = Math.max(
                project.lastEquipmentId || 0,
                maxExistingId
            ) + 1;
            
            const newEquipment = {
                id: project.lastEquipmentId,
                space: '',       // 단일 공간
                inspection: '',  // 빈 값으로 시작
                photos: {        // 위치별 사진 객체
                    '좌측': null,
                    '우측': null,
                    '바닥': null
                }
            };
            projectData.equipment.push(newEquipment);
            renderEquipment();
            saveProjectsToLocalStorage();
            updateProgress();
            showToast('새 장비점검이 추가되었습니다');
            
            setTimeout(() => {
                const equipmentList = document.getElementById('equipmentList');
                if (equipmentList.lastElementChild) {
                    equipmentList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function renderEquipment() {
            const container = document.getElementById('equipmentList');
            
            // equipment 배열이 없으면 초기화
            if (!projectData.equipment) {
                projectData.equipment = [];
            }
            
            if (projectData.equipment.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">등록된 장비점검이 없습니다</div>';
                return;
            }

            container.innerHTML = projectData.equipment.map((item, index) => {
                // 하위 호환성: 기존 4개 구조를 3개로 변환
                if (!item.photos || item.photos['좌측상단']) {
                    item.photos = {
                        '좌측': item.photos?.['좌측상단'] || item.photos?.['좌측하단'] || null,
                        '우측': item.photos?.['우측상단'] || item.photos?.['우측하단'] || null,
                        '바닥': null
                    };
                }
                
                const locations = ['좌측', '우측', '바닥'];
                const locationColors = {
                    '좌측': '#3498db',
                    '우측': '#e74c3c',
                    '바닥': '#f39c12'
                };
                const locationIcons = {
                    '좌측': '⬅️',
                    '우측': '➡️',
                    '바닥': '⬇️'
                };
                
                return `
                <div class="defect-card">
                    <div class="defect-header">
                        <span class="defect-number">NO ${index + 1}</span>
                        <button class="btn btn-danger" onclick="deleteEquipment(${item.id})" style="width: auto; padding: 8px 16px; font-size: 12px;">
                            🗑️ 삭제
                        </button>
                    </div>

                    <div class="form-field">
                        <label class="form-label">공간 선택</label>
                        <div class="touch-button-grid">
                            ${['현관','안방','침실1','침실2','침실3','침실4','복도','거실','주방','팬트리','외부','알파룸','발코니','대피공간','실외기실','파우더룸','드레스룸','공용욕실','부부욕실'].map(space => `
                                <button type="button" class="touch-btn ${item.space === space ? 'selected' : ''}" 
                                        onclick="updateEquipmentSpace(${item.id}, '${space}')">
                                    ${space}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">점검결과</label>
                        <div class="touch-button-grid" style="margin-bottom: 10px;">
                            ${['벽체 수직도 및 바닥 평활도 양호','배수경사(구배)상태 양호','벽체수직 및 바닥수평 / 단열시공 양호','바닥 난방 열화상 결과 온도 분포 양호'].map(result => {
                                const escaped = result.replace(/'/g, '&apos;');
                                return `
                                <button type="button" class="touch-btn ${item.inspection === result ? 'selected' : ''}" 
                                        onclick="updateEquipmentInspection(${item.id}, '${escaped}')">
                                    ${result}
                                </button>
                            `}).join('')}
                        </div>
                        <input type="text" class="form-input" value="${item.inspection || ''}" 
                               onchange="updateEquipmentInspection(${item.id}, this.value)" 
                               placeholder="또는 직접 입력">
                    </div>

                    <div class="form-field">
                        <label class="form-label">📷 위치별 사진 촬영/첨부 (${Object.values(item.photos).filter(p => p).length}/3)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            ${locations.slice(0, 2).map(location => `
                                <div style="border: 2px solid ${locationColors[location]}; border-radius: 8px; overflow: hidden;">
                                    <div style="background: ${locationColors[location]}; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 15px;">
                                        ${locationIcons[location]} ${location}
                                    </div>
                                    ${item.photos[location] ? `
                                        <img src="${item.photos[location]}" style="width: 100%; height: 220px; object-fit: cover;">
                                        <div style="display: flex; border-top: 1px solid #ddd;">
                                            <button class="btn btn-secondary" onclick="openEquipmentLocationCamera(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; padding: 12px; font-size: 13px;">
                                                🔄
                                            </button>
                                            <button class="btn btn-secondary" onclick="openEquipmentLocationGallery(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 12px; font-size: 13px;">
                                                🖼️
                                            </button>
                                            <button class="btn btn-danger" onclick="deleteEquipmentLocationPhoto(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 12px; font-size: 13px;">
                                                🗑️
                                            </button>
                                        </div>
                                    ` : `
                                        <div style="height: 220px; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                                            <div style="font-size: 36px; opacity: 0.3;">📷</div>
                                            <div style="display: flex; gap: 10px; width: 100%; padding: 0 12px;">
                                                <button class="btn btn-primary" onclick="openEquipmentLocationCamera(${item.id}, '${location}')" style="flex: 1; padding: 14px 10px; font-size: 14px; font-weight: bold;">
                                                    📸 촬영
                                                </button>
                                                <button class="btn btn-primary" onclick="openEquipmentLocationGallery(${item.id}, '${location}')" style="flex: 1; padding: 14px 10px; font-size: 14px; font-weight: bold;">
                                                    🖼️ 첨부
                                                </button>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        <!-- 바닥 사진 (전체 너비) -->
                        <div style="border: 2px solid ${locationColors['바닥']}; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${locationColors['바닥']}; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 13px;">
                                ${locationIcons['바닥']} 바닥
                            </div>
                            ${item.photos['바닥'] ? `
                                <img src="${item.photos['바닥']}" style="width: 100%; height: 200px; object-fit: cover;">
                                <div style="display: flex; border-top: 1px solid #ddd;">
                                    <button class="btn btn-secondary" onclick="openEquipmentLocationCamera(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; padding: 10px; font-size: 12px;">
                                        🔄 재촬영
                                    </button>
                                    <button class="btn btn-secondary" onclick="openEquipmentLocationGallery(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 10px; font-size: 12px;">
                                        🖼️ 재첨부
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteEquipmentLocationPhoto(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 10px; font-size: 12px;">
                                        🗑️ 삭제
                                    </button>
                                </div>
                            ` : `
                                <div style="height: 200px; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                                    <div style="font-size: 32px; opacity: 0.3;">📷</div>
                                    <div style="display: flex; gap: 10px; width: 100%; padding: 0 20px;">
                                        <button class="btn btn-primary" onclick="openEquipmentLocationCamera(${item.id}, '바닥')" style="flex: 1; padding: 10px; font-size: 12px;">
                                            📸 촬영
                                        </button>
                                        <button class="btn btn-primary" onclick="openEquipmentLocationGallery(${item.id}, '바닥')" style="flex: 1; padding: 10px; font-size: 12px;">
                                            🖼️ 첨부
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateEquipment(id, field, value) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item[field] = value;
                saveWithDebounce(); // ✅ 텍스트: 지연 저장
            }
        }

        window.updateEquipmentInspection = function(id, value) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item.inspection = value;
                renderEquipment();
                saveWithDebounce(); // ✅ 텍스트: 지연 저장
            }
        }

        window.updateEquipmentSpace = function(id, space) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item.space = space;
                renderEquipment();
                saveWithDebounce(); // ✅ 선택: 지연 저장
            }
        }

        window.openEquipmentLocationCamera = function(id, location) {
            currentPhotoTarget = { equipmentId: id, location: location };
            openCamera();
        }

        window.openEquipmentLocationGallery = async function(id, location) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const item = projectData.equipment.find(e => e.id === id);
                    if (item) {
                        if (!item.photos) {
                            item.photos = {
                                '좌측상단': null,
                                '좌측하단': null,
                                '우측상단': null,
                                '우측하단': null
                            };
                        }
                        item.photos[location] = compressed;
                        renderEquipment();
                        saveProjectsToLocalStorage();
                        updateProgress();
                        showToast(`${location} 사진이 추가되었습니다`);
                    }
                }
            };
            input.click();
        }

        window.deleteEquipmentLocationPhoto = function(id, location) {
            if (confirm(`${location} 사진을 삭제하시겠습니까?`)) {
                const item = projectData.equipment.find(e => e.id === id);
                if (item && item.photos) {
                    item.photos[location] = null;
                    renderEquipment();
                    saveProjectsToLocalStorage();
                    updateProgress();
                    showToast(`${location} 사진이 삭제되었습니다`);
                }
            }
        }

        window.deleteEquipment = function(id) {
            if (confirm('이 장비점검을 삭제하시겠습니까?')) {
                projectData.equipment = projectData.equipment.filter(e => e.id !== id);
                renderEquipment();
                saveProjectsToLocalStorage();
                updateProgress();
                showToast('장비점검이 삭제되었습니다');
            }
        }

        function openEquipmentCamera(id) {
            currentPhotoTarget = { equipmentId: id };
            openCamera();
        }

        async function openEquipmentGallery(id) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const item = projectData.equipment.find(e => e.id === id);
                    if (item) {
                        item.photo = compressed;
                        renderEquipment();
                        saveProjectsToLocalStorage();
                        showToast('사진이 추가되었습니다');
                    }
                }
            };
            input.click();
        }

        function deleteEquipmentPhoto(id) {
            if (confirm('사진을 삭제하시겠습니까?')) {
                const item = projectData.equipment.find(e => e.id === id);
                if (item) {
                    item.photo = null;
                    renderEquipment();
                    saveProjectsToLocalStorage();
                    showToast('사진이 삭제되었습니다');
                }
            }
        }

        // ==================== 공기질 측정 ====================
        function renderAirQuality() {
            const container = document.getElementById('airQualityList');
            
            if (projectData.airQuality.length === 0) {
                projectData.airQuality = [
                    { id: 1, name: '거실', radon: '', formaldehyde: '', vocs: '' },
                    { id: 2, name: '침실1', radon: '', formaldehyde: '', vocs: '' },
                    { id: 3, name: '침실2', radon: '', formaldehyde: '', vocs: '' },
                    { id: 4, name: '침실3', radon: '', formaldehyde: '', vocs: '' },
                    { id: 5, name: '공용욕실', radon: '', formaldehyde: '', vocs: '' },
                    { id: 6, name: '부부욕실', radon: '', formaldehyde: '', vocs: '' }
                ];
                // 프로젝트별 카운터 설정
                const project = getCurrentProject();
                project.lastAirQualityId = 6;
            }

            container.innerHTML = projectData.airQuality.map((room) => `
                <div class="air-quality-card">
                    <div class="air-room-header">
                        <input type="text" 
                               class="air-room-name-input" 
                               value="${room.name}" 
                               onchange="updateAirRoomName(${room.id}, this.value)"
                               placeholder="방 이름">
                        <button class="air-room-delete" onclick="deleteAirRoom(${room.id})">×</button>
                    </div>
                    <div class="air-inputs">
                        <div class="air-input-group">
                            <label>라돈</label>
                            <input type="number" 
                                   value="${room.radon}" 
                                   onchange="updateAirQualityValue(${room.id}, 'radon', this.value)"
                                   placeholder="0">
                            <span>Bq/m³</span>
                        </div>
                        <div class="air-input-group">
                            <label>포름알데히드</label>
                            <input type="number" 
                                   step="0.001"
                                   value="${room.formaldehyde}" 
                                   onchange="updateAirQualityValue(${room.id}, 'formaldehyde', this.value)"
                                   placeholder="0.000">
                            <span>mg/m³</span>
                        </div>
                        <div class="air-input-group">
                            <label>총VOCs</label>
                            <input type="number" 
                                   step="0.001"
                                   value="${room.vocs}" 
                                   onchange="updateAirQualityValue(${room.id}, 'vocs', this.value)"
                                   placeholder="0.000">
                            <span>mg/m³</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.addAirQualityRoom = function() {
            // ✅ 프로젝트별 ID 카운터 사용
            const project = getCurrentProject();
            
            // 기존 최대 ID 확인 (호환성 보장)
            const maxExistingId = project.airQuality && project.airQuality.length > 0 
                ? Math.max(...project.airQuality.map(a => a.id))
                : 0;
            
            // 프로젝트별 카운터 업데이트
            project.lastAirQualityId = Math.max(
                project.lastAirQualityId || 0,
                maxExistingId
            ) + 1;
            
            const newRoom = {
                id: project.lastAirQualityId,
                name: `방${projectData.airQuality.length + 1}`,
                radon: '',
                formaldehyde: '',
                vocs: ''
            };
            projectData.airQuality.push(newRoom);
            renderAirQuality();
            saveProjectsToLocalStorage();
            updateProgress();
            showToast('방이 추가되었습니다');
        }

        window.deleteAirRoom = function(id) {
            if (projectData.airQuality.length <= 1) {
                alert('최소 1개의 방은 있어야 합니다');
                return;
            }
            if (confirm('이 방을 삭제하시겠습니까?')) {
                projectData.airQuality = projectData.airQuality.filter(r => r.id !== id);
                renderAirQuality();
                saveProjectsToLocalStorage();
                updateProgress();
                showToast('방이 삭제되었습니다');
            }
        }

        function updateAirRoomName(id, name) {
            const room = projectData.airQuality.find(r => r.id === id);
            if (room) {
                room.name = name;
                saveWithDebounce(); // ✅ 텍스트: 지연 저장
            }
        }

        function updateAirQualityValue(id, field, value) {
            const room = projectData.airQuality.find(r => r.id === id);
            if (room) {
                // ✅ 입력값 검증
                const numValue = parseFloat(value);
                
                // 빈값은 허용
                if (value === '' || value === null) {
                    room[field] = value;
                    saveWithDebounce(); // ✅ 숫자 입력: 지연 저장
                    updateProgress();
                    return;
                }
                
                // 음수 체크
                if (numValue < 0) {
                    alert('⚠️ 음수는 입력할 수 없습니다');
                    renderAirQuality(); // 원래 값으로 복원
                    return;
                }
                
                // 비현실적 값 체크
                let maxValue = 1000;
                let fieldName = '';
                
                if (field === 'radon') {
                    maxValue = 500; // 라돈 권고기준의 약 3배
                    fieldName = '라돈';
                } else if (field === 'formaldehyde') {
                    maxValue = 2; // 포름알데히드 권고기준의 약 10배
                    fieldName = '포름알데히드';
                } else if (field === 'vocs') {
                    maxValue = 5; // VOCs 권고기준의 약 10배
                    fieldName = '총휘발성유기화합물';
                }
                
                if (numValue > maxValue) {
                    if (!confirm(`⚠️ ${fieldName} 측정값이 매우 높습니다 (${numValue}).\n\n정확히 입력하셨나요?\n\n계속하려면 "확인"을 누르세요.`)) {
                        renderAirQuality(); // 원래 값으로 복원
                        return;
                    }
                }
                
                room[field] = value;
                saveWithDebounce(); // ✅ 숫자 입력: 지연 저장
                updateProgress();
            }
        }

        // ==================== 카메라 기능 ====================
        async function openCamera() {
            try {
                // 카메라 API 지원 확인
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('이 브라우저는 카메라를 지원하지 않습니다. Chrome이나 Safari를 사용해주세요.');
                }
                
                // 디바이스별 최적 카메라 설정
                let constraints = {
                    video: {
                        facingMode: 'environment'
                    },
                    audio: false
                };
                
                // 안드로이드: 고해상도
                if (deviceInfo.isAndroid) {
                    constraints.video.width = { ideal: 1920 };
                    constraints.video.height = { ideal: 1080 };
                }
                // iOS: 중간 해상도 (배터리/성능 최적화)
                else if (deviceInfo.isIOS) {
                    constraints.video.width = { ideal: 1280 };
                    constraints.video.height = { ideal: 720 };
                }
                // 기타 데스크톱
                else {
                    constraints.video.width = { ideal: 1920 };
                    constraints.video.height = { ideal: 1080 };
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                
                // iOS Safari 필수 속성
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.muted = true;
                
                // 비디오 로드 및 재생 대기 (iOS 필수)
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(() => {
                                console.log('카메라 스트림 재생 성공');
                                resolve();
                            })
                            .catch(err => {
                                console.warn('비디오 자동 재생 실패:', err);
                                resolve(); // 실패해도 계속 진행
                            });
                    };
                    
                    // 타임아웃 (3초)
                    setTimeout(resolve, 3000);
                });
                
                // === 모든 플랫폼 공통: 컨텍스트 메뉴 차단 ===
                video.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, { passive: false });
                
                // === 터치 이벤트 최적화 (Android/iOS 모두) ===
                let touchStartTime = 0;
                let touchStartX = 0;
                let touchStartY = 0;
                
                video.addEventListener('touchstart', (e) => {
                    touchStartTime = Date.now();
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    
                    // 멀티 터치 차단 (줌 방지)
                    if (e.touches.length > 1) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }, { passive: false });
                
                video.addEventListener('touchmove', (e) => {
                    // 드래그/스크롤 차단
                    const moveX = Math.abs(e.touches[0].clientX - touchStartX);
                    const moveY = Math.abs(e.touches[0].clientY - touchStartY);
                    
                    if (moveX > 10 || moveY > 10) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }, { passive: false });
                
                video.addEventListener('touchend', (e) => {
                    const touchDuration = Date.now() - touchStartTime;
                    
                    // 길게 누르기 차단 (Google Lens 실행 방지)
                    if (touchDuration > 500) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }, { passive: false });
                
                // 더블 탭 줌 방지
                let lastTap = 0;
                video.addEventListener('touchend', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    
                    if (tapLength < 500 && tapLength > 0) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    lastTap = currentTime;
                }, { passive: false });
                
                // 드래그 방지
                video.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    return false;
                });
                
                // iOS 특별 처리
                if (deviceInfo.isIOS) {
                    video.style.webkitUserSelect = 'none';
                    video.style.webkitTouchCallout = 'none';
                }
                
                // 모달 표시
                document.getElementById('cameraModal').classList.add('active');
                
                // 성공 메시지
                showToast('📸 카메라 준비 완료!');
                
            } catch (error) {
                console.error('카메라 오류:', error);
                
                // 디바이스별 상세 에러 메시지
                let errorMessage = '카메라를 사용할 수 없습니다.\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '📱 카메라 권한이 필요합니다.\n\n';
                    
                    if (deviceInfo.isIOS) {
                        errorMessage += '[iOS 설정 방법]\n';
                        errorMessage += '1. 설정 > Safari > 카메라\n';
                        errorMessage += '2. "허용" 선택\n';
                        errorMessage += '3. Safari 재시작\n\n';
                        errorMessage += '또는 "📎 갤러리"로 사진 업로드';
                    } else if (deviceInfo.isAndroid) {
                        errorMessage += '[Android 설정 방법]\n';
                        errorMessage += '1. 브라우저 주소창 왼쪽 🔒 클릭\n';
                        errorMessage += '2. "카메라" 권한 허용\n';
                        errorMessage += '3. 페이지 새로고침\n\n';
                        errorMessage += '또는 "📎 갤러리"로 사진 업로드';
                    } else {
                        errorMessage += '브라우저 주소창의 🔒를 클릭하여\n';
                        errorMessage += '카메라 권한을 허용해주세요.';
                    }
                    
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '카메라를 찾을 수 없습니다.\n\n';
                    errorMessage += '"📎 갤러리" 버튼으로\n';
                    errorMessage += '사진을 업로드해주세요.';
                    
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '카메라가 다른 앱에서 사용 중입니다.\n\n';
                    errorMessage += '[해결 방법]\n';
                    errorMessage += '1. 다른 카메라 앱 종료\n';
                    errorMessage += '2. 페이지 새로고침 (당겨서 새로고침)\n';
                    errorMessage += '3. "📎 갤러리" 버튼 사용';
                    
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += '이 기기는 요청한 카메라 설정을\n';
                    errorMessage += '지원하지 않습니다.\n\n';
                    errorMessage += '"📎 갤러리"를 사용해주세요.';
                    
                } else {
                    errorMessage += '오류: ' + error.message + '\n\n';
                    errorMessage += '"📎 갤러리" 버튼으로\n';
                    errorMessage += '사진을 업로드해주세요.';
                }
                
                alert(errorMessage);
            }
        }

        window.closeCameraModal = function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
            currentPhotoTarget = null;
        }

        // ==================== 이미지 압축 함수 (통합) ====================
        // ==================== 이미지 압축 (크로스 플랫폼 최적화) ====================
        async function compressImage(input, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                try {
                    // 디바이스별 최적 설정
                    if (deviceInfo.isIOS) {
                        maxWidth = Math.min(maxWidth, 1280); // iOS 메모리 최적화
                        quality = Math.min(quality, 0.8); // 용량 절약
                    }
                    
                    // File 객체 처리
                    if (input instanceof File) {
                        // iOS HEIC 이미지 처리
                        if (input.type === 'image/heic' || input.type === 'image/heif') {
                            console.warn('HEIC 형식 감지 - JPEG로 변환 시도');
                        }
                        
                        const reader = new FileReader();
                        
                        reader.onerror = () => {
                            console.error('파일 읽기 실패');
                            reject(new Error('이미지 파일을 읽을 수 없습니다.'));
                        };
                        
                        reader.onload = (e) => {
                            const img = new Image();
                            
                            img.onerror = () => {
                                console.error('이미지 로드 실패');
                                reject(new Error('이미지를 로드할 수 없습니다.'));
                            };
                            
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    
                                    // 최대 너비 제한
                                    if (width > maxWidth) {
                                        height = (height * maxWidth) / width;
                                        width = maxWidth;
                                    }
                                    
                                    // iOS: 최대 픽셀 제한 (메모리 오버플로우 방지)
                                    const maxPixels = deviceInfo.isIOS ? 4096 * 4096 : 8192 * 8192;
                                    if (width * height > maxPixels) {
                                        const scale = Math.sqrt(maxPixels / (width * height));
                                        width = Math.floor(width * scale);
                                        height = Math.floor(height * scale);
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    
                                    const ctx = canvas.getContext('2d', {
                                        alpha: false,
                                        willReadFrequently: false
                                    });
                                    
                                    // 배경을 흰색으로 (투명 PNG 처리)
                                    ctx.fillStyle = '#FFFFFF';
                                    ctx.fillRect(0, 0, width, height);
                                    
                                    // 이미지 그리기 (안티앨리어싱 최적화)
                                    ctx.imageSmoothingEnabled = true;
                                    ctx.imageSmoothingQuality = 'high';
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    // JPEG 변환
                                    const result = canvas.toDataURL('image/jpeg', quality);
                                    
                                    // 메모리 정리
                                    canvas.width = 0;
                                    canvas.height = 0;
                                    
                                    resolve(result);
                                } catch (err) {
                                    console.error('Canvas 처리 실패:', err);
                                    reject(new Error('이미지 처리 중 오류가 발생했습니다.'));
                                }
                            };
                            
                            img.src = e.target.result;
                        };
                        
                        reader.readAsDataURL(input);
                    }
                    // DataURL 문자열 처리
                    else if (typeof input === 'string') {
                        const img = new Image();
                        
                        img.onerror = () => {
                            console.error('이미지 로드 실패');
                            reject(new Error('이미지를 로드할 수 없습니다.'));
                        };
                        
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                // 최대 너비 제한
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                                
                                // iOS 메모리 제한
                                const maxPixels = deviceInfo.isIOS ? 4096 * 4096 : 8192 * 8192;
                                if (width * height > maxPixels) {
                                    const scale = Math.sqrt(maxPixels / (width * height));
                                    width = Math.floor(width * scale);
                                    height = Math.floor(height * scale);
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                const ctx = canvas.getContext('2d', {
                                    alpha: false,
                                    willReadFrequently: false
                                });
                                
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, width, height);
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                const result = canvas.toDataURL('image/jpeg', quality);
                                
                                // 메모리 정리
                                canvas.width = 0;
                                canvas.height = 0;
                                
                                resolve(result);
                            } catch (err) {
                                console.error('Canvas 처리 실패:', err);
                                reject(new Error('이미지 처리 중 오류가 발생했습니다.'));
                            }
                        };
                        
                        // CORS 이슈 방지
                        img.crossOrigin = 'anonymous';
                        img.src = input;
                    } else {
                        reject(new Error('지원하지 않는 이미지 형식입니다.'));
                    }
                } catch (err) {
                    console.error('이미지 압축 오류:', err);
                    reject(err);
                }
            });
        }

        window.capturePhoto = async function() {
            // 이벤트 전파 방지
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // 원본 이미지
            const originalImage = canvas.toDataURL('image/jpeg', 0.95);
            
            // 이미지 압축 (1920px, 품질 85%)
            const imageData = await compressImage(originalImage, 1920, 0.85);
            
            if (currentPhotoTarget === 'floorplan') {
                const project = getCurrentProject(); // ✅ 현재 프로젝트 가져오기
                project.floorplan = imageData; // ✅ 현재 프로젝트에 저장
                displayFloorplan();
                showToast('평면도가 추가되었습니다');
            } else if (currentPhotoTarget && typeof currentPhotoTarget === 'object') {
                if (currentPhotoTarget.defectId) {
                    // 하자점검 사진
                    const defect = projectData.defects.find(d => d.id === currentPhotoTarget.defectId);
                    if (defect) {
                        defect.photos.push(imageData);
                        
                        if (currentPhotoTarget.step === 'far') {
                            showToast('✓ 멀리서 촬영 완료! 이제 가까이서 촬영해주세요.');
                        } else if (currentPhotoTarget.step === 'close') {
                            showToast('✓ 가까이서 촬영 완료! 하자 사진이 모두 등록되었습니다.');
                        }
                        
                        renderDefects();
                    }
                } else if (currentPhotoTarget.equipmentId) {
                    // 장비점검 사진
                    const equipment = projectData.equipment.find(e => e.id === currentPhotoTarget.equipmentId);
                    if (equipment) {
                        if (currentPhotoTarget.location) {
                            // 위치별 사진
                            if (!equipment.photos) {
                                equipment.photos = {
                                    '좌측상단': null,
                                    '좌측하단': null,
                                    '우측상단': null,
                                    '우측하단': null
                                };
                            }
                            equipment.photos[currentPhotoTarget.location] = imageData;
                            showToast(`✓ ${currentPhotoTarget.location} 사진이 등록되었습니다.`);
                        } else {
                            // 구 버전 호환성
                            equipment.photo = imageData;
                            showToast('✓ 사진이 등록되었습니다.');
                        }
                        renderEquipment();
                    }
                }
            }
            
            saveImmediately(); // ✅ 사진: 즉시 저장
            updateProgress();
            closeCameraModal();
        }

        function updateDefect(id, field, value) {
            const defect = projectData.defects.find(d => d.id === id);
            if (defect) {
                defect[field] = value;
                
                // 상세위치 변경 시 자동 설명 재생성
                if (field === 'detailLocation') {
                    generateAutoDescription(id);
                    renderDefects();
                }
                
                saveWithDebounce(); // ✅ 텍스트 입력: 지연 저장
            }
        }

        window.toggleDefectSelection = function(id, field, value) {
            const defect = projectData.defects.find(d => d.id === id);
            if (!defect) return;
            
            // 배열이 없으면 초기화
            if (!defect[field]) defect[field] = [];
            
            const index = defect[field].indexOf(value);
            if (index > -1) {
                // 이미 선택되어 있으면 제거
                defect[field].splice(index, 1);
            } else {
                // 선택되어 있지 않으면 추가 (최대 4개까지)
                if (defect[field].length < 4) {
                    defect[field].push(value);
                } else {
                    showToast('최대 4개까지만 선택할 수 있습니다');
                    return;
                }
            }
            
            // 선택 후 상세설명 자동 생성
            generateAutoDescription(id);
            
            renderDefects();
            saveWithDebounce(); // ✅ 체크박스: 지연 저장
        }

        function generateAutoDescription(id) {
            const defect = projectData.defects.find(d => d.id === id);
            if (!defect) return;
            
            // 배열이 없으면 초기화
            if (!defect.spaces) defect.spaces = [];
            if (!defect.locations) defect.locations = [];
            if (!defect.types) defect.types = [];
            
            // 선택된 항목이 있을 때만 자동 생성
            if (defect.spaces.length > 0 || defect.locations.length > 0 || defect.types.length > 0 || defect.detailLocation) {
                let description = '';
                
                // 1. 공간 (어디?)
                if (defect.spaces.length > 0) {
                    description += defect.spaces.join(', ');
                }
                
                // 2. 위치 (무엇?) - 한글 문법에 맞게 정렬
                if (defect.locations.length > 0) {
                    if (description) description += ' ';
                    description += sortLocationsForKorean(defect.locations);
                }
                
                // 3. 상세위치 (구체적으로 어디?)
                if (defect.detailLocation) {
                    if (description) description += ' ';
                    description += defect.detailLocation;
                }
                
                // 4. 하자내용 (어떤 문제?)
                if (defect.types.length > 0) {
                    if (description) description += ' ';
                    description += defect.types.join(', ');
                }
                
                defect.description = description;
            }
        }
        
        // 한글 문법에 맞게 위치를 정렬하는 함수
        function sortLocationsForKorean(locations) {
            // 우선순위 정의 (한글 문법에 자연스러운 순서)
            const priority = {
                '창': 1,
                '문': 2,
                '벽': 3,
                '바닥': 4,
                '천장': 5,
                '도배': 6,
                '가구': 7,
                '짝': 8,
                '틀': 9,
                '마감판': 10,
                '수전': 11,
                '타일': 12,
                '도장': 13,
                '줄눈': 14,
                '코킹': 15
            };
            
            // 우선순위에 따라 정렬
            const sorted = [...locations].sort((a, b) => {
                const priorityA = priority[a] || 999;
                const priorityB = priority[b] || 999;
                return priorityA - priorityB;
            });
            
            return sorted.join(' / ');
        }

        function updateDefectStatus(id, status) {
            const defect = projectData.defects.find(d => d.id === id);
            if (defect) {
                defect.status = status;
                renderDefects();
                saveProjectsToLocalStorage();
                showToast(status === 'completed' ? '하자가 완료 처리되었습니다' : '하자가 미완료 상태로 변경되었습니다');
            }
        }

        window.deleteDefect = function(id) {
            if (confirm('이 하자를 삭제하시겠습니까?')) {
                projectData.defects = projectData.defects.filter(d => d.id !== id);
                renderDefects();
                saveImmediately(); // ✅ 중요: 즉시 저장
                updateProgress();
                showToast('하자가 삭제되었습니다');
            }
        }

        // ==================== 엑셀 다운로드 (시공사 제출용) ====================
        // ==================== 모든 자료 다운로드 (PDF + 엑셀 + 사진 ZIP) ====================
        window.downloadAllData = async function() {
            // ✅ 1. 프로젝트 정보 검증
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('프로젝트 정보를 먼저 입력해주세요');
                return;
            }
            
            // ✅ 점검일자 필수 확인
            if (!projectData.inspectionDate) {
                alert('⚠️ 점검일자를 입력해주세요');
                return;
            }
            
            // ✅ 2. 하자 내역 확인
            if (!projectData.defects || projectData.defects.length === 0) {
                alert('다운로드할 하자 내역이 없습니다');
                return;
            }
            
            // ✅ 3. 사진 누락 확인 (2장 미만)
            const defectsWithIncompletePhotos = projectData.defects.filter(d => 
                !d.photos || d.photos.length < 2
            );
            if (defectsWithIncompletePhotos.length > 0) {
                const photoDetails = defectsWithIncompletePhotos.map((d, idx) => {
                    const defectIndex = projectData.defects.indexOf(d) + 1;
                    const photoCount = d.photos ? d.photos.length : 0;
                    return `하자 ${defectIndex}번: 사진 ${photoCount}장`;
                }).join('\n');
                
                if (!confirm(`⚠️ 사진이 2장 미만인 하자가 ${defectsWithIncompletePhotos.length}건 있습니다.\n\n${photoDetails}\n\n📷 권장: 원경 + 근접 사진 2장\n\n시공사 제출 시 증거 자료가 부족할 수 있습니다.\n계속 진행하시겠습니까?`)) {
                    return;
                }
            }
            
            showLoading();
            showToast('📦 모든 자료 준비 중...');
            
            try {
                const zip = new JSZip();
                const projectName = `${projectData.apartmentName}_${projectData.dong}_${projectData.ho}`;
                const authorName = projectData.author ? `_${projectData.author}` : ''; // ✅ 작성자 변수 한 번만 선언
                let photoCount = 0;
                
                // ========== 1. PDF 파일 생성 ==========
                showToast('📄 PDF 보고서 생성 중...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210;
                const pageHeight = 297;

                // PDF 페이지들 생성
                const summaryHTML = createSummaryPage();
                await addHTMLPageToPDF(doc, summaryHTML, pageWidth, pageHeight);

                if (projectData.defects.length > 0) {
                    const defectsWithPhotos = projectData.defects.filter(d => d.photos && d.photos.length > 0);
                    
                    if (defectsWithPhotos.length > 0) {
                        for (let i = 0; i < defectsWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = defectsWithPhotos.slice(i, i + 3);
                            const detailHTML = createDefectDetailPage(batch, i);
                            await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                        }
                    }
                }

                if (projectData.equipment && projectData.equipment.length > 0) {
                    const equipmentWithPhotos = projectData.equipment.filter(e => {
                        if (e.photos && typeof e.photos === 'object') {
                            return Object.values(e.photos).some(photo => photo !== null);
                        }
                        return e.photo;
                    });
                    
                    if (equipmentWithPhotos.length > 0) {
                        for (let i = 0; i < equipmentWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = equipmentWithPhotos.slice(i, i + 3);
                            const equipmentHTML = createEquipmentPage(batch, i);
                            await addHTMLPageToPDF(doc, equipmentHTML, pageWidth, pageHeight);
                        }
                    }
                }

                const airQualityWithData = projectData.airQuality.filter(room => 
                    room.radon || room.formaldehyde || room.vocs
                );
                if (airQualityWithData.length > 0) {
                    doc.addPage();
                    const airQualityHTML = createAirQualityDetailPage();
                    await addHTMLPageToPDF(doc, airQualityHTML, pageWidth, pageHeight);
                }

                doc.addPage();
                const warrantyPage1 = createWarrantyGuidePage1();
                await addHTMLPageToPDF(doc, warrantyPage1, pageWidth, pageHeight);

                doc.addPage();
                const warrantyPage2 = createWarrantyGuidePage2();
                await addHTMLPageToPDF(doc, warrantyPage2, pageWidth, pageHeight);

                doc.addPage();
                const airQualityGuide = createAirQualityManagementGuidePage();
                await addHTMLPageToPDF(doc, airQualityGuide, pageWidth, pageHeight);

                doc.addPage();
                const condensationGuide = createCondensationGuidePage();
                await addHTMLPageToPDF(doc, condensationGuide, pageWidth, pageHeight);

                doc.addPage();
                const movingInGuide = createMovingInGuidePage();
                await addHTMLPageToPDF(doc, movingInGuide, pageWidth, pageHeight);
                
                // PDF를 Blob으로 변환하여 ZIP에 추가
                const pdfBlob = doc.output('blob');
                
                // 작성자 정보 포함한 파일명
                const pdfFileName = `${projectName}${authorName}_하자점검보고서.pdf`;
                
                zip.file(pdfFileName, pdfBlob);
                
                // ========== 2. 엑셀 파일 생성 ==========
                showToast('📊 엑셀 파일 생성 중...');
                
                const workbook = new ExcelJS.Workbook();
                workbook.creator = '더홈점검';
                workbook.created = new Date();
                workbook.modified = new Date();
                workbook.lastModifiedBy = '더홈점검';
                workbook.calcProperties = { fullCalcOnLoad: true };
                
                // ==================== 시트1: 표지 (전문적 디자인) ====================
                const coverSheet = workbook.addWorksheet('표지', {
                    pageSetup: {
                        paperSize: 9, // A4
                        orientation: 'portrait',
                        fitToPage: true,
                        fitToWidth: 1,
                        fitToHeight: 0,
                        margins: {
                            left: 0.7, right: 0.7,
                            top: 0.75, bottom: 0.75,
                            header: 0.3, footer: 0.3
                        }
                    }
                });
                
                coverSheet.getColumn(1).width = 25;
                coverSheet.getColumn(2).width = 35;
                
                // 로고/타이틀 영역 (1~3행)
                coverSheet.mergeCells('A1:B3');
                const titleCell = coverSheet.getCell('A1');
                titleCell.value = '하자점검 리스트';
                titleCell.font = { 
                    name: '맑은 고딕', 
                    size: 32, 
                    bold: true,
                    color: { argb: 'FF1F2937' }
                };
                titleCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'center' 
                };
                titleCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF3F4F6' }
                };
                titleCell.border = {
                    top: { style: 'thick', color: { argb: 'FF10B981' } },
                    left: { style: 'thick', color: { argb: 'FF10B981' } },
                    right: { style: 'thick', color: { argb: 'FF10B981' } },
                    bottom: { style: 'medium', color: { argb: 'FF10B981' } }
                };
                coverSheet.getRow(1).height = 35;
                coverSheet.getRow(2).height = 35;
                coverSheet.getRow(3).height = 35;
                
                // 빈 줄
                coverSheet.getRow(4).height = 20;
                
                // 부제목 (5행)
                coverSheet.mergeCells('A5:B5');
                const subtitleCell = coverSheet.getCell('A5');
                subtitleCell.value = '[ 프로젝트 정보 ]';
                subtitleCell.font = { 
                    name: '맑은 고딕', 
                    size: 14, 
                    bold: true,
                    color: { argb: 'FF10B981' }
                };
                subtitleCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'left' 
                };
                coverSheet.getRow(5).height = 25;
                
                // 프로젝트 정보 (6행~)
                const projectInfo = [
                    ['아파트명', projectData.apartmentName || ''],
                    ['동 / 호수', `${projectData.dong || ''} / ${projectData.ho || ''}`],
                    ['점검일자', projectData.inspectionDate || ''],
                    ['점검자 (계약자)', projectData.inspector || ''],
                    ['연락처', projectData.phone || '']
                ];
                
                projectInfo.forEach((rowData, index) => {
                    const rowNum = 6 + index;
                    const row = coverSheet.getRow(rowNum);
                    row.height = 28;
                    
                    // A열 (라벨)
                    const cellA = row.getCell(1);
                    cellA.value = rowData[0];
                    cellA.font = { 
                        name: '맑은 고딕', 
                        bold: true, 
                        size: 12,
                        color: { argb: 'FFFFFFFF' }
                    };
                    cellA.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF059669' }
                    };
                    cellA.border = {
                        top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                    };
                    cellA.alignment = { 
                        vertical: 'middle', 
                        horizontal: 'center' 
                    };
                    
                    // B열 (값)
                    const cellB = row.getCell(2);
                    cellB.value = rowData[1];
                    cellB.font = { 
                        name: '맑은 고딕', 
                        size: 12,
                        color: { argb: 'FF1F2937' }
                    };
                    cellB.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFFFFF' }
                    };
                    cellB.border = {
                        top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                    };
                    cellB.alignment = { 
                        vertical: 'middle', 
                        horizontal: 'left',
                        indent: 1
                    };
                });
                
                // 빈 줄
                coverSheet.getRow(11).height = 20;
                
                // 하자 요약 (12행)
                coverSheet.mergeCells('A12:B12');
                const summaryCell = coverSheet.getCell('A12');
                summaryCell.value = '[ 하자 현황 ]';
                summaryCell.font = { 
                    name: '맑은 고딕', 
                    size: 14, 
                    bold: true,
                    color: { argb: 'FF10B981' }
                };
                summaryCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'left' 
                };
                coverSheet.getRow(12).height = 25;
                
                // 하자 건수 (13행)
                const defectCountRow = coverSheet.getRow(13);
                defectCountRow.height = 35;
                
                const countLabelCell = defectCountRow.getCell(1);
                countLabelCell.value = '총 하자 건수';
                countLabelCell.font = { 
                    name: '맑은 고딕', 
                    bold: true, 
                    size: 13,
                    color: { argb: 'FFFFFFFF' }
                };
                countLabelCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FF059669' }
                };
                countLabelCell.border = {
                    top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                };
                countLabelCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'center' 
                };
                
                const countValueCell = defectCountRow.getCell(2);
                countValueCell.value = `${projectData.defects.length} 건`;
                countValueCell.font = { 
                    name: '맑은 고딕', 
                    size: 18,
                    bold: true,
                    color: { argb: 'FFEF4444' }
                };
                countValueCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFFEF2F2' }
                };
                countValueCell.border = {
                    top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                };
                countValueCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'center' 
                };
                
                // 빈 줄들
                for (let i = 14; i <= 20; i++) {
                    coverSheet.getRow(i).height = 15;
                }
                
                // 서명란 (21행)
                coverSheet.mergeCells('A21:B21');
                const signCell = coverSheet.getCell('A21');
                signCell.value = '작성자:  _______________     (인)';
                signCell.font = { 
                    name: '맑은 고딕', 
                    size: 12,
                    color: { argb: 'FF6B7280' }
                };
                signCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'right' 
                };
                coverSheet.getRow(21).height = 30;
                
                // 하단 로고/날짜 (22행)
                coverSheet.mergeCells('A22:B22');
                const footerCell = coverSheet.getCell('A22');
                footerCell.value = `Generated by 더홈점검 | ${new Date().toLocaleDateString('ko-KR')}`;
                footerCell.font = { 
                    name: '맑은 고딕', 
                    size: 9,
                    italic: true,
                    color: { argb: 'FF9CA3AF' }
                };
                footerCell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'center' 
                };
                coverSheet.getRow(22).height = 20;
                
                // ==================== 시트2: 하자목록 ====================
                const detailSheet = workbook.addWorksheet('하자목록', {
                    pageSetup: {
                        paperSize: 9, // A4
                        orientation: 'portrait',
                        fitToPage: true,
                        fitToWidth: 1,
                        fitToHeight: 0,
                        margins: {
                            left: 0.7, right: 0.7,
                            top: 0.75, bottom: 0.75,
                            header: 0.3, footer: 0.3
                        }
                    }
                });
                
                // 컬럼 너비 설정
                detailSheet.getColumn(1).width = 7;   // 번호
                detailSheet.getColumn(2).width = 12;  // 공간
                detailSheet.getColumn(3).width = 15;  // 위치
                detailSheet.getColumn(4).width = 15;  // 하자내용
                detailSheet.getColumn(5).width = 40;  // 상세설명
                
                // 헤더 행
                const headerRow = detailSheet.getRow(1);
                headerRow.height = 30;
                
                const headers = ['번호', '공간', '위치', '하자내용', '상세설명'];
                headers.forEach((header, index) => {
                    const cell = headerRow.getCell(index + 1);
                    cell.value = header;
                    cell.font = { 
                        name: '맑은 고딕', 
                        bold: true, 
                        size: 12, 
                        color: { argb: 'FFFFFFFF' } 
                    };
                    cell.alignment = { 
                        vertical: 'middle', 
                        horizontal: 'center', 
                        wrapText: true 
                    };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF059669' }
                    };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'medium', color: { argb: 'FF000000' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        right: { style: 'medium', color: { argb: 'FF000000' } }
                    };
                });
                
                // 하자 데이터 행 (수정: addRow 대신 getRow 사용)
                projectData.defects.forEach((defect, index) => {
                    const row = detailSheet.getRow(index + 2);
                    row.height = 40;
                    
                    // 번호
                    const cell1 = row.getCell(1);
                    cell1.value = index + 1;
                    cell1.font = { name: '맑은 고딕', size: 11, bold: true };
                    cell1.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell1.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' }
                    };
                    cell1.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'medium', color: { argb: 'FF6B7280' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 공간 (배열에서 가져오기)
                    const cell2 = row.getCell(2);
                    cell2.value = (defect.spaces && defect.spaces.length > 0) ? defect.spaces.join(', ') : '';
                    cell2.font = { name: '맑은 고딕', size: 11 };
                    cell2.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell2.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' }
                    };
                    cell2.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 위치 (배열에서 가져오기)
                    const cell3 = row.getCell(3);
                    cell3.value = (defect.locations && defect.locations.length > 0) ? defect.locations.join(', ') : '';
                    cell3.font = { name: '맑은 고딕', size: 11 };
                    cell3.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell3.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' }
                    };
                    cell3.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 하자내용 (배열에서 가져오기)
                    const cell4 = row.getCell(4);
                    cell4.value = (defect.types && defect.types.length > 0) ? defect.types.join(', ') : '';
                    cell4.font = { name: '맑은 고딕', size: 11 };
                    cell4.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell4.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' }
                    };
                    cell4.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 상세설명
                    const cell5 = row.getCell(5);
                    cell5.value = defect.description || '';
                    cell5.font = { name: '맑은 고딕', size: 10 };
                    cell5.alignment = { vertical: 'top', horizontal: 'left', wrapText: true, indent: 1 };
                    cell5.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' }
                    };
                    cell5.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'medium', color: { argb: 'FF6B7280' } }
                    };
                });
                
                // 엑셀 파일을 ZIP에 추가
                const excelBuffer = await workbook.xlsx.writeBuffer();
                
                // 작성자 정보 포함한 파일명
                const excelFileName = `${projectName}${authorName}_하자목록.xlsx`;
                
                zip.file(excelFileName, excelBuffer);
                
                // ========== 3. 사진 추가 ==========
                showToast('📷 사진 수집 중...');
                
                // 평면도
                if (projectData.floorplan) {
                    const floorplanData = projectData.floorplan.split(',')[1];
                    zip.file('평면도.jpg', floorplanData, { base64: true });
                    photoCount++;
                }
                
                // 하자 사진
                if (projectData.defects && projectData.defects.length > 0) {
                    const defectFolder = zip.folder('하자사진');
                    
                    for (let index = 0; index < projectData.defects.length; index++) {
                        const defect = projectData.defects[index];
                        if (defect.photos && defect.photos.length > 0) {
                            const defectNum = String(index + 1).padStart(2, '0');
                            // ✅ 배열에서 첫 번째 값 가져오기
                            const spaceName = (defect.spaces && defect.spaces.length > 0) ? defect.spaces[0] : '미지정';
                            const locationName = (defect.locations && defect.locations.length > 0) ? defect.locations[0] : '미지정';
                            
                            for (let photoIndex = 0; photoIndex < defect.photos.length; photoIndex++) {
                                const photo = defect.photos[photoIndex];
                                const photoType = photoIndex === 0 ? '원경' : '근접';
                                
                                // 워터마크 추가
                                const watermarkText = photoIndex === 0 ? `${index + 1}` : `${index + 1}-1`;
                                const photoWithWatermark = await addWatermarkToPhoto(photo, watermarkText);
                                
                                const photoData = photoWithWatermark.split(',')[1];
                                const fileName = `${defectNum}_${spaceName}_${locationName}_${photoType}.jpg`.replace(/\//g, '-');
                                defectFolder.file(fileName, photoData, { base64: true });
                                photoCount++;
                            }
                        }
                    }
                }
                
                // 장비 사진
                if (projectData.equipment && projectData.equipment.length > 0) {
                    const equipFolder = zip.folder('장비사진');
                    
                    projectData.equipment.forEach((equip, index) => {
                        const equipNum = String(index + 1).padStart(2, '0');
                        const spaceName = equip.space || '미지정';
                        const equipName = equip.equipment || '미지정';
                        
                        if (equip.photos) {
                            Object.entries(equip.photos).forEach(([location, photo]) => {
                                if (photo) {
                                    const photoData = photo.split(',')[1];
                                    const fileName = `${equipNum}_${spaceName}_${equipName}_${location}.jpg`.replace(/\//g, '-');
                                    equipFolder.file(fileName, photoData, { base64: true });
                                    photoCount++;
                                }
                            });
                        } else if (equip.photo) {
                            const photoData = equip.photo.split(',')[1];
                            const fileName = `${equipNum}_${spaceName}_${equipName}.jpg`.replace(/\//g, '-');
                            equipFolder.file(fileName, photoData, { base64: true });
                            photoCount++;
                        }
                    });
                }
                
                // ========== 4. ZIP 파일 생성 및 다운로드 ==========
                showToast(`📦 ZIP 파일 생성 중... (PDF + 엑셀 + 사진 ${photoCount}장)`);
                
                const content = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                
                // 작성자 정보 포함한 파일명
                link.download = `${projectName}${authorName}_전체자료_${projectData.inspectionDate || new Date().toISOString().split('T')[0]}.zip`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                hideLoading();
                showToast(`✅ 다운로드 완료! 📄 PDF + 📊 엑셀 + 📷 사진 ${photoCount}장`);
                
            } catch (error) {
                console.error('전체 자료 다운로드 오류:', error);
                hideLoading();
                alert('다운로드 실패: ' + error.message);
            }
        }

        // ==================== 엑셀 다운로드 (텍스트만) ====================
        async function downloadExcel() {
            // ✅ 1. 프로젝트 정보 검증
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('프로젝트 정보를 먼저 입력해주세요');
                return;
            }
            
            // ✅ 점검일자 필수 확인
            if (!projectData.inspectionDate) {
                alert('⚠️ 점검일자를 입력해주세요');
                return;
            }
            
            if (!projectData.defects || projectData.defects.length === 0) {
                alert('다운로드할 하자 내역이 없습니다');
                return;
            }
            
            showToast('📊 엑셀 파일 생성 중...');
            
            try {
                const workbook = new ExcelJS.Workbook();
                workbook.creator = '더홈점검';
                workbook.created = new Date();
                workbook.modified = new Date();
                workbook.lastModifiedBy = '더홈점검';
                workbook.calcProperties = { fullCalcOnLoad: true };
                
                // === 동일한 코드 재사용 (통합 다운로드와 동일) ===
                // 표지 시트
                const coverSheet = workbook.addWorksheet('표지', {
                    pageSetup: {
                        paperSize: 9,
                        orientation: 'portrait',
                        fitToPage: true,
                        fitToWidth: 1,
                        fitToHeight: 0,
                        margins: {
                            left: 0.7, right: 0.7,
                            top: 0.75, bottom: 0.75,
                            header: 0.3, footer: 0.3
                        }
                    }
                });
                
                coverSheet.getColumn(1).width = 25;
                coverSheet.getColumn(2).width = 35;
                
                // 타이틀
                coverSheet.mergeCells('A1:B3');
                const titleCell = coverSheet.getCell('A1');
                titleCell.value = '하자점검 리스트';
                titleCell.font = { name: '맑은 고딕', size: 32, bold: true, color: { argb: 'FF1F2937' } };
                titleCell.alignment = { vertical: 'middle', horizontal: 'center' };
                titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
                titleCell.border = {
                    top: { style: 'thick', color: { argb: 'FF10B981' } },
                    left: { style: 'thick', color: { argb: 'FF10B981' } },
                    right: { style: 'thick', color: { argb: 'FF10B981' } },
                    bottom: { style: 'medium', color: { argb: 'FF10B981' } }
                };
                coverSheet.getRow(1).height = 35;
                coverSheet.getRow(2).height = 35;
                coverSheet.getRow(3).height = 35;
                coverSheet.getRow(4).height = 20;
                
                // 부제목
                coverSheet.mergeCells('A5:B5');
                const subtitleCell = coverSheet.getCell('A5');
                subtitleCell.value = '[ 프로젝트 정보 ]';
                subtitleCell.font = { name: '맑은 고딕', size: 14, bold: true, color: { argb: 'FF10B981' } };
                subtitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
                coverSheet.getRow(5).height = 25;
                
                // 프로젝트 정보
                const projectInfo = [
                    ['아파트명', projectData.apartmentName || ''],
                    ['동 / 호수', `${projectData.dong || ''} / ${projectData.ho || ''}`],
                    ['점검일자', projectData.inspectionDate || ''],
                    ['점검자 (계약자)', projectData.inspector || ''],
                    ['연락처', projectData.phone || '']
                ];
                
                projectInfo.forEach((rowData, index) => {
                    const rowNum = 6 + index;
                    const row = coverSheet.getRow(rowNum);
                    row.height = 28;
                    
                    const cellA = row.getCell(1);
                    cellA.value = rowData[0];
                    cellA.font = { name: '맑은 고딕', bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                    cellA.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } };
                    cellA.border = {
                        top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                    };
                    cellA.alignment = { vertical: 'middle', horizontal: 'center' };
                    
                    const cellB = row.getCell(2);
                    cellB.value = rowData[1];
                    cellB.font = { name: '맑은 고딕', size: 12, color: { argb: 'FF1F2937' } };
                    cellB.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                    cellB.border = {
                        top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                    };
                    cellB.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
                });
                
                coverSheet.getRow(11).height = 20;
                
                // 하자 요약
                coverSheet.mergeCells('A12:B12');
                const summaryCell = coverSheet.getCell('A12');
                summaryCell.value = '[ 하자 현황 ]';
                summaryCell.font = { name: '맑은 고딕', size: 14, bold: true, color: { argb: 'FF10B981' } };
                summaryCell.alignment = { vertical: 'middle', horizontal: 'left' };
                coverSheet.getRow(12).height = 25;
                
                const defectCountRow = coverSheet.getRow(13);
                defectCountRow.height = 35;
                
                const countLabelCell = defectCountRow.getCell(1);
                countLabelCell.value = '총 하자 건수';
                countLabelCell.font = { name: '맑은 고딕', bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                countLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } };
                countLabelCell.border = {
                    top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                };
                countLabelCell.alignment = { vertical: 'middle', horizontal: 'center' };
                
                const countValueCell = defectCountRow.getCell(2);
                countValueCell.value = `${projectData.defects.length} 건`;
                countValueCell.font = { name: '맑은 고딕', size: 18, bold: true, color: { argb: 'FFEF4444' } };
                countValueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF2F2' } };
                countValueCell.border = {
                    top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                };
                countValueCell.alignment = { vertical: 'middle', horizontal: 'center' };
                
                for (let i = 14; i <= 20; i++) {
                    coverSheet.getRow(i).height = 15;
                }
                
                // 서명란
                coverSheet.mergeCells('A21:B21');
                const signCell = coverSheet.getCell('A21');
                signCell.value = '작성자:  _______________     (인)';
                signCell.font = { name: '맑은 고딕', size: 12, color: { argb: 'FF6B7280' } };
                signCell.alignment = { vertical: 'middle', horizontal: 'right' };
                coverSheet.getRow(21).height = 30;
                
                // 하단
                coverSheet.mergeCells('A22:B22');
                const footerCell = coverSheet.getCell('A22');
                footerCell.value = `Generated by 더홈점검 | ${new Date().toLocaleDateString('ko-KR')}`;
                footerCell.font = { name: '맑은 고딕', size: 9, italic: true, color: { argb: 'FF9CA3AF' } };
                footerCell.alignment = { vertical: 'middle', horizontal: 'center' };
                coverSheet.getRow(22).height = 20;
                
                // 하자목록 시트
                const detailSheet = workbook.addWorksheet('하자목록', {
                    pageSetup: {
                        paperSize: 9,
                        orientation: 'portrait',
                        fitToPage: true,
                        fitToWidth: 1,
                        fitToHeight: 0,
                        margins: {
                            left: 0.7, right: 0.7,
                            top: 0.75, bottom: 0.75,
                            header: 0.3, footer: 0.3
                        }
                    }
                });
                
                detailSheet.getColumn(1).width = 7;
                detailSheet.getColumn(2).width = 12;
                detailSheet.getColumn(3).width = 15;
                detailSheet.getColumn(4).width = 15;
                detailSheet.getColumn(5).width = 40;
                
                const headerRow = detailSheet.getRow(1);
                headerRow.height = 30;
                const headers = ['번호', '공간', '위치', '하자내용', '상세설명'];
                headers.forEach((header, index) => {
                    const cell = headerRow.getCell(index + 1);
                    cell.value = header;
                    cell.font = { name: '맑은 고딕', bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'medium', color: { argb: 'FF000000' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        right: { style: 'medium', color: { argb: 'FF000000' } }
                    };
                });
                
                projectData.defects.forEach((defect, index) => {
                    const row = detailSheet.getRow(index + 2);
                    row.height = 40;
                    
                    const cell1 = row.getCell(1);
                    cell1.value = index + 1;
                    cell1.font = { name: '맑은 고딕', size: 11, bold: true };
                    cell1.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' } };
                    cell1.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'medium', color: { argb: 'FF6B7280' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 공간 (배열에서 가져오기) ✅ 수정됨
                    const cell2 = row.getCell(2);
                    cell2.value = (defect.spaces && defect.spaces.length > 0) ? defect.spaces.join(', ') : '';
                    cell2.font = { name: '맑은 고딕', size: 11 };
                    cell2.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' } };
                    cell2.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 위치 (배열에서 가져오기) ✅ 수정됨
                    const cell3 = row.getCell(3);
                    cell3.value = (defect.locations && defect.locations.length > 0) ? defect.locations.join(', ') : '';
                    cell3.font = { name: '맑은 고딕', size: 11 };
                    cell3.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' } };
                    cell3.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    // 하자내용 (배열에서 가져오기) ✅ 수정됨
                    const cell4 = row.getCell(4);
                    cell4.value = (defect.types && defect.types.length > 0) ? defect.types.join(', ') : '';
                    cell4.font = { name: '맑은 고딕', size: 11 };
                    cell4.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' } };
                    cell4.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                    
                    const cell5 = row.getCell(5);
                    cell5.value = defect.description || '';
                    cell5.font = { name: '맑은 고딕', size: 10 };
                    cell5.alignment = { vertical: 'top', horizontal: 'left', wrapText: true, indent: 1 };
                    cell5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: index % 2 === 0 ? 'FFFFFFFF' : 'FFF9FAFB' } };
                    cell5.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'medium', color: { argb: 'FF6B7280' } }
                    };
                });
                
                // 파일 생성 및 다운로드
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                // ✅ 작성자 정보 포함한 파일명
                const projectName = `${projectData.apartmentName}_${projectData.dong}_${projectData.ho}`;
                const authorName = projectData.author ? `_${projectData.author}` : '';
                const fileName = `${projectName}${authorName}_하자점검리스트_${projectData.inspectionDate || new Date().toISOString().split('T')[0]}.xlsx`;
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast(`✅ 엑셀 다운로드 완료! (하자 ${projectData.defects.length}건)`);
                
            } catch (error) {
                console.error('엑셀 다운로드 오류:', error);
                alert('엑셀 다운로드 실패: ' + error.message);
            }
        }

        // ==================== 사진 ZIP 다운로드 ====================
        async function downloadAllPhotos() {
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('프로젝트 정보를 먼저 입력해주세요');
                return;
            }
            
            showToast('📷 사진 수집 중...');
            
            try {
                const zip = new JSZip();
                const projectName = `${projectData.apartmentName}_${projectData.dong}_${projectData.ho}`;
                let photoCount = 0;
                
                // 1. 평면도
                if (projectData.floorplan) {
                    const floorplanData = projectData.floorplan.split(',')[1];
                    zip.file('평면도.jpg', floorplanData, { base64: true });
                    photoCount++;
                }
                
                // 2. 하자 사진 (순번대로, 폴더 없이)
                if (projectData.defects && projectData.defects.length > 0) {
                    const defectFolder = zip.folder('하자사진');
                    
                    for (let index = 0; index < projectData.defects.length; index++) {
                        const defect = projectData.defects[index];
                        if (defect.photos && defect.photos.length > 0) {
                            const defectNum = String(index + 1).padStart(2, '0'); // 01, 02, 03...
                            // ✅ 배열에서 첫 번째 값 가져오기
                            const spaceName = (defect.spaces && defect.spaces.length > 0) ? defect.spaces[0] : '미지정';
                            const locationName = (defect.locations && defect.locations.length > 0) ? defect.locations[0] : '미지정';
                            
                            for (let photoIndex = 0; photoIndex < defect.photos.length; photoIndex++) {
                                const photo = defect.photos[photoIndex];
                                const photoType = photoIndex === 0 ? '원경' : '근접';
                                
                                // 워터마크 추가
                                const watermarkText = photoIndex === 0 ? `${index + 1}` : `${index + 1}-1`;
                                const photoWithWatermark = await addWatermarkToPhoto(photo, watermarkText);
                                
                                const photoData = photoWithWatermark.split(',')[1];
                                const fileName = `${defectNum}_${spaceName}_${locationName}_${photoType}.jpg`.replace(/\//g, '-');
                                defectFolder.file(fileName, photoData, { base64: true });
                                photoCount++;
                            }
                        }
                    }
                }
                
                // 3. 장비 사진
                if (projectData.equipment && projectData.equipment.length > 0) {
                    const equipFolder = zip.folder('장비사진');
                    
                    projectData.equipment.forEach((equip, index) => {
                        const equipNum = String(index + 1).padStart(2, '0');
                        const spaceName = equip.space || '미지정';
                        const equipName = equip.equipment || '미지정';
                        
                        if (equip.photos) {
                            // 위치별 사진
                            Object.entries(equip.photos).forEach(([location, photo]) => {
                                if (photo) {
                                    const photoData = photo.split(',')[1];
                                    const fileName = `${equipNum}_${spaceName}_${equipName}_${location}.jpg`.replace(/\//g, '-');
                                    equipFolder.file(fileName, photoData, { base64: true });
                                    photoCount++;
                                }
                            });
                        } else if (equip.photo) {
                            // 구 버전 단일 사진
                            const photoData = equip.photo.split(',')[1];
                            const fileName = `${equipNum}_${spaceName}_${equipName}.jpg`.replace(/\//g, '-');
                            equipFolder.file(fileName, photoData, { base64: true });
                            photoCount++;
                        }
                    });
                }
                
                if (photoCount === 0) {
                    showToast('❌ 다운로드할 사진이 없습니다');
                    return;
                }
                
                showToast(`📦 ZIP 파일 생성 중... (${photoCount}장)`);
                
                // ZIP 파일 생성
                const content = await zip.generateAsync({ type: 'blob' });
                
                // 다운로드
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${projectName}_사진모음_${projectData.inspectionDate || new Date().toISOString().split('T')[0]}.zip`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast(`✅ 사진 ${photoCount}장 다운로드 완료!`);
                
            } catch (error) {
                console.error('사진 다운로드 오류:', error);
                alert('사진 다운로드 실패: ' + error.message);
            }
        }

        // ==================== PDF 생성 ====================
        window.generatePDF = async function() {
            // ✅ 1. 프로젝트 정보 검증
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('프로젝트 정보를 먼저 입력해주세요');
                return;
            }
            
            // ✅ 점검일자 필수 확인
            if (!projectData.inspectionDate) {
                alert('⚠️ 점검일자를 입력해주세요');
                return;
            }
            
            // ✅ 2. 사진 누락 확인 (2장 미만)
            if (projectData.defects && projectData.defects.length > 0) {
                const defectsWithIncompletePhotos = projectData.defects.filter(d => 
                    !d.photos || d.photos.length < 2
                );
                if (defectsWithIncompletePhotos.length > 0) {
                    const photoDetails = defectsWithIncompletePhotos.map((d, idx) => {
                        const defectIndex = projectData.defects.indexOf(d) + 1;
                        const photoCount = d.photos ? d.photos.length : 0;
                        return `하자 ${defectIndex}번: 사진 ${photoCount}장`;
                    }).join('\n');
                    
                    if (!confirm(`⚠️ 사진이 2장 미만인 하자가 ${defectsWithIncompletePhotos.length}건 있습니다.\n\n${photoDetails}\n\n📷 권장: 원경 + 근접 사진 2장\n\n고객 보고서 품질이 저하될 수 있습니다.\n계속 진행하시겠습니까?`)) {
                        return;
                    }
                }
            }

            showLoading();

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210;
                const pageHeight = 297;

                // 1페이지: 프로젝트 정보 + 하자 목록 10개
                const firstPageHTML = createSummaryFirstPage();
                await addHTMLPageToPDF(doc, firstPageHTML, pageWidth, pageHeight);

                // 2페이지~: 하자 목록만 (20개씩)
                if (projectData.defects.length > 10) {
                    const itemsPerPage = 20;
                    for (let i = 10; i < projectData.defects.length; i += itemsPerPage) {
                        doc.addPage();
                        const listPageHTML = createDefectListPage(i, itemsPerPage);
                        await addHTMLPageToPDF(doc, listPageHTML, pageWidth, pageHeight);
                    }
                }

                // 하자 상세 사진 페이지 (3개씩, 사진 2장씩)
                if (projectData.defects.length > 0) {
                    const defectsWithPhotos = projectData.defects.filter(d => d.photos && d.photos.length > 0);
                    
                    if (defectsWithPhotos.length > 0) {
                        for (let i = 0; i < defectsWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = defectsWithPhotos.slice(i, i + 3);
                            const detailHTML = await createDefectDetailPage(batch, i);
                            await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                        }
                    }
                }

                // 장비점검 페이지 (1개씩)
                if (projectData.equipment && projectData.equipment.length > 0) {
                    // 사진이 하나라도 있는 항목만 필터링
                    const equipmentWithPhotos = projectData.equipment.filter(e => {
                        if (e.photos && typeof e.photos === 'object') {
                            // 새 버전: photos 객체에서 하나라도 사진이 있으면
                            return Object.values(e.photos).some(photo => photo !== null);
                        }
                        // 구 버전: photo가 있으면
                        return e.photo;
                    });
                    
                    if (equipmentWithPhotos.length > 0) {
                        // 3개씩 페이지에 표시 (하자와 동일)
                        for (let i = 0; i < equipmentWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = equipmentWithPhotos.slice(i, i + 3);
                            const equipmentHTML = createEquipmentPage(batch, i);
                            await addHTMLPageToPDF(doc, equipmentHTML, pageWidth, pageHeight);
                        }
                    }
                }

                // 공기질 상세 페이지 추가
                const airQualityWithData = projectData.airQuality.filter(room => 
                    room.radon || room.formaldehyde || room.vocs
                );
                if (airQualityWithData.length > 0) {
                    doc.addPage();
                    const airQualityHTML = createAirQualityDetailPage();
                    await addHTMLPageToPDF(doc, airQualityHTML, pageWidth, pageHeight);
                }

                // 참고자료 페이지 추가 (보고서 뒤쪽에)
                doc.addPage();
                const warrantyPage1 = createWarrantyGuidePage1();
                await addHTMLPageToPDF(doc, warrantyPage1, pageWidth, pageHeight);

                doc.addPage();
                const warrantyPage2 = createWarrantyGuidePage2();
                await addHTMLPageToPDF(doc, warrantyPage2, pageWidth, pageHeight);

                doc.addPage();
                const airQualityGuide = createAirQualityManagementGuidePage();
                await addHTMLPageToPDF(doc, airQualityGuide, pageWidth, pageHeight);

                doc.addPage();
                const condensationGuide = createCondensationGuidePage();
                await addHTMLPageToPDF(doc, condensationGuide, pageWidth, pageHeight);

                doc.addPage();
                const movingInGuide = createMovingInGuidePage();
                await addHTMLPageToPDF(doc, movingInGuide, pageWidth, pageHeight);

                // 모바일 호환 다운로드
                const filename = `더홈점검_${projectData.apartmentName}_${projectData.dong}${projectData.ho}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    const pdfBlob = doc.output('blob');
                    const blobUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                    
                    hideLoading();
                    showToast('PDF가 다운로드 폴더에 저장되었습니다!');
                } else {
                    doc.save(filename);
                    hideLoading();
                    showToast('PDF가 생성되었습니다');
                }

            } catch (error) {
                console.error('PDF 생성 오류:', error);
                hideLoading();
                alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        async function addHTMLPageToPDF(doc, htmlContent, pageWidth, pageHeight) {
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '794px';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = '#ffffff';
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });

            document.body.removeChild(tempDiv);

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * pageWidth) / canvas.width;
            
            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
        }

        // 첫 페이지: 프로젝트 정보 + 하자 목록 10개
        function createSummaryFirstPage() {
            let defectRows = '';
            const displayDefects = projectData.defects.slice(0, 10);
            
            displayDefects.forEach((defect, index) => {
                const spaces = defect.spaces ? defect.spaces.join(', ') : (defect.space || '-');
                const locations = defect.locations ? defect.locations.join(', ') : (defect.location || '-');
                const types = defect.types ? defect.types.join(', ') : (defect.type || '-');
                const description = defect.description || '';
                
                defectRows += `
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 10px 6px; text-align: center; font-weight: bold; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${index + 1}</td>
                        <td style="padding: 10px 6px; text-align: center; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${spaces}</td>
                        <td style="padding: 10px 6px; text-align: center; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${locations}</td>
                        <td style="padding: 10px 6px; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${types}</td>
                        <td style="padding: 10px 8px; color: #1a1a1a; font-size: 12px; word-break: break-word; white-space: normal; line-height: 1.4; vertical-align: middle; height: 42px;">${description || '-'}</td>
                        <td style="padding: 10px 6px; text-align: center; font-size: 13px; color: #1a1a1a; vertical-align: middle; height: 42px; white-space: nowrap;">${defect.status === 'completed' ? '✓' : '○'}</td>
                    </tr>
                `;
            });

            return `
                <div style="width: 794px; height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative; box-sizing: border-box;">
                    <div style="background: #e3f2fd; border: 2px solid #3498db; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h1 style="margin: 0 0 8px 0; font-size: 26px; color: #000;">더홈점검 하자 보고서</h1>
                        <p style="margin: 0; font-size: 14px; color: #000;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #000; border-bottom: 2px solid #3498db; padding-bottom: 8px;">📋 세대 정보</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #000;">세대 평면도</div>
                                ${projectData.floorplan ? `
                                    <img src="${projectData.floorplan}" style="width: 100%; max-height: 230px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;" />
                                ` : '<div style="width: 100%; height: 230px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">평면도 없음</div>'}
                            </div>

                            <div>
                                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #000;">프로젝트 정보</div>
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px;">
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px; background: #f8f9fa; font-weight: bold; width: 35%; color: #000;">아파트명</td>
                                        <td style="padding: 10px; color: #000;">${projectData.apartmentName}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">동/호수</td>
                                        <td style="padding: 10px; color: #000;">${projectData.dong} / ${projectData.ho}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">점검일자</td>
                                        <td style="padding: 10px; color: #000;">${projectData.inspectionDate || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">고객명</td>
                                        <td style="padding: 10px; color: #000;">${projectData.customerName || '-'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin: 0 0 12px 0; font-size: 18px; color: #000; border-bottom: 2px solid #e74c3c; padding-bottom: 8px;">📋 하자 점검 목록 (총 ${projectData.defects.length}건)</h3>
                    ${projectData.defects.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px; margin-bottom: 0;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #999;">
                                    <th style="padding: 10px 6px; width: 5%; color: #1a1a1a; font-size: 13px; font-weight: bold;">No</th>
                                    <th style="padding: 10px 6px; width: 12%; color: #1a1a1a; font-size: 13px; font-weight: bold;">공간</th>
                                    <th style="padding: 10px 6px; width: 12%; color: #1a1a1a; font-size: 13px; font-weight: bold;">위치</th>
                                    <th style="padding: 10px 6px; width: 15%; color: #1a1a1a; font-size: 13px; font-weight: bold;">하자내용</th>
                                    <th style="padding: 10px 8px; width: 46%; color: #1a1a1a; font-size: 13px; font-weight: bold;">상세설명</th>
                                    <th style="padding: 10px 6px; width: 6%; color: #1a1a1a; font-size: 13px; font-weight: bold;">상태</th>
                                </tr>
                            </thead>
                            <tbody>${defectRows}</tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #999; padding: 40px 0;">등록된 하자가 없습니다</p>'}

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // 나머지 페이지: 하자 목록만 (20개씩)
        function createDefectListPage(startIndex, itemsPerPage = 20) {
            let defectRows = '';
            const endIndex = Math.min(startIndex + itemsPerPage, projectData.defects.length);
            const defectsToDisplay = projectData.defects.slice(startIndex, endIndex);
            
            defectsToDisplay.forEach((defect, index) => {
                const globalIndex = startIndex + index + 1;
                const spaces = defect.spaces ? defect.spaces.join(', ') : (defect.space || '-');
                const locations = defect.locations ? defect.locations.join(', ') : (defect.location || '-');
                const types = defect.types ? defect.types.join(', ') : (defect.type || '-');
                const description = defect.description || '';
                
                defectRows += `
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 10px 6px; text-align: center; font-weight: bold; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${globalIndex}</td>
                        <td style="padding: 10px 6px; text-align: center; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${spaces}</td>
                        <td style="padding: 10px 6px; text-align: center; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${locations}</td>
                        <td style="padding: 10px 6px; color: #1a1a1a; font-size: 13px; vertical-align: middle; height: 42px; white-space: nowrap;">${types}</td>
                        <td style="padding: 10px 8px; color: #1a1a1a; font-size: 12px; word-break: break-word; white-space: normal; line-height: 1.4; vertical-align: middle; height: 42px;">${description || '-'}</td>
                        <td style="padding: 10px 6px; text-align: center; font-size: 13px; color: #1a1a1a; vertical-align: middle; height: 42px; white-space: nowrap;">${defect.status === 'completed' ? '✓' : '○'}</td>
                    </tr>
                `;
            });
            
            const totalPages = Math.ceil((projectData.defects.length - 10) / itemsPerPage) + 1;
            const currentPage = Math.floor((startIndex - 10) / itemsPerPage) + 2;
            const pageIndicator = ` (${currentPage}/${totalPages} 페이지)`;

            return `
                <div style="width: 794px; height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative; box-sizing: border-box;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #000; border-bottom: 2px solid #e74c3c; padding-bottom: 8px;">📋 하자 점검 목록 (총 ${projectData.defects.length}건)${pageIndicator}</h3>
                        <p style="margin: 5px 0 15px 0; font-size: 13px; color: #555;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px; margin-bottom: 0;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #999;">
                                <th style="padding: 10px 6px; width: 5%; color: #1a1a1a; font-size: 13px; font-weight: bold;">No</th>
                                <th style="padding: 10px 6px; width: 12%; color: #1a1a1a; font-size: 13px; font-weight: bold;">공간</th>
                                <th style="padding: 10px 6px; width: 12%; color: #1a1a1a; font-size: 13px; font-weight: bold;">위치</th>
                                <th style="padding: 10px 6px; width: 15%; color: #1a1a1a; font-size: 13px; font-weight: bold;">하자내용</th>
                                <th style="padding: 10px 8px; width: 46%; color: #1a1a1a; font-size: 13px; font-weight: bold;">상세설명</th>
                                <th style="padding: 10px 6px; width: 6%; color: #1a1a1a; font-size: 13px; font-weight: bold;">상태</th>
                            </tr>
                        </thead>
                        <tbody>${defectRows}</tbody>
                    </table>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // 📷 사진에 워터마크 추가하는 함수
        async function addWatermarkToPhoto(imageDataUrl, text) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // 원본 이미지 그리기
                    ctx.drawImage(img, 0, 0);
                    
                    // 워터마크 배지 크기 계산 (이미지 크기에 비례, 더욱 크게)
                    const badgeSize = Math.max(80, Math.min(img.width * 0.15, 120));
                    const fontSize = badgeSize * 0.6;
                    const padding = badgeSize * 0.25;
                    
                    // 반투명 검은색 배경
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                    ctx.roundRect(20, 20, badgeSize, badgeSize, 12);
                    ctx.fill();
                    
                    // 흰색 테두리
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.lineWidth = 3;
                    ctx.roundRect(20, 20, badgeSize, badgeSize, 12);
                    ctx.stroke();
                    
                    // 흰색 텍스트
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, 20 + badgeSize / 2, 20 + badgeSize / 2);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.95));
                };
                img.src = imageDataUrl;
            });
        }

        async function createDefectDetailPage(defects, startIndex) {
            let contentHTML = '';
            
            for (let idx = 0; idx < defects.length; idx++) {
                const defect = defects[idx];
                const globalIndex = startIndex + idx + 1;
                
                // 원본 사진
                const farPhotoOriginal = defect.photos && defect.photos.length > 0 ? defect.photos[0] : '';
                const closePhotoOriginal = defect.photos && defect.photos.length > 1 ? defect.photos[1] : '';
                
                // 워터마크 추가된 사진
                const farPhoto = farPhotoOriginal ? await addWatermarkToPhoto(farPhotoOriginal, `${globalIndex}`) : '';
                const closePhoto = closePhotoOriginal ? await addWatermarkToPhoto(closePhotoOriginal, `${globalIndex}-1`) : '';
                
                // 배열을 문자열로 변환 (하위 호환성)
                const spaces = defect.spaces ? defect.spaces.join(', ') : (defect.space || '-');
                
                // 상세설명만 사용 (이미 모든 정보 포함)
                const description = defect.description || '';
                
                contentHTML += `
                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: white;">
                        <!-- 하자 번호 헤더 -->
                        <div style="background: #f8f9fa; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            하자 ${globalIndex}
                        </div>
                        
                        <!-- 정보 테이블 -->
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 15px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 20%; background: #f8f9fa; font-weight: bold; color: #000;">공간</td>
                                <td style="padding: 10px; color: #000;">${spaces}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">상세설명</td>
                                <td style="padding: 10px; color: #000; line-height: 1.6;">${description || '-'}</td>
                            </tr>
                        </table>

                        <!-- 사진 영역 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                <div style="padding: 10px; text-align: center; font-weight: bold; font-size: 13px; color: #000; background: #e8f5e9; border-bottom: 2px solid #10b981;">
                                    📷 원경 (멀리서)
                                </div>
                                ${farPhoto ? `
                                    <img src="${farPhoto}" style="width: 100%; height: 360px; object-fit: cover; display: block;" />
                                ` : `
                                    <div style="width: 100%; height: 360px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #666; font-size: 13px; font-weight: 600; text-align: center; padding: 10px;">사진 없음</div>
                                `}
                            </div>

                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                <div style="padding: 10px; text-align: center; font-weight: bold; font-size: 13px; color: #000; background: #fff7ed; border-bottom: 2px solid #f59e0b;">
                                    📷 근경 (가까이서)
                                </div>
                                ${closePhoto ? `
                                    <img src="${closePhoto}" style="width: 100%; height: 360px; object-fit: cover; display: block;" />
                                ` : `
                                    <div style="width: 100%; height: 360px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #666; font-size: 13px; font-weight: 600; text-align: center; padding: 10px;">사진 없음</div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: #ffebee; border: 2px solid #e74c3c; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                        <h1 style="margin: 0 0 8px 0; font-size: 26px; color: #000;">하자 상세 사진 (원경+근경)</h1>
                        <p style="margin: 0; font-size: 14px; color: #000;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    ${contentHTML}

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // === 장비점검 측정 보고서 페이지 (3개씩) ===
        function createEquipmentPage(equipmentList, startIndex) {
            let contentHTML = '';
            
            equipmentList.forEach((item, idx) => {
                const globalIndex = startIndex + idx + 1;
                
                // 하위 호환성
                const space = item.space || (item.spaces ? item.spaces.join(', ') : '-');
                
                // 하위 호환성: 기존 4개 구조를 3개로 변환
                if (item.photos && item.photos['좌측상단']) {
                    item.photos = {
                        '좌측': item.photos['좌측상단'] || item.photos['좌측하단'] || null,
                        '우측': item.photos['우측상단'] || item.photos['우측하단'] || null,
                        '바닥': null
                    };
                }
                
                // photos 객체가 있으면 위치별 사진, 없으면 단일 사진 (구 버전)
                const hasLocationPhotos = item.photos && typeof item.photos === 'object';
                
                contentHTML += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 0; background: white; margin-bottom: 20px; page-break-inside: avoid;">
                        <!-- 헤더 -->
                        <div style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #ddd;">
                            <strong style="font-size: 16px; color: #000;">장비점검 ${globalIndex} - ${space}</strong>
                        </div>
                        
                        <!-- 점검결과 -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold; text-align: center; background: #f8f9fa; color: #000; width: 25%;">점검결과</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd; color: #000;">${item.inspection || '벽체수직 및 바닥수평 / 단열시공 양호'}</td>
                            </tr>
                        </table>

                        ${hasLocationPhotos ? `
                            <!-- 사진 영역 -->
                            <div style="padding: 0 15px 15px 15px;">
                                ${(() => {
                                    // 사진이 있는 위치만 필터링
                                    const leftPhoto = item.photos['좌측'];
                                    const rightPhoto = item.photos['우측'];
                                    const floorPhoto = item.photos['바닥'];
                                    
                                    const hasTopPhotos = leftPhoto || rightPhoto;
                                    const hasFloorPhoto = floorPhoto;
                                    
                                    let html = '';
                                    
                                    // 좌측/우측 사진이 하나라도 있으면 표시
                                    if (hasTopPhotos) {
                                        const locations = [];
                                        if (leftPhoto) locations.push({ name: '좌측', photo: leftPhoto, color: '#3498db', icon: '⬅️' });
                                        if (rightPhoto) locations.push({ name: '우측', photo: rightPhoto, color: '#e74c3c', icon: '➡️' });
                                        
                                        // 1개면 full width, 2개면 grid
                                        const gridStyle = locations.length === 2 ? 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;' : '';
                                        
                                        html += `
                                            <div style="${gridStyle} margin-bottom: ${hasFloorPhoto ? '10px' : '0'};">
                                                ${locations.map(loc => `
                                                    <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                        <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid ${loc.color};">
                                                            ${loc.icon} ${loc.name}
                                                        </div>
                                                        <img src="${loc.photo}" style="width: 100%; height: 240px; object-fit: cover; display: block;" />
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                    
                                    // 바닥 사진이 있으면 표시
                                    if (hasFloorPhoto) {
                                        html += `
                                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid #f39c12;">
                                                    ⬇️ 바닥
                                                </div>
                                                <img src="${floorPhoto}" style="width: 100%; height: 260px; object-fit: cover; display: block;" />
                                            </div>
                                        `;
                                    }
                                    
                                    // 사진이 하나도 없으면 안내 메시지
                                    if (!hasTopPhotos && !hasFloorPhoto) {
                                        html = `
                                            <div style="padding: 40px; text-align: center; color: #999; background: #f8f9fa; border-radius: 6px;">
                                                <div style="font-size: 14px; margin-bottom: 8px;">📷 촬영된 사진이 없습니다</div>
                                                <div style="font-size: 11px;">장비점검 시 사진을 첨부해주세요</div>
                                            </div>
                                        `;
                                    }
                                    
                                    return html;
                                })()}
                            </div>
                        ` : `
                            <!-- 단일 사진 (구 버전 호환) -->
                            <div style="text-align: center;">
                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border: 1px solid #ddd; border-bottom: 3px solid #2c3e50; border-radius: 4px 4px 0 0;">
                                    촬영 사진
                                </div>
                                ${item.photo ? `
                                    <img src="${item.photo}" style="width: 100%; max-height: 350px; object-fit: contain; border: 1px solid #ddd; border-top: none;" />
                                ` : `
                                    <div style="width: 100%; height: 250px; background: #f9f9f9; border: 1px solid #ddd; border-top: none; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">사진 없음</div>
                                `}
                            </div>
                        `}
                    </div>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: white; color: #000; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold;">장비 측정 보고서</h2>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    ${contentHTML}

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #666;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>더홈점검 | 070-8019-1456</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 참고자료 페이지 생성 함수들
        function createWarrantyGuidePage1() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #e74c3c; padding-bottom: 10px;">📝 하자보수 청구 가이드</h2>

                    <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            하자를 발견하셨나요? 하자담보책임 기간 내에 적절한 절차로 보수 청구하시면 무상으로 수리받으실 수 있습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1단계: 하자 발견 즉시 사진 촬영 및 기록
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>원경 사진:</strong> 하자가 어느 위치에 있는지 전체적인 공간 촬영</li>
                            <li><strong>근접 사진:</strong> 하자 부위를 확대하여 상세하게 촬영</li>
                            <li><strong>기록 사항:</strong> 발견 날짜, 위치(공간), 하자 내용을 메모</li>
                            <li><strong>TIP:</strong> 자 또는 동전을 함께 찍으면 크기 비교가 용이합니다</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2단계: 하자보수 신청
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12; margin-bottom: 12px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>신청 방법 (2가지)</strong><br>
                                ① <strong>관리사무소</strong>에 접수 (일반적인 방법)<br>
                                ② <strong>시공사 A/S센터</strong>에 직접 접수 (관리사무소 경유 없이)
                            </p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa; border: 1px solid #ddd;">
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd; width: 25%;">구분</th>
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd;">관리사무소 접수</th>
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd;">시공사 A/S센터 직접 접수</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">방법</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">관리사무소 방문/전화/온라인</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">시공사 A/S센터 전화/홈페이지</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">장점</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">가까움, 관리사무소 중재</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">빠른 처리, 직접 소통</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">권장</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">일반 하자</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">긴급 하자, 대응 미흡 시</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #3498db;">
                            <p style="margin: 0 0 8px 0; color: #000; font-size: 12px; font-weight: bold;">📌 제출 서류</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #000; line-height: 1.6;">
                                <li>하자보수 신청서 (관리사무소 비치 또는 시공사 홈페이지 다운로드)</li>
                                <li>하자 사진 (원경, 근접)</li>
                                <li>입주자 정보 (동/호수, 연락처)</li>
                                <li><strong>중요:</strong> 접수증 또는 접수번호 반드시 받기 (증빙자료)</li>
                            </ul>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #fff3e0; color: #000; border-bottom: 2px solid #f39c12; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3단계: 시공사의 하자 확인 및 보수
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li>시공사에서 하자 확인을 위해 방문 (일정 협의, 보통 1~2주 소요)</li>
                            <li>하자 인정 시 보수 일정 협의 및 시행</li>
                            <li>보수 완료 후 입주자 확인 및 서명</li>
                            <li><strong>하자 미인정 시:</strong> 사유 확인 후 재신청 또는 분쟁조정 신청 가능</li>
                            <li><strong>대응 지연 시:</strong> 시공사 본사 A/S센터, 한국소비자원(1372) 상담</li>
                        </ul>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createWarrantyGuidePage2() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #e74c3c; padding-bottom: 10px;">⏰ 하자담보책임 기간 상세</h2>

                    <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            <strong>공동주택관리법 시행령 제36조</strong>에 따라 사업주체는 하자담보책임 기간 동안 무상 보수 의무가 있습니다.
                            기간 만료 전에 반드시 신청하셔야 합니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff3e0;">
                        <h3 style="margin: 0 0 10px 0; color: #f39c12; font-size: 15px;">📅 하자담보책임 기간 기산일</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                            <tr style="border: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd; width: 40%;">기산일 기준</td>
                                <td style="padding: 10px; color: #000; border: 1px solid #ddd;">입주일 또는 사용검사일 중 <strong>빠른 날</strong></td>
                            </tr>
                            <tr style="border: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">예시</td>
                                <td style="padding: 10px; color: #000; border: 1px solid #ddd;">입주일: 2024.3.1 / 사용검사일: 2024.2.15 → <strong>2024.2.15부터 기산</strong></td>
                            </tr>
                        </table>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #000; line-height: 1.6;">
                            ※ 입주자가 입주를 지연한 경우에도 사용검사일 기준 적용<br>
                            ※ 입주자대표회의 또는 관리사무소에서 정확한 날짜 확인 가능
                        </p>
                    </div>

                    <div style="border: 2px solid #e74c3c; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #ffebee; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ① 내력구조부 - 10년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">건물의 주요구조부 (기둥, 보, 내력벽, 주계단, 지붕틀, 바닥)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">구조 균열, 부등침하, 기둥·보 파손</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #fff3e0; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ② 주요 설비 - 3년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">난방·급배수·전기·가스·소방·환기 설비</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">보일러 고장, 수전 누수, 배관 막힘, 누전, 가스밸브 불량</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #e3f2fd; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ③ 마감재 - 2년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">도배, 장판, 타일, 도장, 수장, 미장, 창호</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">도배 들뜸, 장판 변색, 타일 균열, 창호 개폐 불량</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #2ecc71; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ④ 기타 부위 - 5년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">조경, 지능형 홈네트워크, 방수, 단열 등</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">옥상·발코니 누수, 결로(시공하자), 월패드 고장</td>
                            </tr>
                        </table>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createAirQualityManagementGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #2ecc71; padding-bottom: 10px;">🌿 실내 공기질 관리 가이드</h2>

                    <div style="background: #e8f5e9; border-left: 4px solid #2ecc71; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            새 아파트는 자재에서 나오는 유해물질로 인해 실내 공기질이 나쁠 수 있습니다. 
                            입주 전후 적절한 환기와 관리로 쾌적한 실내 환경을 만드세요.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 자주 환기하기 (가장 중요!)
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">환기 횟수</td>
                                <td style="padding: 10px; color: #000;">하루 3회 이상 (아침, 점심, 저녁)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">환기 시간</td>
                                <td style="padding: 10px; color: #000;">회당 최소 30분 (맞바람 치도록 대각선 창문 개방)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">환기 시기</td>
                                <td style="padding: 10px; color: #000;">입주 최소 2주 전부터 매일 환기 (가능하면 1개월)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">TIP</td>
                                <td style="padding: 10px; color: #000;">미세먼지 나쁨 날도 실내가 더 나쁘므로 짧게라도 환기 필수</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #ffebee; color: #000; border-bottom: 2px solid #e74c3c; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 베이크아웃 (Bake-Out)
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12; margin-bottom: 10px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>베이크아웃이란?</strong><br>
                                실내 온도를 높여서 건축 자재에 남아있는 유해물질을 빠르게 배출시키는 방법
                            </p>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>방법:</strong> 모든 창문 닫고 난방을 켜서 실내 온도를 30~35도까지 올림</li>
                            <li><strong>시간:</strong> 6~8시간 유지</li>
                            <li><strong>환기:</strong> 그 후 모든 창문 열고 2시간 이상 환기</li>
                            <li><strong>반복:</strong> 이 과정을 3~5회 반복하면 효과적</li>
                            <li><strong>시기:</strong> 입주 1~2주 전에 실시 권장</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 공기정화 식물 배치
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 산세베리아</div>
                                <div style="font-size: 11px; color: #000;">밤에도 산소 배출, 음이온 발생</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 스파티필름</div>
                                <div style="font-size: 11px; color: #000;">암모니아, 벤젠 제거 탁월</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 아레카야자</div>
                                <div style="font-size: 11px; color: #000;">공기정화 1위, 가습 효과</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 고무나무</div>
                                <div style="font-size: 11px; color: #000;">포름알데히드 제거 효과</div>
                            </div>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #666; line-height: 1.6;">
                            ※ 권장: 3.3㎡(1평)당 중형 화분 1개 또는 소형 2~3개
                        </p>
                    </div>

                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: #e3f2fd;">
                        <h3 style="margin: 0 0 10px 0; color: #3498db; font-size: 16px;">📊 실내 공기질 권고기준</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                            <thead>
                                <tr style="background: #f8f9fa; border: 1px solid #ddd;">
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">오염물질</th>
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">권고기준</th>
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">주요 배출원</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">라돈</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">148 Bq/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">토양, 콘크리트</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">포름알데히드</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">210 μg/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">합판, 접착제, 벽지</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">총휘발성유기화합물</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">500 μg/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">페인트, 접착제, 방향제</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #000; line-height: 1.6;">
                            ※ 「다중이용시설 등의 실내공기질관리법」 신축 공동주택 권고기준<br>
                            ※ 기준 초과 시 환기 및 재측정 필요
                        </p>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createCondensationGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #3498db; padding-bottom: 10px;">💧 결로 예방 및 관리 가이드</h2>

                    <div style="background: #e3f2fd; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            결로는 실내외 온도차와 습도로 인해 발생하는 자연현상입니다. 
                            적절한 환기와 실내 습도 관리로 결로 발생을 최소화할 수 있습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 결로란 무엇인가?
                        </div>
                        <p style="margin: 0 0 10px 0; color: #000; font-size: 12px; line-height: 1.8;">
                            <strong>결로(結露):</strong> 공기 중 수증기가 찬 표면에 닿아 물방울로 맺히는 현상
                        </p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 30%; background: #f8f9fa; font-weight: bold; color: #000;">발생 원인</td>
                                <td style="padding: 10px; color: #000;">실내외 온도차 + 높은 실내 습도</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주요 발생 시기</td>
                                <td style="padding: 10px; color: #000;">겨울철 (11월~3월)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주요 발생 장소</td>
                                <td style="padding: 10px; color: #000;">창문, 외벽, 코너, 욕실 주변</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">문제점</td>
                                <td style="padding: 10px; color: #000;">곰팡이 발생, 벽지 손상, 악취, 건강 피해</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 결로 예방 방법
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 4px; border: 1px solid #2ecc71;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px; font-size: 13px;">✓ 환기하기</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 하루 3회, 10분 이상<br>
                                    • 요리·샤워 후 즉시 환기<br>
                                    • 맞바람 치도록 개방
                                </div>
                            </div>
                            <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; border: 1px solid #3498db;">
                                <div style="font-weight: bold; color: #3498db; margin-bottom: 5px; font-size: 13px;">✓ 습도 조절</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 실내 습도 40~60% 유지<br>
                                    • 가습기 사용 자제<br>
                                    • 빨래 실내 건조 금지
                                </div>
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12;">
                                <div style="font-weight: bold; color: #f39c12; margin-bottom: 5px; font-size: 13px;">✓ 실내 온도</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 18~22도 적정 유지<br>
                                    • 난방 과도하게 높이지 않기<br>
                                    • 외출 시에도 최소 난방
                                </div>
                            </div>
                            <div style="background: #ffebee; padding: 12px; border-radius: 4px; border: 1px solid #e74c3c;">
                                <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 13px;">✓ 가구 배치</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 외벽에서 5~10cm 띄우기<br>
                                    • 통풍 공간 확보<br>
                                    • 붙박이장 환기구 열어두기
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #ffebee; color: #000; border-bottom: 2px solid #e74c3c; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 결로 발생 시 대처 방법
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>물기 제거:</strong> 즉시 마른 걸레로 물기를 닦아냄</li>
                            <li><strong>환기:</strong> 물기 제거 후 즉시 환기하여 습기 배출</li>
                            <li><strong>제습:</strong> 제습기 또는 제습제 사용으로 습도 낮춤</li>
                            <li><strong>곰팡이 제거:</strong> 락스 희석액(1:10)으로 소독 후 환기</li>
                            <li><strong>예방:</strong> 재발 방지를 위해 지속적인 환기 및 습도 관리</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #2ecc71; border-radius: 8px; padding: 15px; background: #e8f5e9;">
                        <h3 style="margin: 0 0 10px 0; color: #2ecc71; font-size: 16px;">💡 더홈점검 TIP</h3>
                        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>결로 vs 누수 구분법:</strong><br>
                                • <strong>결로:</strong> 창문, 벽면 전체에 고르게 물방울 발생, 추운 날 심해짐<br>
                                • <strong>누수:</strong> 특정 부위에만 물이 스며들거나 고임, 날씨와 무관
                            </p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>결로가 아닌 하자일 수 있는 경우:</strong><br>
                                • 단열재 시공 불량 (특정 벽면에만 반복 발생)<br>
                                • 창호 기밀 불량 (창틀 주변에서만 발생)<br>
                                → 이 경우 하자보수 청구 가능
                            </p>
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createMovingInGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #9b59b6; padding-bottom: 10px;">🏡 입주 시 알아두면 유용한 정보</h2>

                    <div style="background: #f3e5f5; border-left: 4px solid #9b59b6; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            새 아파트 입주를 앞두고 계신가요? 입주 전후 알아두면 도움이 되는 실용 정보를 정리했습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #f3e5f5; color: #000; border-bottom: 2px solid #9b59b6; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 입주 전 필수 준비사항
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 30%; background: #f8f9fa; font-weight: bold; color: #000;">전입신고</td>
                                <td style="padding: 10px; color: #000;">입주일로부터 14일 이내 (주민센터 또는 정부24)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">화재보험 가입</td>
                                <td style="padding: 10px; color: #000;">의무가입 (관리사무소에서 일괄 가입 가능)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">인터넷/TV 신청</td>
                                <td style="padding: 10px; color: #000;">입주 2주 전 신청 (설치까지 1~2주 소요)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">가스 개통</td>
                                <td style="padding: 10px; color: #000;">도시가스 회사에 개통 신청 (방문 검사 필요)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주차등록</td>
                                <td style="padding: 10px; color: #000;">관리사무소에 차량번호 등록 (차량등록증 지참)</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 관리비 절약 노하우
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px; font-size: 12px;">난방비 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>적정온도 유지 (20~22도)</li>
                                    <li>외출 시 저온모드</li>
                                    <li>보일러 정기점검</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #3498db; margin-bottom: 5px; font-size: 12px;">전기세 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>대기전력 차단</li>
                                    <li>LED 조명 사용</li>
                                    <li>냉장고 적정온도</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #f39c12; margin-bottom: 5px; font-size: 12px;">수도세 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>절수형 샤워기 설치</li>
                                    <li>설거지 물 받아서</li>
                                    <li>누수 즉시 수리</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 12px;">쓰레기봉투</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>분리수거 철저히</li>
                                    <li>음식물 물기 제거</li>
                                    <li>종량제봉투 아껴쓰기</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 비상 시 주요 연락처
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 35%; background: #f8f9fa; font-weight: bold; color: #000;">관리사무소</td>
                                <td style="padding: 8px; color: #000;">일반 문의, 하자보수, 주차 등</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">경비실</td>
                                <td style="padding: 8px; color: #000;">야간/주말 긴급 상황</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">도시가스 (119)</td>
                                <td style="padding: 8px; color: #000;">가스 누출 신고</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">한국전력 (123)</td>
                                <td style="padding: 8px; color: #000;">정전, 전기 고장</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">수도 (120)</td>
                                <td style="padding: 8px; color: #000;">상수도 고장, 수질 문제</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #fff3e0; color: #000; border-bottom: 2px solid #f39c12; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            4. 이웃 간 층간소음 예방 에티켓
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>조용히 해야 할 시간:</strong> 오후 10시 ~ 오전 8시 (법정 시간)</li>
                            <li><strong>어린이 뛰어다님:</strong> 실내화 착용, 매트 깔기, 조용한 놀이 유도</li>
                            <li><strong>망치질/드릴 작업:</strong> 평일 낮 시간대만 (사전 양해 구하기)</li>
                            <li><strong>세탁기/청소기:</strong> 오전 8시 이후, 오후 10시 이전 사용</li>
                            <li><strong>반려동물:</strong> 짖음 방지 훈련, 배변 매너 준수</li>
                            <li><strong>피아노/악기 연습:</strong> 방음 처리 또는 시간대 조절</li>
                        </ul>
                        <div style="background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c; margin-top: 10px;">
                            <p style="margin: 0; color: #000; font-size: 11px; line-height: 1.6;">
                                <strong>※ 층간소음 분쟁 시:</strong><br>
                                1차: 관리사무소 중재 → 2차: 층간소음 이웃사이센터(1661-2642) 상담 → 3차: 환경분쟁조정위원회 조정 신청
                            </p>
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createAirQualityDetailPage() {
            const airQualityData = projectData.airQuality.filter(room => 
                room.radon || room.formaldehyde || room.vocs
            );

            // 기준치
            const standards = {
                radon: 148,
                formaldehyde: 0.210,
                vocs: 0.500
            };

            // 표 생성
            let tableRows = '';
            airQualityData.forEach((room) => {
                const radonValue = parseFloat(room.radon) || 0;
                const formaldehydeValue = parseFloat(room.formaldehyde) || 0;
                const vocsValue = parseFloat(room.vocs) || 0;

                const radonStatus = radonValue > 0 ? (radonValue <= standards.radon ? '적합' : '부적합') : '-';
                const formaldehydeStatus = formaldehydeValue > 0 ? (formaldehydeValue <= standards.formaldehyde ? '적합' : '부적합') : '-';
                const vocsStatus = vocsValue > 0 ? (vocsValue <= standards.vocs ? '적합' : '부적합') : '-';

                tableRows += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; color: #000000;">${room.name}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.radon || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${radonValue > standards.radon ? '#e74c3c' : '#10b981'}; font-weight: bold;">${radonStatus}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.formaldehyde || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${formaldehydeValue > standards.formaldehyde ? '#e74c3c' : '#10b981'}; font-weight: bold;">${formaldehydeStatus}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.vocs || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${vocsValue > standards.vocs ? '#e74c3c' : '#10b981'}; font-weight: bold;">${vocsStatus}</td>
                    </tr>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                        <h1 style="margin: 0 0 8px 0; font-size: 26px;">실내 공기질 측정 결과</h1>
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #000000; border-bottom: 2px solid #16a085; padding-bottom: 8px;">📋 측정 데이터</h3>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">공간</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">라돈<br>(Bq/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">포름알데히드<br>(mg/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">총VOCs<br>(mg/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">✓ 권고기준 (실내공기질 공정시험기준)</h4>
                        <div style="font-size: 14px; color: #1b5e20; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                            <div>• 라돈(Rn): <strong>148 Bq/m³ 이하</strong></div>
                            <div>• 포름알데히드(HCHO): <strong>0.210 mg/m³ 이하</strong></div>
                            <div>• 총휘발성유기화합물(TVOCs): <strong>0.500 mg/m³ 이하</strong></div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #856404; line-height: 1.6;">
                            <strong>※ 참고사항</strong><br>
                            - 측정 결과는 측정 당시의 환경 조건에 따라 달라질 수 있습니다.<br>
                            - 부적합 판정 시 환기 등의 조치 후 재측정을 권장합니다.<br>
                            - 라돈 농도는 계절, 시간대에 따라 변동이 있을 수 있습니다.
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // ==================== IndexedDB 설정 ====================
        let db;
        const DB_NAME = 'TheHomeInspectionDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'projects';

        // IndexedDB 초기화
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('savedAt', 'savedAt', { unique: false });
                        objectStore.createIndex('apartmentName', 'apartmentName', { unique: false });
                    }
                };
            });
        }

        // IndexedDB에 데이터 저장
        async function saveToIndexedDB(key, data) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    
                    // ✅ 수정: data를 그대로 저장하되, id를 key로 설정
                    const finalData = { 
                        id: key,  // IndexedDB의 키
                        data: data  // 실제 데이터 (프로젝트 배열 또는 단일 프로젝트)
                    };
                    
                    const request = objectStore.put(finalData);
                    
                    request.onsuccess = () => {
                        console.log('✅ IndexedDB 저장 성공:', key);
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 저장 오류:', e);
                throw e;
            }
        }

        // IndexedDB에서 데이터 불러오기
        async function loadFromIndexedDB(key) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.get(key);
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result && result.data) {
                            // ✅ 수정: data 필드에서 실제 데이터 반환
                            console.log('✅ IndexedDB 불러오기 성공:', key);
                            resolve(result.data);
                        } else {
                            console.log('ℹ️ IndexedDB에 데이터 없음:', key);
                            resolve(null);
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 불러오기 오류:', e);
                return null;
            }
        }

        // IndexedDB에서 모든 프로젝트 가져오기
        async function getAllFromIndexedDB() {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 목록 조회 오류:', e);
                return [];
            }
        }

        // IndexedDB에서 데이터 삭제
        async function deleteFromIndexedDB(key) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.delete(key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 삭제 오류:', e);
                throw e;
            }
        }

        // ==================== 자동 저장 함수 ====================
        // autoSaveTimeout 제거됨 - saveTimer로 통합
        
        function autoSaveProjectData() {
            // projectData 업데이트
            projectData.apartmentName = document.getElementById('apartmentName').value;
            projectData.dong = document.getElementById('dong').value;
            projectData.ho = document.getElementById('ho').value;
            projectData.inspectionDate = document.getElementById('inspectionDate').value;
            projectData.customerName = document.getElementById('customerName').value;
            projectData.customerPhone = document.getElementById('customerPhone').value;
            
            // 저장 (이미 debounce 적용)
            saveWithDebounce(500); // 0.5초 지연
            updateProgress();
        }

        // ==================== 데이터 저장/불러오기 (구버전 - 사용 안 함) ====================
        // async function saveToLocalStorage() {
        //     try {
        //         await saveToIndexedDB('thehomein_current', projectData);
        //     } catch (e) {
        //         console.error('저장 오류:', e);
        //         alert('저장 실패: ' + e.message);
        //     }
        // }

        async function loadFromLocalStorage() {
            try {
                const saved = await loadFromIndexedDB('thehomein_current');
                if (saved) {
                    // Proxy를 통해 현재 프로젝트에 데이터 로드
                    const project = getCurrentProject();
                    Object.assign(project, saved);
                    
                    document.getElementById('apartmentName').value = projectData.apartmentName || '';
                    document.getElementById('dong').value = projectData.dong || '';
                    document.getElementById('ho').value = projectData.ho || '';
                    document.getElementById('inspectionDate').value = projectData.inspectionDate || '';
                    document.getElementById('customerName').value = projectData.customerName || '';
                    document.getElementById('customerPhone').value = projectData.customerPhone || '';
                    
                    displayFloorplan();
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    
                    if (projectData.defects.length > 0) {
                        defectIdCounter = Math.max(...projectData.defects.map(d => d.id)) + 1;
                    }
                    if (projectData.equipment && projectData.equipment.length > 0) {
                        equipmentIdCounter = Math.max(...projectData.equipment.map(e => e.id)) + 1;
                    }
                    if (projectData.airQuality.length > 0) {
                        airQualityIdCounter = Math.max(...projectData.airQuality.map(a => a.id)) + 1;
                    }
                }
            } catch (e) {
                console.error('불러오기 오류:', e);
            }
        }

        window.saveCurrentData = async function() {
            const timestamp = new Date().toISOString();
            const key = `thehomein_${timestamp}`;
            
            try {
                await saveToIndexedDB(key, {
                    ...projectData,
                    savedAt: timestamp
                });
                await renderSavedList();
                showToast('데이터가 저장되었습니다');
            } catch (e) {
                alert('저장 실패: ' + e.message);
            }
        }

        async function renderSavedList() {
            const container = document.getElementById('savedList');
            
            try {
                const saved = await getAllFromIndexedDB();
                const filtered = saved.filter(item => item.id !== 'thehomein_current');
                
                if (filtered.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">저장된 프로젝트가 없습니다</p>';
                    return;
                }
                
                // 최신순 정렬
                filtered.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
                
                container.innerHTML = filtered.map(item => `
                    <div class="saved-item">
                        <div class="saved-info">
                            <h3>${item.apartmentName || '제목 없음'} ${item.dong} ${item.ho}</h3>
                            <p>${new Date(item.savedAt).toLocaleString('ko-KR')}</p>
                        </div>
                        <div class="saved-actions">
                            <button class="icon-btn load" onclick="loadSavedData('${item.id}')">📂</button>
                            <button class="icon-btn delete" onclick="deleteSavedData('${item.id}')">🗑️</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('목록 렌더링 오류:', e);
                container.innerHTML = '<p style="color: red; text-align: center;">목록을 불러오는 중 오류가 발생했습니다</p>';
            }
        }

        window.loadSavedData = async function(key) {
            if (confirm('현재 작업 중인 데이터를 불러온 데이터로 덮어쓰시겠습니까?')) {
                try {
                    const data = await loadFromIndexedDB(key);
                    if (!data) {
                        alert('데이터를 찾을 수 없습니다');
                        return;
                    }
                    
                    // Proxy를 통해 현재 프로젝트에 데이터 로드
                    const project = getCurrentProject();
                    Object.assign(project, data);
                    
                    // equipment 데이터가 없으면 초기화
                    if (!project.equipment) {
                        project.equipment = [];
                    }
                    
                    document.getElementById('apartmentName').value = projectData.apartmentName || '';
                    document.getElementById('dong').value = projectData.dong || '';
                    document.getElementById('ho').value = projectData.ho || '';
                    document.getElementById('inspectionDate').value = projectData.inspectionDate || '';
                    document.getElementById('customerName').value = projectData.customerName || '';
                    document.getElementById('customerPhone').value = projectData.customerPhone || '';
                    
                    displayFloorplan();
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    await saveProjectsToLocalStorage();
                    updateProgress();
                    
                    showToast('데이터를 불러왔습니다');
                    switchTab('project');
                } catch (e) {
                    alert('불러오기 실패: ' + e.message);
                }
            }
        }

        window.deleteSavedData = async function(key) {
            if (confirm('이 프로젝트를 삭제하시겠습니까?')) {
                try {
                    await deleteFromIndexedDB(key);
                    await renderSavedList();
                    showToast('프로젝트가 삭제되었습니다');
                } catch (e) {
                    alert('삭제 실패: ' + e.message);
                }
            }
        }

        window.clearAllData = async function() {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                if (confirm('다시 한번 확인합니다. 모든 데이터가 삭제됩니다.')) {
                    try {
                        const allData = await getAllFromIndexedDB();
                        
                        for (const item of allData) {
                            await deleteFromIndexedDB(item.id);
                        }
                        
                        // 현재 프로젝트 초기화
                        const project = getCurrentProject();
                        project.apartmentName = '';
                        project.dong = '';
                        project.ho = '';
                        project.inspectionDate = '';
                        project.customerName = '';
                        project.customerPhone = '';
                        project.floorplan = null;
                        project.defects = [];
                        project.equipment = [];
                        project.airQuality = [];
                        
                        defectIdCounter = 1;
                        equipmentIdCounter = 1;
                        airQualityIdCounter = 1;
                        
                        document.getElementById('apartmentName').value = '';
                        document.getElementById('dong').value = '';
                        document.getElementById('ho').value = '';
                        document.getElementById('inspectionDate').valueAsDate = new Date();
                        document.getElementById('customerName').value = '';
                        document.getElementById('customerPhone').value = '';
                        
                        displayFloorplan();
                        renderDefects();
                        renderEquipment();
                        renderAirQuality();
                        await renderSavedList();
                        updateProgress();
                        
                        showToast('모든 데이터가 삭제되었습니다');
                    } catch (e) {
                        alert('삭제 실패: ' + e.message);
                    }
                }
            }
        }

        // ==================== 계약서 관리 기능 ====================

        // 전역 변수
        let contracts = [];
        let currentEditingContract = null;
        let signaturePads = {};

        // 계약서 데이터 로드
        async function loadContracts() {
            try {
                const db = await initContractDB();
                const tx = db.transaction('contracts', 'readonly');
                const store = tx.objectStore('contracts');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    contracts = request.result || [];
                    displayContractList();
                };
            } catch (error) {
                console.error('계약서 로드 실패:', error);
                contracts = [];
                displayContractList();
            }
        }

        // IndexedDB에 contracts 저장소 추가
        async function initContractDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TheHomeInspectionDB', 3); // 버전 업그레이드
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // contracts 저장소가 없으면 생성
                    if (!db.objectStoreNames.contains('contracts')) {
                        const contractStore = db.createObjectStore('contracts', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        contractStore.createIndex('name', 'name', { unique: false });
                        contractStore.createIndex('createdAt', 'createdAt', { unique: false });
                    }
                };
            });
        }

        // 계약서 목록 표시
        function displayContractList() {
            const container = document.getElementById('contractListContainer');
            
            if (!container) return;
            
            if (contracts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 20px;">📄</div>
                        <p style="font-size: 18px;">작성된 계약서가 없습니다</p>
                        <p style="font-size: 14px; margin-top: 10px;">
                            "➕ 새 계약서 작성" 버튼을 클릭하여 첫 계약서를 작성하세요
                        </p>
                    </div>
                `;
                return;
            }
            
            const sortedContracts = [...contracts].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            container.innerHTML = sortedContracts.map(contract => `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 20px;">
                                ${contract.name}
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 14px; margin: 5px 0;">
                                📅 계약일: ${contract.startDate} ~ ${contract.endDate}
                            </p>
                            <p style="color: var(--text-secondary); font-size: 14px; margin: 5px 0;">
                                💰 단가: ${Number(contract.price).toLocaleString()}원/건
                            </p>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 10px;">
                                작성일: ${new Date(contract.createdAt).toLocaleDateString()}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-direction: column;">
                            <button class="btn btn-primary" onclick="viewContract(${contract.id})" 
                                style="font-size: 14px; padding: 8px 15px;">
                                👁️ 보기
                            </button>
                            <button class="btn" onclick="downloadContractPDF(${contract.id})" 
                                style="font-size: 14px; padding: 8px 15px;">
                                📥 PDF
                            </button>
                            <button class="btn" onclick="deleteContract(${contract.id})" 
                                style="font-size: 14px; padding: 8px 15px; background: var(--danger); color: white;">
                                🗑️ 삭제
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 계약서 검색
        function searchContracts() {
            const searchTerm = document.getElementById('contractSearch').value.toLowerCase();
            const filtered = contracts.filter(c => 
                c.name.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('contractListContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>검색 결과가 없습니다</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(contract => `
                <div class="card" style="margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">${contract.name}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        계약기간: ${contract.startDate} ~ ${contract.endDate}
                    </p>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="viewContract(${contract.id})">보기</button>
                        <button class="btn" onclick="downloadContractPDF(${contract.id})">PDF</button>
                        <button class="btn" onclick="deleteContract(${contract.id})" 
                            style="background: var(--danger); color: white;">삭제</button>
                    </div>
                </div>
            `).join('');
        }

        // 계약서 작성 폼으로 스크롤
        window.showContractForm = function() {
            const contractForm = document.getElementById('contractForm');
            if (contractForm) {
                contractForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // 서명 패드 초기화
            setTimeout(() => {
                if (typeof initializeSignaturePads === 'function') {
                    initializeSignaturePads();
                }
            }, 300);
            
            // 기본 날짜 설정
            const today = new Date().toISOString().split('T')[0];
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            
            const startDateEl = document.getElementById('contractStartDate');
            const endDateEl = document.getElementById('contractEndDate');
            if (startDateEl && !startDateEl.value) startDateEl.value = today;
            if (endDateEl && !endDateEl.value) endDateEl.value = nextYear.toISOString().split('T')[0];
        }

        // 계약서 목록 표시
        window.showContractList = function() {
            // 더 이상 목록 기능 없음 - 아무 동작 안 함
            console.log('계약서 목록 기능이 제거되었습니다.');
        }

        // 서명 패드 초기화
        function initializeSignaturePads() {
            setTimeout(() => {
                ['CEO', 'Freelancer'].forEach(type => {
                    const canvas = document.getElementById(`signature${type}`);
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    let isDrawing = false;
                    let lastX = 0;
                    let lastY = 0;
                    
                    // 캔버스 크기 설정
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * 2;
                    canvas.height = rect.height * 2;
                    ctx.scale(2, 2);
                    
                    // 선 스타일
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    function startDrawing(e) {
                        isDrawing = true;
                        const pos = getPosition(e);
                        [lastX, lastY] = [pos.x, pos.y];
                    }
                    
                    function draw(e) {
                        if (!isDrawing) return;
                        e.preventDefault();
                        
                        const pos = getPosition(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        [lastX, lastY] = [pos.x, pos.y];
                    }
                    
                    function stopDrawing() {
                        isDrawing = false;
                    }
                    
                    function getPosition(e) {
                        const rect = canvas.getBoundingClientRect();
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        return {
                            x: clientX - rect.left,
                            y: clientY - rect.top
                        };
                    }
                    
                    // 이벤트 리스너
                    canvas.addEventListener('mousedown', startDrawing);
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('mouseup', stopDrawing);
                    canvas.addEventListener('mouseout', stopDrawing);
                    
                    canvas.addEventListener('touchstart', startDrawing);
                    canvas.addEventListener('touchmove', draw);
                    canvas.addEventListener('touchend', stopDrawing);
                    
                    signaturePads[type] = { canvas, ctx };
                });
            }, 100);
        }

        // 서명 지우기
        window.clearSignature = function(type) {
            const pad = signaturePads[type];
            if (pad) {
                pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
            }
        }

        // 캔버스가 비어있는지 확인
        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        // 계약서 미리보기
        window.previewContract = function() {
            // 필수 항목 검증
            const name = document.getElementById('contractName').value;
            const address = document.getElementById('contractAddress').value;
            const jumin1 = document.getElementById('contractJumin1').value;
            const jumin2 = document.getElementById('contractJumin2').value;
            const phone = document.getElementById('contractPhone').value;
            const email = document.getElementById('contractEmail').value;
            const startDate = document.getElementById('contractStartDate').value;
            const endDate = document.getElementById('contractEndDate').value;
            
            if (!name || !address || !jumin1 || !jumin2 || !phone || !email || 
                !startDate || !endDate) {
                alert('필수 항목을 모두 입력해주세요');
                return;
            }
            
            // 서명 확인
            const ceoSigned = signaturePads['CEO'] && !isCanvasBlank(signaturePads['CEO'].canvas);
            const freelancerSigned = signaturePads['Freelancer'] && !isCanvasBlank(signaturePads['Freelancer'].canvas);
            
            if (!ceoSigned && !freelancerSigned) {
                alert('최소 한 명은 서명이 필요합니다');
                return;
            }
            
            // 미리보기 생성
            const business = document.getElementById('contractBusiness').value;
            const notes = document.getElementById('contractNotes').value;
            
            // ✅ price와 payDay 정의 추가
            const price = '일당 1만~50만원 (업무별 상이)';
            const payDay = '업무 완료 후 1개월 이내';
            
            // 서명 이미지 가져오기
            const signatureCEO = ceoSigned ? signaturePads['CEO'].canvas.toDataURL() : null;
            const signatureFreelancer = freelancerSigned ? signaturePads['Freelancer'].canvas.toDataURL() : null;
            
            const previewHTML = generateContractHTML({
                name, address, jumin1, jumin2, phone, email, business,
                startDate, endDate, price, payDay, notes,
                signatureCEO, signatureFreelancer
            });
            
            document.getElementById('contractPreviewContent').innerHTML = previewHTML;
            document.getElementById('contractPreviewModal').style.display = 'block';
        }

        // PDF 다운로드 (HTML을 이미지로 변환)
        window.downloadContractPDF = async function() {
            const name = document.getElementById('contractName').value;
            const address = document.getElementById('contractAddress').value;
            const jumin1 = document.getElementById('contractJumin1').value;
            const jumin2 = document.getElementById('contractJumin2').value;
            const phone = document.getElementById('contractPhone').value;
            const email = document.getElementById('contractEmail').value;
            const startDate = document.getElementById('contractStartDate').value;
            const endDate = document.getElementById('contractEndDate').value;
            
            if (!name || !address || !jumin1 || !jumin2 || !phone || !email || !startDate || !endDate) {
                alert('필수 항목을 모두 입력해주세요');
                return;
            }
            
            const ceoSigned = signaturePads['CEO'] && !isCanvasBlank(signaturePads['CEO'].canvas);
            const freelancerSigned = signaturePads['Freelancer'] && !isCanvasBlank(signaturePads['Freelancer'].canvas);
            
            if (!ceoSigned && !freelancerSigned) {
                alert('최소 한 명은 서명이 필요합니다');
                return;
            }
            
            try {
                showToast('PDF 생성 중...', 'info');
                
                const business = document.getElementById('contractBusiness').value;
                const notes = document.getElementById('contractNotes').value;
                const price = '일당 1만~50만원 (업무별 상이)';
                const payDay = '업무 완료 후 1개월 이내';
                
                // 서명 이미지 가져오기
                const signatureCEO = ceoSigned ? signaturePads['CEO'].canvas.toDataURL() : null;
                const signatureFreelancer = freelancerSigned ? signaturePads['Freelancer'].canvas.toDataURL() : null;
                
                // HTML 생성 (서명 포함)
                const contractHTML = generateContractHTML({
                    name, address, jumin1, jumin2, phone, email, business,
                    startDate, endDate, price, payDay, notes,
                    signatureCEO, signatureFreelancer
                });
                
                // 임시 div 생성
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = '794px';
                tempDiv.style.background = 'white';
                tempDiv.innerHTML = contractHTML;
                document.body.appendChild(tempDiv);
                
                // HTML을 이미지로 변환
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // div 제거
                document.body.removeChild(tempDiv);
                
                // PDF 생성
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const doc = new jsPDF('p', 'mm', 'a4');
                let heightLeft = imgHeight;
                let position = 0;
                
                // 첫 페이지
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;
                
                // 추가 페이지 (필요시)
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                }
                
                const fileName = `프리랜서계약서_${name}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('✅ PDF 다운로드 완료!', 'success');
                
            } catch (error) {
                console.error('❌ PDF 생성 실패:', error);
                alert('PDF 생성 실패: ' + error.message);
            }
        }


        // 미리보기 닫기
        window.closePreview = function() {
            document.getElementById('contractPreviewModal').style.display = 'none';
        }

        // 계약서 저장
        window.saveContract = async function() {
            // 유효성 검사
            const name = document.getElementById('contractName').value;
            if (!name) {
                alert('필수 항목을 입력해주세요');
                return;
            }
            
            const contractData = {
                name: document.getElementById('contractName').value,
                address: document.getElementById('contractAddress').value,
                jumin1: document.getElementById('contractJumin1').value,
                jumin2: document.getElementById('contractJumin2').value,
                phone: document.getElementById('contractPhone').value,
                email: document.getElementById('contractEmail').value,
                business: document.getElementById('contractBusiness').value,
                startDate: document.getElementById('contractStartDate').value,
                endDate: document.getElementById('contractEndDate').value,
                price: '일당 1만~50만원 (업무별 상이)',
                payDay: '업무 완료 후 1개월 이내',
                notes: document.getElementById('contractNotes').value,
                signatureCEO: signaturePads['CEO'] ? signaturePads['CEO'].canvas.toDataURL() : null,
                signatureFreelancer: signaturePads['Freelancer'] ? signaturePads['Freelancer'].canvas.toDataURL() : null,
                createdAt: new Date().toISOString()
            };
            
            try {
                const db = await initContractDB();
                const tx = db.transaction('contracts', 'readwrite');
                const store = tx.objectStore('contracts');
                
                store.add(contractData);
                
                tx.oncomplete = () => {
                    showToast('✅ 계약서가 저장되었습니다!', 'success');
                    showContractList();
                };
                
                tx.onerror = () => {
                    throw new Error('저장 실패');
                };
            } catch (error) {
                console.error('저장 실패:', error);
                alert('저장에 실패했습니다: ' + error.message);
            }
        }

        // 계약서 HTML 생성
        function generateContractHTML(data) {
            return `
                <div style="font-family: '맑은 고딕', sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2 style="text-align: center; margin-bottom: 25px; color: #10b981; font-size: 26px;">
                        표준 프리랜서 계약서
                    </h2>
                    
                    <div style="margin-bottom: 25px; text-align: justify; line-height: 1.7; font-size: 14px;">
                        <strong>더홈점검</strong> (이하 "갑"이라 합니다)은 
                        <strong>${data.name}</strong> (이하 "을"이라 합니다)에게 
                        아파트사전점검 대행업무를 의뢰하면서 다음과 같이 프리랜서 계약을 체결한다.
                    </div>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제1조 【목적】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        본 계약은 "갑"이 "을"에게 연구 및 용역을 의뢰함에 있어 필요한 사항을 정하는 것을 목적으로 한다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제2조 【계약업무】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 5px;">
                        "을"은 "갑"이 의뢰한 다음 각 호의 과업을 수행하여야 한다.
                    </p>
                    <p style="margin-left: 20px; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        1. 아파트사전점검 대행 서비스
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제3조 【계약기간】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        계약기간은 <strong>${data.startDate}</strong>로부터 <strong>${data.endDate}</strong>까지로 하며, 
                        "갑"과 "을"의 합의 하에 본 계약기간은 연장되거나 해지될 수 있다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제4조 【근무시간 및 장소】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        "을"은 "갑"이 지정하는 근무시간 및 근무장소에서 업무를 성실히 수행하여야 한다. 
                        다만, "갑"과 합의하여 근무 시간과 근무장소를 조정할 수 있다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제5조 【계약금액】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① 총 계약금액은 일당 1만원~50만원으로 한다. 
                        <strong style="color: #ef4444;">(업무에 따라 지급비용이 다르게 지급됨)</strong>
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② "갑"은 "을"에게 아파트사전점검 업무 완료 후 
                        <strong style="color: #ef4444;">1개월 이내에</strong> "을" 명의의 계좌로 이체한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ③ "갑"은 전 항의 보수 중 사업소득세율(3.3%)에 따라 원천징수의무를 이행한 후 
                        남은 금액을 "을"에게 지급한다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제6조 【양 당사자의 권리와 의무】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① "갑"은 "을"이 과업하는데 필요한 자료 및 정보 등을 제공하여야 하며, 
                        과업수행을 위한 "을"의 요청이 있는 경우 이에 적극적으로 협조하여야 한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② "을"은 본 계약상 부담하는 모든 사항을 "갑"과 합의한 대로 이행하여야 하며, 
                        신의성실의 원칙에 따라 계약 내용을 이행하여야 한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ③ "갑"은 "을"의 과업과 관련하여 협의할 사항이 있는 경우 "을"에게 협의를 요청할 수 있고 
                        "을"은 이러한 "갑"의 요구에 최대한 협조한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ④ "을"은 본 계약 종료 후 지체없이 "갑"으로부터 제공받은 서류, 정보, 데이터 기타 
                        모든 형태의 자료를 "갑"에게 반환하여야 하고, 반환이 어려운 경우 이를 파기하고 
                        "갑"의 승인을 받아야 한다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제7조 【비밀유지 및 지식재산권의 귀속】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① "을"은 본 계약 및 과업과 관련하여 알게 된 일체의 정보를 외부에 누설하거나 
                        유출해서는 아니되며, 이로 인해 발생하는 손해에 대해 책임을 지기로 한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② "을"은 창조, 개선, 작성, 생산한 모든 결과물의 저작권에 대한 책임을 보증하며, 
                        본 계약에 의한 결과물의 권리는 "갑"의 소유가 된다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제8조 【근무조건】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① 본 계약상의 업무를 수행하기 위하여 필요한 기타사항은 자유로 한다.
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② 본 계약 내용 외에도 다른 필요한 업무가 필요한 경우 "갑"은 "을"이 추가로 
                        작업을 수행하는 부분에 대한 인건비와 계약 기간은 상호 협의 하에 결정한다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제9조 【권리의 이전·양도·처분·재위탁 금지】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        "갑" 또는 "을"은 서로 상대방의 서면 동의가 있는 경우를 제외하고는 어떠한 이유로도 
                        본 계약상 자신의 권리나 의무를 다른 제3자에게 이전·양도·처분·재위탁할 수 없다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제10조 【해지】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① "갑"과 "을"은 다음 각 호에 해당될 경우 본 계약을 해지할 수 있다.
                    </p>
                    <p style="margin-left: 20px; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        1. 정당한 이유 없이 과업 진행이 이루어지지 않을 때<br>
                        2. 정당한 이유 없이 계약기간 내에 과업완료가 불가능하다고 판단될 때<br>
                        3. 상호간에 계약을 해지하기로 서면합의한 때<br>
                        4. 회생절차, 파산절차의 개시신청, 채무자 회생 및 파산에 관한 법률에 의한 보전처분의 신청, 
                           기타 이와 유사한 신청, 회사의 해산결의 등의 사유가 발생한 때<br>
                        5. 압류, 가압류, 가처분, 경매의 집행을 받거나 국세나 지방세 체납, 기타 공법상의 처분을 받고 
                           7일 이내에 집행취소나 체납 등 처분의 취소를 받지 않은 때<br>
                        6. 기타 본 계약상의 과업을 수행하는 것이 불가능하다고 객관적으로 판단될 때
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② 본 조에 따른 계약의 해지는 계약기간 중 발생한 당사자 간의 권리의무에 따른 
                        손해배상의 청구에 영향을 미치지 않는다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제11조 【손해배상】
                    </h3>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ① "을"의 귀책사유로 인하여 본 계약이 불이행 되었을 경우 "을"은 "갑"이 제시한 
                        손해배상의 책임을 진다(이때, 손해배상액은 상호 협의 한다).
                    </p>
                    <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        ② "을"의 귀책사유로 인하여 기타 제3자에게 손해가 발생하는 경우 이는 "을"이 부담하며, 
                        "갑"이 전부 또는 일부를 배상한 때에는 "갑"이 "을"에게 이를 구상할 수 있다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제12조 【일부무효】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        본 계약의 일부 조항이 법령 또는 판결에 의하여 무효 또는 불법으로 판정되는 경우에도 
                        본 계약 전체가 무효로 되는 것은 아니며, 무효로 되지 않는 다른 조항은 법령에 의하여 
                        허용되는 한도에서 여전히 유효하게 존속하고, 무효 또는 불법조항이 포함되지 않았던 것처럼 해석한다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제13조 【계약의 변경】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        본 계약은 "갑"과 "을"의 서면합의에 따라 변경될 수 있다.
                    </p>
                    
                    <h3 style="color: #10b981; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px; font-size: 15px;">
                        제14조 【관할】
                    </h3>
                    <p style="text-align: justify; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                        본 계약과 관련하여 분쟁이 발생한 경우 당사자의 상호 협의에 의한 해결을 모색하되, 
                        분쟁에 관한 합의가 이루어지지 아니한 경우에는 "갑"의 본점 소재지 관할법원을 
                        제1심 관할법원으로 하여 소송을 통해 분쟁을 해결하기로 한다.
                    </p>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <p style="text-align: center; margin-bottom: 30px; line-height: 1.6; font-size: 13px; margin-bottom: 15px;">
                            각 당사자는 위 계약을 증명하기 위하여 본 계약서 2통을 작성하여,<br>
                            각각 서명(또는 기명)날인 후 "갑"과 "을"이 각각 1통씩을 보관한다.
                        </p>
                        
                        <p style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 40px;">
                            ${new Date().getFullYear()}년 ${new Date().getMonth() + 1}월 ${new Date().getDate()}일
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                            <div style="border: 2px solid #10b981; padding: 15px; border-radius: 8px; background: white;">
                                <h4 style="color: #10b981; margin-bottom: 10px; text-align: center; font-size: 16px;">【갑】</h4>
                                <p style="line-height: 1.6; font-size: 13px;">
                                    <strong>대표자:</strong> 박지현 (더홈점검)<br>
                                    <strong>주소:</strong> 경기도 부천시 원미구 송내대로265번길 23, 201호<br>
                                    <strong>사업자번호:</strong> 531-42-01293<br>
                                    <strong>연락처:</strong> 070-8019-1456
                                </p>
                                ${data.signatureCEO ? `
                                    <div style="margin-top: 10px; text-align: center;">
                                        <img src="${data.signatureCEO}" style="max-width: 150px; max-height: 60px; border: 1px solid #ddd; padding: 5px; background: white;" alt="CEO 서명">
                                        <p style="font-size: 11px; color: #666; margin-top: 5px;">(서명)</p>
                                    </div>
                                ` : `
                                    <div style="margin-top: 10px; padding: 30px; border: 1px dashed #ddd; text-align: center; color: #999; font-size: 12px;">
                                        서명 없음
                                    </div>
                                `}
                            </div>
                            
                            <div style="border: 2px solid #10b981; padding: 15px; border-radius: 8px; background: white;">
                                <h4 style="color: #10b981; margin-bottom: 10px; text-align: center; font-size: 16px;">【을】</h4>
                                <p style="line-height: 1.6; font-size: 13px;">
                                    <strong>성명:</strong> ${data.name}<br>
                                    <strong>주소:</strong> ${data.address}<br>
                                    <strong>주민등록번호:</strong> ${data.jumin1}-${data.jumin2}******<br>
                                    <strong>연락처:</strong> ${data.phone}<br>
                                    <strong>이메일:</strong> ${data.email}
                                    ${data.business ? `<br><strong>사업자번호:</strong> ${data.business}` : ''}
                                </p>
                                ${data.signatureFreelancer ? `
                                    <div style="margin-top: 10px; text-align: center;">
                                        <img src="${data.signatureFreelancer}" style="max-width: 150px; max-height: 60px; border: 1px solid #ddd; padding: 5px; background: white;" alt="프리랜서 서명">
                                        <p style="font-size: 11px; color: #666; margin-top: 5px;">(서명)</p>
                                    </div>
                                ` : `
                                    <div style="margin-top: 10px; padding: 30px; border: 1px dashed #ddd; text-align: center; color: #999; font-size: 12px;">
                                        서명 없음
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    ${data.notes ? `
                        <div style="margin-top: 30px; padding: 20px; background: #fffbeb; border-radius: 8px; border-left: 5px solid #fbbf24;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">📌 특이사항</h4>
                            <p style="line-height: 1.6; font-size: 13px; margin-bottom: 15px; color: #92400e;">${data.notes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 계약서 보기
        window.viewContract = async function(id) {
            try {
                const db = await initContractDB();
                const tx = db.transaction('contracts', 'readonly');
                const store = tx.objectStore('contracts');
                const request = store.get(id);
                
                request.onsuccess = () => {
                    const contract = request.result;
                    if (!contract) {
                        alert('계약서를 찾을 수 없습니다');
                        return;
                    }
                    
                    const html = generateContractHTML(contract);
                    document.getElementById('contractPreviewContent').innerHTML = html;
                    document.getElementById('contractPreviewModal').style.display = 'block';
                };
            } catch (error) {
                console.error('조회 실패:', error);
                alert('계약서를 불러올 수 없습니다');
            }
        }

        // PDF 생성
        window.generateContractPDF = function() {
            showToast('📄 인쇄 화면으로 이동합니다', 'info');
            setTimeout(() => {
                window.print();
            }, 500);
        }



        // 계약서 삭제
        window.deleteContract = async function(id) {
            if (!confirm('정말 이 계약서를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const db = await initContractDB();
                const tx = db.transaction('contracts', 'readwrite');
                const store = tx.objectStore('contracts');
                
                store.delete(id);
                
                tx.oncomplete = () => {
                    showToast('삭제되었습니다', 'success');
                    loadContracts();
                };
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('삭제에 실패했습니다');
            }
        }

        // 페이지 로드 시 계약서 데이터 로드
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('contract')) {
                loadContracts();
            }
        });

    </script>
</body>
</html>
