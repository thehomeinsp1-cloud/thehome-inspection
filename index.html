<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>더홈점검 - 하자관리 시스템</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="더홈점검">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- jsPDF + html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google API Client Library -->
    <!-- Google API (광고차단기로 인해 주석 처리) -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <!-- <script src="https://accounts.google.com/gsi/client" async defer></script> -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #fbbf24;
            --danger: #ef4444;
            --bg-dark: #1a202c;
            --bg-darker: #111827;
            --card-bg: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 5px;
            margin: 20px 0;
            gap: 5px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        /* 평면도 관리 */
        .floorplan-container {
            text-align: center;
        }

        .floorplan-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid var(--border);
        }

        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-action-btn {
            padding: 14px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .photo-action-btn.camera {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .photo-action-btn:active {
            transform: scale(0.98);
        }

        /* 하자 목록 */
        .defect-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .defect-number {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .defect-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 공기질 측정 */
        .air-quality-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        .air-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .air-room-name-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
        }

        .air-room-delete {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .air-inputs {
            display: grid;
            gap: 12px;
        }

        .air-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .air-input-group label {
            min-width: 100px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .air-input-group input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            text-align: center;
        }

        .air-input-group span {
            color: var(--text-secondary);
            font-size: 12px;
            min-width: 80px;
        }

        .air-add-btn {
            width: 100%;
            padding: 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .air-add-btn:active {
            transform: scale(0.98);
        }

        .reference-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* 데이터 관리 */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .saved-info {
            flex: 1;
        }

        .saved-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .saved-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saved-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .icon-btn.load {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
        }

        .icon-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Toast 알림 */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 카메라 모달 */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .camera-modal.active {
            display: flex;
        }

        #cameraPreview {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
        }

        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: var(--primary);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .camera-btn.close {
            background: var(--danger);
        }

        /* 플로팅 버튼 */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .floating-btn:active {
            transform: scale(0.95);
        }

        .floating-btn:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        /* 로딩 */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 40px;
            border-radius: 16px;
            z-index: 2000;
            text-align: center;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 반응형 */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* 선택 박스 스타일 */
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* 입력 필드 비활성화 스타일 */
        .form-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 터치 버튼 스타일 */
        .touch-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .touch-btn {
            padding: 10px 8px;
            border: 2px solid var(--border);
            background: rgba(30, 41, 59, 0.3);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .touch-btn:active {
            transform: scale(0.95);
        }

        .touch-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .touch-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
    </style>

</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <h1>🏠 더홈점검</h1>
        <p>하자관리 시스템 v3.2 (사진 2장 촬영)</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <div class="container">
        <!-- 탭 메뉴 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">📝 프로젝트</button>
            <button class="tab" onclick="switchTab('defects', event)">🔍 하자점검</button>
            <button class="tab" onclick="switchTab('equipment', event)">📸 장비점검</button>
            <button class="tab" onclick="switchTab('airquality', event)">🌬️ 공기질</button>
            <button class="tab" onclick="switchTab('data', event)">💾 데이터</button>
        </div>

        <!-- 프로젝트 정보 섹션 -->
        <div id="project" class="section active">
            <!-- 프로젝트 목록 카드 -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <h2 style="color: white; margin-bottom: 15px;">📋 프로젝트 목록</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="addNewProject()" class="btn" style="background: white; color: #667eea; flex: 1; min-width: 120px;">
                        ➕ 새 프로젝트
                    </button>
                    <button onclick="deleteCurrentProject()" class="btn" style="background: rgba(255,255,255,0.2); color: white; flex: 1; min-width: 120px;">
                        🗑️ 현재 삭제
                    </button>
                </div>

                <div id="projectList" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- 프로젝트 목록이 여기 표시됩니다 -->
                </div>

                <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                    💡 팁: 하루에 여러 프로젝트를 작업할 수 있습니다. 프로젝트를 클릭하면 전환됩니다.
                </div>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📝 프로젝트 정보</h2>
                
                <div class="form-field">
                    <label class="form-label">아파트명</label>
                    <input type="text" class="form-input" id="apartmentName" placeholder="예: 래미안 아파트" oninput="autoSaveProjectData()">
                </div>

                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">동</label>
                        <input type="text" class="form-input" id="dong" placeholder="예: 101동" oninput="autoSaveProjectData()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">호수</label>
                        <input type="text" class="form-input" id="ho" placeholder="예: 502호" oninput="autoSaveProjectData()">
                    </div>
                </div>

                <div class="form-field">
                    <label class="form-label">점검일자</label>
                    <input type="date" class="form-input" id="inspectionDate" onchange="autoSaveProjectData()">
                </div>

                <div class="form-field">
                    <label class="form-label">고객명</label>
                    <input type="text" class="form-input" id="customerName" placeholder="고객 이름" oninput="autoSaveProjectData()">
                </div>

                <div class="form-field">
                    <label class="form-label">연락처</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="010-0000-0000" oninput="autoSaveProjectData()">
                </div>

                <button class="btn btn-primary" onclick="saveProject()">✅ 프로젝트 정보 저장</button>
            </div>

            <!-- 평면도 섹션 통합 -->
            <div class="card" style="margin-top: 20px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📐 평면도 관리</h2>
                
                <div class="floorplan-container">
                    <img id="floorplanPreview" class="floorplan-preview" style="display: none;">
                    <p id="floorplanPlaceholder" style="color: var(--text-secondary); padding: 60px 0;">
                        평면도를 추가해주세요
                    </p>
                    
                    <div class="photo-actions">
                        <button class="photo-action-btn camera" onclick="openFloorplanCamera()">
                            📷 촬영하기
                        </button>
                        <button class="photo-action-btn" onclick="openFloorplanGallery()">
                            🖼️ 갤러리
                        </button>
                    </div>

                    <button class="btn btn-danger" onclick="deleteFloorplan()" style="margin-top: 15px;">
                        🗑️ 평면도 삭제
                    </button>
                </div>
            </div>
        </div>

        <!-- 하자 점검 섹션 -->
        <div id="defects" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🔍 하자 점검</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    우측 하단의 ➕ 버튼을 눌러 하자를 추가하세요
                </p>
            </div>

            <div id="defectsList"></div>
        </div>

        <!-- 장비점검 섹션 -->
        <div id="equipment" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">📸 장비 점검 LIST</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    열화상 카메라 및 실물 사진 촬영 (우측 하단 ➕ 버튼)
                </p>
            </div>

            <div id="equipmentList"></div>
        </div>

        <!-- 공기질 측정 섹션 -->
        <div id="airquality" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🌬️ 공기질 측정</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    실내 공기질을 측정하고 기록하세요
                </p>
            </div>

            <div id="airQualityList"></div>

            <button class="air-add-btn" onclick="addAirQualityRoom()">
                ➕ 방 추가
            </button>

            <div class="card reference-info">
                <strong>📋 권고기준</strong><br>
                라돈: 148 Bq/m³ 이하<br>
                포름알데히드: 0.210 mg/m³ 이하<br>
                총휘발성유기화합물: 0.500 mg/m³ 이하
            </div>
        </div>

        <!-- 데이터 관리 섹션 -->
        <div id="data" class="section">
            <!-- Google Drive 연동 카드 -->
            <div class="card" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; margin-bottom: 20px;">
                <h2 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <path d="M6.5 12L1 21h11l5.5-9H6.5zM19 12l-5.5-9L8 12h11zM7.5 3l-6 9h11l-5-9z"/>
                        </svg>
                        Google Drive 연동
                    </div>
                    <div id="onlineStatus" style="font-size: 14px; padding: 4px 12px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; gap: 6px;">
                        🟢 온라인
                    </div>
                </h2>
                
                <div id="googleDriveStatus" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px;">
                    <div id="notSignedIn" style="display: block;">
                        ⚠️ 로그인이 필요합니다. 구글 계정으로 로그인하면 팀원들과 데이터를 실시간으로 공유할 수 있습니다.
                    </div>
                    <div id="signedIn" style="display: none;">
                        ✅ <span id="userEmail"></span>님 로그인됨
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="signInBtn" class="btn" onclick="handleGoogleSignIn()" style="flex: 1; background: white; color: #4285f4; font-weight: bold;">
                        🔐 Google 로그인
                    </button>
                    <button id="signOutBtn" class="btn" onclick="handleGoogleSignOut()" style="flex: 1; background: rgba(255,255,255,0.2); color: white; display: none;">
                        🚪 로그아웃
                    </button>
                </div>
                
                <!-- 동기화 버튼 (오프라인 작업 시 표시) -->
                <button id="syncBtn" class="btn" onclick="syncPendingProjects()" style="display: none; margin-top: 10px; background: #fbbf24; color: #1a202c; font-weight: bold; position: relative;">
                    <span id="syncBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
                    📤 대기 프로젝트 동기화
                </button>
            </div>

            <!-- 클라우드 저장/불러오기 -->
            <div class="card" id="cloudActionsCard" style="display: none;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">☁️ 클라우드 저장소</h3>
                
                <button class="btn btn-primary" onclick="uploadProjectToDrive()" style="margin-bottom: 10px;">
                    ☁️ Drive에 저장
                </button>
                
                <button class="btn btn-secondary" onclick="loadFromDrive()" style="margin-bottom: 10px;">
                    📥 Drive에서 불러오기
                </button>

                <button class="btn" onclick="showDriveProjects()" style="background: #34a853; color: white;">
                    📂 프로젝트 목록 보기
                </button>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">💾 로컬 데이터 관리</h2>
                
                <button class="btn btn-primary" onclick="generatePDF()">📄 PDF 보고서 생성</button>
                
                <div style="height: 20px;"></div>
                
                <button class="btn btn-secondary" onclick="saveCurrentData()">💾 로컬 저장</button>
                
                <div style="height: 20px;"></div>
                
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ 모든 데이터 삭제</button>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">📦 로컬 저장 프로젝트</h3>
                <div id="savedList" class="saved-list"></div>
            </div>
        </div>
    </div>

    <!-- 카메라 모달 -->
    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="camera-btn" onclick="capturePhoto()" ontouchstart="">📸</button>
            <button class="camera-btn close" onclick="closeCameraModal()" ontouchstart="">✕</button>
        </div>
    </div>

    <!-- 플로팅 하자/장비 추가 버튼 -->
    <button id="floatingAddBtn" class="floating-btn" onclick="handleFloatingBtnClick()" style="display: none;">
        ➕
    </button>

    <!-- 로딩 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>처리 중...</p>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Drive 프로젝트 목록 모달 -->
    <div id="driveProjectsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-dark); border-radius: 12px; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary);">📂 Drive 프로젝트 목록</h2>
                <button onclick="closeDriveProjectsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
            </div>
            <div id="driveProjectsList" style="max-height: 60vh; overflow-y: auto;">
                <!-- 프로젝트 목록이 여기 표시됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // ==================== 온라인/오프라인 상태 관리 ====================
        let isOnline = navigator.onLine;
        let pendingSyncProjects = []; // 동기화 대기 프로젝트
        
        // Service Worker는 환경 제약으로 제거
        // localStorage를 사용한 데이터 저장으로 대체
        
        // 온라인/오프라인 상태 감지
        window.addEventListener('online', () => {
            isOnline = true;
            updateOnlineStatus();
            showToast('✅ 온라인 연결됨', 'success');
            
            // 동기화 대기 중인 프로젝트 확인
            loadPendingSyncProjects();
            if (pendingSyncProjects.length > 0) {
                setTimeout(() => {
                    if (confirm(`동기화 대기 중인 프로젝트가 ${pendingSyncProjects.length}건 있습니다.\n지금 드라이브에 업로드하시겠습니까?`)) {
                        syncPendingProjects();
                    }
                }, 1000);
            }
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateOnlineStatus();
            showToast('📶 오프라인 모드 - 작업 내용은 로컬에 저장됩니다', 'warning');
        });
        
        // 온라인 상태 표시 업데이트
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.innerHTML = '🟢 온라인';
                    statusIndicator.style.color = '#10b981';
                } else {
                    statusIndicator.innerHTML = '🔴 오프라인';
                    statusIndicator.style.color = '#ef4444';
                }
            }
        }
        
        // localStorage 기반 동기화 대기 관리
        function loadPendingSyncProjects() {
            try {
                const saved = localStorage.getItem('pendingSyncProjects');
                if (saved) {
                    pendingSyncProjects = JSON.parse(saved);
                    updateSyncBadge();
                }
            } catch (error) {
                console.error('동기화 목록 로드 실패:', error);
                pendingSyncProjects = [];
            }
        }
        
        function savePendingSyncProjects() {
            try {
                localStorage.setItem('pendingSyncProjects', JSON.stringify(pendingSyncProjects));
                updateSyncBadge();
            } catch (error) {
                console.error('동기화 목록 저장 실패:', error);
            }
        }
        
        function addToPendingSync(projectData) {
            projectData.syncTimestamp = Date.now();
            pendingSyncProjects.push(projectData);
            savePendingSyncProjects();
            
            // 동기화 버튼 표시
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) syncBtn.style.display = 'block';
        }
        
        function removePendingSyncProject(index) {
            pendingSyncProjects.splice(index, 1);
            savePendingSyncProjects();
        }
        
        // 동기화 뱃지 업데이트
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (pendingSyncProjects.length > 0) {
                    badge.textContent = pendingSyncProjects.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // 대기 중인 프로젝트 동기화
        async function syncPendingProjects() {
            if (!isOnline) {
                showToast('❌ 인터넷 연결이 필요합니다', 'error');
                return;
            }
            
            if (pendingSyncProjects.length === 0) {
                showToast('✅ 동기화할 프로젝트가 없습니다', 'success');
                return;
            }
            
            showLoading('동기화 중...');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = pendingSyncProjects.length - 1; i >= 0; i--) {
                try {
                    const project = pendingSyncProjects[i];
                    await uploadProjectToDrive(project);
                    removePendingSyncProject(i);
                    successCount++;
                } catch (error) {
                    console.error('동기화 실패:', error);
                    failCount++;
                }
            }
            
            hideLoading();
            
            if (failCount === 0) {
                showToast(`✅ 모든 프로젝트(${successCount}건)가 동기화되었습니다`, 'success');
            } else {
                showToast(`⚠️ ${successCount}건 성공, ${failCount}건 실패`, 'warning');
            }
            
            // 동기화 버튼 숨기기
            if (pendingSyncProjects.length === 0) {
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) syncBtn.style.display = 'none';
            }
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            loadPendingSyncProjects();
            updateOnlineStatus();
        });
        
        // ==================== Google OAuth2 직접 구현 (광고차단기 우회) ====================
        const GOOGLE_CLIENT_ID = '41297273395-akfc0j40utujca3ofvbdmmqdlh449do2.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyBNAkir6I-_MudQIpQHooyaxafA7HrkcGQ';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        
        let accessToken = null;
        let currentUser = null;

        // ==================== 프로젝트 목록 관리 ====================
        let projects = []; // 모든 프로젝트 목록
        let currentProjectId = null; // 현재 작업 중인 프로젝트 ID

        // 프로젝트 템플릿
        function createNewProject() {
            return {
                id: Date.now(),
                apartmentName: '',
                dong: '',
                ho: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                customerName: '',
                customerPhone: '',
                floorplan: null,
                defects: [],
                equipment: [],
                airQuality: [],
                createdAt: new Date().toISOString(),
                isUploaded: false
            };
        }

        // 현재 프로젝트 가져오기
        function getCurrentProject() {
            if (projects.length === 0) {
                const newProject = createNewProject();
                projects.push(newProject);
                currentProjectId = newProject.id;
            }
            return projects.find(p => p.id === currentProjectId) || projects[0];
        }

        // 하위 호환성을 위한 projectData
        let projectData = getCurrentProject();

        let defectIdCounter = 1;
        let equipmentIdCounter = 1;
        let airQualityIdCounter = 1;
        let cameraStream = null;
        let currentPhotoTarget = null;

        // ==================== Google API 초기화 ====================
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // ==================== OAuth2 팝업 로그인 ====================
        async function handleGoogleSignIn() {
            console.log('🔵 OAuth2 팝업 로그인 시작...');
            
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams({
                client_id: GOOGLE_CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: SCOPES,
                prompt: 'consent'
            });
            
            // 팝업으로 로그인
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popup = window.open(
                authUrl,
                'Google Login',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!popup) {
                showToast('❌ 팝업이 차단되었습니다');
                return;
            }
        }
        
        // 메시지 수신 (팝업에서 토큰 전달)
        window.addEventListener('message', async (event) => {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'GOOGLE_AUTH') {
                const token = event.data.accessToken;
                if (token) {
                    accessToken = token;
                    localStorage.setItem('google_access_token', accessToken);
                    console.log('✅ 토큰 저장 완료');
                    
                    // 사용자 정보 가져오기
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                        if (!response.ok) throw new Error('Failed');
                        
                        currentUser = await response.json();
                        console.log('✅ 로그인 성공:', currentUser.email);
                        
                        updateSignInStatus(true);
                        showToast('✅ ' + currentUser.email + ' 로그인 성공!');
                        
                    } catch (error) {
                        console.error('❌ 사용자 정보 가져오기 실패:', error);
                        showToast('❌ 로그인 오류');
                        accessToken = null;
                        localStorage.removeItem('google_access_token');
                    }
                }
            }
        });
        
        // URL에서 토큰 추출 (리다이렉트 콜백)
        function checkUrlForToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token && window.opener) {
                // 부모 창으로 토큰 전달
                window.opener.postMessage({
                    type: 'GOOGLE_AUTH',
                    accessToken: token
                }, window.location.origin);
                window.close();
            }
        }
        
        // 페이지 로드 시 토큰 체크
        checkUrlForToken();
        
        // 저장된 토큰으로 자동 로그인
        async function checkIfSignedIn() {
            const token = localStorage.getItem('google_access_token');
            if (token) {
                accessToken = token;
                
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                    if (!response.ok) throw new Error('Token expired');
                    
                    currentUser = await response.json();
                    updateSignInStatus(true);
                    console.log('✅ 자동 로그인:', currentUser.email);
                } catch (error) {
                    console.log('❌ 토큰 만료');
                    accessToken = null;
                    localStorage.removeItem('google_access_token');
                }
            }
        }

        function handleGoogleSignOut() {
            if (accessToken) {
                // Google OAuth2 토큰 해지
                fetch('https://accounts.google.com/o/oauth2/revoke?token=' + accessToken);
                
                accessToken = null;
                currentUser = null;
                localStorage.removeItem('google_access_token');
                updateSignInStatus(false);
                showToast('로그아웃되었습니다');
            }
        }

        function updateSignInStatus(isSignedIn) {
            try {
                if (isSignedIn) {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const userEmail = document.getElementById('userEmail');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'none';
                    if (signedIn) signedIn.style.display = 'block';
                    if (userEmail) userEmail.textContent = currentUser?.email || '사용자';
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (signOutBtn) signOutBtn.style.display = 'block';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'block';
                } else {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'block';
                    if (signedIn) signedIn.style.display = 'none';
                    if (signInBtn) signInBtn.style.display = 'block';
                    if (signOutBtn) signOutBtn.style.display = 'none';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'none';
                }
                console.log('✅ UI 업데이트 완료:', isSignedIn ? '로그인' : '로그아웃');
            } catch (e) {
                console.error('UI 업데이트 오류:', e);
            }
        }

        // ==================== Drive 폴더 관리 ====================
        async function getOrCreateAppFolder() {
            try {
                // "더홈점검" 폴더 찾기
                const response = await gapi.client.drive.files.list({
                    q: "name='더홈점검' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // 폴더가 없으면 생성
                const folderMetadata = {
                    name: '더홈점검',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('폴더 생성/찾기 오류:', error);
                throw error;
            }
        }

        // ==================== Drive 저장 ====================
        

        // ==================== Drive 불러오기 ====================
                async function createProjectFolder(appFolderId, projectName) {
            try {
                const folderMetadata = {
                    name: projectName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [appFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id, name'
                });

                return folder.result.id;
            } catch (error) {
                console.error('프로젝트 폴더 생성 오류:', error);
                throw error;
            }
        }

        // 하자사진 폴더 생성

        async function createPhotosFolder(projectFolderId) {
            try {
                const folderMetadata = {
                    name: '하자사진',
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [projectFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('사진 폴더 생성 오류:', error);
                throw error;
            }
        }

        // Base64 이미지를 Blob으로 변환

        function base64ToBlob(base64, mimeType) {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeType });
        }

        async function uploadPhoto(photosFolderId, photoData, fileName) {
            try {
                const blob = base64ToBlob(photoData, 'image/jpeg');
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: fileName,
                    mimeType: 'image/jpeg',
                    parents: [photosFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('사진 업로드 실패');
                }

                const result = await response.json();
                return result.id;
            } catch (error) {
                console.error('사진 업로드 오류:', error);
                throw error;
            }
        }

        // Google Sheets 생성 (하자 리스트)

        async function createDefectSpreadsheet(projectFolderId, projectName, defects) {
            try {
                // 스프레드시트 생성
                const spreadsheetBody = {
                    properties: {
                        title: `${projectName}_하자점검_리스트`
                    },
                    sheets: [{
                        properties: {
                            title: '하자목록'
                        }
                    }]
                };

                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    resource: spreadsheetBody
                });

                const spreadsheetId = createResponse.result.spreadsheetId;

                // 스프레드시트를 프로젝트 폴더로 이동
                await gapi.client.drive.files.update({
                    fileId: spreadsheetId,
                    addParents: projectFolderId,
                    fields: 'id, parents'
                });

                // 데이터 입력 준비
                const headers = [['No', '공간', '위치', '하자종류', '상세설명']];
                const rows = defects.map((defect, index) => {
                    // 상세설명만 사용 (이미 모든 정보 포함)
                    const description = defect.description || '';
                    
                    return [
                        index + 1,
                        defect.spaces.join(', '),
                        defect.locations.join(', '),
                        defect.types.join(', '),
                        description || '-'
                    ];
                });

                const allData = [...headers, ...rows];

                // 데이터 입력
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: allData
                    }
                });

                // 헤더 스타일 적용
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [
                            // 헤더 배경색 및 글자색
                            {
                                repeatCell: {
                                    range: {
                                        sheetId: 0,
                                        startRowIndex: 0,
                                        endRowIndex: 1
                                    },
                                    cell: {
                                        userEnteredFormat: {
                                            backgroundColor: {
                                                red: 0.06,
                                                green: 0.73,
                                                blue: 0.51
                                            },
                                            textFormat: {
                                                foregroundColor: {
                                                    red: 1,
                                                    green: 1,
                                                    blue: 1
                                                },
                                                bold: true
                                            }
                                        }
                                    },
                                    fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                }
                            },
                            // 컬럼 너비 조정
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 0,
                                        endIndex: 1
                                    },
                                    properties: {
                                        pixelSize: 50
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 1,
                                        endIndex: 2
                                    },
                                    properties: {
                                        pixelSize: 100
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 2,
                                        endIndex: 3
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 3,
                                        endIndex: 4
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 4,
                                        endIndex: 5
                                    },
                                    properties: {
                                        pixelSize: 300
                                    },
                                    fields: 'pixelSize'
                                }
                            }
                        ]
                    }
                });

                return spreadsheetId;
            } catch (error) {
                console.error('스프레드시트 생성 오류:', error);
                throw error;
            }
        }

        // 프로젝트 정보 JSON 업로드

        async function uploadProjectInfo(projectFolderId, projectData) {
            try {
                const projectInfo = {
                    apartmentName: projectData.apartmentName,
                    dong: projectData.dong,
                    ho: projectData.ho,
                    inspectionDate: projectData.inspectionDate,
                    customerName: projectData.customerName,
                    customerPhone: projectData.customerPhone,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: currentUser?.email
                };

                const blob = new Blob([JSON.stringify(projectInfo, null, 2)], { type: 'application/json' });

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: '프로젝트_정보.json',
                    mimeType: 'application/json',
                    parents: [projectFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('프로젝트 정보 업로드 실패');
                }

                return true;
            } catch (error) {
                console.error('프로젝트 정보 업로드 오류:', error);
                throw error;
            }
        }

        // 메인 업로드 함수

        async function uploadProjectToDrive(projectToUpload = null) {
            // projectToUpload가 있으면 그것 사용 (동기화용), 없으면 현재 프로젝트
            const project = projectToUpload || getCurrentProject();
            
            // 오프라인 체크
            if (!isOnline) {
                // 오프라인일 때 로컬 저장
                try {
                    addToPendingSync(project);
                    showToast('📶 오프라인 - 프로젝트가 저장되었습니다. 온라인 연결 시 동기화하세요.', 'warning');
                    return;
                } catch (error) {
                    alert('로컬 저장 실패: ' + error.message);
                    return;
                }
            }
            
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            // 필수 정보 확인
            if (!project.apartmentName || !project.dong || !project.ho) {
                alert('프로젝트 정보(아파트명, 동, 호)를 먼저 입력해주세요');
                return;
            }

            if (project.defects.length === 0) {
                alert('최소 1개 이상의 하자를 등록해주세요');
                return;
            }

            // projectToUpload가 있으면 동기화 중이므로 confirm 스킵
            if (!projectToUpload && !confirm(`"${project.apartmentName} ${project.dong} ${project.ho}"를 Google Drive에 업로드하시겠습니까?`)) {
                return;
            }

            showLoading();

            try {
                // 1. 앱 루트 폴더 가져오기/생성
                const appFolderId = await getOrCreateAppFolder();
                
                // 2. 프로젝트 폴더 생성
                const projectName = `${project.inspectionDate}_${project.apartmentName}_${project.dong}_${project.ho}`;
                const projectFolderId = await createProjectFolder(appFolderId, projectName);
                
                // 3. 하자사진 폴더 생성
                const photosFolderId = await createPhotosFolder(projectFolderId);
                
                // 4. 사진 업로드 (찍은 순서대로 1.jpg, 2.jpg...)
                let photoIndex = 1;
                const totalPhotos = project.defects.reduce((sum, defect) => sum + (defect.photos?.length || 0), 0);
                
                for (const defect of project.defects) {
                    if (defect.photos && defect.photos.length > 0) {
                        for (const photo of defect.photos) {
                            await uploadPhoto(photosFolderId, photo, `${photoIndex}.jpg`);
                            photoIndex++;
                        }
                    }
                }
                
                // 5. 하자 리스트 스프레드시트 생성
                await createDefectSpreadsheet(projectFolderId, projectName, project.defects);
                
                // 6. 프로젝트 정보 JSON 업로드
                await uploadProjectInfo(projectFolderId, project);
                
                // 7. 프로젝트 상태 업데이트
                project.isUploaded = true;
                project.uploadedAt = new Date().toISOString();
                project.driveFolderId = projectFolderId;
                
                // 8. 로컬 저장
                saveProjectsToLocalStorage();
                renderProjectList();
                
                hideLoading();
                showToast(`✅ 업로드 완료! (사진 ${totalPhotos}장)`);
                
                // 동기화 중이 아닐 때만 alert 표시
                if (!projectToUpload) {
                    alert(`✅ 업로드 완료!\n\n프로젝트: ${projectName}\n사진: ${totalPhotos}장\n하자: ${project.defects.length}개\n\nGoogle Drive에서 확인하세요!`);
                }
                
            } catch (error) {
                console.error('업로드 오류:', error);
                hideLoading();
                alert('업로드 중 오류가 발생했습니다:\n' + error.message);
            }
        }

        // ==================== Drive 불러오기 (삭제 예정) ====================


        async function loadFromDrive() {
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('불러올 프로젝트 정보(아파트명, 동, 호)를 먼저 입력해주세요');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();
                const fileName = `${projectData.apartmentName}_${projectData.dong}동_${projectData.ho}호.json`;

                // 파일 검색
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (!response.result.files || response.result.files.length === 0) {
                    hideLoading();
                    alert('해당 프로젝트를 찾을 수 없습니다');
                    return;
                }

                const fileId = response.result.files[0].id;

                // 파일 내용 다운로드
                const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!fileResponse.ok) {
                    throw new Error('파일 다운로드 실패');
                }

                const data = await fileResponse.json();

                // 데이터 로드
                projectData = {
                    apartmentName: data.apartmentName || '',
                    dong: data.dong || '',
                    ho: data.ho || '',
                    inspectionDate: data.inspectionDate || '',
                    customerName: data.customerName || '',
                    customerPhone: data.customerPhone || '',
                    floorplan: data.floorplan || null,
                    defects: data.defects || [],
                    equipment: data.equipment || [],
                    airQuality: data.airQuality || []
                };

                // ID 카운터 업데이트
                if (projectData.defects.length > 0) {
                    defectIdCounter = Math.max(...projectData.defects.map(d => d.id)) + 1;
                }
                if (projectData.equipment && projectData.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...projectData.equipment.map(e => e.id)) + 1;
                }
                if (projectData.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...projectData.airQuality.map(a => a.id)) + 1;
                }

                // UI 업데이트
                renderAll();
                saveToLocalStorage();

                hideLoading();
                showToast('✅ Drive에서 불러왔습니다!');
            } catch (error) {
                console.error('Drive 불러오기 오류:', error);
                hideLoading();
                alert('불러오기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // ==================== Drive 프로젝트 목록 ====================
        async function showDriveProjects() {
            if (!accessToken) {
                alert('먼저 Google 로그인을 해주세요');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();

                // 폴더 내 모든 JSON 파일 검색
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and mimeType='application/json' and trashed=false`,
                    fields: 'files(id, name, modifiedTime)',
                    orderBy: 'modifiedTime desc',
                    spaces: 'drive'
                });

                const files = response.result.files || [];

                hideLoading();

                if (files.length === 0) {
                    alert('저장된 프로젝트가 없습니다');
                    return;
                }

                // 모달에 목록 표시
                const listContainer = document.getElementById('driveProjectsList');
                listContainer.innerHTML = files.map(file => `
                    <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" 
                         onclick="loadDriveProjectById('${file.id}')"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'"
                         onmouseout="this.style.background='var(--card-bg)'">
                        <div style="font-weight: bold; margin-bottom: 5px;">📄 ${file.name.replace('.json', '')}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            마지막 수정: ${new Date(file.modifiedTime).toLocaleString('ko-KR')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('driveProjectsModal').style.display = 'block';
            } catch (error) {
                console.error('프로젝트 목록 불러오기 오류:', error);
                hideLoading();
                alert('목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        async function loadDriveProjectById(fileId) {
            showLoading();
            closeDriveProjectsModal();

            try {
                // 파일 내용 다운로드
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error('파일 다운로드 실패');
                }

                const data = await response.json();

                // 데이터 로드
                projectData = {
                    apartmentName: data.apartmentName || '',
                    dong: data.dong || '',
                    ho: data.ho || '',
                    inspectionDate: data.inspectionDate || '',
                    customerName: data.customerName || '',
                    customerPhone: data.customerPhone || '',
                    floorplan: data.floorplan || null,
                    defects: data.defects || [],
                    equipment: data.equipment || [],
                    airQuality: data.airQuality || []
                };

                // ID 카운터 업데이트
                if (projectData.defects.length > 0) {
                    defectIdCounter = Math.max(...projectData.defects.map(d => d.id)) + 1;
                }
                if (projectData.equipment && projectData.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...projectData.equipment.map(e => e.id)) + 1;
                }
                if (projectData.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...projectData.airQuality.map(a => a.id)) + 1;
                }

                // UI 업데이트
                renderAll();
                saveToLocalStorage();

                hideLoading();
                showToast('✅ 프로젝트를 불러왔습니다!');
            } catch (error) {
                console.error('프로젝트 불러오기 오류:', error);
                hideLoading();
                alert('불러오기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function closeDriveProjectsModal() {
            document.getElementById('driveProjectsModal').style.display = 'none';
        }

        // ==================== 프로젝트 목록 관리 함수 ====================
        
        // 프로젝트 목록 렌더링
        function renderProjectList() {
            const listContainer = document.getElementById('projectList');
            
            if (projects.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">프로젝트가 없습니다. "새 프로젝트"를 추가하세요.</div>';
                return;
            }

            listContainer.innerHTML = projects.map((project, index) => {
                const isActive = project.id === currentProjectId;
                const projectName = project.apartmentName && project.dong && project.ho 
                    ? `${project.apartmentName} ${project.dong} ${project.ho}`
                    : `프로젝트 ${index + 1} (정보 미입력)`;
                
                const uploadStatus = project.isUploaded 
                    ? '<span style="color: #10b981;">✅ 업로드 완료</span>' 
                    : '<span style="color: #fbbf24;">⏳ 작업중</span>';

                return `
                    <div onclick="switchProject(${project.id})" 
                         style="background: ${isActive ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)'}; 
                                padding: 12px; 
                                border-radius: 6px; 
                                margin-bottom: 8px; 
                                cursor: pointer;
                                border: ${isActive ? '2px solid white' : '2px solid transparent'};
                                transition: all 0.3s;"
                         onmouseover="if(!${isActive}) this.style.background='rgba(255,255,255,0.2)'"
                         onmouseout="if(!${isActive}) this.style.background='rgba(255,255,255,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${isActive ? '▶ ' : ''}${projectName}
                                </div>
                                <div style="font-size: 11px; opacity: 0.8;">
                                    하자: ${project.defects.length}개 | 
                                    장비: ${project.equipment ? project.equipment.length : 0}개 | 
                                    공기질: ${project.airQuality.length}개
                                </div>
                            </div>
                            <div style="font-size: 12px;">
                                ${uploadStatus}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 새 프로젝트 추가
        function addNewProject() {
            const newProject = createNewProject();
            projects.push(newProject);
            currentProjectId = newProject.id;
            
            // 현재 프로젝트 참조 업데이트
            projectData = getCurrentProject();
            
            // UI 새로고침
            renderProjectList();
            loadProjectToUI();
            updateProgress();
            
            showToast('✨ 새 프로젝트가 추가되었습니다!');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // 프로젝트 전환
        function switchProject(projectId) {
            if (projectId === currentProjectId) return;
            
            // 현재 프로젝트 UI 데이터 저장
            saveCurrentProjectFromUI();
            
            // 프로젝트 전환
            currentProjectId = projectId;
            projectData = getCurrentProject();
            
            // 새 프로젝트 UI 로드
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('📂 프로젝트가 전환되었습니다');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // 현재 프로젝트 삭제
        function deleteCurrentProject() {
            if (projects.length <= 1) {
                alert('❌ 마지막 프로젝트는 삭제할 수 없습니다');
                return;
            }

            const project = getCurrentProject();
            const projectName = project.apartmentName && project.dong && project.ho 
                ? `${project.apartmentName} ${project.dong} ${project.ho}`
                : '현재 프로젝트';

            if (!confirm(`"${projectName}"를 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }

            // 프로젝트 삭제
            projects = projects.filter(p => p.id !== currentProjectId);
            
            // 첫 번째 프로젝트로 전환
            currentProjectId = projects[0].id;
            projectData = getCurrentProject();
            
            // UI 업데이트
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('🗑️ 프로젝트가 삭제되었습니다');
            
            // 로컬 스토리지 저장
            saveProjectsToLocalStorage();
        }

        // UI에서 현재 프로젝트로 데이터 저장
        function saveCurrentProjectFromUI() {
            const project = getCurrentProject();
            
            project.apartmentName = document.getElementById('apartmentName').value;
            project.dong = document.getElementById('dong').value;
            project.ho = document.getElementById('ho').value;
            project.inspectionDate = document.getElementById('inspectionDate').value;
            project.customerName = document.getElementById('customerName').value;
            project.customerPhone = document.getElementById('customerPhone').value;
            
            // floorplan, defects, equipment, airQuality는 이미 projectData 참조로 실시간 업데이트됨
        }

        // 프로젝트 데이터를 UI에 로드
        function loadProjectToUI() {
            const project = getCurrentProject();
            
            document.getElementById('apartmentName').value = project.apartmentName || '';
            document.getElementById('dong').value = project.dong || '';
            document.getElementById('ho').value = project.ho || '';
            document.getElementById('inspectionDate').value = project.inspectionDate || '';
            document.getElementById('customerName').value = project.customerName || '';
            document.getElementById('customerPhone').value = project.customerPhone || '';
            
            // 평면도 표시
            if (project.floorplan) {
                document.getElementById('floorplanPreview').innerHTML = 
                    `<img src="${project.floorplan}" alt="평면도" style="max-width: 100%; border-radius: 8px;">`;
            } else {
                document.getElementById('floorplanPreview').innerHTML = '';
            }
            
            // 하자, 장비, 공기질 목록 렌더링
            renderDefects();
            renderEquipment();
            renderAirQuality();
        }

        // 프로젝트 목록을 로컬 스토리지에 저장
        async function saveProjectsToLocalStorage() {
            try {
                await saveToIndexedDB('projects_list', { projects, currentProjectId });
                console.log('✅ 프로젝트 목록 저장 완료');
            } catch (e) {
                console.error('프로젝트 목록 저장 실패:', e);
            }
        }

        // 프로젝트 목록을 IndexedDB에서 불러오기
        async function loadProjectsFromLocalStorage() {
            try {
                const saved = await loadFromIndexedDB('projects_list');
                
                if (saved && saved.projects) {
                    projects = saved.projects;
                    currentProjectId = saved.currentProjectId;
                    
                    projectData = getCurrentProject();
                    console.log('✅ 프로젝트 목록 불러오기 완료:', projects.length + '개');
                } else {
                    // 첫 실행 시 빈 프로젝트 생성
                    const newProject = createNewProject();
                    projects.push(newProject);
                    currentProjectId = newProject.id;
                    projectData = getCurrentProject();
                    console.log('✅ 새 프로젝트 생성 완료');
                }
                
                renderProjectList();
            } catch (e) {
                console.error('프로젝트 목록 불러오기 실패:', e);
                // 실패 시 새 프로젝트 생성
                const newProject = createNewProject();
                projects.push(newProject);
                currentProjectId = newProject.id;
                projectData = getCurrentProject();
                renderProjectList();
            }
        }

        // ==================== 초기화 ====================
        // Google API 로드
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        }
        if (typeof google !== 'undefined') {
            gisLoaded();
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
        
        // IndexedDB 초기화
        try {
            await initDB();
            console.log('IndexedDB 초기화 완료');
        } catch (e) {
            console.error('IndexedDB 초기화 실패:', e);
        }
        
        
        // 자동 로그인 체크
        checkIfSignedIn();
        
        // 프로젝트 목록 불러오기
        await loadProjectsFromLocalStorage();
        
        // IndexedDB에서 현재 작업 불러오기 (render 포함)
        await loadFromLocalStorage();
        
        // 저장된 프로젝트 목록 렌더링
        await renderSavedList();
        
        // 진행률 업데이트
        updateProgress();
            
            // 점검일자 기본값 설정 (저장된 값이 없을 때만)
            if (!document.getElementById('inspectionDate').value) {
                document.getElementById('inspectionDate').valueAsDate = new Date();
            }
            
            console.log('✅ 앱 초기화 완료');
        });

        // 탭 전환
        function switchTab(tabName, evt) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            // 하자점검 또는 장비점검 탭에서만 플로팅 버튼 표시
            const floatingBtn = document.getElementById('floatingAddBtn');
            if (tabName === 'defects' || tabName === 'equipment') {
                floatingBtn.style.display = 'flex';
            } else {
                floatingBtn.style.display = 'none';
            }
            
            updateProgress();
        }

        // 진행률 업데이트
        function updateProgress() {
            let progress = 0;
            const weights = {
                project: 20,
                floorplan: 15,
                defects: 25,
                equipment: 20,
                airquality: 20
            };

            if (projectData.apartmentName && projectData.dong && projectData.ho) {
                progress += weights.project;
            }

            if (projectData.floorplan) {
                progress += weights.floorplan;
            }

            if (projectData.defects.length > 0) {
                progress += weights.defects;
            }

            if (projectData.equipment && projectData.equipment.length > 0) {
                progress += weights.equipment;
            }

            if (projectData.airQuality.length > 0) {
                progress += weights.airquality;
            }

            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Toast 메시지
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // ==================== 프로젝트 정보 ====================
        function saveProject() {
            const newApartmentName = document.getElementById('apartmentName').value;
            const newDong = document.getElementById('dong').value;
            const newHo = document.getElementById('ho').value;
            
            const isNewProject = (
                projectData.apartmentName !== newApartmentName ||
                projectData.dong !== newDong ||
                projectData.ho !== newHo
            ) && (projectData.apartmentName || projectData.dong || projectData.ho);

            if (isNewProject && (projectData.defects.length > 0 || projectData.floorplan || projectData.airQuality.some(r => r.radon || r.formaldehyde || r.vocs))) {
                if (confirm('새로운 프로젝트를 시작하시겠습니까?\n\n현재 하자 점검 및 공기질 데이터가 초기화됩니다.\n(이전 프로젝트는 "데이터" 탭에서 저장하세요)')) {
                    projectData.defects = [];
                    projectData.floorplan = null;
                    projectData.equipment = [];
                    projectData.airQuality = [
                        { id: airQualityIdCounter++, name: '거실', radon: '', formaldehyde: '', vocs: '' },
                        { id: airQualityIdCounter++, name: '침실1', radon: '', formaldehyde: '', vocs: '' },
                        { id: airQualityIdCounter++, name: '침실2', radon: '', formaldehyde: '', vocs: '' },
                        { id: airQualityIdCounter++, name: '침실3', radon: '', formaldehyde: '', vocs: '' },
                        { id: airQualityIdCounter++, name: '공용욕실', radon: '', formaldehyde: '', vocs: '' },
                        { id: airQualityIdCounter++, name: '부부욕실', radon: '', formaldehyde: '', vocs: '' }
                    ];
                    
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    displayFloorplan();
                    showToast('새 프로젝트를 시작합니다');
                } else {
                    return;
                }
            }

            projectData.apartmentName = newApartmentName;
            projectData.dong = newDong;
            projectData.ho = newHo;
            projectData.inspectionDate = document.getElementById('inspectionDate').value;
            projectData.customerName = document.getElementById('customerName').value;
            projectData.customerPhone = document.getElementById('customerPhone').value;

            saveToLocalStorage();
            updateProgress();
            showToast('프로젝트 정보가 저장되었습니다');
        }

        // ==================== 평면도 관리 ====================
        function openFloorplanCamera() {
            currentPhotoTarget = 'floorplan';
            openCamera();
        }

        async function openFloorplanGallery() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    projectData.floorplan = compressed;
                    displayFloorplan();
                    saveToLocalStorage();
                    updateProgress();
                    showToast('평면도가 추가되었습니다');
                }
            };
            input.click();
        }

        function displayFloorplan() {
            const preview = document.getElementById('floorplanPreview');
            const placeholder = document.getElementById('floorplanPlaceholder');
            
            if (projectData.floorplan) {
                preview.src = projectData.floorplan;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        function deleteFloorplan() {
            if (confirm('평면도를 삭제하시겠습니까?')) {
                projectData.floorplan = null;
                displayFloorplan();
                saveToLocalStorage();
                updateProgress();
                showToast('평면도가 삭제되었습니다');
            }
        }

        // ==================== 하자 점검 ====================
        function handleFloatingBtnClick() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection.id === 'defects') {
                addDefect();
            } else if (activeSection.id === 'equipment') {
                addEquipment();
            }
        }

        function addDefect() {
            const newDefect = {
                id: defectIdCounter++,
                spaces: [],      // 배열로 변경
                locations: [],   // 배열로 변경
                types: [],       // 배열로 변경
                detailLocation: '',
                description: '',
                photos: [],
                status: 'pending'
            };
            projectData.defects.push(newDefect);
            renderDefects();
            saveToLocalStorage();
            updateProgress();
            showToast('새 하자가 추가되었습니다');
            
            // 새로 추가된 하자로 스크롤
            setTimeout(() => {
                const defectsList = document.getElementById('defectsList');
                if (defectsList.lastElementChild) {
                    defectsList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function renderDefects() {
            const container = document.getElementById('defectsList');
            
            if (projectData.defects.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">등록된 하자가 없습니다</div>';
                return;
            }

            container.innerHTML = projectData.defects.map((defect, index) => {
                // 배열이 없으면 초기화
                if (!defect.spaces) defect.spaces = [];
                if (!defect.locations) defect.locations = [];
                if (!defect.types) defect.types = [];
                
                return `
                <div class="defect-card">
                    <div class="defect-header">
                        <span class="defect-number">하자 ${index + 1}</span>
                        <select class="defect-status ${defect.status === 'completed' ? 'status-completed' : 'status-pending'}" 
                                onchange="updateDefectStatus(${defect.id}, this.value)">
                            <option value="pending" ${defect.status === 'pending' ? 'selected' : ''}>미완료</option>
                            <option value="completed" ${defect.status === 'completed' ? 'selected' : ''}>완료</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">📷 사진 촬영/첨부 (필수 2장: 멀리서 → 가까이서)</label>
                        
                        ${defect.photos.length === 0 ? `
                            <div style="text-align: center; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 2px dashed var(--primary); border-radius: 12px;">
                                <div style="font-size: 30px; margin-bottom: 6px;">📷</div>
                                <div style="font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px;">
                                    1단계: 멀리서 촬영/첨부
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button class="btn btn-primary" onclick="startDefectPhotoSequence(${defect.id})" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        📷 촬영
                                    </button>
                                    <button class="btn btn-primary" onclick="uploadDefectPhotoFromGallery(${defect.id}, 'far')" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        🖼️ 갤러리
                                    </button>
                                </div>
                            </div>
                        ` : defect.photos.length === 1 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="position: relative; width: 100%;">
                                    <img src="${defect.photos[0]}" alt="멀리서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(16, 185, 129, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 멀리서
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(251, 191, 36, 0.1); border: 2px dashed var(--secondary); border-radius: 12px;">
                                <div style="font-size: 30px; margin-bottom: 6px;">📷</div>
                                <div style="font-size: 14px; font-weight: bold; color: var(--secondary); margin-bottom: 8px;">
                                    2단계: 가까이서 촬영/첨부
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button class="btn btn-secondary" onclick="continueDefectPhotoSequence(${defect.id})" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        📷 촬영
                                    </button>
                                    <button class="btn btn-secondary" onclick="uploadDefectPhotoFromGallery(${defect.id}, 'close')" style="flex: 1; max-width: 150px; padding: 10px; font-size: 13px;">
                                        🖼️ 갤러리
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div style="position: relative;">
                                    <img src="${defect.photos[0]}" alt="멀리서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(16, 185, 129, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 멀리서
                                    </div>
                                </div>
                                <div style="position: relative;">
                                    <img src="${defect.photos[1]}" alt="가까이서" style="width: 100%; height: 220px; object-fit: cover; border-radius: 8px; border: 2px solid var(--secondary);">
                                    <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(251, 191, 36, 0.95); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;">
                                        ✓ 가까이서
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="retakeDefectPhotos(${defect.id})" style="padding: 8px; font-size: 13px;">
                                🔄 다시 촬영
                            </button>
                        `}
                    </div>

                    <div class="form-field">
                        <label class="form-label">공간 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.spaces.length}/4 선택됨</div>
                        <div class="touch-button-grid">
                            ${['현관','안방','침실1','침실2','침실3','침실4','복도','거실','주방','팬트리','외부','알파룸','발코니','대피공간','실외기실','파우더룸','드레스룸','공용욕실','부부욕실'].map(space => `
                                <button type="button" class="touch-btn ${defect.spaces.includes(space) ? 'selected' : ''}" 
                                        ${defect.spaces.length >= 4 && !defect.spaces.includes(space) ? 'disabled' : ''}
                                        onclick="toggleDefectSelection(${defect.id}, 'spaces', '${space}')">
                                    ${space}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">위치 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.locations.length}/4 선택됨</div>
                        <div class="touch-button-grid">
                            ${['벽','바닥','천장','도배','가구','창','문','짝','틀','마감판','수전','타일','도장','줄눈','코킹'].map(location => `
                                <button type="button" class="touch-btn ${defect.locations.includes(location) ? 'selected' : ''}" 
                                        ${defect.locations.length >= 4 && !defect.locations.includes(location) ? 'disabled' : ''}
                                        onclick="toggleDefectSelection(${defect.id}, 'locations', '${location}')">
                                    ${location}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">📝 상세위치 (선택사항)</label>
                        <input type="text" class="form-input" value="${defect.detailLocation || ''}" 
                               onchange="updateDefect(${defect.id}, 'detailLocation', this.value)" 
                               placeholder="예: 거실 창문 우측 하단, 주방 싱크대 좌측 벽 등">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            💡 위치를 더 구체적으로 설명하고 싶을 때 입력하세요
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">하자내용 선택 (최대 4개)</label>
                        <div class="selected-count">${defect.types.length}/4 선택됨</div>
                        
                        <!-- 상단 그룹: 하자 유형 -->
                        <div style="margin-bottom: 8px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">
                                하자 유형
                            </div>
                            <div class="touch-button-grid">
                                ${['유격','틈새','단차','파손','긁힘','찍힘','들뜸','오염','마감','고정','수평/수직'].map(type => `
                                    <button type="button" class="touch-btn ${defect.types.includes(type) ? 'selected' : ''}" 
                                            ${defect.types.length >= 4 && !defect.types.includes(type) ? 'disabled' : ''}
                                            onclick="toggleDefectSelection(${defect.id}, 'types', '${type}')">
                                        ${type}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- 구분선 -->
                        <div style="border-top: 1px solid var(--border); margin: 12px 0;"></div>
                        
                        <!-- 하단 그룹: 상태/정도 -->
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">
                                상태 / 정도
                            </div>
                            <div class="touch-button-grid">
                                ${['전체','다수','작동','불량','미시공','오시공'].map(type => `
                                    <button type="button" class="touch-btn ${defect.types.includes(type) ? 'selected' : ''}" 
                                            ${defect.types.length >= 4 && !defect.types.includes(type) ? 'disabled' : ''}
                                            onclick="toggleDefectSelection(${defect.id}, 'types', '${type}')">
                                        ${type}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">상세설명 (자동 생성)</label>
                        <textarea class="form-input" rows="3" 
                                  readonly
                                  style="background: rgba(16, 185, 129, 0.05); cursor: default;"
                                  placeholder="공간, 위치, 하자내용을 선택하면 자동으로 생성됩니다">${defect.description || ''}</textarea>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                            💡 공간, 위치, 하자내용, 상세위치를 선택하면 자동으로 생성됩니다
                        </div>
                    </div>

                    <button class="btn btn-danger" onclick="deleteDefect(${defect.id})">
                        🗑️ 하자 삭제
                    </button>
                </div>
            `;
            }).join('');
        }

        function startDefectPhotoSequence(defectId) {
            currentPhotoTarget = { defectId: defectId, step: 'far' };
            openCamera();
        }

        function continueDefectPhotoSequence(defectId) {
            currentPhotoTarget = { defectId: defectId, step: 'close' };
            openCamera();
        }

        function retakeDefectPhotos(defectId) {
            if (confirm('사진을 다시 촬영하시겠습니까?\n(기존 사진 2장이 삭제됩니다)')) {
                const defect = projectData.defects.find(d => d.id === defectId);
                if (defect) {
                    defect.photos = [];
                    renderDefects();
                    saveToLocalStorage();
                    showToast('사진이 초기화되었습니다. 다시 촬영해주세요.');
                }
            }
        }

        async function uploadDefectPhotoFromGallery(defectId, step) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const defect = projectData.defects.find(d => d.id === defectId);
                    if (defect) {
                        defect.photos.push(compressed);
                        
                        if (step === 'far') {
                            showToast('✓ 멀리서 사진 추가 완료! 이제 가까이서 촬영/첨부해주세요.');
                        } else if (step === 'close') {
                            showToast('✓ 가까이서 사진 추가 완료! 하자 사진이 모두 등록되었습니다.');
                        }
                        
                        renderDefects();
                        saveToLocalStorage();
                        updateProgress();
                    }
                }
            };
            input.click();
        }

        // ==================== 장비점검 ====================
        function addEquipment() {
            const newEquipment = {
                id: equipmentIdCounter++,
                space: '',       // 단일 공간
                inspection: '',  // 빈 값으로 시작
                photos: {        // 위치별 사진 객체
                    '좌측': null,
                    '우측': null,
                    '바닥': null
                }
            };
            projectData.equipment.push(newEquipment);
            renderEquipment();
            saveToLocalStorage();
            updateProgress();
            showToast('새 장비점검이 추가되었습니다');
            
            setTimeout(() => {
                const equipmentList = document.getElementById('equipmentList');
                if (equipmentList.lastElementChild) {
                    equipmentList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function renderEquipment() {
            const container = document.getElementById('equipmentList');
            
            // equipment 배열이 없으면 초기화
            if (!projectData.equipment) {
                projectData.equipment = [];
            }
            
            if (projectData.equipment.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">등록된 장비점검이 없습니다</div>';
                return;
            }

            container.innerHTML = projectData.equipment.map((item, index) => {
                // 하위 호환성: 기존 4개 구조를 3개로 변환
                if (!item.photos || item.photos['좌측상단']) {
                    item.photos = {
                        '좌측': item.photos?.['좌측상단'] || item.photos?.['좌측하단'] || null,
                        '우측': item.photos?.['우측상단'] || item.photos?.['우측하단'] || null,
                        '바닥': null
                    };
                }
                
                const locations = ['좌측', '우측', '바닥'];
                const locationColors = {
                    '좌측': '#3498db',
                    '우측': '#e74c3c',
                    '바닥': '#f39c12'
                };
                const locationIcons = {
                    '좌측': '⬅️',
                    '우측': '➡️',
                    '바닥': '⬇️'
                };
                
                return `
                <div class="defect-card">
                    <div class="defect-header">
                        <span class="defect-number">NO ${index + 1}</span>
                        <button class="btn btn-danger" onclick="deleteEquipment(${item.id})" style="width: auto; padding: 8px 16px; font-size: 12px;">
                            🗑️ 삭제
                        </button>
                    </div>

                    <div class="form-field">
                        <label class="form-label">공간 선택</label>
                        <div class="touch-button-grid">
                            ${['현관','안방','침실1','침실2','침실3','침실4','복도','거실','주방','팬트리','외부','알파룸','발코니','대피공간','실외기실','파우더룸','드레스룸','공용욕실','부부욕실'].map(space => `
                                <button type="button" class="touch-btn ${item.space === space ? 'selected' : ''}" 
                                        onclick="updateEquipmentSpace(${item.id}, '${space}')">
                                    ${space}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label">점검결과</label>
                        <div class="touch-button-grid" style="margin-bottom: 10px;">
                            ${['벽체 수직도 및 바닥 평활도 양호','배수경사(구배)상태 양호','벽체수직 및 바닥수평 / 단열시공 양호','바닥 난방 열화상 결과 온도 분포 양호'].map(result => {
                                const escaped = result.replace(/'/g, '&apos;');
                                return `
                                <button type="button" class="touch-btn ${item.inspection === result ? 'selected' : ''}" 
                                        onclick="updateEquipmentInspection(${item.id}, '${escaped}')">
                                    ${result}
                                </button>
                            `}).join('')}
                        </div>
                        <input type="text" class="form-input" value="${item.inspection || ''}" 
                               onchange="updateEquipmentInspection(${item.id}, this.value)" 
                               placeholder="또는 직접 입력">
                    </div>

                    <div class="form-field">
                        <label class="form-label">📷 위치별 사진 촬영/첨부 (${Object.values(item.photos).filter(p => p).length}/3)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            ${locations.slice(0, 2).map(location => `
                                <div style="border: 2px solid ${locationColors[location]}; border-radius: 8px; overflow: hidden;">
                                    <div style="background: ${locationColors[location]}; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 15px;">
                                        ${locationIcons[location]} ${location}
                                    </div>
                                    ${item.photos[location] ? `
                                        <img src="${item.photos[location]}" style="width: 100%; height: 220px; object-fit: cover;">
                                        <div style="display: flex; border-top: 1px solid #ddd;">
                                            <button class="btn btn-secondary" onclick="openEquipmentLocationCamera(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; padding: 12px; font-size: 13px;">
                                                🔄
                                            </button>
                                            <button class="btn btn-secondary" onclick="openEquipmentLocationGallery(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 12px; font-size: 13px;">
                                                🖼️
                                            </button>
                                            <button class="btn btn-danger" onclick="deleteEquipmentLocationPhoto(${item.id}, '${location}')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 12px; font-size: 13px;">
                                                🗑️
                                            </button>
                                        </div>
                                    ` : `
                                        <div style="height: 220px; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                                            <div style="font-size: 36px; opacity: 0.3;">📷</div>
                                            <div style="display: flex; gap: 10px; width: 100%; padding: 0 12px;">
                                                <button class="btn btn-primary" onclick="openEquipmentLocationCamera(${item.id}, '${location}')" style="flex: 1; padding: 14px 10px; font-size: 14px; font-weight: bold;">
                                                    📸 촬영
                                                </button>
                                                <button class="btn btn-primary" onclick="openEquipmentLocationGallery(${item.id}, '${location}')" style="flex: 1; padding: 14px 10px; font-size: 14px; font-weight: bold;">
                                                    🖼️ 첨부
                                                </button>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        <!-- 바닥 사진 (전체 너비) -->
                        <div style="border: 2px solid ${locationColors['바닥']}; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${locationColors['바닥']}; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 13px;">
                                ${locationIcons['바닥']} 바닥
                            </div>
                            ${item.photos['바닥'] ? `
                                <img src="${item.photos['바닥']}" style="width: 100%; height: 200px; object-fit: cover;">
                                <div style="display: flex; border-top: 1px solid #ddd;">
                                    <button class="btn btn-secondary" onclick="openEquipmentLocationCamera(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; padding: 10px; font-size: 12px;">
                                        🔄 재촬영
                                    </button>
                                    <button class="btn btn-secondary" onclick="openEquipmentLocationGallery(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 10px; font-size: 12px;">
                                        🖼️ 재첨부
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteEquipmentLocationPhoto(${item.id}, '바닥')" style="flex: 1; border-radius: 0; border: none; border-left: 1px solid #ddd; padding: 10px; font-size: 12px;">
                                        🗑️ 삭제
                                    </button>
                                </div>
                            ` : `
                                <div style="height: 200px; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                                    <div style="font-size: 32px; opacity: 0.3;">📷</div>
                                    <div style="display: flex; gap: 10px; width: 100%; padding: 0 20px;">
                                        <button class="btn btn-primary" onclick="openEquipmentLocationCamera(${item.id}, '바닥')" style="flex: 1; padding: 10px; font-size: 12px;">
                                            📸 촬영
                                        </button>
                                        <button class="btn btn-primary" onclick="openEquipmentLocationGallery(${item.id}, '바닥')" style="flex: 1; padding: 10px; font-size: 12px;">
                                            🖼️ 첨부
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateEquipment(id, field, value) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item[field] = value;
                saveToLocalStorage();
            }
        }

        function updateEquipmentInspection(id, value) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item.inspection = value;
                renderEquipment();
                saveToLocalStorage();
            }
        }

        function updateEquipmentSpace(id, space) {
            const item = projectData.equipment.find(e => e.id === id);
            if (item) {
                item.space = space;
                renderEquipment();
                saveToLocalStorage();
            }
        }

        function openEquipmentLocationCamera(id, location) {
            currentPhotoTarget = { equipmentId: id, location: location };
            openCamera();
        }

        async function openEquipmentLocationGallery(id, location) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const item = projectData.equipment.find(e => e.id === id);
                    if (item) {
                        if (!item.photos) {
                            item.photos = {
                                '좌측상단': null,
                                '좌측하단': null,
                                '우측상단': null,
                                '우측하단': null
                            };
                        }
                        item.photos[location] = compressed;
                        renderEquipment();
                        saveToLocalStorage();
                        updateProgress();
                        showToast(`${location} 사진이 추가되었습니다`);
                    }
                }
            };
            input.click();
        }

        function deleteEquipmentLocationPhoto(id, location) {
            if (confirm(`${location} 사진을 삭제하시겠습니까?`)) {
                const item = projectData.equipment.find(e => e.id === id);
                if (item && item.photos) {
                    item.photos[location] = null;
                    renderEquipment();
                    saveToLocalStorage();
                    updateProgress();
                    showToast(`${location} 사진이 삭제되었습니다`);
                }
            }
        }

        function deleteEquipment(id) {
            if (confirm('이 장비점검을 삭제하시겠습니까?')) {
                projectData.equipment = projectData.equipment.filter(e => e.id !== id);
                renderEquipment();
                saveToLocalStorage();
                updateProgress();
                showToast('장비점검이 삭제되었습니다');
            }
        }

        function openEquipmentCamera(id) {
            currentPhotoTarget = { equipmentId: id };
            openCamera();
        }

        async function openEquipmentGallery(id) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await compressImage(file);
                    const item = projectData.equipment.find(e => e.id === id);
                    if (item) {
                        item.photo = compressed;
                        renderEquipment();
                        saveToLocalStorage();
                        showToast('사진이 추가되었습니다');
                    }
                }
            };
            input.click();
        }

        function deleteEquipmentPhoto(id) {
            if (confirm('사진을 삭제하시겠습니까?')) {
                const item = projectData.equipment.find(e => e.id === id);
                if (item) {
                    item.photo = null;
                    renderEquipment();
                    saveToLocalStorage();
                    showToast('사진이 삭제되었습니다');
                }
            }
        }

        // ==================== 공기질 측정 ====================
        function renderAirQuality() {
            const container = document.getElementById('airQualityList');
            
            if (projectData.airQuality.length === 0) {
                projectData.airQuality = [
                    { id: airQualityIdCounter++, name: '거실', radon: '', formaldehyde: '', vocs: '' },
                    { id: airQualityIdCounter++, name: '침실1', radon: '', formaldehyde: '', vocs: '' },
                    { id: airQualityIdCounter++, name: '침실2', radon: '', formaldehyde: '', vocs: '' },
                    { id: airQualityIdCounter++, name: '침실3', radon: '', formaldehyde: '', vocs: '' },
                    { id: airQualityIdCounter++, name: '공용욕실', radon: '', formaldehyde: '', vocs: '' },
                    { id: airQualityIdCounter++, name: '부부욕실', radon: '', formaldehyde: '', vocs: '' }
                ];
            }

            container.innerHTML = projectData.airQuality.map((room) => `
                <div class="air-quality-card">
                    <div class="air-room-header">
                        <input type="text" 
                               class="air-room-name-input" 
                               value="${room.name}" 
                               onchange="updateAirRoomName(${room.id}, this.value)"
                               placeholder="방 이름">
                        <button class="air-room-delete" onclick="deleteAirRoom(${room.id})">×</button>
                    </div>
                    <div class="air-inputs">
                        <div class="air-input-group">
                            <label>라돈</label>
                            <input type="number" 
                                   value="${room.radon}" 
                                   onchange="updateAirQualityValue(${room.id}, 'radon', this.value)"
                                   placeholder="0">
                            <span>Bq/m³</span>
                        </div>
                        <div class="air-input-group">
                            <label>포름알데히드</label>
                            <input type="number" 
                                   step="0.001"
                                   value="${room.formaldehyde}" 
                                   onchange="updateAirQualityValue(${room.id}, 'formaldehyde', this.value)"
                                   placeholder="0.000">
                            <span>mg/m³</span>
                        </div>
                        <div class="air-input-group">
                            <label>총VOCs</label>
                            <input type="number" 
                                   step="0.001"
                                   value="${room.vocs}" 
                                   onchange="updateAirQualityValue(${room.id}, 'vocs', this.value)"
                                   placeholder="0.000">
                            <span>mg/m³</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addAirQualityRoom() {
            const newRoom = {
                id: airQualityIdCounter++,
                name: `방${projectData.airQuality.length + 1}`,
                radon: '',
                formaldehyde: '',
                vocs: ''
            };
            projectData.airQuality.push(newRoom);
            renderAirQuality();
            saveToLocalStorage();
            updateProgress();
            showToast('방이 추가되었습니다');
        }

        function deleteAirRoom(id) {
            if (projectData.airQuality.length <= 1) {
                alert('최소 1개의 방은 있어야 합니다');
                return;
            }
            if (confirm('이 방을 삭제하시겠습니까?')) {
                projectData.airQuality = projectData.airQuality.filter(r => r.id !== id);
                renderAirQuality();
                saveToLocalStorage();
                updateProgress();
                showToast('방이 삭제되었습니다');
            }
        }

        function updateAirRoomName(id, name) {
            const room = projectData.airQuality.find(r => r.id === id);
            if (room) {
                room.name = name;
                saveToLocalStorage();
            }
        }

        function updateAirQualityValue(id, field, value) {
            const room = projectData.airQuality.find(r => r.id === id);
            if (room) {
                room[field] = value;
                saveToLocalStorage();
                updateProgress();
            }
        }

        // ==================== 카메라 기능 ====================
        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                document.getElementById('cameraModal').classList.add('active');
            } catch (error) {
                alert('카메라를 사용할 수 없습니다: ' + error.message);
            }
        }

        function closeCameraModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
            currentPhotoTarget = null;
        }

        // ==================== 이미지 압축 함수 (통합) ====================
        async function compressImage(input, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve) => {
                // input이 File 객체인 경우
                if (input instanceof File) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // 최대 너비 제한
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(input);
                }
                // input이 dataURL인 경우
                else if (typeof input === 'string') {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 최대 너비 제한
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = input;
                }
            });
        }

        async function capturePhoto() {
            // 이벤트 전파 방지
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // 원본 이미지
            const originalImage = canvas.toDataURL('image/jpeg', 0.95);
            
            // 이미지 압축 (1920px, 품질 85%)
            const imageData = await compressImage(originalImage, 1920, 0.85);
            
            if (currentPhotoTarget === 'floorplan') {
                projectData.floorplan = imageData;
                displayFloorplan();
                showToast('평면도가 추가되었습니다');
            } else if (currentPhotoTarget && typeof currentPhotoTarget === 'object') {
                if (currentPhotoTarget.defectId) {
                    // 하자점검 사진
                    const defect = projectData.defects.find(d => d.id === currentPhotoTarget.defectId);
                    if (defect) {
                        defect.photos.push(imageData);
                        
                        if (currentPhotoTarget.step === 'far') {
                            showToast('✓ 멀리서 촬영 완료! 이제 가까이서 촬영해주세요.');
                        } else if (currentPhotoTarget.step === 'close') {
                            showToast('✓ 가까이서 촬영 완료! 하자 사진이 모두 등록되었습니다.');
                        }
                        
                        renderDefects();
                    }
                } else if (currentPhotoTarget.equipmentId) {
                    // 장비점검 사진
                    const equipment = projectData.equipment.find(e => e.id === currentPhotoTarget.equipmentId);
                    if (equipment) {
                        if (currentPhotoTarget.location) {
                            // 위치별 사진
                            if (!equipment.photos) {
                                equipment.photos = {
                                    '좌측상단': null,
                                    '좌측하단': null,
                                    '우측상단': null,
                                    '우측하단': null
                                };
                            }
                            equipment.photos[currentPhotoTarget.location] = imageData;
                            showToast(`✓ ${currentPhotoTarget.location} 사진이 등록되었습니다.`);
                        } else {
                            // 구 버전 호환성
                            equipment.photo = imageData;
                            showToast('✓ 사진이 등록되었습니다.');
                        }
                        renderEquipment();
                    }
                }
            }
            
            saveToLocalStorage();
            updateProgress();
            closeCameraModal();
        }

        function updateDefect(id, field, value) {
            const defect = projectData.defects.find(d => d.id === id);
            if (defect) {
                defect[field] = value;
                
                // 상세위치 변경 시 자동 설명 재생성
                if (field === 'detailLocation') {
                    generateAutoDescription(id);
                    renderDefects();
                }
                
                saveToLocalStorage();
            }
        }

        function toggleDefectSelection(id, field, value) {
            const defect = projectData.defects.find(d => d.id === id);
            if (!defect) return;
            
            // 배열이 없으면 초기화
            if (!defect[field]) defect[field] = [];
            
            const index = defect[field].indexOf(value);
            if (index > -1) {
                // 이미 선택되어 있으면 제거
                defect[field].splice(index, 1);
            } else {
                // 선택되어 있지 않으면 추가 (최대 4개까지)
                if (defect[field].length < 4) {
                    defect[field].push(value);
                } else {
                    showToast('최대 4개까지만 선택할 수 있습니다');
                    return;
                }
            }
            
            // 선택 후 상세설명 자동 생성
            generateAutoDescription(id);
            
            renderDefects();
            saveToLocalStorage();
        }

        function generateAutoDescription(id) {
            const defect = projectData.defects.find(d => d.id === id);
            if (!defect) return;
            
            // 배열이 없으면 초기화
            if (!defect.spaces) defect.spaces = [];
            if (!defect.locations) defect.locations = [];
            if (!defect.types) defect.types = [];
            
            // 선택된 항목이 있을 때만 자동 생성
            if (defect.spaces.length > 0 || defect.locations.length > 0 || defect.types.length > 0 || defect.detailLocation) {
                let description = '';
                
                // 1. 공간 (어디?)
                if (defect.spaces.length > 0) {
                    description += defect.spaces.join(', ');
                }
                
                // 2. 위치 (무엇?) - 한글 문법에 맞게 정렬
                if (defect.locations.length > 0) {
                    if (description) description += ' ';
                    description += sortLocationsForKorean(defect.locations);
                }
                
                // 3. 상세위치 (구체적으로 어디?)
                if (defect.detailLocation) {
                    if (description) description += ' ';
                    description += defect.detailLocation;
                }
                
                // 4. 하자내용 (어떤 문제?)
                if (defect.types.length > 0) {
                    if (description) description += ' ';
                    description += defect.types.join(', ');
                }
                
                defect.description = description;
            }
        }
        
        // 한글 문법에 맞게 위치를 정렬하는 함수
        function sortLocationsForKorean(locations) {
            // 우선순위 정의 (한글 문법에 자연스러운 순서)
            const priority = {
                '창': 1,
                '문': 2,
                '벽': 3,
                '바닥': 4,
                '천장': 5,
                '도배': 6,
                '가구': 7,
                '짝': 8,
                '틀': 9,
                '마감판': 10,
                '수전': 11,
                '타일': 12,
                '도장': 13,
                '줄눈': 14,
                '코킹': 15
            };
            
            // 우선순위에 따라 정렬
            const sorted = [...locations].sort((a, b) => {
                const priorityA = priority[a] || 999;
                const priorityB = priority[b] || 999;
                return priorityA - priorityB;
            });
            
            return sorted.join(' / ');
        }

        function updateDefectStatus(id, status) {
            const defect = projectData.defects.find(d => d.id === id);
            if (defect) {
                defect.status = status;
                renderDefects();
                saveToLocalStorage();
                showToast(status === 'completed' ? '하자가 완료 처리되었습니다' : '하자가 미완료 상태로 변경되었습니다');
            }
        }

        function deleteDefect(id) {
            if (confirm('이 하자를 삭제하시겠습니까?')) {
                projectData.defects = projectData.defects.filter(d => d.id !== id);
                renderDefects();
                saveToLocalStorage();
                updateProgress();
                showToast('하자가 삭제되었습니다');
            }
        }

        // ==================== PDF 생성 ====================
        async function generatePDF() {
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('프로젝트 정보를 먼저 입력해주세요');
                return;
            }

            showLoading();

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210;
                const pageHeight = 297;

                // 1페이지: 전체 요약
                const summaryHTML = createSummaryPage();
                await addHTMLPageToPDF(doc, summaryHTML, pageWidth, pageHeight);

                // 2페이지~: 하자 상세 사진 (3개씩, 사진 2장씩)
                if (projectData.defects.length > 0) {
                    const defectsWithPhotos = projectData.defects.filter(d => d.photos && d.photos.length > 0);
                    
                    if (defectsWithPhotos.length > 0) {
                        for (let i = 0; i < defectsWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = defectsWithPhotos.slice(i, i + 3);
                            const detailHTML = createDefectDetailPage(batch, i);
                            await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                        }
                    }
                }

                // 장비점검 페이지 (1개씩)
                if (projectData.equipment && projectData.equipment.length > 0) {
                    // 사진이 하나라도 있는 항목만 필터링
                    const equipmentWithPhotos = projectData.equipment.filter(e => {
                        if (e.photos && typeof e.photos === 'object') {
                            // 새 버전: photos 객체에서 하나라도 사진이 있으면
                            return Object.values(e.photos).some(photo => photo !== null);
                        }
                        // 구 버전: photo가 있으면
                        return e.photo;
                    });
                    
                    if (equipmentWithPhotos.length > 0) {
                        // 3개씩 페이지에 표시 (하자와 동일)
                        for (let i = 0; i < equipmentWithPhotos.length; i += 3) {
                            doc.addPage();
                            const batch = equipmentWithPhotos.slice(i, i + 3);
                            const equipmentHTML = createEquipmentPage(batch, i);
                            await addHTMLPageToPDF(doc, equipmentHTML, pageWidth, pageHeight);
                        }
                    }
                }

                // 공기질 상세 페이지 추가
                const airQualityWithData = projectData.airQuality.filter(room => 
                    room.radon || room.formaldehyde || room.vocs
                );
                if (airQualityWithData.length > 0) {
                    doc.addPage();
                    const airQualityHTML = createAirQualityDetailPage();
                    await addHTMLPageToPDF(doc, airQualityHTML, pageWidth, pageHeight);
                }

                // 참고자료 페이지 추가 (보고서 뒤쪽에)
                doc.addPage();
                const warrantyPage1 = createWarrantyGuidePage1();
                await addHTMLPageToPDF(doc, warrantyPage1, pageWidth, pageHeight);

                doc.addPage();
                const warrantyPage2 = createWarrantyGuidePage2();
                await addHTMLPageToPDF(doc, warrantyPage2, pageWidth, pageHeight);

                doc.addPage();
                const airQualityGuide = createAirQualityManagementGuidePage();
                await addHTMLPageToPDF(doc, airQualityGuide, pageWidth, pageHeight);

                doc.addPage();
                const condensationGuide = createCondensationGuidePage();
                await addHTMLPageToPDF(doc, condensationGuide, pageWidth, pageHeight);

                doc.addPage();
                const movingInGuide = createMovingInGuidePage();
                await addHTMLPageToPDF(doc, movingInGuide, pageWidth, pageHeight);

                // 모바일 호환 다운로드
                const filename = `더홈점검_${projectData.apartmentName}_${projectData.dong}${projectData.ho}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    const pdfBlob = doc.output('blob');
                    const blobUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                    
                    hideLoading();
                    showToast('PDF가 다운로드 폴더에 저장되었습니다!');
                } else {
                    doc.save(filename);
                    hideLoading();
                    showToast('PDF가 생성되었습니다');
                }

            } catch (error) {
                console.error('PDF 생성 오류:', error);
                hideLoading();
                alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        async function addHTMLPageToPDF(doc, htmlContent, pageWidth, pageHeight) {
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '794px';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = '#ffffff';
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });

            document.body.removeChild(tempDiv);

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * pageWidth) / canvas.width;
            
            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
        }

        function createSummaryPage() {
            let defectRows = '';
            const displayDefects = projectData.defects.slice(0, 15);
            displayDefects.forEach((defect, index) => {
                // 배열을 문자열로 변환 (하위 호환성)
                const spaces = defect.spaces ? defect.spaces.join(', ') : (defect.space || '-');
                const locations = defect.locations ? defect.locations.join(', ') : (defect.location || '-');
                const types = defect.types ? defect.types.join(', ') : (defect.type || '-');
                
                // 상세설명만 사용 (이미 모든 정보 포함)
                const description = defect.description || '';
                
                defectRows += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px; text-align: center; font-weight: bold; color: #000000;">${index + 1}</td>
                        <td style="padding: 8px; text-align: center; color: #000000;">${spaces}</td>
                        <td style="padding: 8px; text-align: center; color: #000000;">${locations}</td>
                        <td style="padding: 8px; color: #000000;">${types}</td>
                        <td style="padding: 8px; color: #000000; font-size: 11px; word-break: break-word; white-space: normal; line-height: 1.4;">${description || '-'}</td>
                        <td style="padding: 8px; text-align: center; font-size: 11px; color: #000000;">${defect.status === 'completed' ? '✓' : '○'}</td>
                    </tr>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: #f8f9fa; color: #000; border: 2px solid #2c3e50; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h1 style="margin: 0 0 8px 0; font-size: 28px;">더홈점검 하자 보고서</h1>
                                <p style="margin: 0; font-size: 14px; opacity: 0.9;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                            </div>
                            <div style="text-align: right; font-size: 12px;">
                                <div style="font-weight: bold; margin-bottom: 4px;">더홈점검</div>
                                <div>070-8019-1456</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #000000; border-bottom: 2px solid #3498db; padding-bottom: 6px;">세대 평면도</h3>
                            ${projectData.floorplan ? `
                                <img src="${projectData.floorplan}" style="width: 100%; max-height: 280px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;" />
                            ` : '<div style="width: 100%; height: 280px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">평면도 없음</div>'}
                        </div>

                        <div>
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #000000; border-bottom: 2px solid #3498db; padding-bottom: 6px;">프로젝트 정보</h3>
                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; margin-bottom: 20px; font-size: 13px;">
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 10px; background: #f8f9fa; font-weight: bold; width: 35%; color: #000000;">아파트명</td>
                                    <td style="padding: 10px; color: #000000;">${projectData.apartmentName}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000000;">동/호수</td>
                                    <td style="padding: 10px; color: #000000;">${projectData.dong} / ${projectData.ho}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000000;">점검일자</td>
                                    <td style="padding: 10px; color: #000000;">${projectData.inspectionDate || '-'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000000;">고객명</td>
                                    <td style="padding: 10px; color: #000000;">${projectData.customerName || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #000000; border-bottom: 2px solid #e74c3c; padding-bottom: 6px;">하자 점검 목록 (총 ${projectData.defects.length}건)</h3>
                    ${projectData.defects.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 10px; width: 5%; color: #000000;">No</th>
                                    <th style="padding: 10px; width: 10%; color: #000000;">공간</th>
                                    <th style="padding: 10px; width: 10%; color: #000000;">위치</th>
                                    <th style="padding: 10px; width: 12%; color: #000000;">하자내용</th>
                                    <th style="padding: 10px; width: 50%; color: #000000;">상세설명</th>
                                    <th style="padding: 10px; width: 8%; color: #000000;">상태</th>
                                </tr>
                            </thead>
                            <tbody>${defectRows}</tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #999; padding: 40px 0;">등록된 하자가 없습니다</p>'}

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        function createDefectDetailPage(defects, startIndex) {
            let contentHTML = '';
            
            defects.forEach((defect, idx) => {
                const globalIndex = startIndex + idx + 1;
                const farPhoto = defect.photos && defect.photos.length > 0 ? defect.photos[0] : '';
                const closePhoto = defect.photos && defect.photos.length > 1 ? defect.photos[1] : '';
                
                // 배열을 문자열로 변환 (하위 호환성)
                const spaces = defect.spaces ? defect.spaces.join(', ') : (defect.space || '-');
                const locations = defect.locations ? defect.locations.join(', ') : (defect.location || '-');
                const types = defect.types ? defect.types.join(', ') : (defect.type || '-');
                
                // 상세설명만 사용 (이미 모든 정보 포함)
                const description = defect.description || '';
                
                contentHTML += `
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0; margin-bottom: 20px; background: white; page-break-inside: avoid;">
                        <!-- 하자 번호 헤더 -->
                        <div style="background: #f8f9fa; padding: 8px 12px; border-bottom: 1px solid #ddd;">
                            <strong style="font-size: 14px; color: #000;">하자 ${globalIndex}</strong>
                        </div>
                        
                        <!-- 정보 테이블 -->
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr>
                                <td style="padding: 8px 12px; width: 15%; background: #f8f9fa; font-weight: bold; color: #000; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd;">공간</td>
                                <td style="padding: 8px 12px; width: 35%; color: #000; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd;">${spaces}</td>
                                <td style="padding: 8px 12px; width: 15%; background: #f8f9fa; font-weight: bold; color: #000; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd;">위치</td>
                                <td style="padding: 8px 12px; width: 35%; color: #000; border-bottom: 1px solid #ddd;">${locations}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 12px; background: #f8f9fa; font-weight: bold; color: #000; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd;">하자내용</td>
                                <td colspan="3" style="padding: 8px 12px; color: #000; border-bottom: 1px solid #ddd;">${types}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 12px; background: #f8f9fa; font-weight: bold; color: #000; border-right: 1px solid #ddd;">상세설명</td>
                                <td colspan="3" style="padding: 8px 12px; color: #000; font-size: 13px; line-height: 1.6;">${description || '-'}</td>
                            </tr>
                        </table>

                        <!-- 사진 영역 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px;">
                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid #10b981;">
                                    📷 원경 (멀리서)
                                </div>
                                ${farPhoto ? `
                                    <img src="${farPhoto}" style="width: 100%; height: 220px; object-fit: cover; display: block;" />
                                ` : `
                                    <div style="width: 100%; height: 220px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #999; font-size: 11px; text-align: center; padding: 10px;">사진 없음</div>
                                `}
                            </div>

                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid #f59e0b;">
                                    📷 근경 (가까이서)
                                </div>
                                ${closePhoto ? `
                                    <img src="${closePhoto}" style="width: 100%; height: 220px; object-fit: cover; display: block;" />
                                ` : `
                                    <div style="width: 100%; height: 220px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #999; font-size: 11px; text-align: center; padding: 10px;">사진 없음</div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: white; color: #000; padding: 15px 20px; margin-bottom: 25px; border-radius: 8px; border: 1px solid #ddd;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: bold;">하자 상세 사진 (원경+근경)</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho}</p>
                    </div>

                    ${contentHTML}

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #666; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // === 장비점검 측정 보고서 페이지 (3개씩) ===
        function createEquipmentPage(equipmentList, startIndex) {
            let contentHTML = '';
            
            equipmentList.forEach((item, idx) => {
                const globalIndex = startIndex + idx + 1;
                
                // 하위 호환성
                const space = item.space || (item.spaces ? item.spaces.join(', ') : '-');
                
                // 하위 호환성: 기존 4개 구조를 3개로 변환
                if (item.photos && item.photos['좌측상단']) {
                    item.photos = {
                        '좌측': item.photos['좌측상단'] || item.photos['좌측하단'] || null,
                        '우측': item.photos['우측상단'] || item.photos['우측하단'] || null,
                        '바닥': null
                    };
                }
                
                // photos 객체가 있으면 위치별 사진, 없으면 단일 사진 (구 버전)
                const hasLocationPhotos = item.photos && typeof item.photos === 'object';
                
                contentHTML += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 0; background: white; margin-bottom: 20px; page-break-inside: avoid;">
                        <!-- 헤더 -->
                        <div style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #ddd;">
                            <strong style="font-size: 16px; color: #000;">장비점검 ${globalIndex} - ${space}</strong>
                        </div>
                        
                        <!-- 점검결과 -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold; text-align: center; background: #f8f9fa; color: #000; width: 25%;">점검결과</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd; color: #000;">${item.inspection || '벽체수직 및 바닥수평 / 단열시공 양호'}</td>
                            </tr>
                        </table>

                        ${hasLocationPhotos ? `
                            <!-- 사진 영역 -->
                            <div style="padding: 0 15px 15px 15px;">
                                ${(() => {
                                    // 사진이 있는 위치만 필터링
                                    const leftPhoto = item.photos['좌측'];
                                    const rightPhoto = item.photos['우측'];
                                    const floorPhoto = item.photos['바닥'];
                                    
                                    const hasTopPhotos = leftPhoto || rightPhoto;
                                    const hasFloorPhoto = floorPhoto;
                                    
                                    let html = '';
                                    
                                    // 좌측/우측 사진이 하나라도 있으면 표시
                                    if (hasTopPhotos) {
                                        const locations = [];
                                        if (leftPhoto) locations.push({ name: '좌측', photo: leftPhoto, color: '#3498db', icon: '⬅️' });
                                        if (rightPhoto) locations.push({ name: '우측', photo: rightPhoto, color: '#e74c3c', icon: '➡️' });
                                        
                                        // 1개면 full width, 2개면 grid
                                        const gridStyle = locations.length === 2 ? 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;' : '';
                                        
                                        html += `
                                            <div style="${gridStyle} margin-bottom: ${hasFloorPhoto ? '10px' : '0'};">
                                                ${locations.map(loc => `
                                                    <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                        <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid ${loc.color};">
                                                            ${loc.icon} ${loc.name}
                                                        </div>
                                                        <img src="${loc.photo}" style="width: 100%; height: 240px; object-fit: cover; display: block;" />
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                    
                                    // 바닥 사진이 있으면 표시
                                    if (hasFloorPhoto) {
                                        html += `
                                            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border-bottom: 3px solid #f39c12;">
                                                    ⬇️ 바닥
                                                </div>
                                                <img src="${floorPhoto}" style="width: 100%; height: 260px; object-fit: cover; display: block;" />
                                            </div>
                                        `;
                                    }
                                    
                                    // 사진이 하나도 없으면 안내 메시지
                                    if (!hasTopPhotos && !hasFloorPhoto) {
                                        html = `
                                            <div style="padding: 40px; text-align: center; color: #999; background: #f8f9fa; border-radius: 6px;">
                                                <div style="font-size: 14px; margin-bottom: 8px;">📷 촬영된 사진이 없습니다</div>
                                                <div style="font-size: 11px;">장비점검 시 사진을 첨부해주세요</div>
                                            </div>
                                        `;
                                    }
                                    
                                    return html;
                                })()}
                            </div>
                        ` : `
                            <!-- 단일 사진 (구 버전 호환) -->
                            <div style="text-align: center;">
                                <div style="padding: 8px; text-align: center; font-weight: bold; font-size: 12px; color: #333; border: 1px solid #ddd; border-bottom: 3px solid #2c3e50; border-radius: 4px 4px 0 0;">
                                    촬영 사진
                                </div>
                                ${item.photo ? `
                                    <img src="${item.photo}" style="width: 100%; max-height: 350px; object-fit: contain; border: 1px solid #ddd; border-top: none;" />
                                ` : `
                                    <div style="width: 100%; height: 250px; background: #f9f9f9; border: 1px solid #ddd; border-top: none; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">사진 없음</div>
                                `}
                            </div>
                        `}
                    </div>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: white; color: #000; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold;">장비 측정 보고서</h2>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    ${contentHTML}

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #666;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>더홈점검 | 070-8019-1456</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 참고자료 페이지 생성 함수들
        function createWarrantyGuidePage1() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #e74c3c; padding-bottom: 10px;">📝 하자보수 청구 가이드</h2>

                    <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            하자를 발견하셨나요? 하자담보책임 기간 내에 적절한 절차로 보수 청구하시면 무상으로 수리받으실 수 있습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1단계: 하자 발견 즉시 사진 촬영 및 기록
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>원경 사진:</strong> 하자가 어느 위치에 있는지 전체적인 공간 촬영</li>
                            <li><strong>근접 사진:</strong> 하자 부위를 확대하여 상세하게 촬영</li>
                            <li><strong>기록 사항:</strong> 발견 날짜, 위치(공간), 하자 내용을 메모</li>
                            <li><strong>TIP:</strong> 자 또는 동전을 함께 찍으면 크기 비교가 용이합니다</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2단계: 하자보수 신청
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12; margin-bottom: 12px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>신청 방법 (2가지)</strong><br>
                                ① <strong>관리사무소</strong>에 접수 (일반적인 방법)<br>
                                ② <strong>시공사 A/S센터</strong>에 직접 접수 (관리사무소 경유 없이)
                            </p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa; border: 1px solid #ddd;">
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd; width: 25%;">구분</th>
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd;">관리사무소 접수</th>
                                    <th style="padding: 8px; color: #000; border: 1px solid #ddd;">시공사 A/S센터 직접 접수</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">방법</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">관리사무소 방문/전화/온라인</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">시공사 A/S센터 전화/홈페이지</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">장점</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">가까움, 관리사무소 중재</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">빠른 처리, 직접 소통</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">권장</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">일반 하자</td>
                                    <td style="padding: 8px; color: #000; border: 1px solid #ddd;">긴급 하자, 대응 미흡 시</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #3498db;">
                            <p style="margin: 0 0 8px 0; color: #000; font-size: 12px; font-weight: bold;">📌 제출 서류</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #000; line-height: 1.6;">
                                <li>하자보수 신청서 (관리사무소 비치 또는 시공사 홈페이지 다운로드)</li>
                                <li>하자 사진 (원경, 근접)</li>
                                <li>입주자 정보 (동/호수, 연락처)</li>
                                <li><strong>중요:</strong> 접수증 또는 접수번호 반드시 받기 (증빙자료)</li>
                            </ul>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #fff3e0; color: #000; border-bottom: 2px solid #f39c12; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3단계: 시공사의 하자 확인 및 보수
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li>시공사에서 하자 확인을 위해 방문 (일정 협의, 보통 1~2주 소요)</li>
                            <li>하자 인정 시 보수 일정 협의 및 시행</li>
                            <li>보수 완료 후 입주자 확인 및 서명</li>
                            <li><strong>하자 미인정 시:</strong> 사유 확인 후 재신청 또는 분쟁조정 신청 가능</li>
                            <li><strong>대응 지연 시:</strong> 시공사 본사 A/S센터, 한국소비자원(1372) 상담</li>
                        </ul>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createWarrantyGuidePage2() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #e74c3c; padding-bottom: 10px;">⏰ 하자담보책임 기간 상세</h2>

                    <div style="background: #ffebee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            <strong>공동주택관리법 시행령 제36조</strong>에 따라 사업주체는 하자담보책임 기간 동안 무상 보수 의무가 있습니다.
                            기간 만료 전에 반드시 신청하셔야 합니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff3e0;">
                        <h3 style="margin: 0 0 10px 0; color: #f39c12; font-size: 15px;">📅 하자담보책임 기간 기산일</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                            <tr style="border: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd; width: 40%;">기산일 기준</td>
                                <td style="padding: 10px; color: #000; border: 1px solid #ddd;">입주일 또는 사용검사일 중 <strong>빠른 날</strong></td>
                            </tr>
                            <tr style="border: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000; border: 1px solid #ddd;">예시</td>
                                <td style="padding: 10px; color: #000; border: 1px solid #ddd;">입주일: 2024.3.1 / 사용검사일: 2024.2.15 → <strong>2024.2.15부터 기산</strong></td>
                            </tr>
                        </table>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #000; line-height: 1.6;">
                            ※ 입주자가 입주를 지연한 경우에도 사용검사일 기준 적용<br>
                            ※ 입주자대표회의 또는 관리사무소에서 정확한 날짜 확인 가능
                        </p>
                    </div>

                    <div style="border: 2px solid #e74c3c; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #ffebee; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ① 내력구조부 - 10년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">건물의 주요구조부 (기둥, 보, 내력벽, 주계단, 지붕틀, 바닥)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">구조 균열, 부등침하, 기둥·보 파손</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #fff3e0; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ② 주요 설비 - 3년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">난방·급배수·전기·가스·소방·환기 설비</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">보일러 고장, 수전 누수, 배관 막힘, 누전, 가스밸브 불량</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
                        <div style="background: #e3f2fd; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ③ 마감재 - 2년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">도배, 장판, 타일, 도장, 수장, 미장, 창호</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">도배 들뜸, 장판 변색, 타일 균열, 창호 개폐 불량</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #2ecc71; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 14px; font-weight: bold;">
                            ④ 기타 부위 - 5년
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">대상</td>
                                <td style="padding: 8px; color: #000;">조경, 지능형 홈네트워크, 방수, 단열 등</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">하자 예시</td>
                                <td style="padding: 8px; color: #000;">옥상·발코니 누수, 결로(시공하자), 월패드 고장</td>
                            </tr>
                        </table>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createAirQualityManagementGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #2ecc71; padding-bottom: 10px;">🌿 실내 공기질 관리 가이드</h2>

                    <div style="background: #e8f5e9; border-left: 4px solid #2ecc71; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            새 아파트는 자재에서 나오는 유해물질로 인해 실내 공기질이 나쁠 수 있습니다. 
                            입주 전후 적절한 환기와 관리로 쾌적한 실내 환경을 만드세요.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 자주 환기하기 (가장 중요!)
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 25%; background: #f8f9fa; font-weight: bold; color: #000;">환기 횟수</td>
                                <td style="padding: 10px; color: #000;">하루 3회 이상 (아침, 점심, 저녁)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">환기 시간</td>
                                <td style="padding: 10px; color: #000;">회당 최소 30분 (맞바람 치도록 대각선 창문 개방)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">환기 시기</td>
                                <td style="padding: 10px; color: #000;">입주 최소 2주 전부터 매일 환기 (가능하면 1개월)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">TIP</td>
                                <td style="padding: 10px; color: #000;">미세먼지 나쁨 날도 실내가 더 나쁘므로 짧게라도 환기 필수</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #ffebee; color: #000; border-bottom: 2px solid #e74c3c; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 베이크아웃 (Bake-Out)
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12; margin-bottom: 10px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>베이크아웃이란?</strong><br>
                                실내 온도를 높여서 건축 자재에 남아있는 유해물질을 빠르게 배출시키는 방법
                            </p>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>방법:</strong> 모든 창문 닫고 난방을 켜서 실내 온도를 30~35도까지 올림</li>
                            <li><strong>시간:</strong> 6~8시간 유지</li>
                            <li><strong>환기:</strong> 그 후 모든 창문 열고 2시간 이상 환기</li>
                            <li><strong>반복:</strong> 이 과정을 3~5회 반복하면 효과적</li>
                            <li><strong>시기:</strong> 입주 1~2주 전에 실시 권장</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 공기정화 식물 배치
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 산세베리아</div>
                                <div style="font-size: 11px; color: #000;">밤에도 산소 배출, 음이온 발생</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 스파티필름</div>
                                <div style="font-size: 11px; color: #000;">암모니아, 벤젠 제거 탁월</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 아레카야자</div>
                                <div style="font-size: 11px; color: #000;">공기정화 1위, 가습 효과</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px;">✓ 고무나무</div>
                                <div style="font-size: 11px; color: #000;">포름알데히드 제거 효과</div>
                            </div>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #666; line-height: 1.6;">
                            ※ 권장: 3.3㎡(1평)당 중형 화분 1개 또는 소형 2~3개
                        </p>
                    </div>

                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: #e3f2fd;">
                        <h3 style="margin: 0 0 10px 0; color: #3498db; font-size: 16px;">📊 실내 공기질 권고기준</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                            <thead>
                                <tr style="background: #f8f9fa; border: 1px solid #ddd;">
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">오염물질</th>
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">권고기준</th>
                                    <th style="padding: 10px; color: #000; border: 1px solid #ddd;">주요 배출원</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">라돈</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">148 Bq/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">토양, 콘크리트</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">포름알데히드</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">210 μg/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">합판, 접착제, 벽지</td>
                                </tr>
                                <tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; font-weight: bold; color: #000; border: 1px solid #ddd;">총휘발성유기화합물</td>
                                    <td style="padding: 8px; color: #000; text-align: center; border: 1px solid #ddd;">500 μg/m³ 이하</td>
                                    <td style="padding: 8px; color: #000; font-size: 11px; border: 1px solid #ddd;">페인트, 접착제, 방향제</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #000; line-height: 1.6;">
                            ※ 「다중이용시설 등의 실내공기질관리법」 신축 공동주택 권고기준<br>
                            ※ 기준 초과 시 환기 및 재측정 필요
                        </p>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createCondensationGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #3498db; padding-bottom: 10px;">💧 결로 예방 및 관리 가이드</h2>

                    <div style="background: #e3f2fd; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            결로는 실내외 온도차와 습도로 인해 발생하는 자연현상입니다. 
                            적절한 환기와 실내 습도 관리로 결로 발생을 최소화할 수 있습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 결로란 무엇인가?
                        </div>
                        <p style="margin: 0 0 10px 0; color: #000; font-size: 12px; line-height: 1.8;">
                            <strong>결로(結露):</strong> 공기 중 수증기가 찬 표면에 닿아 물방울로 맺히는 현상
                        </p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 30%; background: #f8f9fa; font-weight: bold; color: #000;">발생 원인</td>
                                <td style="padding: 10px; color: #000;">실내외 온도차 + 높은 실내 습도</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주요 발생 시기</td>
                                <td style="padding: 10px; color: #000;">겨울철 (11월~3월)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주요 발생 장소</td>
                                <td style="padding: 10px; color: #000;">창문, 외벽, 코너, 욕실 주변</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">문제점</td>
                                <td style="padding: 10px; color: #000;">곰팡이 발생, 벽지 손상, 악취, 건강 피해</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 결로 예방 방법
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 4px; border: 1px solid #2ecc71;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px; font-size: 13px;">✓ 환기하기</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 하루 3회, 10분 이상<br>
                                    • 요리·샤워 후 즉시 환기<br>
                                    • 맞바람 치도록 개방
                                </div>
                            </div>
                            <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; border: 1px solid #3498db;">
                                <div style="font-weight: bold; color: #3498db; margin-bottom: 5px; font-size: 13px;">✓ 습도 조절</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 실내 습도 40~60% 유지<br>
                                    • 가습기 사용 자제<br>
                                    • 빨래 실내 건조 금지
                                </div>
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 4px; border: 1px solid #f39c12;">
                                <div style="font-weight: bold; color: #f39c12; margin-bottom: 5px; font-size: 13px;">✓ 실내 온도</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 18~22도 적정 유지<br>
                                    • 난방 과도하게 높이지 않기<br>
                                    • 외출 시에도 최소 난방
                                </div>
                            </div>
                            <div style="background: #ffebee; padding: 12px; border-radius: 4px; border: 1px solid #e74c3c;">
                                <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 13px;">✓ 가구 배치</div>
                                <div style="font-size: 11px; color: #000; line-height: 1.6;">
                                    • 외벽에서 5~10cm 띄우기<br>
                                    • 통풍 공간 확보<br>
                                    • 붙박이장 환기구 열어두기
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #ffebee; color: #000; border-bottom: 2px solid #e74c3c; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 결로 발생 시 대처 방법
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>물기 제거:</strong> 즉시 마른 걸레로 물기를 닦아냄</li>
                            <li><strong>환기:</strong> 물기 제거 후 즉시 환기하여 습기 배출</li>
                            <li><strong>제습:</strong> 제습기 또는 제습제 사용으로 습도 낮춤</li>
                            <li><strong>곰팡이 제거:</strong> 락스 희석액(1:10)으로 소독 후 환기</li>
                            <li><strong>예방:</strong> 재발 방지를 위해 지속적인 환기 및 습도 관리</li>
                        </ul>
                    </div>

                    <div style="border: 2px solid #2ecc71; border-radius: 8px; padding: 15px; background: #e8f5e9;">
                        <h3 style="margin: 0 0 10px 0; color: #2ecc71; font-size: 16px;">💡 더홈점검 TIP</h3>
                        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>결로 vs 누수 구분법:</strong><br>
                                • <strong>결로:</strong> 창문, 벽면 전체에 고르게 물방울 발생, 추운 날 심해짐<br>
                                • <strong>누수:</strong> 특정 부위에만 물이 스며들거나 고임, 날씨와 무관
                            </p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; color: #000; font-size: 12px; line-height: 1.8;">
                                <strong>결로가 아닌 하자일 수 있는 경우:</strong><br>
                                • 단열재 시공 불량 (특정 벽면에만 반복 발생)<br>
                                • 창호 기밀 불량 (창틀 주변에서만 발생)<br>
                                → 이 경우 하자보수 청구 가능
                            </p>
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createMovingInGuidePage() {
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px; position: relative;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #000; border-bottom: 3px solid #9b59b6; padding-bottom: 10px;">🏡 입주 시 알아두면 유용한 정보</h2>

                    <div style="background: #f3e5f5; border-left: 4px solid #9b59b6; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #000; font-size: 13px; line-height: 1.8;">
                            새 아파트 입주를 앞두고 계신가요? 입주 전후 알아두면 도움이 되는 실용 정보를 정리했습니다.
                        </p>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #f3e5f5; color: #000; border-bottom: 2px solid #9b59b6; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            1. 입주 전 필수 준비사항
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; width: 30%; background: #f8f9fa; font-weight: bold; color: #000;">전입신고</td>
                                <td style="padding: 10px; color: #000;">입주일로부터 14일 이내 (주민센터 또는 정부24)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">화재보험 가입</td>
                                <td style="padding: 10px; color: #000;">의무가입 (관리사무소에서 일괄 가입 가능)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">인터넷/TV 신청</td>
                                <td style="padding: 10px; color: #000;">입주 2주 전 신청 (설치까지 1~2주 소요)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">가스 개통</td>
                                <td style="padding: 10px; color: #000;">도시가스 회사에 개통 신청 (방문 검사 필요)</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #000;">주차등록</td>
                                <td style="padding: 10px; color: #000;">관리사무소에 차량번호 등록 (차량등록증 지참)</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e8f5e9; color: #000; border-bottom: 2px solid #2ecc71; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            2. 관리비 절약 노하우
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #2ecc71; margin-bottom: 5px; font-size: 12px;">난방비 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>적정온도 유지 (20~22도)</li>
                                    <li>외출 시 저온모드</li>
                                    <li>보일러 정기점검</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #3498db; margin-bottom: 5px; font-size: 12px;">전기세 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>대기전력 차단</li>
                                    <li>LED 조명 사용</li>
                                    <li>냉장고 적정온도</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #f39c12; margin-bottom: 5px; font-size: 12px;">수도세 절약</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>절수형 샤워기 설치</li>
                                    <li>설거지 물 받아서</li>
                                    <li>누수 즉시 수리</li>
                                </ul>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 12px;">쓰레기봉투</div>
                                <ul style="margin: 5px 0 0 0; padding-left: 15px; font-size: 11px; color: #000; line-height: 1.6;">
                                    <li>분리수거 철저히</li>
                                    <li>음식물 물기 제거</li>
                                    <li>종량제봉투 아껴쓰기</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="background: #e3f2fd; color: #000; border-bottom: 2px solid #3498db; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            3. 비상 시 주요 연락처
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; width: 35%; background: #f8f9fa; font-weight: bold; color: #000;">관리사무소</td>
                                <td style="padding: 8px; color: #000;">일반 문의, 하자보수, 주차 등</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">경비실</td>
                                <td style="padding: 8px; color: #000;">야간/주말 긴급 상황</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">도시가스 (119)</td>
                                <td style="padding: 8px; color: #000;">가스 누출 신고</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">한국전력 (123)</td>
                                <td style="padding: 8px; color: #000;">정전, 전기 고장</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; background: #f8f9fa; font-weight: bold; color: #000;">수도 (120)</td>
                                <td style="padding: 8px; color: #000;">상수도 고장, 수질 문제</td>
                            </tr>
                        </table>
                    </div>

                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <div style="background: #fff3e0; color: #000; border-bottom: 2px solid #f39c12; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-size: 15px; font-weight: bold;">
                            4. 이웃 간 층간소음 예방 에티켓
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #000; line-height: 1.8;">
                            <li><strong>조용히 해야 할 시간:</strong> 오후 10시 ~ 오전 8시 (법정 시간)</li>
                            <li><strong>어린이 뛰어다님:</strong> 실내화 착용, 매트 깔기, 조용한 놀이 유도</li>
                            <li><strong>망치질/드릴 작업:</strong> 평일 낮 시간대만 (사전 양해 구하기)</li>
                            <li><strong>세탁기/청소기:</strong> 오전 8시 이후, 오후 10시 이전 사용</li>
                            <li><strong>반려동물:</strong> 짖음 방지 훈련, 배변 매너 준수</li>
                            <li><strong>피아노/악기 연습:</strong> 방음 처리 또는 시간대 조절</li>
                        </ul>
                        <div style="background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c; margin-top: 10px;">
                            <p style="margin: 0; color: #000; font-size: 11px; line-height: 1.6;">
                                <strong>※ 층간소음 분쟁 시:</strong><br>
                                1차: 관리사무소 중재 → 2차: 층간소음 이웃사이센터(1661-2642) 상담 → 3차: 환경분쟁조정위원회 조정 신청
                            </p>
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function createAirQualityDetailPage() {
            const airQualityData = projectData.airQuality.filter(room => 
                room.radon || room.formaldehyde || room.vocs
            );

            // 기준치
            const standards = {
                radon: 148,
                formaldehyde: 0.210,
                vocs: 0.500
            };

            // 표 생성
            let tableRows = '';
            airQualityData.forEach((room) => {
                const radonValue = parseFloat(room.radon) || 0;
                const formaldehydeValue = parseFloat(room.formaldehyde) || 0;
                const vocsValue = parseFloat(room.vocs) || 0;

                const radonStatus = radonValue > 0 ? (radonValue <= standards.radon ? '적합' : '부적합') : '-';
                const formaldehydeStatus = formaldehydeValue > 0 ? (formaldehydeValue <= standards.formaldehyde ? '적합' : '부적합') : '-';
                const vocsStatus = vocsValue > 0 ? (vocsValue <= standards.vocs ? '적합' : '부적합') : '-';

                tableRows += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; color: #000000;">${room.name}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.radon || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${radonValue > standards.radon ? '#e74c3c' : '#10b981'}; font-weight: bold;">${radonStatus}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.formaldehyde || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${formaldehydeValue > standards.formaldehyde ? '#e74c3c' : '#10b981'}; font-weight: bold;">${formaldehydeStatus}</td>
                        <td style="padding: 10px; text-align: center; color: #000000;">${room.vocs || '-'}</td>
                        <td style="padding: 10px; text-align: center; color: ${vocsValue > standards.vocs ? '#e74c3c' : '#10b981'}; font-weight: bold;">${vocsStatus}</td>
                    </tr>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px;">
                    <div style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                        <h1 style="margin: 0 0 8px 0; font-size: 26px;">실내 공기질 측정 결과</h1>
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">${projectData.apartmentName} ${projectData.dong} ${projectData.ho} | ${projectData.inspectionDate || ''}</p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #000000; border-bottom: 2px solid #16a085; padding-bottom: 8px;">📋 측정 데이터</h3>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">공간</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">라돈<br>(Bq/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">포름알데히드<br>(mg/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">총VOCs<br>(mg/m³)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; color: #000000;">판정</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">✓ 권고기준 (실내공기질 공정시험기준)</h4>
                        <div style="font-size: 14px; color: #1b5e20; line-height: 2;">
                            <div>• 라돈(Rn): <strong>148 Bq/m³ 이하</strong></div>
                            <div>• 포름알데히드(HCHO): <strong>0.210 mg/m³ 이하</strong></div>
                            <div>• 총휘발성유기화합물(TVOCs): <strong>0.500 mg/m³ 이하</strong></div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #856404; line-height: 1.6;">
                            <strong>※ 참고사항</strong><br>
                            - 측정 결과는 측정 당시의 환경 조건에 따라 달라질 수 있습니다.<br>
                            - 부적합 판정 시 환기 등의 조치 후 재측정을 권장합니다.<br>
                            - 라돈 농도는 계절, 시간대에 따라 변동이 있을 수 있습니다.
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 20px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 11px; color: #000000; text-align: center;">
                        <div>더홈점검 | 전화: 070-8019-1456 / 010-9985-0128 | 사전점검 전문업체</div>
                    </div>
                </div>
            `;
        }

        // ==================== IndexedDB 설정 ====================
        let db;
        const DB_NAME = 'TheHomeInspectionDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'projects';

        // IndexedDB 초기화
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('savedAt', 'savedAt', { unique: false });
                        objectStore.createIndex('apartmentName', 'apartmentName', { unique: false });
                    }
                };
            });
        }

        // IndexedDB에 데이터 저장
        async function saveToIndexedDB(key, data) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    
                    // data에서 id 제거하고 key를 id로 사용
                    const dataToSave = { ...data };
                    delete dataToSave.id; // 기존 id 제거
                    const finalData = { id: key, ...dataToSave };
                    
                    const request = objectStore.put(finalData);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 저장 오류:', e);
                throw e;
            }
        }

        // IndexedDB에서 데이터 불러오기
        async function loadFromIndexedDB(key) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.get(key);
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result) {
                            // IndexedDB의 id 키 제거 (저장용 id이므로)
                            const { id, ...data } = result;
                            resolve(data);
                        } else {
                            resolve(null);
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 불러오기 오류:', e);
                return null;
            }
        }

        // IndexedDB에서 모든 프로젝트 가져오기
        async function getAllFromIndexedDB() {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 목록 조회 오류:', e);
                return [];
            }
        }

        // IndexedDB에서 데이터 삭제
        async function deleteFromIndexedDB(key) {
            try {
                if (!db) await initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.delete(key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IndexedDB 삭제 오류:', e);
                throw e;
            }
        }

        // ==================== 자동 저장 함수 ====================
        let autoSaveTimeout;
        
        function autoSaveProjectData() {
            // 디바운싱: 0.5초 후 저장 (연속 입력 시 마지막만 저장)
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                // projectData 업데이트
                projectData.apartmentName = document.getElementById('apartmentName').value;
                projectData.dong = document.getElementById('dong').value;
                projectData.ho = document.getElementById('ho').value;
                projectData.inspectionDate = document.getElementById('inspectionDate').value;
                projectData.customerName = document.getElementById('customerName').value;
                projectData.customerPhone = document.getElementById('customerPhone').value;
                
                // 저장
                await saveToLocalStorage();
                updateProgress();
                
                console.log('✅ 자동 저장 완료');
            }, 500);
        }

        // ==================== 데이터 저장/불러오기 ====================
        async function saveToLocalStorage() {
            try {
                await saveToIndexedDB('thehomein_current', projectData);
            } catch (e) {
                console.error('저장 오류:', e);
                alert('저장 실패: ' + e.message);
            }
        }

        async function loadFromLocalStorage() {
            try {
                const saved = await loadFromIndexedDB('thehomein_current');
                if (saved) {
                    projectData = saved;
                    
                    document.getElementById('apartmentName').value = projectData.apartmentName || '';
                    document.getElementById('dong').value = projectData.dong || '';
                    document.getElementById('ho').value = projectData.ho || '';
                    document.getElementById('inspectionDate').value = projectData.inspectionDate || '';
                    document.getElementById('customerName').value = projectData.customerName || '';
                    document.getElementById('customerPhone').value = projectData.customerPhone || '';
                    
                    displayFloorplan();
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    
                    if (projectData.defects.length > 0) {
                        defectIdCounter = Math.max(...projectData.defects.map(d => d.id)) + 1;
                    }
                    if (projectData.equipment && projectData.equipment.length > 0) {
                        equipmentIdCounter = Math.max(...projectData.equipment.map(e => e.id)) + 1;
                    }
                    if (projectData.airQuality.length > 0) {
                        airQualityIdCounter = Math.max(...projectData.airQuality.map(a => a.id)) + 1;
                    }
                }
            } catch (e) {
                console.error('불러오기 오류:', e);
            }
        }

        async function saveCurrentData() {
            const timestamp = new Date().toISOString();
            const key = `thehomein_${timestamp}`;
            
            try {
                await saveToIndexedDB(key, {
                    ...projectData,
                    savedAt: timestamp
                });
                await renderSavedList();
                showToast('데이터가 저장되었습니다');
            } catch (e) {
                alert('저장 실패: ' + e.message);
            }
        }

        async function renderSavedList() {
            const container = document.getElementById('savedList');
            
            try {
                const saved = await getAllFromIndexedDB();
                const filtered = saved.filter(item => item.id !== 'thehomein_current');
                
                if (filtered.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">저장된 프로젝트가 없습니다</p>';
                    return;
                }
                
                // 최신순 정렬
                filtered.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
                
                container.innerHTML = filtered.map(item => `
                    <div class="saved-item">
                        <div class="saved-info">
                            <h3>${item.apartmentName || '제목 없음'} ${item.dong} ${item.ho}</h3>
                            <p>${new Date(item.savedAt).toLocaleString('ko-KR')}</p>
                        </div>
                        <div class="saved-actions">
                            <button class="icon-btn load" onclick="loadSavedData('${item.id}')">📂</button>
                            <button class="icon-btn delete" onclick="deleteSavedData('${item.id}')">🗑️</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('목록 렌더링 오류:', e);
                container.innerHTML = '<p style="color: red; text-align: center;">목록을 불러오는 중 오류가 발생했습니다</p>';
            }
        }

        async function loadSavedData(key) {
            if (confirm('현재 작업 중인 데이터를 불러온 데이터로 덮어쓰시겠습니까?')) {
                try {
                    const data = await loadFromIndexedDB(key);
                    if (!data) {
                        alert('데이터를 찾을 수 없습니다');
                        return;
                    }
                    
                    projectData = data;
                    
                    // equipment 데이터가 없으면 초기화
                    if (!projectData.equipment) {
                        projectData.equipment = [];
                    }
                    
                    document.getElementById('apartmentName').value = projectData.apartmentName || '';
                    document.getElementById('dong').value = projectData.dong || '';
                    document.getElementById('ho').value = projectData.ho || '';
                    document.getElementById('inspectionDate').value = projectData.inspectionDate || '';
                    document.getElementById('customerName').value = projectData.customerName || '';
                    document.getElementById('customerPhone').value = projectData.customerPhone || '';
                    
                    displayFloorplan();
                    renderDefects();
                    renderEquipment();
                    renderAirQuality();
                    await saveToLocalStorage();
                    updateProgress();
                    
                    showToast('데이터를 불러왔습니다');
                    switchTab('project');
                } catch (e) {
                    alert('불러오기 실패: ' + e.message);
                }
            }
        }

        async function deleteSavedData(key) {
            if (confirm('이 프로젝트를 삭제하시겠습니까?')) {
                try {
                    await deleteFromIndexedDB(key);
                    await renderSavedList();
                    showToast('프로젝트가 삭제되었습니다');
                } catch (e) {
                    alert('삭제 실패: ' + e.message);
                }
            }
        }

        async function clearAllData() {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                if (confirm('다시 한번 확인합니다. 모든 데이터가 삭제됩니다.')) {
                    try {
                        const allData = await getAllFromIndexedDB();
                        
                        for (const item of allData) {
                            await deleteFromIndexedDB(item.id);
                        }
                        
                        projectData = {
                            apartmentName: '',
                            dong: '',
                            ho: '',
                            inspectionDate: '',
                            customerName: '',
                            customerPhone: '',
                            floorplan: null,
                            defects: [],
                            equipment: [],
                            airQuality: []
                        };
                        
                        defectIdCounter = 1;
                        equipmentIdCounter = 1;
                        airQualityIdCounter = 1;
                        
                        document.getElementById('apartmentName').value = '';
                        document.getElementById('dong').value = '';
                        document.getElementById('ho').value = '';
                        document.getElementById('inspectionDate').valueAsDate = new Date();
                        document.getElementById('customerName').value = '';
                        document.getElementById('customerPhone').value = '';
                        
                        displayFloorplan();
                        renderDefects();
                        renderEquipment();
                        renderAirQuality();
                        await renderSavedList();
                        updateProgress();
                        
                        showToast('모든 데이터가 삭제되었습니다');
                    } catch (e) {
                        alert('삭제 실패: ' + e.message);
                    }
                }
            }
        }
    </script>
</body>
</html>
