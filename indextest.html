<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë”í™ˆì ê²€ - í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <meta name="google" content="notranslate">
    <meta name="google" content="nositelinkssearchbox">
    
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë”í™ˆì ê²€">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ìœ ì§€ + ë³´ê³ ì„œìš© í°íŠ¸ ì¶”ê°€ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #fbbf24;
            --danger: #ef4444;
            --bg-dark: #1a202c;
            --card-bg: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }

        body.light-mode {
            --bg-dark: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --border: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light-mode { background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: relative;
        }

        .header h1 { font-size: 24px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; border-radius: 10px; transition: width 0.3s ease; }

        .tabs {
            display: flex; background: var(--card-bg); border-radius: 12px; padding: 5px; margin: 20px -20px; gap: 5px;
            overflow-x: auto; -webkit-overflow-scrolling: touch; position: sticky; top: 0; z-index: 99; backdrop-filter: blur(10px);
        }
        .tab { flex: 1; padding: 12px 20px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 8px; font-weight: bold; white-space: nowrap; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .form-field { margin-bottom: 20px; }
        .form-label { display: block; color: var(--primary); font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-input { width: 100%; padding: 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 16px; }
        body.light-mode .form-input { background: rgba(255, 255, 255, 0.9); border: 1px solid #d1d5db; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-secondary { background: rgba(251, 191, 36, 0.1); border: 2px solid var(--secondary); color: var(--secondary); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); color: var(--danger); }

        /* ì¹´ë©”ë¼ ë° ê¸°íƒ€ UI */
        .camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; flex-direction: column; }
        .camera-modal.active { display: flex; }
        #cameraPreview { width: 100%; height: 100%; object-fit: cover; }
        .camera-controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .camera-btn { width: 80px; height: 80px; border-radius: 50%; background: white; border: 4px solid #ccc; cursor: pointer; }
        .close-camera { background: #ef4444; border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; }
        
        /* ë¡œë”© */
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; color: white; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ê¸°íƒ€ ìœ í‹¸ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-item { aspect-ratio: 1; position: relative; border-radius: 8px; overflow: hidden; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .touch-button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .touch-btn { padding: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.1); color: var(--text-secondary); border-radius: 8px; cursor: pointer; font-size: 13px; }
        .touch-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* í…Œë§ˆ í† ê¸€ */
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; }

        /* í”Œë¡œíŒ… ë²„íŠ¼ */
        .floating-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 900; }
    </style>
</head>
<body>
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">ğŸŒ™</button>
        <h1>ğŸ  ë”í™ˆì ê²€</h1>
        <p>í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ v3.2 (Professional Report)</p>
        <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">ğŸ“ í”„ë¡œì íŠ¸</button>
            <button class="tab" onclick="switchTab('defects', event)">ğŸ” í•˜ìì ê²€</button>
            <button class="tab" onclick="switchTab('equipment', event)">ğŸ“¸ ì¥ë¹„ì ê²€</button>
            <button class="tab" onclick="switchTab('data', event)">ğŸ’¾ ë°ì´í„°</button>
        </div>

        <div id="project" class="section active">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í”„ë¡œì íŠ¸ ì •ë³´</h2>
                <div class="form-field">
                    <label class="form-label">ì•„íŒŒíŠ¸ëª…</label>
                    <input type="text" class="form-input" id="apartmentName" placeholder="ì˜ˆ: ë˜ë¯¸ì•ˆ ì•„íŒŒíŠ¸" oninput="autoSaveProjectData()">
                </div>
                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">ë™</label>
                        <input type="text" class="form-input" id="dong" placeholder="101" oninput="cleanDongHo(this, 'ë™'); autoSaveProjectData()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">í˜¸ìˆ˜</label>
                        <input type="text" class="form-input" id="ho" placeholder="502" oninput="cleanDongHo(this, 'í˜¸'); autoSaveProjectData()">
                    </div>
                </div>
                <div class="form-field">
                    <label class="form-label">ì ê²€ì¼ì</label>
                    <input type="date" class="form-input" id="inspectionDate" onchange="autoSaveProjectData()">
                </div>
                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">ê³ ê°ëª…</label>
                        <input type="text" class="form-input" id="customerName" placeholder="ê³ ê° ì´ë¦„" oninput="autoSaveProjectData()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">ì‘ì„±ì</label>
                        <input type="text" class="form-input" id="author" placeholder="ì ê²€ì ì´ë¦„" oninput="autoSaveProjectData()">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í‰ë©´ë„</h2>
                <div style="text-align: center;">
                    <img id="floorplanPreview" style="max-width: 100%; display: none; border-radius: 8px; margin-bottom: 10px;">
                    <p id="floorplanPlaceholder" style="color: var(--text-secondary); padding: 40px;">í‰ë©´ë„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="openFloorplanCamera()">ğŸ“· ì´¬ì˜</button>
                        <button class="btn btn-secondary" onclick="openFloorplanGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="defects" class="section">
            <div id="defectsList"></div>
            <div style="height: 80px;"></div> </div>

        <div id="equipment" class="section">
            <div id="equipmentList"></div>
            <div style="height: 80px;"></div>
        </div>

        <div id="data" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ’¾ ë³´ê³ ì„œ ìƒì„± & ì €ì¥</h2>
                <button class="btn btn-primary" onclick="generatePDF()">ğŸ“„ PDF ë³´ê³ ì„œ ìƒì„± (ë””ìì¸ v3.2)</button>
                <div style="height: 10px;"></div>
                <button class="btn btn-secondary" onclick="downloadAllData()">ğŸ“¦ ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ZIP)</button>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <button class="btn btn-danger" onclick="resetProject()">ğŸ—‘ï¸ ìƒˆ í”„ë¡œì íŠ¸ (ì´ˆê¸°í™”)</button>
                </div>
            </div>
        </div>
    </div>

    <button id="floatingAddBtn" class="floating-btn" onclick="handleFloatingBtnClick()" style="display: none;">â•</button>

    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="close-camera" onclick="closeCameraModal()">âœ•</button>
            <button class="camera-btn" onclick="capturePhoto()"></button>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ==================== ì „ì—­ ìƒíƒœ ====================
        const projectData = new Proxy({
            apartmentName: '', dong: '', ho: '', inspectionDate: '', customerName: '', author: '',
            floorplan: null,
            defects: [],
            equipment: [],
            airQuality: []
        }, {
            set(target, prop, value) {
                target[prop] = value;
                return true;
            }
        });

        let currentPhotoTarget = null;

        // ==================== ì´ˆê¸°í™” ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            if(!document.getElementById('inspectionDate').value) {
                document.getElementById('inspectionDate').valueAsDate = new Date();
            }
            updateProgress();
        });

        // ==================== PDF ìƒì„± ë¡œì§ (ë””ìì¸ ë¦¬ë‰´ì–¼ v3.2) ====================
        
        // ë¡œê³  HTML ìƒì„± (ê³ í•´ìƒë„ ë²¡í„° ìŠ¤íƒ€ì¼)
        function getLogoHtml() {
            // SVGë¡œ ì§‘ ëª¨ì–‘ ë¡œê³  + 'ë”í™ˆì ê²€' í…ìŠ¤íŠ¸ êµ¬í˜„
            return `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 4L4 16H8V34H16V24H24V34H32V16H36L20 4Z" fill="url(#paint0_linear)" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                        <path d="M16 24C16 21.7909 17.7909 20 20 20C22.2091 20 24 21.7909 24 24V34H16V24Z" fill="#8B5CF6"/>
                        <defs>
                            <linearGradient id="paint0_linear" x1="20" y1="4" x2="20" y2="34" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#22D3EE"/>
                                <stop offset="1" stop-color="#3B82F6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <div style="display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 22px; font-weight: 900; color: #1f2937; letter-spacing: -1px; line-height: 1; font-family: 'Malgun Gothic', sans-serif;">
                            ë”í™ˆì ê²€
                        </div>
                    </div>
                </div>
            `;
        }

        // 1. í‘œì§€ ë° ìš”ì•½ í˜ì´ì§€
        window.createSummaryFirstPage = function() {
            let defectRows = '';
            const displayDefects = projectData.defects.slice(0, 15); 
            
            displayDefects.forEach((defect, index) => {
                const spaces = defect.spaces ? defect.spaces.join(', ') : '-';
                const locations = defect.locations ? defect.locations.join(', ') : '-';
                const types = defect.types ? defect.types.join(', ') : '-';
                const description = defect.description || '-';
                
                defectRows += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 10px 5px; text-align: center; font-weight: 800; color: #10b981; font-size: 11px;">${String(index + 1).padStart(2, '0')}</td>
                        <td style="padding: 10px 5px; text-align: center; color: #374151; font-weight: 700; font-size: 11px;">${spaces}</td>
                        <td style="padding: 10px 5px; text-align: center; color: #4b5563; font-weight: 600; font-size: 11px;">${locations}</td>
                        <td style="padding: 10px 5px; color: #4b5563; font-weight: 600; font-size: 11px;">${types}</td>
                        <td style="padding: 10px 5px; color: #6b7280; font-size: 10px; line-height: 1.4;">${description}</td>
                    </tr>
                `;
            });

            const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 45px; box-sizing: border-box; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 3px solid #10b981; padding-bottom: 20px; margin-bottom: 35px;">
                        <div>${getLogoHtml()}</div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: #10b981; font-weight: 800; margin-bottom: 4px; letter-spacing: 2px; text-transform: uppercase;">Pre-Inspection Report</div>
                            <div style="font-size: 28px; color: #1f2937; font-weight: 900; letter-spacing: -0.5px;">ì‚¬ì „ì ê²€ ê²°ê³¼ë³´ê³ ì„œ</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 20px; margin-bottom: 35px;">
                        <div style="flex: 1; background: #f9fafb; border-radius: 12px; padding: 25px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                            <h3 style="margin: 0 0 20px 0; font-size: 14px; color: #10b981; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Project Info</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <tr><td style="padding: 8px 0; color: #9ca3af; width: 80px; font-weight: 500;">ì•„íŒŒíŠ¸ëª…</td><td style="padding: 8px 0; color: #1f2937; font-weight: 700;">${projectData.apartmentName}</td></tr>
                                <tr><td style="padding: 8px 0; color: #9ca3af; font-weight: 500;">ë™ / í˜¸ìˆ˜</td><td style="padding: 8px 0; color: #1f2937; font-weight: 700;">${projectData.dong}ë™ ${projectData.ho}í˜¸</td></tr>
                                <tr><td style="padding: 8px 0; color: #9ca3af; font-weight: 500;">ì ê²€ì¼ì</td><td style="padding: 8px 0; color: #1f2937; font-weight: 600;">${projectData.inspectionDate || '-'}</td></tr>
                                <tr><td style="padding: 8px 0; color: #9ca3af; font-weight: 500;">ê³ ê°ëª…</td><td style="padding: 8px 0; color: #1f2937; font-weight: 600;">${projectData.customerName || '-'}</td></tr>
                                <tr><td style="padding: 15px 0 0 0; color: #9ca3af; font-weight: 500; border-top: 1px solid #e5e7eb;">ì´ í•˜ì</td><td style="padding: 15px 0 0 0; color: #ef4444; font-weight: 800; font-size: 16px; border-top: 1px solid #e5e7eb;">${projectData.defects.length} ê±´</td></tr>
                            </table>
                        </div>

                        <div style="flex: 1.2; background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                            ${projectData.floorplan 
                                ? `<img src="${projectData.floorplan}" style="max-width: 100%; max-height: 100%; object-fit: contain;" />` 
                                : `<div style="color: #d1d5db; font-size: 13px; text-align: center; display: flex; flex-direction: column; gap: 10px; align-items: center;"><span style="font-size: 24px;">ğŸ“</span><span>í‰ë©´ë„ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span></div>`
                            }
                            <div style="position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.9); padding: 4px 10px; border-radius: 6px; font-size: 10px; color: #4b5563; font-weight: 800; border: 1px solid #e5e7eb;">FLOOR PLAN</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                         <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 4px; height: 18px; background: #10b981; margin-right: 10px; border-radius: 2px;"></div>
                            <h3 style="margin: 0; font-size: 16px; color: #1f2937; font-weight: 800;">ì£¼ìš” í•˜ì ë‚´ì—­ (ìš”ì•½)</h3>
                         </div>
                         <table style="width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; border-top: 2px solid #1f2937;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 1px solid #d1d5db;">
                                    <th style="padding: 12px; text-align: center; width: 40px; color: #4b5563; font-weight: 700;">No</th>
                                    <th style="padding: 12px; text-align: center; width: 80px; color: #4b5563; font-weight: 700;">ê³µê°„</th>
                                    <th style="padding: 12px; text-align: center; width: 80px; color: #4b5563; font-weight: 700;">ìœ„ì¹˜</th>
                                    <th style="padding: 12px; text-align: left; width: 120px; color: #4b5563; font-weight: 700;">ìœ í˜•</th>
                                    <th style="padding: 12px; text-align: left; color: #4b5563; font-weight: 700;">ë‚´ìš©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${defectRows || '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #9ca3af;">ë“±ë¡ëœ í•˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                         </table>
                    </div>

                    <div style="position: absolute; bottom: 40px; left: 45px; right: 45px; border-top: 1px solid #e5e7eb; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #9ca3af;">
                        <div style="font-weight: 600;">THE HOME INSPECTION</div>
                        <div>${today}</div>
                    </div>
                </div>
            `;
        }

        // 2. í•˜ì ëª©ë¡ í˜ì´ì§€
        window.createDefectListPage = function(startIndex, itemsPerPage = 18) {
            let defectRows = '';
            const endIndex = Math.min(startIndex + itemsPerPage, projectData.defects.length);
            const defectsToDisplay = projectData.defects.slice(startIndex, endIndex);
            
            defectsToDisplay.forEach((defect, index) => {
                const globalIndex = startIndex + index + 1;
                const spaces = defect.spaces ? defect.spaces.join(', ') : '-';
                const locations = defect.locations ? defect.locations.join(', ') : '-';
                const types = defect.types ? defect.types.join(', ') : '-';
                const description = defect.description || '-';
                
                defectRows += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 12px 5px; text-align: center; font-weight: 800; color: #10b981;">${String(globalIndex).padStart(2, '0')}</td>
                        <td style="padding: 12px 5px; text-align: center; color: #374151; font-weight: 600;">${spaces}</td>
                        <td style="padding: 12px 5px; text-align: center; color: #374151; font-weight: 600;">${locations}</td>
                        <td style="padding: 12px 5px; color: #374151;">${types}</td>
                        <td style="padding: 12px 5px; color: #6b7280;">${description}</td>
                    </tr>
                `;
            });

            const totalPages = Math.ceil((projectData.defects.length - 15) / 18) + 1;
            const currentPage = Math.floor((startIndex - 15) / 18) + 2;

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 45px; box-sizing: border-box; position: relative;">
                    <div style="border-bottom: 2px solid #f3f4f6; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${getLogoHtml().replace('22px', '18px').replace('40', '30').replace('40', '30')}
                            <div style="height: 16px; width: 1px; background: #d1d5db;"></div>
                            <h2 style="margin: 0; font-size: 16px; color: #374151; font-weight: 700;">í•˜ì ì ê²€ ë‚´ì—­ ìƒì„¸</h2>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; background: #f9fafb; padding: 4px 10px; border-radius: 20px; border: 1px solid #e5e7eb;">
                            ${projectData.apartmentName} ${projectData.dong}ë™ ${projectData.ho}í˜¸
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 1px solid #d1d5db;">
                                <th style="padding: 10px; text-align: center; width: 40px; color: #4b5563; font-weight: 700;">No</th>
                                <th style="padding: 10px; text-align: center; width: 90px; color: #4b5563; font-weight: 700;">ê³µê°„</th>
                                <th style="padding: 10px; text-align: center; width: 90px; color: #4b5563; font-weight: 700;">ìœ„ì¹˜</th>
                                <th style="padding: 10px; text-align: left; width: 130px; color: #4b5563; font-weight: 700;">í•˜ì ìœ í˜•</th>
                                <th style="padding: 10px; text-align: left; color: #4b5563; font-weight: 700;">ìƒì„¸ ì„¤ëª…</th>
                            </tr>
                        </thead>
                        <tbody>${defectRows}</tbody>
                    </table>

                    <div style="position: absolute; bottom: 40px; left: 45px; right: 45px; border-top: 1px solid #e5e7eb; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #9ca3af;">
                        <div style="font-weight: 600;">THE HOME INSPECTION</div>
                        <div>Page ${currentPage} / ${totalPages}</div>
                    </div>
                </div>
            `;
        }

        // 3. í•˜ì ìƒì„¸ ì‚¬ì§„ í˜ì´ì§€
        window.createDefectDetailPage = async function(defects, startIndex) {
            let contentHTML = '';
            
            for (let idx = 0; idx < defects.length; idx++) {
                const defect = defects[idx];
                const globalIndex = startIndex + idx + 1;
                
                const dongHo = `${projectData.dong}ë™${projectData.ho}í˜¸`;
                const farPhotoOriginal = defect.photos && defect.photos[0] ? defect.photos[0] : '';
                const closePhotoOriginal = defect.photos && defect.photos[1] ? defect.photos[1] : '';
                
                const farPhoto = farPhotoOriginal ? await window.addWatermarkToPhoto(farPhotoOriginal, `${dongHo}_${globalIndex}`) : '';
                const closePhoto = closePhotoOriginal ? await window.addWatermarkToPhoto(closePhotoOriginal, `${dongHo}_${globalIndex}-1`) : '';
                
                const spaces = defect.spaces ? defect.spaces.join(', ') : '-';
                const description = defect.description || 'ë‚´ìš© ì—†ìŒ';
                
                contentHTML += `
                    <div style="margin-bottom: 25px; break-inside: avoid; background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; padding: 10px 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                            <div style="background: #10b981; color: white; font-weight: 800; font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">
                                #${String(globalIndex).padStart(2, '0')}
                            </div>
                            <div style="font-size: 13px; font-weight: 700; color: #1f2937;">${spaces}</div>
                            <div style="width: 1px; height: 12px; background: #d1d5db; margin: 0 10px;"></div>
                            <div style="font-size: 12px; color: #4b5563; flex: 1;">${description}</div>
                        </div>
                        <div style="display: flex; gap: 2px; padding: 2px; background: #e5e7eb;">
                            <div style="flex: 1; background: white; position: relative; height: 220px;">
                                ${farPhoto ? 
                                    `<img src="${farPhoto}" style="width: 100%; height: 100%; object-fit: contain;" />` : 
                                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px; background: #f3f4f6;">ì›ê²½ ì‚¬ì§„ ì—†ìŒ</div>`
                                }
                                <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600;">ì›ê²½ (Location)</div>
                            </div>
                            <div style="flex: 1; background: white; position: relative; height: 220px;">
                                ${closePhoto ? 
                                    `<img src="${closePhoto}" style="width: 100%; height: 100%; object-fit: contain;" />` : 
                                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px; background: #f3f4f6;">ê·¼ê²½ ì‚¬ì§„ ì—†ìŒ</div>`
                                }
                                <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(16, 185, 129, 0.9); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600;">ê·¼ê²½ (Detail)</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 45px; box-sizing: border-box; position: relative;">
                    <div style="border-bottom: 2px solid #10b981; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; font-weight: 800; color: #1f2937;">í•˜ì ìƒì„¸ ë¦¬í¬íŠ¸</div>
                            <span style="font-size: 12px; color: #10b981; font-weight: 600; background: #ecfdf5; padding: 4px 10px; border-radius: 20px;">Photo Log</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">${projectData.apartmentName}</div>
                    </div>
                    ${contentHTML}
                    <div style="position: absolute; bottom: 40px; left: 45px; right: 45px; border-top: 1px solid #e5e7eb; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #9ca3af;">
                        <div style="font-weight: 600;">THE HOME INSPECTION</div>
                        <div>${projectData.inspectionDate || '-'}</div>
                    </div>
                </div>
            `;
        }

        // 4. ì¥ë¹„ ì ê²€ í˜ì´ì§€
        window.createEquipmentPage = function(equipmentList, startIndex) {
            let contentHTML = '';
            equipmentList.forEach((item, idx) => {
                const globalIndex = startIndex + idx + 1;
                const space = item.space || (item.spaces ? item.spaces.join(', ') : '-');
                
                if (item.photos && item.photos['ì¢Œì¸¡ìƒë‹¨']) {
                    item.photos = { 'ì¢Œì¸¡': item.photos['ì¢Œì¸¡ìƒë‹¨']||null, 'ìš°ì¸¡': item.photos['ìš°ì¸¡ìƒë‹¨']||null, 'ë°”ë‹¥1': item.photos['ë°”ë‹¥']||null, 'ë°”ë‹¥2': null };
                }
                const hasLocationPhotos = item.photos && typeof item.photos === 'object';
                
                contentHTML += `
                     <div style="margin-bottom: 30px; break-inside: avoid; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="background: #f9fafb; padding: 12px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 800; color: #1f2937; font-size: 14px;">
                                <span style="color: #10b981; margin-right: 8px;">#${String(globalIndex).padStart(2, '0')}</span>${space}
                            </div>
                            <div style="font-size: 11px; color: #10b981; background: #ecfdf5; padding: 2px 8px; border-radius: 4px; font-weight: 700; border: 1px solid #a7f3d0;">ì¥ë¹„ ì ê²€</div>
                        </div>
                        <div style="padding: 12px 20px; border-bottom: 1px solid #e5e7eb; background: white;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">ì ê²€ ê²°ê³¼</div>
                            <div style="font-size: 13px; color: #1f2937; font-weight: 500;">${item.inspection || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
                        </div>
                        <div style="padding: 15px; background: white;">
                             ${(() => {
                                const colors = { 'ì¢Œì¸¡': '#3b82f6', 'ìš°ì¸¡': '#ef4444', 'ë°”ë‹¥1': '#f59e0b', 'ë°”ë‹¥2': '#f59e0b' };
                                if (!hasLocationPhotos) {
                                    return item.photo ? `<div style="text-align: center;"><img src="${item.photo}" style="max-width: 100%; height: 200px; object-fit: contain; border-radius: 6px;" /></div>` : `<div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 12px; background: #f3f4f6; border-radius: 6px;">ì‚¬ì§„ ì—†ìŒ</div>`;
                                }
                                let photosHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                                ['ì¢Œì¸¡', 'ìš°ì¸¡'].forEach(loc => {
                                    if (item.photos[loc]) {
                                        photosHtml += `<div style="border: 1px solid #eee; border-radius: 6px; overflow: hidden;"><div style="background: ${colors[loc]}10; color: ${colors[loc]}; font-size: 11px; font-weight: 800; text-align: center; padding: 6px; border-bottom: 1px solid ${colors[loc]}20;">${loc}</div><img src="${item.photos[loc]}" style="width: 100%; height: 180px; object-fit: cover; display: block;" /></div>`;
                                    }
                                });
                                ['ë°”ë‹¥1', 'ë°”ë‹¥2'].forEach(loc => {
                                     if (item.photos[loc]) {
                                        photosHtml += `<div style="border: 1px solid #eee; border-radius: 6px; overflow: hidden;"><div style="background: ${colors[loc]}10; color: ${colors[loc]}; font-size: 11px; font-weight: 800; text-align: center; padding: 6px; border-bottom: 1px solid ${colors[loc]}20;">${loc}</div><img src="${item.photos[loc]}" style="width: 100%; height: 180px; object-fit: cover; display: block;" /></div>`;
                                    }
                                });
                                photosHtml += '</div>';
                                return photosHtml;
                             })()}
                        </div>
                    </div>
                `;
            });

            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 45px; box-sizing: border-box; position: relative;">
                    <div style="border-bottom: 2px solid #10b981; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;">
                         <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; font-weight: 800; color: #1f2937;">ì¥ë¹„ ì ê²€ ë¦¬í¬íŠ¸</div>
                            <span style="font-size: 12px; color: #10b981; font-weight: 600; background: #ecfdf5; padding: 4px 10px; border-radius: 20px;">Equipment Inspection</span>
                        </div>
                    </div>
                    ${contentHTML}
                    <div style="position: absolute; bottom: 40px; left: 45px; right: 45px; border-top: 1px solid #e5e7eb; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #9ca3af;">
                        <div style="font-weight: 600;">THE HOME INSPECTION</div>
                        <div>${projectData.apartmentName}</div>
                    </div>
                </div>
            `;
        }

        window.generatePDF = async function() {
            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) { alert('í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
            if (projectData.defects.length === 0 && projectData.equipment.length === 0) { alert('ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
            
            document.getElementById('loading').classList.add('active');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;

                // 1. í‘œì§€
                await window.addHTMLPageToPDF(doc, window.createSummaryFirstPage(), pageWidth, pageHeight);

                // 2. í•˜ì ëª©ë¡ (2í˜ì´ì§€ë¶€í„°)
                if (projectData.defects.length > 15) {
                    for (let i = 15; i < projectData.defects.length; i += 18) {
                        doc.addPage();
                        await window.addHTMLPageToPDF(doc, window.createDefectListPage(i, 18), pageWidth, pageHeight);
                    }
                }

                // 3. í•˜ì ìƒì„¸ ì‚¬ì§„
                if (projectData.defects.length > 0) {
                    const defectsWithPhotos = projectData.defects.filter(d => d.photos && d.photos.length > 0);
                    for (let i = 0; i < defectsWithPhotos.length; i += 3) {
                        doc.addPage();
                        const batch = defectsWithPhotos.slice(i, i + 3);
                        await window.addHTMLPageToPDF(doc, await window.createDefectDetailPage(batch, i), pageWidth, pageHeight);
                    }
                }

                // 4. ì¥ë¹„ ì ê²€
                const equipmentWithPhotos = projectData.equipment.filter(e => (e.photos && Object.values(e.photos).some(p=>p)) || e.photo);
                if (equipmentWithPhotos.length > 0) {
                    for (let i = 0; i < equipmentWithPhotos.length; i += 2) {
                        doc.addPage();
                        await window.addHTMLPageToPDF(doc, window.createEquipmentPage(equipmentWithPhotos.slice(i, i+2), i), pageWidth, pageHeight);
                    }
                }

                const filename = `ë”í™ˆì ê²€_${projectData.apartmentName}_${projectData.dong}ë™${projectData.ho}í˜¸.pdf`;
                doc.save(filename);
                showToast('PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                alert('PDF ìƒì„± ì‹¤íŒ¨: ' + e.message);
                console.error(e);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        window.addHTMLPageToPDF = async function(doc, htmlContent, pageWidth, pageHeight) {
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '794px'; 
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, logging: false });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            doc.addImage(imgData, 'JPEG', 0, 0, pageWidth, Math.min((canvas.height * pageWidth) / canvas.width, pageHeight));
            document.body.removeChild(tempDiv);
        }
        
        window.addWatermarkToPhoto = function(imgUrl, text) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const fontSize = Math.max(24, canvas.width * 0.03);
                    ctx.font = `bold ${fontSize}px sans-serif`;
                    const padding = fontSize * 0.5;
                    const textWidth = ctx.measureText(text).width + padding * 2;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.fillRect(20, 20, textWidth, fontSize + padding);
                    
                    ctx.fillStyle = 'white';
                    ctx.textBaseline = 'top';
                    ctx.fillText(text, 20 + padding, 20 + padding/2);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = imgUrl;
            });
        }

        // ==================== ê¸°ë³¸ ë¡œì§ (íƒ­, ì €ì¥, ì¹´ë©”ë¼ ë“±) ====================
        function switchTab(tabId, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(event) event.target.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btn = document.getElementById('floatingAddBtn');
            btn.style.display = (tabId === 'defects' || tabId === 'equipment') ? 'flex' : 'none';
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('themeToggle').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        function cleanDongHo(input, type) {
            input.value = input.value.replace(type, '').trim();
        }

        function updateProgress() {
            const fields = [projectData.apartmentName, projectData.dong, projectData.ho, projectData.inspectionDate, projectData.customerName];
            const filled = fields.filter(f => f).length;
            const defectScore = Math.min(projectData.defects.length * 5, 50);
            const total = Math.min(100, (filled * 10) + defectScore);
            document.getElementById('progressBar').style.width = total + '%';
        }

        function autoSaveProjectData() {
            updateProgress();
            saveToLocalStorage();
        }

        function saveToLocalStorage() {
            localStorage.setItem('thehomein_data', JSON.stringify(projectData));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('thehomein_data');
            if (data) {
                const parsed = JSON.parse(data);
                Object.assign(projectData, parsed);
                document.getElementById('apartmentName').value = projectData.apartmentName || '';
                document.getElementById('dong').value = projectData.dong || '';
                document.getElementById('ho').value = projectData.ho || '';
                document.getElementById('inspectionDate').value = projectData.inspectionDate || '';
                document.getElementById('customerName').value = projectData.customerName || '';
                document.getElementById('author').value = projectData.author || '';
                
                if(projectData.floorplan) document.getElementById('floorplanPreview').src = projectData.floorplan;
                renderDefects();
                renderEquipment();
            }
        }

        function handleFloatingBtnClick() {
            const activeTab = document.querySelector('.tab.active').innerText;
            if (activeTab.includes('í•˜ì')) addDefect();
            else if (activeTab.includes('ì¥ë¹„')) addEquipment();
        }

        // í•˜ì ì¶”ê°€/ì‚­ì œ/ë Œë”ë§
        function addDefect() {
            projectData.defects.push({ spaces: [], locations: [], types: [], description: '', photos: [] });
            renderDefects();
            saveToLocalStorage();
        }
        function renderDefects() {
            const list = document.getElementById('defectsList');
            list.innerHTML = projectData.defects.map((d, i) => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong style="color:var(--primary)">í•˜ì #${i+1}</strong>
                        <button class="btn-danger" style="padding:4px 8px; border-radius:4px; font-size:12px;" onclick="removeDefect(${i})">ì‚­ì œ</button>
                    </div>
                    <div class="form-field">
                        <div class="touch-button-grid">
                            ${['ê±°ì‹¤','ì£¼ë°©','ì¹¨ì‹¤1','ì¹¨ì‹¤2','ìš•ì‹¤','í˜„ê´€','ë² ë€ë‹¤'].map(s => `<button class="touch-btn ${d.spaces.includes(s)?'selected':''}" onclick="toggleSelection(${i}, 'spaces', '${s}')">${s}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-field">
                        <div class="touch-button-grid">
                            ${['ë²½','ë°”ë‹¥','ì²œì¥','ì°½í˜¸','ê°€êµ¬','ë„ì–´','ì½˜ì„¼íŠ¸'].map(l => `<button class="touch-btn ${d.locations.includes(l)?'selected':''}" onclick="toggleSelection(${i}, 'locations', '${l}')">${l}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-field">
                        <div class="touch-button-grid">
                            ${['ì°í˜','ê¸í˜','ì˜¤ì—¼','íŒŒì†','ë“¤ëœ¸','ìœ ê²©','ì‘ë™ë¶ˆëŸ‰'].map(t => `<button class="touch-btn ${d.types.includes(t)?'selected':''}" onclick="toggleSelection(${i}, 'types', '${t}')">${t}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-field">
                        <input type="text" class="form-input" placeholder="ìƒì„¸ ë‚´ìš© ì…ë ¥" value="${d.description}" oninput="updateDefect(${i}, 'description', this.value)">
                    </div>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="openCamera('defect', ${i})">ğŸ“· ì‚¬ì§„ ì´¬ì˜</button>
                        <div style="font-size:12px; color:gray; display:flex; align-items:center;">í˜„ì¬ ì‚¬ì§„: ${d.photos.length}ì¥</div>
                    </div>
                    <div class="photo-grid">
                        ${d.photos.map((p, pi) => `<div class="photo-item"><img src="${p}"><button onclick="removePhoto(${i}, ${pi})" style="position:absolute; top:0; right:0; background:red; color:white; border:none;">X</button></div>`).join('')}
                    </div>
                </div>
            `).join('');
        }
        function toggleSelection(idx, field, val) {
            const arr = projectData.defects[idx][field];
            const found = arr.indexOf(val);
            if(found > -1) arr.splice(found, 1); else arr.push(val);
            renderDefects(); saveToLocalStorage();
        }
        function updateDefect(idx, field, val) { projectData.defects[idx][field] = val; saveToLocalStorage(); }
        function removeDefect(idx) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { projectData.defects.splice(idx, 1); renderDefects(); saveToLocalStorage(); } }
        function removePhoto(dIdx, pIdx) { projectData.defects[dIdx].photos.splice(pIdx, 1); renderDefects(); saveToLocalStorage(); }

        // ì¥ë¹„ ì¶”ê°€/ì‚­ì œ/ë Œë”ë§
        function addEquipment() {
            projectData.equipment.push({ spaces: [], photos: {}, inspection: 'ì´ìƒ ì—†ìŒ' });
            renderEquipment(); saveToLocalStorage();
        }
        function renderEquipment() {
            const list = document.getElementById('equipmentList');
            list.innerHTML = projectData.equipment.map((e, i) => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong style="color:var(--primary)">ì¥ë¹„ì ê²€ #${i+1}</strong>
                        <button class="btn-danger" style="padding:4px 8px; border-radius:4px; font-size:12px;" onclick="removeEquipment(${i})">ì‚­ì œ</button>
                    </div>
                    <div class="form-field">
                        <div class="touch-button-grid">
                            ${['ê±°ì‹¤','ì•ˆë°©','ì¹¨ì‹¤1','ì¹¨ì‹¤2','ìš•ì‹¤'].map(s => `<button class="touch-btn ${e.spaces && e.spaces.includes(s)?'selected':''}" onclick="toggleEquipSpace(${i}, '${s}')">${s}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-field">
                        <input type="text" class="form-input" value="${e.inspection}" oninput="updateEquip(${i}, 'inspection', this.value)">
                    </div>
                    <div class="grid-2">
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ì¢Œì¸¡')">ğŸ“¸ ì¢Œì¸¡</button>
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ìš°ì¸¡')">ğŸ“¸ ìš°ì¸¡</button>
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ë°”ë‹¥')">ğŸ“¸ ë°”ë‹¥</button>
                    </div>
                </div>
            `).join('');
        }
        function toggleEquipSpace(idx, val) {
            if(!projectData.equipment[idx].spaces) projectData.equipment[idx].spaces = [];
            const arr = projectData.equipment[idx].spaces;
            const found = arr.indexOf(val);
            if(found > -1) arr.splice(found, 1); else arr.push(val);
            renderEquipment(); saveToLocalStorage();
        }
        function updateEquip(idx, field, val) { projectData.equipment[idx][field] = val; saveToLocalStorage(); }
        function removeEquipment(idx) { projectData.equipment.splice(idx, 1); renderEquipment(); saveToLocalStorage(); }

        // ì¹´ë©”ë¼ ë¡œì§
        function openCamera(type, idx, subType) {
            currentPhotoTarget = { type, idx, subType };
            const video = document.getElementById('cameraPreview');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => { video.srcObject = stream; document.getElementById('cameraModal').classList.add('active'); })
                .catch(err => alert('ì¹´ë©”ë¼ ì˜¤ë¥˜: ' + err));
        }
        function closeCameraModal() {
            const video = document.getElementById('cameraPreview');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('cameraModal').classList.remove('active');
        }
        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const data = canvas.toDataURL('image/jpeg', 0.8);
            
            if(currentPhotoTarget.type === 'defect') {
                projectData.defects[currentPhotoTarget.idx].photos.push(data);
                renderDefects();
            } else if(currentPhotoTarget.type === 'equip') {
                if(!projectData.equipment[currentPhotoTarget.idx].photos) projectData.equipment[currentPhotoTarget.idx].photos = {};
                projectData.equipment[currentPhotoTarget.idx].photos[currentPhotoTarget.idx.subType || 'ê¸°ë³¸'] = data; // ë‹¨ìˆœí™”
                projectData.equipment[currentPhotoTarget.idx].photos['ì¢Œì¸¡ìƒë‹¨'] = data; // í˜¸í™˜ì„±
                renderEquipment();
            }
            saveToLocalStorage();
            closeCameraModal();
        }

        // í‰ë©´ë„
        function openFloorplanGallery() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = evt => {
                    projectData.floorplan = evt.target.result;
                    document.getElementById('floorplanPreview').src = evt.target.result;
                    document.getElementById('floorplanPreview').style.display = 'block';
                    document.getElementById('floorplanPlaceholder').style.display = 'none';
                    saveToLocalStorage();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        function resetProject() {
            if(confirm('ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('thehomein_data');
                location.reload();
            }
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>