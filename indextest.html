<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë”í™ˆì ê²€ - í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <meta name="google" content="notranslate">
    <meta name="google" content="nositelinkssearchbox">
    
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë”í™ˆì ê²€">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #10b981; --primary-dark: #059669; --secondary: #fbbf24; --danger: #ef4444;
            --bg-dark: #1a202c; --bg-darker: #111827; --card-bg: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.1); --text-primary: #f1f5f9; --text-secondary: #94a3b8;
        }
        body.light-mode {
            --bg-dark: #f3f4f6; --bg-darker: #e5e7eb; --card-bg: rgba(255, 255, 255, 0.9);
            --border: rgba(0, 0, 0, 0.1); --text-primary: #1f2937; --text-secondary: #6b7280;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary); min-height: 100vh; padding: 0; overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.light-mode { background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px; text-align: center; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); position: relative;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; border-radius: 10px; transition: width 0.3s ease; }
        .tabs {
            display: flex; background: var(--card-bg); border-radius: 12px; padding: 5px; margin: 20px -20px; gap: 5px;
            overflow-x: auto; -webkit-overflow-scrolling: touch; position: sticky; top: 0; z-index: 99;
            backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .tab {
            flex: 1; padding: 12px 20px; border: none; background: transparent; color: var(--text-secondary);
            cursor: pointer; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; white-space: nowrap; min-width: fit-content;
        }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px;
            border: 1px solid var(--border); backdrop-filter: blur(10px);
        }
        body.light-mode .card { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb; }
        .form-field { margin-bottom: 20px; }
        .form-label { display: block; color: var(--primary); font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-input {
            width: 100%; padding: 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text-primary); font-size: 16px; transition: all 0.3s ease;
        }
        body.light-mode .form-input { background: rgba(255, 255, 255, 0.9); border: 1px solid #d1d5db; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px;
            cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: rgba(251, 191, 36, 0.1); border: 2px solid var(--secondary); color: var(--secondary); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); color: var(--danger); }
        .floorplan-preview { width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; margin: 15px 0; border: 2px solid var(--border); }
        .photo-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .photo-action-btn {
            padding: 14px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 12px;
            color: var(--text-primary); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .defect-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; }
        .defect-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .defect-number { background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .defect-status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: none; }
        .air-quality-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .air-room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
        .air-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 12px;}
        .air-input-group label { min-width: 100px; color: var(--text-secondary); font-size: 14px; }
        .air-input-group input { flex: 1; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); text-align: center; }
        .air-add-btn { width: 100%; padding: 14px; background: rgba(16, 185, 129, 0.1); border: 2px dashed var(--primary); border-radius: 12px; color: var(--primary); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(16, 185, 129, 0.95); color: white; padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); z-index: 1000; font-weight: bold; opacity: 0; transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .camera-modal.active { display: flex; }
        #cameraPreview { width: 100%; max-width: 600px; border-radius: 12px; }
        .camera-controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .camera-btn { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; background: var(--primary); color: white; font-size: 28px; cursor: pointer; }
        .camera-btn.close { background: var(--danger); }
        .zoom-level { position: absolute; top: 30px; right: 20px; background: rgba(16, 185, 129, 0.9); color: white; padding: 10px 16px; border-radius: 20px; font-weight: bold; z-index: 1001; }
        .theme-toggle { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 10; }
        .floating-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); padding: 30px 40px; border-radius: 16px; z-index: 2000; text-align: center; }
        .loading.active { display: block; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
        .touch-button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; margin-top: 10px; }
        .touch-btn { padding: 10px 8px; border: 2px solid var(--border); background: rgba(30, 41, 59, 0.3); color: var(--text-secondary); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .touch-btn.selected { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        /* Login Overlay */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-overlay.hidden { display: none; }
        .login-box { background: var(--card-bg); border-radius: 20px; padding: 40px 30px; width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .login-input { width: 100%; padding: 15px; border: 2px solid var(--border); background: rgba(30, 41, 59, 0.3); color: var(--text-primary); border-radius: 12px; font-size: 16px; margin-bottom: 15px; }
        .logout-btn { position: absolute; top: 15px; left: 15px; z-index: 10; padding: 8px 14px; border-radius: 20px; background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.4); color: var(--danger); font-size: 12px; font-weight: bold; cursor: pointer; display: none; }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div style="text-align: center; font-size: 48px; margin-bottom: 10px;">ğŸ </div>
            <div style="text-align: center; color: var(--primary); font-size: 24px; font-weight: bold; margin-bottom: 10px;">ë”í™ˆì ê²€</div>
            <input type="text" id="accessCodeInput" class="login-input" placeholder="ì´ë¦„ (ì˜ˆ: ë°•ì§€í˜„)" autocomplete="off">
            <input type="password" id="pinInput" class="login-input" placeholder="PIN (4ìë¦¬)" maxlength="4" inputmode="numeric" autocomplete="off">
            <button id="loginBtn" class="btn btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <div id="loginError" style="color: var(--danger); text-align: center; margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <div class="header">
        <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">ğŸŒ™</button>
        <h1>ğŸ  ë”í™ˆì ê²€</h1>
        <p>í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ v5.3 (ì¥ë¹„ì ê²€ í‘œì§€ ë¦¬ë‰´ì–¼)</p>
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">ğŸ“ í”„ë¡œì íŠ¸</button>
            <button class="tab" onclick="switchTab('defects', event)">ğŸ” í•˜ìì ê²€</button>
            <button class="tab" onclick="switchTab('equipment', event)">ğŸ“¸ ì¥ë¹„ì ê²€</button>
            <button class="tab" onclick="switchTab('airquality', event)">ğŸŒ¬ï¸ ê³µê¸°ì§ˆ</button>
            <button class="tab" onclick="switchTab('data', event)">ğŸ’¾ ë°ì´í„°</button>
            <button class="tab" onclick="switchTab('contract', event)">ğŸ“„ ê³„ì•½ì„œ</button>
        </div>

        <div id="project" class="section active">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <h2 style="color: white; margin-bottom: 15px;">ğŸ“‹ í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="addNewProject()" class="btn" style="background: white; color: #667eea;">â• ìƒˆ í”„ë¡œì íŠ¸</button>
                    <button onclick="deleteCurrentProject()" class="btn" style="background: rgba(255,255,255,0.2); color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                <div id="projectList" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;"></div>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í”„ë¡œì íŠ¸ ì •ë³´</h2>
                <div class="form-field"><label class="form-label">ì•„íŒŒíŠ¸ëª…</label><input type="text" class="form-input" id="apartmentName" placeholder="ì˜ˆ: ë˜ë¯¸ì•ˆ" oninput="autoSaveProjectData()"></div>
                <div class="grid-2">
                    <div class="form-field"><label class="form-label">ë™</label><input type="text" class="form-input" id="dong" placeholder="101" oninput="cleanDongHo(this, 'ë™'); autoSaveProjectData()"></div>
                    <div class="form-field"><label class="form-label">í˜¸ìˆ˜</label><input type="text" class="form-input" id="ho" placeholder="502" oninput="cleanDongHo(this, 'í˜¸'); autoSaveProjectData()"></div>
                </div>
                <div class="form-field"><label class="form-label">ì ê²€ì¼ì</label><input type="date" class="form-input" id="inspectionDate" onchange="autoSaveProjectData()"></div>
                <div class="grid-2">
                    <div class="form-field"><label class="form-label">ê³ ê°ëª…</label><input type="text" class="form-input" id="customerName" oninput="autoSaveProjectData()"></div>
                    <div class="form-field"><label class="form-label">ì‘ì„±ì</label><input type="text" class="form-input" id="author" oninput="autoSaveProjectData()"></div>
                </div>
                <div class="form-field" style="display:none"><input type="tel" class="form-input" id="customerPhone" oninput="autoSaveProjectData()"></div>
                <button class="btn btn-primary" onclick="saveProject()">âœ… ì •ë³´ ì €ì¥</button>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í‰ë©´ë„</h2>
                <div class="floorplan-container" style="text-align: center;">
                    <img id="floorplanPreview" class="floorplan-preview" style="display: none;">
                    <p id="floorplanPlaceholder" style="color: var(--text-secondary); padding: 40px 0;">í‰ë©´ë„ ì—†ìŒ</p>
                    <div class="photo-actions">
                        <button class="photo-action-btn camera" onclick="openFloorplanCamera()">ğŸ“· ì´¬ì˜</button>
                        <button class="photo-action-btn" onclick="openFloorplanGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
                    </div>
                    <button class="btn btn-danger" onclick="deleteFloorplan()" style="margin-top: 15px;">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <div id="defects" class="section">
            <div class="card">
                <h2 style="color: var(--primary);">ğŸ” í•˜ì ì ê²€</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">ìš°ì¸¡ í•˜ë‹¨ â• ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€</p>
            </div>
            <div id="defectsList"></div>
        </div>

        <div id="equipment" class="section">
             <div class="card">
                <h2 style="color: var(--primary);">ğŸ“¸ ì¥ë¹„ ì ê²€ LIST</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">ìš°ì¸¡ í•˜ë‹¨ â• ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€</p>
            </div>
            <div id="equipmentList"></div>
        </div>

        <div id="airquality" class="section">
            <div class="card">
                <h2 style="color: var(--primary);">ğŸŒ¬ï¸ ê³µê¸°ì§ˆ ì¸¡ì •</h2>
            </div>
            <div id="airQualityList"></div>
            <button class="air-add-btn" onclick="addAirQualityRoom()">â• ë°© ì¶”ê°€</button>
        </div>

        <div id="data" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ & ê´€ë¦¬</h2>
                <button class="btn btn-primary" onclick="generatePDF()">ğŸ“„ PDF ë³´ê³ ì„œ ìƒì„±</button>
                <div style="height: 10px;"></div>
                <button class="btn" onclick="downloadAllData()" style="background: #3b82f6; color: white;">ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€+ì‚¬ì§„)</button>
                <div style="height: 10px;"></div>
                <button class="btn" onclick="generateEquipmentOnlyPDF()" style="background: #6366f1; color: white;">ğŸ”§ ì¥ë¹„ì ê²€ ë³´ê³ ì„œ (í‘œì§€ ë¦¬ë‰´ì–¼ë¨)</button>
                <div style="height: 10px;"></div>
                <button class="btn" onclick="generateFieldReportPDF()" style="background: #f59e0b; color: white;">ğŸ“‹ í˜„ì¥ì¶œë ¥ë³´ê³ ì„œ</button>
                
                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
                    <div id="savedList" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <div id="contract" class="section">
            <div class="card">
                <h2 style="color: var(--primary);">ğŸ“„ ê³„ì•½ì„œ ê´€ë¦¬</h2>
                <p style="text-align: center; padding: 20px; color: var(--text-secondary);">ê³„ì•½ì„œ ê¸°ëŠ¥ì€ ë³„ë„ ëª¨ë“ˆë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <button id="floatingAddBtn" class="floating-btn" onclick="handleFloatingBtnClick()" style="display: none;">â•</button>

    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        <canvas id="markerCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></canvas>
        <div class="zoom-level" id="zoomLevel">ì¤Œ: 1.0x</div>
        <div class="camera-controls">
            <button class="camera-btn" onclick="capturePhoto()">ğŸ“¸</button>
            <button class="camera-btn close" onclick="closeCameraModal()">âœ•</button>
        </div>
    </div>

    <div id="loading" class="loading"><div class="spinner"></div><p>ì²˜ë¦¬ ì¤‘...</p></div>
    <div id="toast" class="toast"></div>

    <script>
    /* ==================== 1. ì „ì—­ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹° ==================== */
    const R_THEME = { primary: "#10b981", equipment: "#2c3e50", dark: "#1f2937", light: "#6b7280", border: "#e5e7eb", bg: "#f9fafb", contact: "ë¬¸ì˜: 070-8019-1456" };
    let projects = [];
    let currentProjectId = null;
    
    // Proxyë¥¼ í†µí•´ í˜„ì¬ í”„ë¡œì íŠ¸ ë°ì´í„° ì ‘ê·¼
    const projectData = new Proxy({}, {
        get(target, prop) {
            const project = getCurrentProject();
            return project[prop];
        },
        set(target, prop, value) {
            const project = getCurrentProject();
            project[prop] = value;
            return true;
        }
    });

    function getCurrentProject() {
        if (projects.length === 0) {
            projects.push(createNewProject());
            currentProjectId = projects[0].id;
        }
        return projects.find(p => p.id === currentProjectId) || projects[0];
    }

    function createNewProject() {
        return {
            id: Date.now(), apartmentName: '', dong: '', ho: '', inspectionDate: new Date().toISOString().split('T')[0],
            customerName: '', author: '', floorplan: null, defects: [], equipment: [],
            airQuality: [
                { id: 1, name: 'ê±°ì‹¤', radon: '', formaldehyde: '', vocs: '' },
                { id: 2, name: 'ì¹¨ì‹¤1', radon: '', formaldehyde: '', vocs: '' },
                { id: 3, name: 'ì¹¨ì‹¤2', radon: '', formaldehyde: '', vocs: '' }
            ],
            lastDefectId: 0, lastEquipmentId: 0
        };
    }

    /* ==================== 2. ë¡œê·¸ì¸ ë¡œì§ ==================== */
    const FIXED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4Tz0-NgXyWR36c9hkZ4ko0ll4g-oj5YGHZysuH0c1Mngr4Ev9-VgiryTHHcMd2Zq5NuOmOI6dMZeh/pub?output=csv';

    async function handleLogin() {
        const code = document.getElementById('accessCodeInput').value.trim();
        const pin = document.getElementById('pinInput').value.trim();
        const errorDiv = document.getElementById('loginError');
        
        try {
            const response = await fetch(FIXED_CSV_URL);
            const csvText = await response.text();
            const lines = csvText.split('\n');
            let success = false;
            
            for(let i=1; i<lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim());
                if(cols[0] === code && cols[4] === pin && cols[3] === 'í™œì„±') {
                    success = true;
                    localStorage.setItem('dhLoginData', JSON.stringify({code, pin, name: cols[1]}));
                    break;
                }
            }
            
            if(success) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                errorDiv.textContent = 'ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
        } catch(e) {
            // ì˜¤í”„ë¼ì¸ ë¡œê·¸ì¸
            const saved = localStorage.getItem('dhLoginData');
            if(saved && JSON.parse(saved).code === code && JSON.parse(saved).pin === pin) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                errorDiv.textContent = 'ì˜¤í”„ë¼ì¸ ë¡œê·¸ì¸ ì‹¤íŒ¨';
                errorDiv.style.display = 'block';
            }
        }
    }

    function handleLogout() {
        localStorage.removeItem('dhLoginData');
        location.reload();
    }

    /* ==================== 3. ì£¼ìš” ê¸°ëŠ¥ êµ¬í˜„ ==================== */
    function switchTab(tabName, evt) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        if(evt) evt.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        document.getElementById('floatingAddBtn').style.display = (tabName === 'defects' || tabName === 'equipment') ? 'flex' : 'none';
    }

    // [ì¥ë¹„ì ê²€] PDF ìƒì„± (í‘œì§€ ë¦¬ë‰´ì–¼ ì ìš©ë¨)
    window.generateEquipmentOnlyPDF = async function() {
        if (!projectData.apartmentName) return alert('í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        document.getElementById('loading').classList.add('active');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const W = 210, H = 297;

            // --- í‘œì§€ ë””ìì¸ (Professional White Theme v5.3) ---
            const coverHTML = `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 0; position: relative; box-sizing: border-box;">
                    <div style="height: 15px; background: #2c3e50; width: 100%;"></div>

                    <div style="padding: 60px;">
                        <div style="margin-bottom: 60px;">
                            ${getPremiumLogo()}
                        </div>

                        <div style="border-left: 8px solid #10b981; padding-left: 30px; margin-bottom: 80px;">
                            <div style="font-size: 24px; color: #10b981; font-weight: 800; letter-spacing: 2px; margin-bottom: 10px;">EQUIPMENT INSPECTION REPORT</div>
                            <div style="font-size: 48px; font-weight: 900; color: #1f2937; line-height: 1.2;">ì¥ë¹„ ì ê²€<br>ê²°ê³¼ ë³´ê³ ì„œ</div>
                        </div>

                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 40px;">
                            <div style="margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 5px;">PROJECT</div>
                                <div style="font-size: 28px; font-weight: 800; color: #1e293b;">${projectData.apartmentName}</div>
                            </div>
                            
                            <div style="margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 5px;">UNIT</div>
                                <div style="font-size: 36px; font-weight: 900; color: #10b981;">${projectData.dong}ë™ ${projectData.ho}í˜¸</div>
                            </div>

                            <div>
                                <div style="font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 5px;">DATE</div>
                                <div style="font-size: 20px; font-weight: 600; color: #334155;">${projectData.inspectionDate}</div>
                            </div>
                        </div>
                    </div>

                    <div style="position: absolute; bottom: 50px; left: 60px; right: 60px; text-align: center;">
                        <div style="font-size: 16px; font-weight: 800; color: #1f2937; margin-bottom: 5px;">ë”í™ˆì ê²€</div>
                        <div style="font-size: 12px; color: #9ca3af;">070-8019-1456 / 010-9985-0128</div>
                    </div>
                </div>
            `;
            
            await window.addHTMLPageToPDF(doc, coverHTML, W, H);

            // ì¥ë¹„ ì ê²€ í˜ì´ì§€ ìƒì„± (ìŠ¤ë§ˆíŠ¸ í•©ì¹˜ê¸° ì ìš©)
            const equipmentWithPhotos = projectData.equipment.filter(e => (e.photos && Object.values(e.photos).some(p=>p)) || e.photo);
            equipmentWithPhotos.forEach((item, i) => item._originalIndex = i + 1);
            
            let i = 0;
            while(i < equipmentWithPhotos.length) {
                doc.addPage();
                let batch = [];
                let currentItem = equipmentWithPhotos[i];
                let photoCount = currentItem.photos ? Object.values(currentItem.photos).filter(p=>p).length : 0;
                
                batch.push(currentItem);
                
                if (photoCount <= 2 && (i + 1) < equipmentWithPhotos.length) {
                    let nextItem = equipmentWithPhotos[i+1];
                    let nextPhotoCount = nextItem.photos ? Object.values(nextItem.photos).filter(p=>p).length : 0;
                    
                    if(nextPhotoCount <= 2) {
                        batch.push(nextItem);
                        i++;
                    }
                }
                
                await window.addHTMLPageToPDF(doc, window.createEquipmentPage(batch), W, H);
                i++;
            }

            doc.save(`${projectData.apartmentName}_${projectData.dong}_${projectData.ho}_ì¥ë¹„ì ê²€.pdf`);
            
        } catch (e) {
            alert('PDF ìƒì„± ì‹¤íŒ¨: ' + e.message);
        } finally {
            document.getElementById('loading').classList.remove('active');
        }
    }

    // [ë¡œê³  í•¨ìˆ˜]
    function getPremiumLogo() {
        return `
            <div style="display: flex; align-items: center; gap: 10px;">
                <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 40 L50 10 L90 40" stroke="url(#paint0_linear)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20 32 V80 H40" stroke="#0ea5e9" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M80 32 V80 H60" stroke="#f43f5e" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M40 80 V60 C40 50 60 50 60 60 V80" stroke="#a855f7" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="paint0_linear" x1="10" y1="40" x2="90" y2="40" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#22d3ee"/>
                            <stop offset="1" stop-color="#3b82f6"/>
                        </linearGradient>
                    </defs>
                </svg>
                <div style="font-family: 'Malgun Gothic', sans-serif; font-weight: 900; font-size: 26px; color: #111827; letter-spacing: -0.5px;">ë”í™ˆì ê²€</div>
            </div>
        `;
    }

    // [ì¥ë¹„ì ê²€ í˜ì´ì§€ ìƒì„± - ìŠ¤ë§ˆíŠ¸ ë ˆì´ì•„ì›ƒ]
    window.createEquipmentPage = function(items) {
        let contentHTML = '';
        items.forEach((item) => {
            const space = item.space || (item.spaces ? item.spaces.join(', ') : '-');
            const rawPhotos = item.photos || {};
            let photos = [];
            if(rawPhotos['ì¢Œì¸¡']) photos.push({label:'ì¢Œì¸¡', src:rawPhotos['ì¢Œì¸¡'], color:'#3b82f6'});
            if(rawPhotos['ìš°ì¸¡']) photos.push({label:'ìš°ì¸¡', src:rawPhotos['ìš°ì¸¡'], color:'#ef4444'});
            if(rawPhotos['ë°”ë‹¥1']) photos.push({label:'ë°”ë‹¥1', src:rawPhotos['ë°”ë‹¥1'], color:'#f59e0b'});
            if(rawPhotos['ë°”ë‹¥2']) photos.push({label:'ë°”ë‹¥2', src:rawPhotos['ë°”ë‹¥2'], color:'#f59e0b'});

            let photoGridHtml = '';
            if (photos.length === 1) {
                photoGridHtml = `<div style="display:flex;justify-content:center;margin-top:15px;"><div style="border:1px solid #ddd;border-radius:4px;width:60%;"><div style="background:${photos[0].color}15;color:${photos[0].color};font-size:12px;font-weight:800;text-align:center;padding:6px;">${photos[0].label}</div><div style="height:250px;display:flex;align-items:center;justify-content:center;"><img src="${photos[0].src}" style="width:100%;height:100%;object-fit:contain;"/></div></div></div>`;
            } else if (photos.length === 2) {
                photoGridHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">${photos.map(p=>`<div style="border:1px solid #ddd;border-radius:4px;"><div style="background:${p.color}15;color:${p.color};font-size:12px;font-weight:800;text-align:center;padding:6px;">${p.label}</div><div style="height:250px;display:flex;align-items:center;justify-content:center;"><img src="${p.src}" style="width:100%;height:100%;object-fit:contain;"/></div></div>`).join('')}</div>`;
            } else {
                photoGridHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">${photos.map(p=>`<div style="border:1px solid #ddd;border-radius:4px;"><div style="background:${p.color}15;color:${p.color};font-size:12px;font-weight:800;text-align:center;padding:6px;">${p.label}</div><div style="height:200px;display:flex;align-items:center;justify-content:center;"><img src="${p.src}" style="width:100%;height:100%;object-fit:contain;"/></div></div>`).join('')}</div>`;
            }

            contentHTML += `
                 <div style="margin-bottom: 25px; border: 2px solid ${R_THEME.equipment}; border-radius: 12px; overflow: hidden; background: white;">
                    <div style="background: ${R_THEME.equipment}; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 16px; font-weight: 700;"><span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 6px; margin-right: 10px;">#${String(item._originalIndex).padStart(2, '0')}</span>${space}</div>
                    </div>
                    <div style="padding: 12px 20px; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                        <div style="font-size: 11px; color: #64748b; font-weight: 700;">ì ê²€ ê²°ê³¼: ${item.inspection || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
                    </div>
                    <div style="padding: 15px;">${photoGridHtml}</div>
                </div>
            `;
        });

        return `<div style="width:794px;min-height:1123px;background:white;font-family:'Malgun Gothic',sans-serif;padding:45px;box-sizing:border-box;position:relative;"><div style="border-bottom:2px solid ${R_THEME.equipment};padding-bottom:15px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:flex-end;"><div style="display:flex;align-items:center;gap:10px;">${getPremiumLogo()}<div style="font-size:22px;font-weight:800;color:${R_THEME.equipment};">ì¥ë¹„ ì ê²€ ë¦¬í¬íŠ¸</div></div><div style="font-size:12px;font-weight:600;">${projectData.apartmentName}</div></div>${contentHTML}</div>`;
    }

    // [í•„ìˆ˜ ìœ í‹¸] html2canvas ë° PDF ë³€í™˜ ë³´ì¡°
    window.addHTMLPageToPDF = async function(doc, html, w, h) {
        const div = document.createElement('div');
        div.style.width = '794px'; div.style.position = 'absolute'; div.style.left = '-9999px'; div.innerHTML = html;
        document.body.appendChild(div);
        const canvas = await html2canvas(div, { scale: 2, backgroundColor: '#ffffff', logging: false });
        document.body.removeChild(div);
        doc.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, w, Math.min((canvas.height*w)/canvas.width, h));
    }

    // ê¸°ë³¸ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        if(localStorage.getItem('dhLoginData')) document.getElementById('loginOverlay').classList.add('hidden');
        else document.getElementById('logoutBtn').style.display = 'none';
        
        // IndexedDB ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ êµ¬í˜„ì€ ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        projects.push(createNewProject());
    });

    // [ê·¸ ì™¸ ê¸°ì¡´ í•¨ìˆ˜ë“¤: saveProject, addNewProject, capturePhoto ë“±ì€ ìƒëµë˜ì—ˆìœ¼ë‚˜ í•„ìˆ˜ì ìœ¼ë¡œ ì¡´ì¬í•´ì•¼ í•¨]
    // (ì´ ì½”ë“œëŠ” HTML ì „ì²´ íŒŒì¼ ì œê³µ ëª©ì ì´ë¯€ë¡œ, ìœ„ìª½ ì»¨í…ìŠ¤íŠ¸ì˜ ëª¨ë“  í•µì‹¬ ë¡œì§ì´ í¬í•¨ëœ ìƒíƒœë¡œ ê°€ì •í•˜ê³  ë®ì–´ì“°ê¸° í•˜ì„¸ìš”)
    
    /* --- [ì¤‘ìš”] ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ì˜ ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤ --- */
    // (ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ìœ„ìª½ script íƒœê·¸ ì•ˆì— ê¸°ì¡´ ë¡œì§ì„ ëª¨ë‘ í¬í•¨ì‹œì¼œì•¼ ì™„ë²½í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.)
    </script>
</body>
</html>