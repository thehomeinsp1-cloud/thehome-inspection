<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë”í™ˆì ê²€ - í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <!-- Google Lens ìë™ ì‹¤í–‰ ë°©ì§€ -->
    <meta name="google" content="notranslate">
    <meta name="google" content="nositelinkssearchbox">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë”í™ˆì ê²€">
    
    <!-- PWA Manifest -->
    <!-- manifest.json ì œê±° (CORS ì—ëŸ¬ ë°©ì§€) -->
    
    <!-- jsPDF + html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- JSZip for ZIP download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- ExcelJS for Excel with images (ì•ˆì •ì ì¸ ë²„ì „) -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <!-- Google API Client Library -->
    <!-- Google API (ê´‘ê³ ì°¨ë‹¨ê¸°ë¡œ ì¸í•´ ì£¼ì„ ì²˜ë¦¬) -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <!-- <script src="https://accounts.google.com/gsi/client" async defer></script> -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #fbbf24;
            --danger: #ef4444;
            --bg-dark: #1a202c;
            --bg-darker: #111827;
            --card-bg: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }

        /* ë¼ì´íŠ¸ ëª¨ë“œ */
        body.light-mode {
            --bg-dark: #f3f4f6;
            --bg-darker: #e5e7eb;
            --card-bg: rgba(255, 255, 255, 0.9);
            --border: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light-mode {
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: relative; /* ë²„íŠ¼ ìœ„ì¹˜ ê¸°ì¤€ */
            /* sticky ì œê±° - íƒ­ë§Œ ê³ ì • */
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 5px;
            margin: 20px -20px;
            gap: 5px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            
            /* ìƒë‹¨ ê³ ì • */
            position: sticky;
            top: 0;
            z-index: 99;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        body.light-mode .card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        body.light-mode .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
        }

        body.light-mode textarea.form-input {
            background: rgba(255, 255, 255, 0.9);
        }

        body.light-mode select.form-input {
            background: rgba(255, 255, 255, 0.9);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        /* í‰ë©´ë„ ê´€ë¦¬ */
        .floorplan-container {
            text-align: center;
        }

        .floorplan-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid var(--border);
        }

        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-action-btn {
            padding: 14px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .photo-action-btn.camera {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .photo-action-btn:active {
            transform: scale(0.98);
        }

        /* í•˜ì ëª©ë¡ */
        .defect-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        body.light-mode .defect-card {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .defect-number {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .defect-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: none; /* ìˆ¨ê¹€ ì²˜ë¦¬ */
        }

        .status-pending {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ê³µê¸°ì§ˆ ì¸¡ì • */
        .air-quality-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
        }

        .air-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .air-room-name-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
        }

        .air-room-delete {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .air-inputs {
            display: grid;
            gap: 12px;
        }

        .air-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .air-input-group label {
            min-width: 100px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .air-input-group input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            text-align: center;
        }

        .air-input-group span {
            color: var(--text-secondary);
            font-size: 12px;
            min-width: 80px;
        }

        .air-add-btn {
            width: 100%;
            padding: 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .air-add-btn:active {
            transform: scale(0.98);
        }

        .reference-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ë°ì´í„° ê´€ë¦¬ */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .saved-info {
            flex: 1;
        }

        .saved-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .saved-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saved-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .icon-btn.load {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
        }

        .icon-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Toast ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ì¹´ë©”ë¼ ëª¨ë‹¬ */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .camera-modal.active {
            display: flex;
        }

        #cameraPreview {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            /* Google Lens ìë™ ì‹¤í–‰ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            pointer-events: auto;
        }

        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: var(--primary);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .camera-btn.close {
            background: var(--danger);
        }

        /* í•€ì¹˜ì¤Œ ê¸°ëŠ¥ ì¶”ê°€ */
        .zoom-level {
            position: absolute;
            top: 30px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: bold;
            z-index: 1001;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .zoom-controls {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1001;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .zoom-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        /* í…Œë§ˆ í† ê¸€ ë²„íŠ¼ */
        .theme-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        body.light-mode .theme-toggle {
            background: rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(0, 0, 0, 0.2);
        }

        /* í”Œë¡œíŒ… ë²„íŠ¼ */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .floating-btn:active {
            transform: scale(0.95);
        }

        .floating-btn:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        /* ë¡œë”© */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 40px;
            border-radius: 16px;
            z-index: 2000;
            text-align: center;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            /* ë™/í˜¸ìˆ˜ëŠ” ëª¨ë°”ì¼ì—ì„œë„ ê°€ë¡œë¡œ í‘œì‹œ (ê°„ê²©ë§Œ ì¤„ì„) */
            .grid-2 {
                gap: 10px;
            }
        }

        /* ì„ íƒ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .form-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* í„°ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .touch-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .touch-btn {
            padding: 10px 8px;
            border: 2px solid var(--border);
            background: rgba(30, 41, 59, 0.3);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .touch-btn:active {
            transform: scale(0.95);
        }

        .touch-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .touch-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* ==================== ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ ==================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .login-logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 10px;
        }

        .login-title {
            text-align: center;
            color: var(--primary);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            background: rgba(30, 41, 59, 0.3);
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(30, 41, 59, 0.5);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .login-error {
            color: var(--danger);
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .login-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            padding: 8px 14px;
            border-radius: 20px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.4);
            backdrop-filter: blur(10px);
            color: var(--danger);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: none;
        }

        .logout-btn:active {
            transform: scale(0.95);
            background: var(--danger);
            color: white;
        }
        
        body.light-mode .logout-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }
        /* ==================== ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ ë ==================== */
    </style>

</head>
<body>
    <!-- ==================== ë¡œê·¸ì¸ í™”ë©´ ==================== -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-logo">ğŸ </div>
            <div class="login-title">ë”í™ˆì ê²€</div>
            <div class="login-subtitle">ì§ì› ë¡œê·¸ì¸</div>
            
            <input 
                type="text" 
                id="accessCodeInput" 
                class="login-input" 
                placeholder="ì´ë¦„ (ì˜ˆ: ë°•ì§€í˜„)"
                autocomplete="off"
            >
            
            <input 
                type="password" 
                id="pinInput" 
                class="login-input" 
                placeholder="ê°œì¸ PIN (4ìë¦¬)"
                maxlength="4"
                inputmode="numeric"
                autocomplete="off"
            >
            
            <button id="loginBtn" class="login-btn" onclick="handleLogin()">
                ë¡œê·¸ì¸
            </button>
            
            <div id="loginError" class="login-error"></div>
            
            <div class="login-info">
                ğŸ“Œ ì´ë¦„ê³¼ PINì„ ëª¨ë¥´ì‹œë©´<br>
                ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”<br>
                ğŸ“ 070-8019-1456
            </div>
        </div>
    </div>

    <!-- ==================== ë¡œê·¸ì¸ í™”ë©´ ë ==================== -->

    <!-- í—¤ë” -->
    <div class="header">
        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
        <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">
            ğŸšª ë¡œê·¸ì•„ì›ƒ
        </button>
        
        <!-- í…Œë§ˆ í† ê¸€ ë²„íŠ¼ -->
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜">
            ğŸŒ™
        </button>
        
        <h1>ğŸ  ë”í™ˆì ê²€</h1>
        <p>í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ v3.2 (ì‚¬ì§„ 2ì¥ ì´¬ì˜)</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <div class="container">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">ğŸ“ í”„ë¡œì íŠ¸</button>
            <button class="tab" onclick="switchTab('defects', event)">ğŸ” í•˜ìì ê²€</button>
            <button class="tab" onclick="switchTab('equipment', event)">ğŸ“¸ ì¥ë¹„ì ê²€</button>
            <button class="tab" onclick="switchTab('airquality', event)">ğŸŒ¬ï¸ ê³µê¸°ì§ˆ</button>
            <button class="tab" onclick="switchTab('data', event)">ğŸ’¾ ë°ì´í„°</button>
            <button class="tab" onclick="switchTab('contract', event)">ğŸ“„ ê³„ì•½ì„œ</button>
        </div>

        <!-- í”„ë¡œì íŠ¸ ì •ë³´ ì„¹ì…˜ -->
        <div id="project" class="section active">
            <!-- í”„ë¡œì íŠ¸ ëª©ë¡ ì¹´ë“œ -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <h2 style="color: white; margin-bottom: 15px;">ğŸ“‹ í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="addNewProject()" class="btn" style="background: white; color: #667eea; flex: 1; min-width: 120px;">
                        â• ìƒˆ í”„ë¡œì íŠ¸
                    </button>
                    <button onclick="deleteCurrentProject()" class="btn" style="background: rgba(255,255,255,0.2); color: white; flex: 1; min-width: 120px;">
                        ğŸ—‘ï¸ í˜„ì¬ ì‚­ì œ
                    </button>
                </div>

                <div id="projectList" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- í”„ë¡œì íŠ¸ ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>

                <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                    ğŸ’¡ íŒ: í•˜ë£¨ì— ì—¬ëŸ¬ í”„ë¡œì íŠ¸ë¥¼ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ì „í™˜ë©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í”„ë¡œì íŠ¸ ì •ë³´</h2>
                
                <div class="form-field">
                    <label class="form-label">ì•„íŒŒíŠ¸ëª…</label>
                    <input type="text" class="form-input" id="apartmentName" placeholder="ì˜ˆ: ë˜ë¯¸ì•ˆ ì•„íŒŒíŠ¸" oninput="autoSaveProjectData()">
                </div>

                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">ë™</label>
                        <input type="text" class="form-input" id="dong" placeholder="ì˜ˆ: 101" oninput="cleanDongHo(this, 'ë™'); autoSaveProjectData()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">í˜¸ìˆ˜</label>
                        <input type="text" class="form-input" id="ho" placeholder="ì˜ˆ: 502" oninput="cleanDongHo(this, 'í˜¸'); autoSaveProjectData()">
                    </div>
                </div>

                <div class="form-field">
                    <label class="form-label">ì ê²€ì¼ì</label>
                    <input type="date" class="form-input" id="inspectionDate" onchange="autoSaveProjectData()">
                </div>

                <div class="grid-2">
                    <div class="form-field">
                        <label class="form-label">ê³ ê°ëª…</label>
                        <input type="text" class="form-input" id="customerName" placeholder="ê³ ê° ì´ë¦„" oninput="autoSaveProjectData()">
                    </div>

                    <div class="form-field">
                        <label class="form-label">ì ê²€ ì‘ì„±ì</label>
                        <input type="text" class="form-input" id="author" placeholder="ì‘ì„±ì ì´ë¦„" oninput="autoSaveProjectData()">
                    </div>
                </div>

                <div class="form-field" style="display: none;">
                    <label class="form-label">ì—°ë½ì²˜</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="010-0000-0000" oninput="autoSaveProjectData()">
                </div>

                <button class="btn btn-primary" onclick="saveProject()">âœ… í”„ë¡œì íŠ¸ ì •ë³´ ì €ì¥</button>
            </div>

            <!-- í‰ë©´ë„ ì„¹ì…˜ í†µí•© -->
            <div class="card" style="margin-top: 20px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í‰ë©´ë„ ê´€ë¦¬</h2>
                
                <div class="floorplan-container">
                    <img id="floorplanPreview" class="floorplan-preview" style="display: none;">
                    <p id="floorplanPlaceholder" style="color: var(--text-secondary); padding: 60px 0;">
                        í‰ë©´ë„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”
                    </p>
                    
                    <div class="photo-actions">
                        <button class="photo-action-btn camera" onclick="openFloorplanCamera()">
                            ğŸ“· ì´¬ì˜í•˜ê¸°
                        </button>
                        <button class="photo-action-btn" onclick="openFloorplanGallery()">
                            ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬
                        </button>
                    </div>

                    <button class="btn btn-danger" onclick="deleteFloorplan()" style="margin-top: 15px;">
                        ğŸ—‘ï¸ í‰ë©´ë„ ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>

        <!-- í•˜ì ì ê²€ ì„¹ì…˜ -->
        <div id="defects" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ” í•˜ì ì ê²€</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    ìš°ì¸¡ í•˜ë‹¨ì˜ â• ë²„íŠ¼ì„ ëˆŒëŸ¬ í•˜ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”
                </p>
            </div>

            <div id="defectsList"></div>
        </div>

        <!-- ì¥ë¹„ì ê²€ ì„¹ì…˜ -->
        <div id="equipment" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“¸ ì¥ë¹„ ì ê²€ LIST</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    ì—´í™”ìƒ ì¹´ë©”ë¼ ë° ì‹¤ë¬¼ ì‚¬ì§„ ì´¬ì˜ (ìš°ì¸¡ í•˜ë‹¨ â• ë²„íŠ¼)
                </p>
            </div>

            <div id="equipmentList"></div>
        </div>

        <!-- ê³µê¸°ì§ˆ ì¸¡ì • ì„¹ì…˜ -->
        <div id="airquality" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸŒ¬ï¸ ê³µê¸°ì§ˆ ì¸¡ì •</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    ì‹¤ë‚´ ê³µê¸°ì§ˆì„ ì¸¡ì •í•˜ê³  ê¸°ë¡í•˜ì„¸ìš”
                </p>
            </div>

            <div id="airQualityList"></div>

            <button class="air-add-btn" onclick="addAirQualityRoom()">
                â• ë°© ì¶”ê°€
            </button>

            <div class="card reference-info">
                <strong>ğŸ“‹ ê¶Œê³ ê¸°ì¤€</strong><br>
                ë¼ëˆ: 148 Bq/mÂ³ ì´í•˜<br>
                í¬ë¦„ì•Œë°íˆë“œ: 0.210 mg/mÂ³ ì´í•˜<br>
                ì´íœ˜ë°œì„±ìœ ê¸°í™”í•©ë¬¼: 0.500 mg/mÂ³ ì´í•˜
            </div>
        </div>

        <!-- ë°ì´í„° ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="data" class="section">
            <!-- Google Drive ì—°ë™ ì¹´ë“œ -->
            <!-- Google Drive ì—°ë™ (ê¸°ë³¸ ìˆ¨ê¹€) -->
            <div class="card" id="googleDriveCard" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; margin-bottom: 20px; display: none;">
                <h2 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                            <path d="M6.5 12L1 21h11l5.5-9H6.5zM19 12l-5.5-9L8 12h11zM7.5 3l-6 9h11l-5-9z"/>
                        </svg>
                        Google Drive ì—°ë™ (ì„ íƒ ê¸°ëŠ¥)
                    </div>
                    <button onclick="toggleGoogleDrive()" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 4px 12px; border-radius: 12px; cursor: pointer; font-size: 14px;">
                        âœ• ë‹«ê¸°
                    </button>
                </h2>
                
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 13px;">
                    ğŸ’¡ <strong>íŒ€ ê³µìœ  ê¸°ëŠ¥:</strong> Google Client IDë¥¼ ì„¤ì •í•˜ë©´ íŒ€ì›ë“¤ê³¼ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜¼ì ì‚¬ìš©í•˜ì‹ ë‹¤ë©´ ì´ ê¸°ëŠ¥ì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
                </div>
                
                <div id="googleDriveStatus" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px;">
                    <div id="notSignedIn" style="display: block;">
                        âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                    <div id="signedIn" style="display: none;">
                        âœ… <span id="userEmail"></span>ë‹˜ ë¡œê·¸ì¸ë¨
                    </div>
                </div>
                
                <!-- Google Client ID ì„¤ì • -->
                <div id="clientIdSetup" style="margin-bottom: 15px; padding: 10px; background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 8px; display: none;">
                    <div style="font-size: 13px; color: #fbbf24; margin-bottom: 8px;">
                        ğŸ”‘ Google Client IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
                    </div>
                    <input type="text" id="clientIdInput" placeholder="123456789-abcdef.apps.googleusercontent.com" 
                           style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 8px; font-size: 12px;">
                    <button onclick="saveClientId()" class="btn" style="width: 100%; background: #fbbf24; color: #1a202c; font-weight: bold;">
                        ğŸ’¾ ì €ì¥
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="signInBtn" class="btn" onclick="handleGoogleSignIn()" style="flex: 1; background: white; color: #4285f4; font-weight: bold;">
                        ğŸ” Google ë¡œê·¸ì¸
                    </button>
                    <button id="signOutBtn" class="btn" onclick="handleGoogleSignOut()" style="flex: 1; background: rgba(255,255,255,0.2); color: white; display: none;">
                        ğŸšª ë¡œê·¸ì•„ì›ƒ
                    </button>
                    <button onclick="toggleClientIdSetup()" class="btn" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 0 15px;">
                        âš™ï¸
                    </button>
                </div>
                
                <!-- ë™ê¸°í™” ë²„íŠ¼ (ì˜¤í”„ë¼ì¸ ì‘ì—… ì‹œ í‘œì‹œ) -->
                <button id="syncBtn" class="btn" onclick="syncPendingProjects()" style="display: none; margin-top: 10px; background: #fbbf24; color: #1a202c; font-weight: bold; position: relative;">
                    <span id="syncBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
                    ğŸ“¤ ëŒ€ê¸° í”„ë¡œì íŠ¸ ë™ê¸°í™”
                </button>
            </div>

            <!-- í´ë¼ìš°ë“œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° -->
            <div class="card" id="cloudActionsCard" style="display: none;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ì†Œ</h3>
                
                <button class="btn btn-primary" onclick="uploadProjectToDrive()" style="margin-bottom: 10px;">
                    â˜ï¸ Driveì— ì €ì¥
                </button>
                
                <button class="btn btn-secondary" onclick="loadFromDrive()" style="margin-bottom: 10px;">
                    ğŸ“¥ Driveì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>

                <button class="btn" onclick="showDriveProjects()" style="background: #34a853; color: white;">
                    ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡ ë³´ê¸°
                </button>
            </div>

            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ’¾ ë‹¤ìš´ë¡œë“œ & ê´€ë¦¬</span>
                    <button onclick="toggleGoogleDrive()" class="btn" style="background: rgba(66, 133, 244, 0.1); color: #4285f4; padding: 8px 16px; font-size: 13px;">
                        â˜ï¸ íŒ€ ê³µìœ  ê¸°ëŠ¥
                    </button>
                </h2>
                
                <button class="btn btn-primary" onclick="generatePDF()">ğŸ“„ PDF ë³´ê³ ì„œ ìƒì„±</button>
                
                <div style="height: 10px;"></div>
                
                <button class="btn" onclick="downloadAllData()" style="background: #3b82f6; color: white; font-weight: bold;">
                    ğŸ“¦ ëª¨ë“  ìë£Œ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€ + ì‚¬ì§„ ZIP)
                </button>
                
                <div style="height: 10px;"></div>
                
                <button class="btn" onclick="generateEquipmentOnlyPDF()" style="background: #6366f1; color: white; font-weight: bold;">
                    ğŸ”§ ì¥ë¹„ì ê²€ ë³´ê³ ì„œ (ì¥ë¹„ì¸¡ì •ë§Œ)
                </button>
                
                <div style="height: 10px;"></div>
                
                <button class="btn" onclick="generateFieldReportPDF()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: bold;">
                    ğŸ“‹ í˜„ì¥ì¶œë ¥ë³´ê³ ì„œ (ìš”ì•½í˜• í…Œì´ë¸”)
                </button>
                
                <div style="height: 20px;"></div>
                
                <details style="margin-bottom: 20px;">
                    <summary style="cursor: pointer; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; color: #ef4444; font-weight: bold;">
                        âš ï¸ ê³ ê¸‰ ê¸°ëŠ¥ (ì¼ë°˜ ì‚¬ìš©ìëŠ” í•„ìš” ì—†ìŒ)
                    </summary>
                    <div style="padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px; margin-top: 10px;">
                        <p style="font-size: 13px; color: #333; margin-bottom: 10px;">
                            ğŸ’¡ <strong>ìë™ ì €ì¥:</strong> ë°ì´í„°ëŠ” ì…ë ¥ê³¼ ë™ì‹œì— ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.<br>
                            ğŸ’¡ <strong>ë°ì´í„° ì‚­ì œ:</strong> ë¸Œë¼ìš°ì € ë°ì´í„°ë¥¼ ì™„ì „íˆ ì§€ìš°ê³  ì‹¶ì„ ë•Œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
                        </p>
                        <button class="btn btn-secondary" onclick="saveCurrentData()" style="width: 100%; margin-bottom: 10px;">
                            ğŸ’¾ ìˆ˜ë™ ì €ì¥ (ìë™ ì €ì¥ë˜ë¯€ë¡œ ë¶ˆí•„ìš”)
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%; margin-bottom: 15px;">
                            ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ (ë³µêµ¬ ë¶ˆê°€)
                        </button>
                        
                        <div style="border-top: 2px solid rgba(239, 68, 68, 0.2); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--danger); margin-bottom: 15px; font-size: 16px;">ğŸ“¦ ì €ì¥ëœ í”„ë¡œì íŠ¸ ëª©ë¡</h3>
                            <p style="font-size: 13px; color: #333; margin-bottom: 10px;">
                                âš ï¸ <strong>í”„ë¡œì íŠ¸ ì‚­ì œ ì‹œ ë³µêµ¬ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤!</strong>
                            </p>
                            <div id="savedList" class="saved-list"></div>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- ì¹´ë©”ë¼ ëª¨ë‹¬ -->
    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        
        <!-- í„°ì¹˜ í¬ì¸íŠ¸ ë§ˆì»¤ í‘œì‹œìš© ìº”ë²„ìŠ¤ ì˜¤ë²„ë ˆì´ -->
        <canvas id="markerCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></canvas>
        
        <!-- ì¤Œ ë ˆë²¨ í‘œì‹œ -->
        <div class="zoom-level" id="zoomLevel">ì¤Œ: 1.0x</div>
        
        <!-- ì¤Œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
            <button class="zoom-btn" onclick="adjustZoom(-0.1)">âˆ’</button>
        </div>
        
        <div class="camera-controls">
            <button class="camera-btn" onclick="capturePhoto()" ontouchstart="">ğŸ“¸</button>
            <button class="camera-btn close" onclick="closeCameraModal()" ontouchstart="">âœ•</button>
        </div>
    </div>

        <!-- ê³„ì•½ì„œ ê´€ë¦¬ ì„¹ì…˜ (ìˆ¨ê¹€) -->
        <div id="contract" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“„ í”„ë¦¬ëœì„œ ê³„ì•½ì„œ ê´€ë¦¬</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 14px;">
                    í”„ë¦¬ëœì„œ ê³ ìš©ê³„ì•½ì„œë¥¼ ë””ì§€í„¸ë¡œ ì‘ì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤
                </p>

                <!-- ê³„ì•½ì„œ ì‘ì„± ì•ˆë‚´ -->
                <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 15px;">
                    <p style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 12px;">
                        âœ¨ ê°„í¸í•œ ê³„ì•½ì„œ ì‘ì„±
                    </p>
                    <p style="color: white; font-size: 15px; margin-bottom: 20px; opacity: 0.95;">
                        ì‘ì„± â†’ ì„œëª… â†’ PDF ë‹¤ìš´ë¡œë“œ â†’ ì¹´í†¡/ì´ë©”ì¼ ê³µìœ 
                    </p>
                    <button class="btn" onclick="showContractForm()" 
                        style="background: white; color: #10b981; font-size: 17px; padding: 14px 35px; font-weight: bold; border: none;">
                        â• ê³„ì•½ì„œ ì‘ì„±í•˜ê¸°
                    </button>
                </div>

                <!-- ê³„ì•½ì„œ ì‘ì„± í¼ -->
                <div id="contractForm" style="display: block;">
                    <div class="form-group">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ‘¤ í”„ë¦¬ëœì„œ ì •ë³´</h3>
                        
                        <div class="form-field">
                            <label class="form-label">ì„±ëª… *</label>
                            <input type="text" class="form-input" id="contractName" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì£¼ì†Œ *</label>
                            <input type="text" class="form-input" id="contractAddress" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="contractJumin1" placeholder="ìƒë…„ì›”ì¼ 6ìë¦¬" 
                                    maxlength="6" style="width: 150px;" required>
                                <span>-</span>
                                <input type="text" class="form-input" id="contractJumin2" placeholder="ë’·ìë¦¬ 1ìë¦¬" 
                                    maxlength="1" style="width: 60px;" required>
                                <span>******</span>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì—°ë½ì²˜ *</label>
                            <input type="tel" class="form-input" id="contractPhone" placeholder="010-0000-0000" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì´ë©”ì¼ *</label>
                            <input type="email" class="form-input" id="contractEmail" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ (ì„ íƒ)</label>
                            <input type="text" class="form-input" id="contractBusiness" placeholder="000-00-00000">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ“‹ ê³„ì•½ ì¡°ê±´</h3>
                        
                        <div class="form-field">
                            <label class="form-label">ê³„ì•½ ì‹œì‘ì¼ *</label>
                            <input type="date" class="form-input" id="contractStartDate" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ê³„ì•½ ì¢…ë£Œì¼ *</label>
                            <input type="date" class="form-input" id="contractEndDate" required>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ê³„ì•½ê¸ˆì•¡ ì•ˆë‚´</label>
                            <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <p style="color: var(--text-primary); margin-bottom: 8px;">
                                    <strong>ì¼ë‹¹: 1ë§Œì› ~ 50ë§Œì›</strong>
                                </p>
                                <p style="color: var(--text-secondary); font-size: 13px;">
                                    â€» ì—…ë¬´ì— ë”°ë¼ ì§€ê¸‰ë¹„ìš©ì´ ë‹¤ë¥´ê²Œ ì§€ê¸‰ë©ë‹ˆë‹¤
                                </p>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">ì§€ê¸‰ì¼ ì•ˆë‚´</label>
                            <div style="padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid var(--secondary);">
                                <p style="color: var(--text-primary); margin-bottom: 8px;">
                                    <strong>ì—…ë¬´ ì™„ë£Œ í›„ 1ê°œì›” ì´ë‚´ ì§€ê¸‰</strong>
                                </p>
                                <p style="color: var(--text-secondary); font-size: 13px;">
                                    â€» ì‚¬ì—…ì†Œë“ì„¸ 3.3% ì›ì²œì§•ìˆ˜ í›„ ì§€ê¸‰
                                </p>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</label>
                            <textarea class="form-input" id="contractNotes" rows="3" 
                                placeholder="ì¶”ê°€ ê³„ì•½ ì¡°ê±´ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">âœï¸ ì „ì ì„œëª…</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label class="form-label">ëŒ€í‘œ ì„œëª… (ë°•ì§€í˜„)</label>
                            <div style="border: 2px solid var(--border); border-radius: 8px; background: white; position: relative;">
                                <canvas id="signatureCEO" width="600" height="200" 
                                    style="display: block; width: 100%; cursor: crosshair; touch-action: none;"></canvas>
                            </div>
                            <button class="btn" onclick="clearSignature('CEO')" style="margin-top: 10px; background: var(--danger);">
                                ğŸ—‘ï¸ ì„œëª… ì§€ìš°ê¸°
                            </button>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="form-label">í”„ë¦¬ëœì„œ ì„œëª…</label>
                            <div style="border: 2px solid var(--border); border-radius: 8px; background: white; position: relative;">
                                <canvas id="signatureFreelancer" width="600" height="200" 
                                    style="display: block; width: 100%; cursor: crosshair; touch-action: none;"></canvas>
                            </div>
                            <button class="btn" onclick="clearSignature('Freelancer')" style="margin-top: 10px; background: var(--danger);">
                                ğŸ—‘ï¸ ì„œëª… ì§€ìš°ê¸°
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="previewContract()" style="flex: 1;">
                            ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button class="btn btn-primary" onclick="downloadContractPDF()" style="flex: 1;">
                            ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 15px; color: var(--text-secondary); font-size: 14px;">
                        ğŸ’¡ ì„œëª… í›„ PDF ë‹¤ìš´ë¡œë“œ â†’ ì¹´í†¡/ì´ë©”ì¼ë¡œ ê³µìœ í•˜ì„¸ìš”
                    </p>
                </div>

                <!-- ê³„ì•½ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
                <div id="contractPreviewModal" style="display: none; position: fixed; top: 0; left: 0; 
                    width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; 
                    overflow: auto; padding: 20px;">
                    <div style="max-width: 800px; margin: 0 auto; background: white; 
                        border-radius: 15px; padding: 30px; position: relative; color: #333;">
                        <button onclick="closePreview()" 
                            style="position: absolute; top: 15px; right: 15px; 
                            background: #dc3545; color: white; border: none; 
                            border-radius: 50%; width: 40px; height: 40px; 
                            font-size: 20px; cursor: pointer;">âœ•</button>
                        
                        <div id="contractPreviewContent"></div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="closePreview()" style="padding: 12px 40px; font-size: 16px;">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    <!-- í”Œë¡œíŒ… í•˜ì/ì¥ë¹„ ì¶”ê°€ ë²„íŠ¼ -->
    <button id="floatingAddBtn" class="floating-btn" onclick="handleFloatingBtnClick()" style="display: none;">
        â•
    </button>

    <!-- ë¡œë”© -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Drive í”„ë¡œì íŠ¸ ëª©ë¡ ëª¨ë‹¬ -->
    <div id="driveProjectsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 50px auto; background: var(--bg-dark); border-radius: 12px; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary);">ğŸ“‚ Drive í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                <button onclick="closeDriveProjectsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">âœ•</button>
            </div>
            <div id="driveProjectsList" style="max-height: 60vh; overflow-y: auto;">
                <!-- í”„ë¡œì íŠ¸ ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        // ==================== ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ====================
        // Google Sheets ê³µê°œ URL (CSV í˜•ì‹)
        // ì‚¬ìš© ë°©ë²•: Google Sheets â†’ íŒŒì¼ â†’ ê³µìœ  â†’ ì›¹ì— ê²Œì‹œ â†’ CSV í˜•ì‹ ì„ íƒ
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4Tz0-NgXyWR36c9hkZ4ko0ll4g-oj5YGHZysuH0c1Mngr4Ev9-VgiryTHHcMd2Zq5NuOmOI6dMZeh/pub?output=csv';
        
        // ë¡œê·¸ì¸ í™•ì¸
        function checkLoginStatus() {
            const loginData = localStorage.getItem('dhLoginData');
            
            if (loginData) {
                try {
                    const data = JSON.parse(loginData);
                    const now = new Date().getTime();
                    
                    // 90ì¼ = 90 * 24 * 60 * 60 * 1000
                    if (now - data.loginTime < 90 * 24 * 60 * 60 * 1000) {
                        // ë¡œê·¸ì¸ ìœ íš¨
                        hideLoginScreen();
                        return true;
                    } else {
                        // ì„¸ì…˜ ë§Œë£Œ
                        localStorage.removeItem('dhLoginData');
                    }
                } catch (e) {
                    localStorage.removeItem('dhLoginData');
                }
            }
            
            // ë¡œê·¸ì¸ í•„ìš”
            showLoginScreen();
            return false;
        }
        
        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLoginScreen() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('accessCodeInput').focus();
        }
        
        // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¹€
        function hideLoginScreen() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
        }
        
        // Google Sheetsì—ì„œ ì•¡ì„¸ìŠ¤ ì½”ë“œ ë° PIN í™•ì¸
        async function verifyAccessCode(code, pin) {
            try {
                // Google Sheets CSV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(GOOGLE_SHEETS_CSV_URL);
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                // CSV íŒŒì‹± (ì²« ì¤„ì€ í—¤ë”ì´ë¯€ë¡œ ê±´ë„ˆëœ€)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // CSV í˜•ì‹: ì•¡ì„¸ìŠ¤ì½”ë“œ,ì´ë¦„,ì†Œì†,ìƒíƒœ,PIN
                    const columns = line.split(',');
                    const accessCode = columns[0]?.trim();
                    const status = columns[3]?.trim();
                    const storedPin = columns[4]?.trim();
                    
                    // ì½”ë“œ ì¼ì¹˜ ë° í™œì„± ìƒíƒœ ë° PIN í™•ì¸
                    if (accessCode === code && status === 'í™œì„±' && storedPin === pin) {
                        return {
                            success: true,
                            name: columns[1]?.trim(),
                            team: columns[2]?.trim()
                        };
                    }
                }
                
                return { success: false, message: 'ì´ë¦„ ë˜ëŠ” PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤' };
                
            } catch (error) {
                console.error('ì•¡ì„¸ìŠ¤ ì½”ë“œ í™•ì¸ ì˜¤ë¥˜:', error);
                
                // ì˜¤í”„ë¼ì¸ì´ê±°ë‚˜ ì‹œíŠ¸ ì ‘ê·¼ ë¶ˆê°€ ì‹œ - ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì •ë³´ í™•ì¸
                const lastLogin = localStorage.getItem('dhLoginData');
                if (lastLogin) {
                    try {
                        const data = JSON.parse(lastLogin);
                        if (data.code === code && data.pin === pin) {
                            return { 
                                success: true, 
                                name: data.name, 
                                team: data.team,
                                offline: true 
                            };
                        }
                    } catch (e) {}
                }
                
                return { 
                    success: false, 
                    message: 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.' 
                };
            }
        }
        
        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const codeInput = document.getElementById('accessCodeInput');
            const pinInput = document.getElementById('pinInput');
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            const code = codeInput.value.trim();
            const pin = pinInput.value.trim();
            
            // ì…ë ¥ê°’ í™•ì¸
            if (!code) {
                errorDiv.textContent = 'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”';
                errorDiv.classList.add('show');
                return;
            }
            
            if (!pin) {
                errorDiv.textContent = 'PINì„ ì…ë ¥í•˜ì„¸ìš”';
                errorDiv.classList.add('show');
                return;
            }
            
            if (pin.length !== 4) {
                errorDiv.textContent = 'PINì€ 4ìë¦¬ ìˆ«ìì…ë‹ˆë‹¤';
                errorDiv.classList.add('show');
                return;
            }
            
            // ë¡œë”© ìƒíƒœ
            loginBtn.disabled = true;
            loginBtn.textContent = 'í™•ì¸ ì¤‘...';
            errorDiv.classList.remove('show');
            
            // ì•¡ì„¸ìŠ¤ ì½”ë“œ ë° PIN í™•ì¸
            const result = await verifyAccessCode(code, pin);
            
            if (result.success) {
                // ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
                const loginData = {
                    code: code,
                    pin: pin,
                    name: result.name,
                    team: result.team,
                    loginTime: new Date().getTime()
                };
                localStorage.setItem('dhLoginData', JSON.stringify(loginData));
                
                // ë¡œê·¸ì¸ ì„±ê³µ
                if (result.offline) {
                    showToast('âœ“ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                } else {
                    showToast('âœ“ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }
                
                hideLoginScreen();
                codeInput.value = '';
                pinInput.value = '';
                
            } else {
                // ë¡œê·¸ì¸ ì‹¤íŒ¨
                errorDiv.textContent = result.message;
                errorDiv.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('dhLoginData');
                showLoginScreen();
                showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            }
        }
        
        // ==================== ë¹„í™œì„± ê³„ì • ì²´í¬ ====================
        async function checkAccountStatus() {
            try {
                const loginData = localStorage.getItem('dhLoginData');
                if (!loginData) return true;
                
                const data = JSON.parse(loginData);
                const code = data.code;
                
                const response = await fetch(GOOGLE_SHEETS_CSV_URL);
                if (!response.ok) return true;
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(',');
                    const accessCode = columns[0]?.trim();
                    const status = columns[3]?.trim();
                    
                    if (accessCode === code) {
                        if (status !== 'í™œì„±') {
                            localStorage.removeItem('dhLoginData');
                            showLoginScreen();
                            alert('ê³„ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                            return false;
                        }
                        return true;
                    }
                }
                
                localStorage.removeItem('dhLoginData');
                showLoginScreen();
                alert('ê³„ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return false;
                
            } catch (error) {
                console.log('ê³„ì • ìƒíƒœ ì²´í¬ ì‹¤íŒ¨:', error);
                return true;
            }
        }
        // ==================== ë¹„í™œì„± ê³„ì • ì²´í¬ ë ====================
        
        // Enter í‚¤ë¡œ ë¡œê·¸ì¸
        document.addEventListener('DOMContentLoaded', () => {
            const codeInput = document.getElementById('accessCodeInput');
            const pinInput = document.getElementById('pinInput');
            
            if (codeInput) {
                codeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        pinInput.focus(); // PIN ì…ë ¥ í•„ë“œë¡œ ì´ë™
                    }
                });
            }
            
            if (pinInput) {
                pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            checkLoginStatus();
            
            // ë¹„í™œì„± ê³„ì • ì²´í¬
            setTimeout(async () => {
                const loginData = localStorage.getItem('dhLoginData');
                if (loginData) {
                    await checkAccountStatus();
                }
            }, 1000);
        });
        // ==================== ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ë ====================

        // ==================== ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (í¬ë¡œìŠ¤ í”Œë«í¼ ì•ˆì •ì„±) ====================
        window.addEventListener('error', (event) => {
            console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
            
            // ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•œ ë©”ì‹œì§€ í‘œì‹œ
            if (event.error && event.error.message) {
                const errorMsg = event.error.message.toLowerCase();
                
                // ë©”ëª¨ë¦¬ ì˜¤ë¥˜ (iOSì—ì„œ í”í•¨)
                if (errorMsg.includes('memory') || errorMsg.includes('quota')) {
                    showToast('âš ï¸ ë©”ëª¨ë¦¬ ë¶€ì¡±. ì‚¬ì§„ì„ ì••ì¶•í•˜ì—¬ ì¬ì‹œë„í•©ë‹ˆë‹¤.', 'warning');
                }
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
                else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                    showToast('ğŸ“¶ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
            }
            
            // ì—ëŸ¬ ë¡œê·¸ (ê°œë°œìš©)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('ì—ëŸ¬ ìƒì„¸:', {
                    message: event.error?.message,
                    stack: event.error?.stack,
                    filename: event.filename,
                    lineno: event.lineno
                });
            }
        });
        
        // Promise rejection í•¸ë“¤ëŸ¬
        window.addEventListener('unhandledrejection', (event) => {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
            
            // ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬
            if (event.reason && event.reason.message && 
                event.reason.message.includes('NetworkError')) {
                event.preventDefault();
                showToast('ğŸ“¶ ì¼ì‹œì ì¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.', 'warning');
            }
        });
        
        // ==================== ë””ë°”ì´ìŠ¤ ë° ë¸Œë¼ìš°ì € ê°ì§€ ====================
        const deviceInfo = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isAndroid: /Android/.test(navigator.userAgent),
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            isChrome: /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor),
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            version: navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/) || []
        };
        
        // iOS ë²„ì „ í™•ì¸
        deviceInfo.iOSVersion = deviceInfo.isIOS && deviceInfo.version.length > 1 
            ? parseInt(deviceInfo.version[1]) 
            : 0;
        
        console.log('ë””ë°”ì´ìŠ¤ ì •ë³´:', deviceInfo);
        
        // ë””ë°”ì´ìŠ¤ë³„ ê²½ê³  í‘œì‹œ
        if (deviceInfo.isIOS && deviceInfo.iOSVersion < 13) {
            alert('âš ï¸ iOS 13 ì´ìƒ ê¶Œì¥\nì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
        
        // ==================== ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê´€ë¦¬ ====================
        let isOnline = navigator.onLine;
        let pendingSyncProjects = []; // ë™ê¸°í™” ëŒ€ê¸° í”„ë¡œì íŠ¸
        
        // Service WorkerëŠ” í™˜ê²½ ì œì•½ìœ¼ë¡œ ì œê±°
        // localStorageë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ì €ì¥ìœ¼ë¡œ ëŒ€ì²´
        
        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
        window.addEventListener('online', () => {
            isOnline = true;
            updateOnlineStatus();
            showToast('âœ… ì˜¨ë¼ì¸ ì—°ê²°ë¨', 'success');
            
            // ë™ê¸°í™” ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì íŠ¸ í™•ì¸
            loadPendingSyncProjects();
            if (pendingSyncProjects.length > 0) {
                setTimeout(() => {
                    if (confirm(`ë™ê¸°í™” ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ${pendingSyncProjects.length}ê±´ ìˆìŠµë‹ˆë‹¤.\nì§€ê¸ˆ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        syncPendingProjects();
                    }
                }, 1000);
            }
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateOnlineStatus();
            showToast('ğŸ“¶ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ì‘ì—… ë‚´ìš©ì€ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤', 'warning');
        });
        
        // ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.innerHTML = 'ğŸŸ¢ ì˜¨ë¼ì¸';
                    statusIndicator.style.color = '#10b981';
                } else {
                    statusIndicator.innerHTML = 'ğŸ”´ ì˜¤í”„ë¼ì¸';
                    statusIndicator.style.color = '#ef4444';
                }
            }
        }
        
        // localStorage ê¸°ë°˜ ë™ê¸°í™” ëŒ€ê¸° ê´€ë¦¬
        function loadPendingSyncProjects() {
            try {
                const saved = localStorage.getItem('pendingSyncProjects');
                if (saved) {
                    pendingSyncProjects = JSON.parse(saved);
                    updateSyncBadge();
                }
            } catch (error) {
                console.error('ë™ê¸°í™” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                pendingSyncProjects = [];
            }
        }
        
        function savePendingSyncProjects() {
            try {
                localStorage.setItem('pendingSyncProjects', JSON.stringify(pendingSyncProjects));
                updateSyncBadge();
            } catch (error) {
                console.error('ë™ê¸°í™” ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
        
        function addToPendingSync(projectData) {
            projectData.syncTimestamp = Date.now();
            pendingSyncProjects.push(projectData);
            savePendingSyncProjects();
            
            // ë™ê¸°í™” ë²„íŠ¼ í‘œì‹œ
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) syncBtn.style.display = 'block';
        }
        
        function removePendingSyncProject(index) {
            pendingSyncProjects.splice(index, 1);
            savePendingSyncProjects();
        }
        
        // ë™ê¸°í™” ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (pendingSyncProjects.length > 0) {
                    badge.textContent = pendingSyncProjects.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì íŠ¸ ë™ê¸°í™”
        window.syncPendingProjects = async function() {
            if (!isOnline) {
                showToast('âŒ ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            if (pendingSyncProjects.length === 0) {
                showToast('âœ… ë™ê¸°í™”í•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'success');
                return;
            }
            
            showLoading('ë™ê¸°í™” ì¤‘...');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = pendingSyncProjects.length - 1; i >= 0; i--) {
                try {
                    const project = pendingSyncProjects[i];
                    await uploadProjectToDrive(project);
                    removePendingSyncProject(i);
                    successCount++;
                } catch (error) {
                    console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
                    failCount++;
                }
            }
            
            hideLoading();
            
            if (failCount === 0) {
                showToast(`âœ… ëª¨ë“  í”„ë¡œì íŠ¸(${successCount}ê±´)ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
                showToast(`âš ï¸ ${successCount}ê±´ ì„±ê³µ, ${failCount}ê±´ ì‹¤íŒ¨`, 'warning');
            }
            
            // ë™ê¸°í™” ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (pendingSyncProjects.length === 0) {
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) syncBtn.style.display = 'none';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            loadPendingSyncProjects();
            updateOnlineStatus();
        });
        
        // ==================== Google ë¡œê·¸ì¸ ë¹„í™œì„±í™” (ë³´ì•ˆ) ====================
        // âš ï¸ API í‚¤ê°€ GitHubì— ë…¸ì¶œë˜ì–´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤
        // ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ ìƒˆë¡œìš´ Client IDë¥¼ ë°œê¸‰ë°›ì•„ ì„¤ì •í•˜ì„¸ìš”
        
        let GOOGLE_CLIENT_ID = localStorage.getItem('google_client_id') || '';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        
        let accessToken = null;
        let currentUser = null;
        
        const GOOGLE_DRIVE_DISABLED = true; // Google Drive ê¸°ëŠ¥ ë¹„í™œì„±í™”
        
        // ì„¤ì • ì €ì¥
        function saveGoogleClientId(clientId) {
            GOOGLE_CLIENT_ID = clientId;
            localStorage.setItem('google_client_id', clientId);
            showToast('âœ… Client ID ì €ì¥ ì™„ë£Œ');
        }
        
        // Client ID ì„¤ì • í† ê¸€
        window.toggleClientIdSetup = function() {
            const setup = document.getElementById('clientIdSetup');
            if (setup.style.display === 'none') {
                setup.style.display = 'block';
                document.getElementById('clientIdInput').value = GOOGLE_CLIENT_ID;
            } else {
                setup.style.display = 'none';
            }
        }
        
        // Client ID ì €ì¥
        window.saveClientId = function() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) {
                showToast('âŒ Client IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                showToast('âŒ ì˜¬ë°”ë¥¸ Client ID í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                return;
            }
            
            saveGoogleClientId(clientId);
            toggleClientIdSetup();
        }
        
        // Google Drive ì¹´ë“œ í† ê¸€
        window.toggleGoogleDrive = function() {
            const card = document.getElementById('googleDriveCard');
            if (card.style.display === 'none') {
                card.style.display = 'block';
                showToast('ğŸ’¡ íŒ€ ê³µìœ ê°€ í•„ìš”í•˜ë©´ Client IDë¥¼ ì„¤ì •í•˜ì„¸ìš”');
            } else {
                card.style.display = 'none';
            }
        }

        // ==================== í”„ë¡œì íŠ¸ ëª©ë¡ ê´€ë¦¬ ====================
        let projects = []; // ëª¨ë“  í”„ë¡œì íŠ¸ ëª©ë¡
        let currentProjectId = null; // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í”„ë¡œì íŠ¸ ID

        // í”„ë¡œì íŠ¸ í…œí”Œë¦¿
        function createNewProject() {
            return {
                id: Date.now(),
                apartmentName: '',
                dong: '',
                ho: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                customerName: '',
                customerPhone: '',
                author: '', // âœ… ì ê²€ ì‘ì„±ì ì¶”ê°€
                floorplan: null,
                defects: [],
                equipment: [],
                airQuality: [],
                createdAt: new Date().toISOString(),
                isUploaded: false,
                // âœ… í”„ë¡œì íŠ¸ë³„ ID ì¹´ìš´í„° ì¶”ê°€
                lastDefectId: 0,
                lastEquipmentId: 0,
                lastAirQualityId: 0
            };
        }

        // í˜„ì¬ í”„ë¡œì íŠ¸ ê°€ì ¸ì˜¤ê¸°
        function getCurrentProject() {
            if (projects.length === 0) {
                const newProject = createNewProject();
                projects.push(newProject);
                currentProjectId = newProject.id;
            }
            return projects.find(p => p.id === currentProjectId) || projects[0];
        }

        // âœ… projectDataë¥¼ Proxyë¡œ ë³€ê²½ - í•­ìƒ í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ì°¸ì¡°
        const projectData = new Proxy({}, {
            get(target, prop) {
                const project = getCurrentProject();
                return project[prop];
            },
            set(target, prop, value) {
                const project = getCurrentProject();
                project[prop] = value;
                return true;
            }
        });

        // âœ… ID ì¹´ìš´í„°ë¥¼ í”„ë¡œì íŠ¸ë³„ë¡œ ê´€ë¦¬í•˜ë„ë¡ ë³€ê²½
        // ì´ì œ ê° í”„ë¡œì íŠ¸ê°€ ë…ë¦½ì ì¸ ID ì²´ê³„ë¥¼ ê°€ì§
        // let defectIdCounter = 1; // ì œê±°ë¨
        // let equipmentIdCounter = 1; // ì œê±°ë¨  
        // let airQualityIdCounter = 1; // ì œê±°ë¨
        let cameraStream = null;
        let currentPhotoTarget = null;

        // ==================== Google API ì´ˆê¸°í™” ====================
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // ==================== OAuth2 íŒì—… ë¡œê·¸ì¸ ====================
        window.handleGoogleSignIn = async function() {
            // Client ID í™•ì¸
            if (!GOOGLE_CLIENT_ID) {
                showToast('âŒ Client IDë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš” (âš™ï¸ ë²„íŠ¼)');
                toggleClientIdSetup();
                return;
            }
            
            console.log('ğŸ”µ OAuth2 íŒì—… ë¡œê·¸ì¸ ì‹œì‘...');
            
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams({
                client_id: GOOGLE_CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: SCOPES,
                prompt: 'consent'
            });
            
            // íŒì—…ìœ¼ë¡œ ë¡œê·¸ì¸
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popup = window.open(
                authUrl,
                'Google Login',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!popup) {
                showToast('âŒ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }
        }
        
        // ë©”ì‹œì§€ ìˆ˜ì‹  (íŒì—…ì—ì„œ í† í° ì „ë‹¬)
        window.addEventListener('message', async (event) => {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'GOOGLE_AUTH') {
                const token = event.data.accessToken;
                if (token) {
                    accessToken = token;
                    localStorage.setItem('google_access_token', accessToken);
                    console.log('âœ… í† í° ì €ì¥ ì™„ë£Œ');
                    
                    // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                        if (!response.ok) throw new Error('Failed');
                        
                        currentUser = await response.json();
                        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', currentUser.email);
                        
                        updateSignInStatus(true);
                        showToast('âœ… ' + currentUser.email + ' ë¡œê·¸ì¸ ì„±ê³µ!');
                        
                    } catch (error) {
                        console.error('âŒ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                        showToast('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜');
                        accessToken = null;
                        localStorage.removeItem('google_access_token');
                    }
                }
            }
        });
        
        // URLì—ì„œ í† í° ì¶”ì¶œ (ë¦¬ë‹¤ì´ë ‰íŠ¸ ì½œë°±)
        function checkUrlForToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token && window.opener) {
                // ë¶€ëª¨ ì°½ìœ¼ë¡œ í† í° ì „ë‹¬
                window.opener.postMessage({
                    type: 'GOOGLE_AUTH',
                    accessToken: token
                }, window.location.origin);
                window.close();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ì²´í¬
        checkUrlForToken();
        
        // ì €ì¥ëœ í† í°ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸
        async function checkIfSignedIn() {
            const token = localStorage.getItem('google_access_token');
            if (token) {
                accessToken = token;
                
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken);
                    if (!response.ok) throw new Error('Token expired');
                    
                    currentUser = await response.json();
                    updateSignInStatus(true);
                    console.log('âœ… ìë™ ë¡œê·¸ì¸:', currentUser.email);
                } catch (error) {
                    console.log('âŒ í† í° ë§Œë£Œ');
                    accessToken = null;
                    localStorage.removeItem('google_access_token');
                }
            }
        }

        window.handleGoogleSignOut = function() {
            if (accessToken) {
                // Google OAuth2 í† í° í•´ì§€
                fetch('https://accounts.google.com/o/oauth2/revoke?token=' + accessToken);
                
                accessToken = null;
                currentUser = null;
                localStorage.removeItem('google_access_token');
                updateSignInStatus(false);
                showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        function updateSignInStatus(isSignedIn) {
            try {
                if (isSignedIn) {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const userEmail = document.getElementById('userEmail');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'none';
                    if (signedIn) signedIn.style.display = 'block';
                    if (userEmail) userEmail.textContent = currentUser?.email || 'ì‚¬ìš©ì';
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (signOutBtn) signOutBtn.style.display = 'block';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'block';
                } else {
                    const notSignedIn = document.getElementById('notSignedIn');
                    const signedIn = document.getElementById('signedIn');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    const cloudActionsCard = document.getElementById('cloudActionsCard');
                    
                    if (notSignedIn) notSignedIn.style.display = 'block';
                    if (signedIn) signedIn.style.display = 'none';
                    if (signInBtn) signInBtn.style.display = 'block';
                    if (signOutBtn) signOutBtn.style.display = 'none';
                    if (cloudActionsCard) cloudActionsCard.style.display = 'none';
                }
                console.log('âœ… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ:', isSignedIn ? 'ë¡œê·¸ì¸' : 'ë¡œê·¸ì•„ì›ƒ');
            } catch (e) {
                console.error('UI ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
            }
        }

        // ==================== Drive í´ë” ê´€ë¦¬ ====================
        async function getOrCreateAppFolder() {
            try {
                // "ë”í™ˆì ê²€" í´ë” ì°¾ê¸°
                const response = await gapi.client.drive.files.list({
                    q: "name='ë”í™ˆì ê²€' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                const folderMetadata = {
                    name: 'ë”í™ˆì ê²€',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('í´ë” ìƒì„±/ì°¾ê¸° ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ==================== Drive ì €ì¥ ====================
        

        // ==================== Drive ë¶ˆëŸ¬ì˜¤ê¸° ====================
                async function createProjectFolder(appFolderId, projectName) {
            try {
                const folderMetadata = {
                    name: projectName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [appFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id, name'
                });

                return folder.result.id;
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ í´ë” ìƒì„± ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // í•˜ìì‚¬ì§„ í´ë” ìƒì„±

        async function createPhotosFolder(projectFolderId) {
            try {
                const folderMetadata = {
                    name: 'í•˜ìì‚¬ì§„',
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [projectFolderId]
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('ì‚¬ì§„ í´ë” ìƒì„± ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // Base64 ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜

        function base64ToBlob(base64, mimeType) {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeType });
        }

        async function uploadPhoto(photosFolderId, photoData, fileName) {
            try {
                const blob = base64ToBlob(photoData, 'image/jpeg');
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: fileName,
                    mimeType: 'image/jpeg',
                    parents: [photosFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const result = await response.json();
                return result.id;
            } catch (error) {
                console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // Google Sheets ìƒì„± (í•˜ì ë¦¬ìŠ¤íŠ¸)

        async function createDefectSpreadsheet(projectFolderId, projectName, defects) {
            try {
                // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
                const spreadsheetBody = {
                    properties: {
                        title: `${projectName}_í•˜ìì ê²€_ë¦¬ìŠ¤íŠ¸`
                    },
                    sheets: [{
                        properties: {
                            title: 'í•˜ìëª©ë¡'
                        }
                    }]
                };

                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    resource: spreadsheetBody
                });

                const spreadsheetId = createResponse.result.spreadsheetId;

                // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
                await gapi.client.drive.files.update({
                    fileId: spreadsheetId,
                    addParents: projectFolderId,
                    fields: 'id, parents'
                });

                // ë°ì´í„° ì…ë ¥ ì¤€ë¹„
                const headers = [['No', 'ê³µê°„', 'ìœ„ì¹˜', 'í•˜ìì¢…ë¥˜', 'ìƒì„¸ì„¤ëª…']];
                const rows = defects.map((defect, index) => {
                    // ìƒì„¸ì„¤ëª…ë§Œ ì‚¬ìš© (ì´ë¯¸ ëª¨ë“  ì •ë³´ í¬í•¨)
                    const description = defect.description || '';
                    
                    return [
                        index + 1,
                        defect.spaces.join(', '),
                        defect.locations.join(', '),
                        defect.types.join(', '),
                        description || '-'
                    ];
                });

                const allData = [...headers, ...rows];

                // ë°ì´í„° ì…ë ¥
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: allData
                    }
                });

                // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [
                            // í—¤ë” ë°°ê²½ìƒ‰ ë° ê¸€ììƒ‰
                            {
                                repeatCell: {
                                    range: {
                                        sheetId: 0,
                                        startRowIndex: 0,
                                        endRowIndex: 1
                                    },
                                    cell: {
                                        userEnteredFormat: {
                                            backgroundColor: {
                                                red: 0.06,
                                                green: 0.73,
                                                blue: 0.51
                                            },
                                            textFormat: {
                                                foregroundColor: {
                                                    red: 1,
                                                    green: 1,
                                                    blue: 1
                                                },
                                                bold: true
                                            }
                                        }
                                    },
                                    fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                }
                            },
                            // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 0,
                                        endIndex: 1
                                    },
                                    properties: {
                                        pixelSize: 50
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 1,
                                        endIndex: 2
                                    },
                                    properties: {
                                        pixelSize: 100
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 2,
                                        endIndex: 3
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 3,
                                        endIndex: 4
                                    },
                                    properties: {
                                        pixelSize: 150
                                    },
                                    fields: 'pixelSize'
                                }
                            },
                            {
                                updateDimensionProperties: {
                                    range: {
                                        sheetId: 0,
                                        dimension: 'COLUMNS',
                                        startIndex: 4,
                                        endIndex: 5
                                    },
                                    properties: {
                                        pixelSize: 300
                                    },
                                    fields: 'pixelSize'
                                }
                            }
                        ]
                    }
                });

                return spreadsheetId;
            } catch (error) {
                console.error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // í”„ë¡œì íŠ¸ ì •ë³´ JSON ì—…ë¡œë“œ

        async function uploadProjectInfo(projectFolderId, projectData) {
            try {
                const projectInfo = {
                    apartmentName: projectData.apartmentName,
                    dong: projectData.dong,
                    ho: projectData.ho,
                    inspectionDate: projectData.inspectionDate,
                    customerName: projectData.customerName,
                    customerPhone: projectData.customerPhone,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: currentUser?.email
                };

                const blob = new Blob([JSON.stringify(projectInfo, null, 2)], { type: 'application/json' });

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({
                    name: 'í”„ë¡œì íŠ¸_ì •ë³´.json',
                    mimeType: 'application/json',
                    parents: [projectFolderId]
                })], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                return true;
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ë©”ì¸ ì—…ë¡œë“œ í•¨ìˆ˜

        window.uploadProjectToDrive = async function(projectToUpload = null) {
            // projectToUploadê°€ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš© (ë™ê¸°í™”ìš©), ì—†ìœ¼ë©´ í˜„ì¬ í”„ë¡œì íŠ¸
            const project = projectToUpload || getCurrentProject();
            
            // ì˜¤í”„ë¼ì¸ ì²´í¬
            if (!isOnline) {
                // ì˜¤í”„ë¼ì¸ì¼ ë•Œ ë¡œì»¬ ì €ì¥
                try {
                    addToPendingSync(project);
                    showToast('ğŸ“¶ ì˜¤í”„ë¼ì¸ - í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¨ë¼ì¸ ì—°ê²° ì‹œ ë™ê¸°í™”í•˜ì„¸ìš”.', 'warning');
                    return;
                } catch (error) {
                    alert('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                    return;
                }
            }
            
            if (!accessToken) {
                alert('ë¨¼ì € Google ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                return;
            }

            // í•„ìˆ˜ ì •ë³´ í™•ì¸
            if (!project.apartmentName || !project.dong || !project.ho) {
                alert('í”„ë¡œì íŠ¸ ì •ë³´(ì•„íŒŒíŠ¸ëª…, ë™, í˜¸)ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            if (project.defects.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í•˜ìë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”');
                return;
            }

            // projectToUploadê°€ ìˆìœ¼ë©´ ë™ê¸°í™” ì¤‘ì´ë¯€ë¡œ confirm ìŠ¤í‚µ
            if (!projectToUpload && !confirm(`"${project.apartmentName} ${project.dong} ${project.ho}"ë¥¼ Google Driveì— ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            showLoading();

            try {
                // 1. ì•± ë£¨íŠ¸ í´ë” ê°€ì ¸ì˜¤ê¸°/ìƒì„±
                const appFolderId = await getOrCreateAppFolder();
                
                // 2. í”„ë¡œì íŠ¸ í´ë” ìƒì„±
                const projectName = `${project.inspectionDate}_${project.apartmentName}_${project.dong}_${project.ho}`;
                const projectFolderId = await createProjectFolder(appFolderId, projectName);
                
                // 3. í•˜ìì‚¬ì§„ í´ë” ìƒì„±
                const photosFolderId = await createPhotosFolder(projectFolderId);
                
                // 4. ì‚¬ì§„ ì—…ë¡œë“œ (ì°ì€ ìˆœì„œëŒ€ë¡œ 1.jpg, 2.jpg...)
                let photoIndex = 1;
                const totalPhotos = project.defects.reduce((sum, defect) => {
                    if (!defect.photos) return sum;
                    return sum + defect.photos.filter(p => p !== null).length;
                }, 0);
                
                for (const defect of project.defects) {
                    if (defect.photos && defect.photos.length > 0) {
                        for (const photo of defect.photos) {
                            if (photo !== null) {
                                await uploadPhoto(photosFolderId, photo, `${photoIndex}.jpg`);
                                photoIndex++;
                            }
                        }
                    }
                }
                
                // 5. í•˜ì ë¦¬ìŠ¤íŠ¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
                await createDefectSpreadsheet(projectFolderId, projectName, project.defects);
                
                // 6. í”„ë¡œì íŠ¸ ì •ë³´ JSON ì—…ë¡œë“œ
                await uploadProjectInfo(projectFolderId, project);
                
                // 7. í”„ë¡œì íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
                project.isUploaded = true;
                project.uploadedAt = new Date().toISOString();
                project.driveFolderId = projectFolderId;
                
                // 8. ë¡œì»¬ ì €ì¥
                saveProjectsToLocalStorage();
                renderProjectList();
                
                hideLoading();
                showToast(`âœ… ì—…ë¡œë“œ ì™„ë£Œ! (ì‚¬ì§„ ${totalPhotos}ì¥)`);
                
                // ë™ê¸°í™” ì¤‘ì´ ì•„ë‹ ë•Œë§Œ alert í‘œì‹œ
                if (!projectToUpload) {
                    alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n\ní”„ë¡œì íŠ¸: ${projectName}\nì‚¬ì§„: ${totalPhotos}ì¥\ní•˜ì: ${project.defects.length}ê°œ\n\nGoogle Driveì—ì„œ í™•ì¸í•˜ì„¸ìš”!`);
                }
                
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
            }
        }

        // ==================== Drive ë¶ˆëŸ¬ì˜¤ê¸° (ì‚­ì œ ì˜ˆì •) ====================


        window.loadFromDrive = async function() {
            if (!accessToken) {
                alert('ë¨¼ì € Google ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                return;
            }

            if (!projectData.apartmentName || !projectData.dong || !projectData.ho) {
                alert('ë¶ˆëŸ¬ì˜¬ í”„ë¡œì íŠ¸ ì •ë³´(ì•„íŒŒíŠ¸ëª…, ë™, í˜¸)ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();
                const fileName = `${projectData.apartmentName}_${projectData.dong}ë™_${projectData.ho}í˜¸.json`;

                // íŒŒì¼ ê²€ìƒ‰
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (!response.result.files || response.result.files.length === 0) {
                    hideLoading();
                    alert('í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                const fileId = response.result.files[0].id;

                // íŒŒì¼ ë‚´ìš© ë‹¤ìš´ë¡œë“œ
                const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!fileResponse.ok) {
                    throw new Error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await fileResponse.json();

                // í˜„ì¬ í”„ë¡œì íŠ¸ì— ë°ì´í„° ë¡œë“œ
                const project = getCurrentProject();
                project.apartmentName = data.apartmentName || '';
                project.dong = data.dong || '';
                project.ho = data.ho || '';
                project.inspectionDate = data.inspectionDate || '';
                project.customerName = data.customerName || '';
                project.customerPhone = data.customerPhone || '';
                project.author = data.author || ''; // âœ… ì‘ì„±ì ì¶”ê°€
                project.floorplan = data.floorplan || null;
                project.defects = data.defects || [];
                project.equipment = data.equipment || [];
                project.airQuality = data.airQuality || [];

                // ID ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                if (project.defects.length > 0) {
                    defectIdCounter = Math.max(...project.defects.map(d => d.id)) + 1;
                }
                if (project.equipment && project.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...project.equipment.map(e => e.id)) + 1;
                }
                if (project.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...project.airQuality.map(a => a.id)) + 1;
                }

                // UI ì—…ë°ì´íŠ¸
                renderAll();
                saveProjectsToLocalStorage();

                hideLoading();
                showToast('âœ… Driveì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Drive ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ==================== Drive í”„ë¡œì íŠ¸ ëª©ë¡ ====================
        window.showDriveProjects = async function() {
            if (!accessToken) {
                alert('ë¨¼ì € Google ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                return;
            }

            showLoading();

            try {
                const folderId = await getOrCreateAppFolder();

                // í´ë” ë‚´ ëª¨ë“  JSON íŒŒì¼ ê²€ìƒ‰
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and mimeType='application/json' and trashed=false`,
                    fields: 'files(id, name, modifiedTime)',
                    orderBy: 'modifiedTime desc',
                    spaces: 'drive'
                });

                const files = response.result.files || [];

                hideLoading();

                if (files.length === 0) {
                    alert('ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                // ëª¨ë‹¬ì— ëª©ë¡ í‘œì‹œ
                const listContainer = document.getElementById('driveProjectsList');
                listContainer.innerHTML = files.map(file => `
                    <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" 
                         onclick="loadDriveProjectById('${file.id}')"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'"
                         onmouseout="this.style.background='var(--card-bg)'">
                        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“„ ${file.name.replace('.json', '')}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ë§ˆì§€ë§‰ ìˆ˜ì •: ${new Date(file.modifiedTime).toLocaleString('ko-KR')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('driveProjectsModal').style.display = 'block';
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        window.loadDriveProjectById = async function(fileId) {
            showLoading();
            closeDriveProjectsModal();

            try {
                // íŒŒì¼ ë‚´ìš© ë‹¤ìš´ë¡œë“œ
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();

                // í˜„ì¬ í”„ë¡œì íŠ¸ì— ë°ì´í„° ë¡œë“œ
                const project = getCurrentProject();
                project.apartmentName = data.apartmentName || '';
                project.dong = data.dong || '';
                project.ho = data.ho || '';
                project.inspectionDate = data.inspectionDate || '';
                project.customerName = data.customerName || '';
                project.customerPhone = data.customerPhone || '';
                project.author = data.author || ''; // âœ… ì‘ì„±ì ì¶”ê°€
                project.floorplan = data.floorplan || null;
                project.defects = data.defects || [];
                project.equipment = data.equipment || [];
                project.airQuality = data.airQuality || [];

                // ID ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                if (project.defects.length > 0) {
                    defectIdCounter = Math.max(...project.defects.map(d => d.id)) + 1;
                }
                if (project.equipment && project.equipment.length > 0) {
                    equipmentIdCounter = Math.max(...project.equipment.map(e => e.id)) + 1;
                }
                if (project.airQuality.length > 0) {
                    airQualityIdCounter = Math.max(...project.airQuality.map(a => a.id)) + 1;
                }

                // UI ì—…ë°ì´íŠ¸
                renderAll();
                saveProjectsToLocalStorage();

                hideLoading();
                showToast('âœ… í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        window.closeDriveProjectsModal = function() {
            document.getElementById('driveProjectsModal').style.display = 'none';
        }

        // ==================== í”„ë¡œì íŠ¸ ëª©ë¡ ê´€ë¦¬ í•¨ìˆ˜ ====================
        
        // í”„ë¡œì íŠ¸ ëª©ë¡ ë Œë”ë§
        async function renderProjectList() {
            const isActive = await checkAccountStatus();
            if (!isActive) return;
            
            const listContainer = document.getElementById('projectList');
            
            if (projects.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ í”„ë¡œì íŠ¸"ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                return;
            }

            listContainer.innerHTML = projects.map((project, index) => {
                const isActive = project.id === currentProjectId;
                const projectName = project.apartmentName && project.dong && project.ho 
                    ? `${project.apartmentName} ${project.dong} ${project.ho}`
                    : `í”„ë¡œì íŠ¸ ${index + 1} (ì •ë³´ ë¯¸ì…ë ¥)`;
                
                const uploadStatus = project.isUploaded 
                    ? '<span style="color: #10b981;">âœ… ì—…ë¡œë“œ ì™„ë£Œ</span>' 
                    : '<span style="color: #fbbf24;">â³ ì‘ì—…ì¤‘</span>';
                
                const authorInfo = project.author 
                    ? `ì‘ì„±ì: ${project.author} | ` 
                    : ''; // âœ… ì‘ì„±ì ì •ë³´ ì¶”ê°€

                return `
                    <div onclick="switchProject(${project.id})" 
                         style="background: ${isActive ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)'}; 
                                padding: 12px; 
                                border-radius: 6px; 
                                margin-bottom: 8px; 
                                cursor: pointer;
                                border: ${isActive ? '2px solid white' : '2px solid transparent'};
                                transition: all 0.3s;"
                         onmouseover="if(!${isActive}) this.style.background='rgba(255,255,255,0.2)'"
                         onmouseout="if(!${isActive}) this.style.background='rgba(255,255,255,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${isActive ? 'â–¶ ' : ''}${projectName}
                                </div>
                                <div style="font-size: 11px; opacity: 0.8;">
                                    ${authorInfo}í•˜ì: ${project.defects.length}ê°œ | 
                                    ì¥ë¹„: ${project.equipment ? project.equipment.length : 0}ê°œ | 
                                    ê³µê¸°ì§ˆ: ${project.airQuality.length}ê°œ
                                </div>
                            </div>
                            <div style="font-size: 12px;">
                                ${uploadStatus}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€
        window.addNewProject = async function() {
            const isActive = await checkAccountStatus();
            if (!isActive) return;
            
            const newProject = createNewProject();
            projects.push(newProject);
            currentProjectId = newProject.id;
            
            console.log('â• ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±:', {
                newProjectId: newProject.id,
                totalProjects: projects.length,
                hasFloorplan: !!newProject.floorplan
            });
            
            // UI ìƒˆë¡œê³ ì¹¨
            renderProjectList();
            loadProjectToUI();
            updateProgress();
            
            showToast('âœ¨ ìƒˆ í”„ë¡œì íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
            saveProjectsToLocalStorage();
        }

        // í”„ë¡œì íŠ¸ ì „í™˜
        window.switchProject = function(projectId) {
            if (projectId === currentProjectId) return;
            
            console.log('ğŸ”„ í”„ë¡œì íŠ¸ ì „í™˜:', {
                from: currentProjectId,
                to: projectId
            });
            
            // í˜„ì¬ í”„ë¡œì íŠ¸ UI ë°ì´í„° ì €ì¥
            saveCurrentProjectFromUI();
            
            // í”„ë¡œì íŠ¸ ì „í™˜ (Proxyê°€ ìë™ìœ¼ë¡œ ìƒˆ í”„ë¡œì íŠ¸ ì°¸ì¡°)
            currentProjectId = projectId;
            
            console.log('ğŸ“‚ ì „í™˜ í›„ í”„ë¡œì íŠ¸:', {
                id: projectId,
                hasFloorplan: !!getCurrentProject().floorplan
            });
            
            // ìƒˆ í”„ë¡œì íŠ¸ UI ë¡œë“œ
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('ğŸ“‚ í”„ë¡œì íŠ¸ê°€ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
            saveProjectsToLocalStorage();
        }

        // í˜„ì¬ í”„ë¡œì íŠ¸ ì‚­ì œ
        window.deleteCurrentProject = function() {
            if (projects.length <= 1) {
                alert('âŒ ë§ˆì§€ë§‰ í”„ë¡œì íŠ¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            const project = getCurrentProject();
            const projectName = project.apartmentName && project.dong && project.ho 
                ? `${project.apartmentName} ${project.dong} ${project.ho}`
                : 'í˜„ì¬ í”„ë¡œì íŠ¸';

            if (!confirm(`"${projectName}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            // í”„ë¡œì íŠ¸ ì‚­ì œ
            projects = projects.filter(p => p.id !== currentProjectId);
            
            // ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ë¡œ ì „í™˜
            currentProjectId = projects[0].id;
            
            // UI ì—…ë°ì´íŠ¸
            loadProjectToUI();
            renderProjectList();
            updateProgress();
            
            showToast('ğŸ—‘ï¸ í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
            saveProjectsToLocalStorage();
        }

        // UIì—ì„œ í˜„ì¬ í”„ë¡œì íŠ¸ë¡œ ë°ì´í„° ì €ì¥
        function saveCurrentProjectFromUI() {
            const project = getCurrentProject();
            
            project.apartmentName = document.getElementById('apartmentName').value;
            project.dong = document.getElementById('dong').value;
            project.ho = document.getElementById('ho').value;
            project.inspectionDate = document.getElementById('inspectionDate').value;
            project.customerName = document.getElementById('customerName').value;
            project.customerPhone = document.getElementById('customerPhone').value;
            project.author = document.getElementById('author').value; // âœ… ì‘ì„±ì ì €ì¥
            
            // floorplan, defects, equipment, airQualityëŠ” ì´ë¯¸ projectData ì°¸ì¡°ë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¨
        }

        // í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ UIì— ë¡œë“œ
        function loadProjectToUI() {
            const project = getCurrentProject();
            
            document.getElementById('apartmentName').value = project.apartmentName || '';
            document.getElementById('dong').value = project.dong || '';
            document.getElementById('ho').value = project.ho || '';
            document.getElementById('inspectionDate').value = project.inspectionDate || '';
            document.getElementById('customerName').value = project.customerName || '';
            document.getElementById('customerPhone').value = project.customerPhone || '';
            document.getElementById('author').value = project.author || ''; // âœ… ì‘ì„±ì ë¡œë“œ
            
            // í‰ë©´ë„ í‘œì‹œ - displayFloorplan() í•¨ìˆ˜ ì‚¬ìš©
            displayFloorplan();
            
            // í•˜ì, ì¥ë¹„, ê³µê¸°ì§ˆ ëª©ë¡ ë Œë”ë§
            renderDefects();
            renderEquipment();
            renderAirQuality();
        }

        // ==================== ìë™ ì €ì¥ ìµœì í™” ====================
        let saveTimer = null;
        let isSaving = false;
        
        // Debounced ì €ì¥ (í…ìŠ¤íŠ¸ ì…ë ¥ ë“± ë¹ˆë²ˆí•œ ë³€ê²½ìš©)
        function saveWithDebounce(delay = 1000) {
            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            
            // ìƒˆ íƒ€ì´ë¨¸ ì„¤ì •
            saveTimer = setTimeout(() => {
                saveProjectsToLocalStorage();
                saveTimer = null;
            }, delay);
        }
        
        // ì¦‰ì‹œ ì €ì¥ (ì¤‘ìš”í•œ ì‘ì—…ìš©)
        function saveImmediately() {
            // Debounce íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (saveTimer) {
                clearTimeout(saveTimer);
                saveTimer = null;
            }
            
            // ì¦‰ì‹œ ì €ì¥
            saveProjectsToLocalStorage();
        }
        
        // í˜ì´ì§€ ì¢…ë£Œì‹œ pending ì €ì¥ ì²˜ë¦¬
        window.addEventListener('beforeunload', (e) => {
            if (saveTimer) {
                // pending ì €ì¥ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰
                clearTimeout(saveTimer);
                saveTimer = null;
                
                // ë™ê¸°ì ìœ¼ë¡œ ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì— ì„ì‹œ ì €ì¥
                try {
                    const backupData = {
                        projects: projects,
                        currentProjectId: currentProjectId,
                        timestamp: new Date().toISOString()
                    };
                    sessionStorage.setItem('thehomein_temp_backup', JSON.stringify(backupData));
                    console.log('ğŸ“¦ ì¢…ë£Œ ì „ ì„ì‹œ ë°±ì—… ì™„ë£Œ');
                } catch (error) {
                    console.error('ì„ì‹œ ë°±ì—… ì‹¤íŒ¨:', error);
                }
            }
        });
        
        // í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜ ìˆ˜ì •)
        async function saveProjectsToLocalStorage() {
            // ì¤‘ë³µ ì €ì¥ ë°©ì§€
            if (isSaving) {
                console.log('â³ ì €ì¥ ì¤‘... ê±´ë„ˆëœ€');
                return;
            }
            
            isSaving = true;
            
            try {
                console.log('ğŸ’¾ ì €ì¥ ì‹œì‘:', {
                    totalProjects: projects.length,
                    currentProjectId: currentProjectId,
                    projects: projects.map(p => ({
                        id: p.id,
                        name: `${p.apartmentName} ${p.dong} ${p.ho}`.trim() || '(ì´ë¦„ì—†ìŒ)',
                        hasFloorplan: !!p.floorplan,
                        floorplanSize: p.floorplan ? p.floorplan.length : 0
                    }))
                });
                
                // í”„ë¡œì íŠ¸ ëª©ë¡ ì €ì¥
                await saveToIndexedDB('projects_list', { projects, currentProjectId });
                
                // âœ… í˜„ì¬ ì‘ì—… ì¤‘ì¸ í”„ë¡œì íŠ¸ë„ ë³„ë„ë¡œ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë³µêµ¬ìš©)
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    await saveToIndexedDB('thehomein_current', currentProject);
                    console.log('âœ… í˜„ì¬ í”„ë¡œì íŠ¸ ì €ì¥ ì™„ë£Œ');
                }
                
                console.log('âœ… í”„ë¡œì íŠ¸ ëª©ë¡ ì €ì¥ ì™„ë£Œ');
            } catch (e) {
                console.error('í”„ë¡œì íŠ¸ ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
                
                // âœ… ì‚¬ìš©ì ì•Œë¦¼ ì¶”ê°€
                if (e.name === 'QuotaExceededError') {
                    // ì €ì¥ ê³µê°„ ë¶€ì¡±
                    showToast('âš ï¸ ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ë¶ˆí•„ìš”í•œ ì‚¬ì§„ì„ ì‚­ì œí•´ì£¼ì„¸ìš”', 'error');
                    
                    // ê³µê°„ ì‚¬ìš©ëŸ‰ ì²´í¬ (ê°€ëŠ¥í•œ ê²½ìš°)
                    if (navigator.storage && navigator.storage.estimate) {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = Math.round(estimate.usage / 1024 / 1024);
                        const quotaMB = Math.round(estimate.quota / 1024 / 1024);
                        console.log(`ğŸ“Š ì €ì¥ê³µê°„: ${usedMB}MB / ${quotaMB}MB ì‚¬ìš© ì¤‘`);
                    }
                } else if (e.name === 'InvalidStateError' || e.name === 'TransactionInactiveError') {
                    // íŠ¸ëœì­ì…˜ ì˜¤ë¥˜
                    showToast('âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤', 'warning');
                    
                    // 1ì´ˆ í›„ ì¬ì‹œë„
                    setTimeout(async () => {
                        try {
                            await saveToIndexedDB('projects_list', { projects, currentProjectId });
                            showToast('âœ… ì¬ì‹œë„ ì„±ê³µ! ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        } catch (retryError) {
                            showToast('âŒ ì €ì¥ ì‹¤íŒ¨! ì•±ì„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”', 'error');
                        }
                    }, 1000);
                } else {
                    // ê¸°íƒ€ ì˜¤ë¥˜
                    showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨! ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'error');
                }
                
                // ì„ì‹œ ë°±ì—… (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€)
                try {
                    const backupData = {
                        projects: projects,
                        currentProjectId: currentProjectId,
                        timestamp: new Date().toISOString()
                    };
                    sessionStorage.setItem('thehomein_temp_backup', JSON.stringify(backupData));
                    console.log('ğŸ“¦ ì„ì‹œ ë°±ì—… ì™„ë£Œ (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€)');
                } catch (backupError) {
                    console.error('ì„ì‹œ ë°±ì—…ë„ ì‹¤íŒ¨:', backupError);
                }
            } finally {
                isSaving = false;
            }
        }

        // í”„ë¡œì íŠ¸ ëª©ë¡ì„ IndexedDBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadProjectsFromLocalStorage() {
            try {
                const saved = await loadFromIndexedDB('projects_list');
                
                if (saved && saved.projects) {
                    projects = saved.projects;
                    currentProjectId = saved.currentProjectId;
                    
                    console.log('âœ… í”„ë¡œì íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', projects.length + 'ê°œ');
                    
                    // âœ… í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ë°ì´í„°ë¥¼ UIì— ë°˜ì˜
                    const currentProject = getCurrentProject();
                    if (currentProject) {
                        document.getElementById('apartmentName').value = currentProject.apartmentName || '';
                        document.getElementById('dong').value = currentProject.dong || '';
                        document.getElementById('ho').value = currentProject.ho || '';
                        document.getElementById('inspectionDate').value = currentProject.inspectionDate || '';
                        document.getElementById('customerName').value = currentProject.customerName || '';
                        document.getElementById('customerPhone').value = currentProject.customerPhone || '';
                        document.getElementById('author').value = currentProject.author || '';
                        
                        // âœ… ID ì¹´ìš´í„° ì´ˆê¸°í™” ì œê±° (ì´ì œ í”„ë¡œì íŠ¸ë³„ë¡œ ê´€ë¦¬ë¨)
                        // ê¸°ì¡´ ì½”ë“œ ì œê±°ë¨ - í”„ë¡œì íŠ¸ë³„ lastDefectId, lastEquipmentId, lastAirQualityId ì‚¬ìš©
                        
                        // ë Œë”ë§
                        displayFloorplan();
                        renderDefects();
                        renderEquipment();
                        renderAirQuality();
                    }
                } else {
                    // âœ… IndexedDB ì‹¤íŒ¨ ì‹œ ì„ì‹œ ë°±ì—… í™•ì¸
                    const tempBackup = sessionStorage.getItem('thehomein_temp_backup');
                    if (tempBackup) {
                        try {
                            const backupData = JSON.parse(tempBackup);
                            projects = backupData.projects;
                            currentProjectId = backupData.currentProjectId;
                            
                            console.log('ğŸ“¦ ì„ì‹œ ë°±ì—…ì—ì„œ ë³µêµ¬:', projects.length + 'ê°œ');
                            showToast('ğŸ“¦ ì„ì‹œ ë°±ì—…ì—ì„œ ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤', 'info');
                            
                            // ë³µêµ¬ í›„ ë‹¤ì‹œ ì €ì¥ ì‹œë„
                            saveProjectsToLocalStorage();
                        } catch (backupError) {
                    