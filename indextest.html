<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë”í™ˆì ê²€ - í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <meta name="google" content="notranslate">
    <meta name="theme-color" content="#10b981">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #10b981; --primary-dark: #059669; --secondary: #fbbf24; --danger: #ef4444; --bg-dark: #1a202c; --card-bg: rgba(30, 41, 59, 0.5); --border: rgba(255, 255, 255, 0.1); --text-primary: #f1f5f9; --text-secondary: #94a3b8; }
        body.light-mode { --bg-dark: #f3f4f6; --card-bg: rgba(255, 255, 255, 0.9); --border: rgba(0, 0, 0, 0.1); --text-primary: #1f2937; --text-secondary: #6b7280; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-primary); min-height: 100vh; padding: 0; overflow-x: hidden; }
        body.light-mode { background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; transition: width 0.3s ease; }
        .tabs { display: flex; background: var(--card-bg); border-radius: 12px; padding: 5px; margin: 20px -20px; gap: 5px; overflow-x: auto; position: sticky; top: 0; z-index: 99; backdrop-filter: blur(10px); }
        .tab { flex: 1; padding: 12px 20px; border: none; background: transparent; color: var(--text-secondary); border-radius: 8px; font-weight: bold; white-space: nowrap; cursor: pointer; }
        .tab.active { background: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .form-field { margin-bottom: 20px; }
        .form-label { display: block; color: var(--primary); font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-input { width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 16px; }
        body.light-mode .form-input { background: rgba(255,255,255,0.9); border: 1px solid #d1d5db; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-secondary { background: rgba(251,191,36,0.1); border: 2px solid var(--secondary); color: var(--secondary); }
        .btn-danger { background: rgba(239,68,68,0.1); border: 2px solid var(--danger); color: var(--danger); }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-overlay.hidden { display: none; }
        .login-box { background: var(--card-bg); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 2px solid var(--border); background: rgba(0,0,0,0.3); color: white; }
        
        /* ì¹´ë©”ë¼ ë° ê¸°íƒ€ */
        .camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; }
        .camera-modal.active { display: flex; }
        #cameraPreview { width: 100%; height: 100%; object-fit: contain; }
        .camera-controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .camera-btn { width: 80px; height: 80px; border-radius: 50%; background: white; border: 4px solid #ccc; cursor: pointer; }
        .close-camera { background: #ef4444; color: white; width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; }
        
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; color: white; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(16, 185, 129, 0.9); color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; }
        
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; }
        .logout-btn { position: absolute; top: 20px; left: 20px; background: rgba(239,68,68,0.2); border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 12px; display: none; }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h1 style="color: var(--primary); margin-bottom: 20px;">ğŸ  ë”í™ˆì ê²€</h1>
            <input type="text" id="accessCodeInput" class="login-input" placeholder="ì´ë¦„ (ì˜ˆ: ë°•ì§€í˜„)">
            <input type="password" id="pinInput" class="login-input" placeholder="PIN (4ìë¦¬)" maxlength="4">
            <button class="btn btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div class="header">
        <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">ğŸŒ™</button>
        <h1>ğŸ  ë”í™ˆì ê²€</h1>
        <p>í•˜ìê´€ë¦¬ ì‹œìŠ¤í…œ v6.1 (ìµœì¢… ì™„ë£Œ)</p>
        <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('project', event)">ğŸ“ í”„ë¡œì íŠ¸</button>
            <button class="tab" onclick="switchTab('defects', event)">ğŸ” í•˜ìì ê²€</button>
            <button class="tab" onclick="switchTab('equipment', event)">ğŸ“¸ ì¥ë¹„ì ê²€</button>
            <button class="tab" onclick="switchTab('airquality', event)">ğŸŒ¬ï¸ ê³µê¸°ì§ˆ</button>
            <button class="tab" onclick="switchTab('data', event)">ğŸ’¾ ë°ì´í„°</button>
        </div>

        <div id="project" class="section active">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í”„ë¡œì íŠ¸ ì •ë³´</h2>
                <div class="form-field"><label class="form-label">ì•„íŒŒíŠ¸ëª…</label><input type="text" class="form-input" id="apartmentName" oninput="autoSave()"></div>
                <div class="grid-2">
                    <div class="form-field"><label class="form-label">ë™</label><input type="text" class="form-input" id="dong" oninput="autoSave()"></div>
                    <div class="form-field"><label class="form-label">í˜¸ìˆ˜</label><input type="text" class="form-input" id="ho" oninput="autoSave()"></div>
                </div>
                <div class="form-field"><label class="form-label">ì ê²€ì¼ì</label><input type="date" class="form-input" id="inspectionDate" oninput="autoSave()"></div>
                <div class="form-field"><label class="form-label">ê³ ê°ëª…</label><input type="text" class="form-input" id="customerName" oninput="autoSave()"></div>
            </div>
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“ í‰ë©´ë„</h2>
                <div style="text-align: center;">
                    <img id="floorplanPreview" style="max-width: 100%; display: none; border-radius: 8px; margin-bottom: 10px;">
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="openFloorplanCamera()">ğŸ“· ì´¬ì˜</button>
                        <button class="btn btn-secondary" onclick="openFloorplanGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="defects" class="section">
            <div id="defectsList"></div>
            <button class="btn btn-primary" onclick="addDefect()" style="margin-top: 20px;">â• í•˜ì ì¶”ê°€</button>
        </div>

        <div id="equipment" class="section">
            <div id="equipmentList"></div>
            <button class="btn btn-secondary" onclick="addEquipment()" style="margin-top: 20px;">â• ì¥ë¹„ì ê²€ ì¶”ê°€</button>
        </div>

        <div id="airquality" class="section">
            <div id="airQualityList"></div>
            <button class="btn btn-primary" onclick="addAirQualityRoom()" style="margin-top: 20px;">â• ì¸¡ì • ê³µê°„ ì¶”ê°€</button>
        </div>

        <div id="data" class="section">
            <div class="card">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ’¾ ë³´ê³ ì„œ ìƒì„±</h2>
                <button class="btn btn-primary" onclick="generatePDF()">ğŸ“„ í†µí•© ë³´ê³ ì„œ (í•˜ì+ì¥ë¹„+ê³µê¸°+ê°€ì´ë“œ)</button>
                <div style="height: 15px;"></div>
                <button class="btn btn-secondary" onclick="generateEquipmentOnlyPDF()">ğŸ”§ ì¥ë¹„ì ê²€ ë¦¬í¬íŠ¸ (ë³„ë„)</button>
                <div style="height: 15px;"></div>
                <button class="btn btn-danger" onclick="resetProject()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div id="cameraModal" class="camera-modal">
        <video id="cameraPreview" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="close-camera" onclick="closeCameraModal()">âœ•</button>
            <button class="camera-btn" onclick="capturePhoto()"></button>
        </div>
    </div>

    <div id="loading" class="loading"><div class="spinner"></div><p>ì²˜ë¦¬ ì¤‘...</p></div>
    <div id="toast" class="toast"></div>

    <script>
        // ==================== ë°ì´í„° & ì„¤ì • ====================
        const projectData = {
            apartmentName: '', dong: '', ho: '', inspectionDate: '', customerName: '',
            floorplan: null, defects: [], equipment: [], airQuality: []
        };

        const R_THEME = {
            primary: "#10b981",
            equipment: "#2c3e50",
            dark: "#1f2937",
            light: "#6b7280",
            border: "#e5e7eb",
            bg: "#f9fafb",
            contact: "ë¬¸ì˜: 070-8019-1456 / 010-9985-0128"
        };

        // ==================== ë¡œê·¸ì¸ ë¡œì§ ====================
        const FIXED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4Tz0-NgXyWR36c9hkZ4ko0ll4g-oj5YGHZysuH0c1Mngr4Ev9-VgiryTHHcMd2Zq5NuOmOI6dMZeh/pub?output=csv';
        
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            if(localStorage.getItem('dhLoginData')) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutBtn').style.display = 'block';
            }
            if(!document.getElementById('inspectionDate').value) {
                document.getElementById('inspectionDate').valueAsDate = new Date();
            }
            updateProgress();
        });

        async function handleLogin() {
            const code = document.getElementById('accessCodeInput').value.trim();
            const pin = document.getElementById('pinInput').value.trim();
            
            try {
                const response = await fetch(FIXED_CSV_URL);
                const text = await response.text();
                const lines = text.split('\n');
                let valid = false;
                
                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    if(cols[0] === code && cols[3] === 'í™œì„±' && cols[4] === pin) {
                        valid = true; break;
                    }
                }
                
                if(valid) {
                    localStorage.setItem('dhLoginData', JSON.stringify({code, pin}));
                    document.getElementById('loginOverlay').classList.add('hidden');
                    document.getElementById('logoutBtn').style.display = 'block';
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ');
                } else {
                    alert('ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }
            } catch(e) {
                // ì˜¤í”„ë¼ì¸ ë¡œê·¸ì¸ ì§€ì›
                if(localStorage.getItem('dhLoginData')) {
                    document.getElementById('loginOverlay').classList.add('hidden');
                } else {
                    alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                }
            }
        }

        function handleLogout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('dhLoginData');
                location.reload();
            }
        }

        // ==================== ê¸°ë³¸ ê¸°ëŠ¥ ====================
        function switchTab(id, e) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(e) e.target.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function autoSave() {
            projectData.apartmentName = document.getElementById('apartmentName').value;
            projectData.dong = document.getElementById('dong').value;
            projectData.ho = document.getElementById('ho').value;
            projectData.inspectionDate = document.getElementById('inspectionDate').value;
            projectData.customerName = document.getElementById('customerName').value;
            localStorage.setItem('thehomein_data', JSON.stringify(projectData));
            updateProgress();
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('thehomein_data');
            if(data) {
                const parsed = JSON.parse(data);
                Object.assign(projectData, parsed);
                document.getElementById('apartmentName').value = projectData.apartmentName;
                document.getElementById('dong').value = projectData.dong;
                document.getElementById('ho').value = projectData.ho;
                document.getElementById('inspectionDate').value = projectData.inspectionDate;
                document.getElementById('customerName').value = projectData.customerName;
                if(projectData.floorplan) {
                    document.getElementById('floorplanPreview').src = projectData.floorplan;
                    document.getElementById('floorplanPreview').style.display = 'block';
                }
                renderDefects();
                renderEquipment();
                renderAirQuality();
            }
        }

        function updateProgress() {
            const filled = [projectData.apartmentName, projectData.dong].filter(x=>x).length;
            const total = Math.min(100, (filled * 10) + (projectData.defects.length * 5));
            document.getElementById('progressBar').style.width = total + '%';
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            document.getElementById('themeToggle').textContent = document.body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }

        // ==================== ê¸°ëŠ¥ êµ¬í˜„ ====================
        // 1. í•˜ì
        function addDefect() {
            projectData.defects.push({ id: Date.now(), spaces: [], locations: [], types: [], description: '', photos: [] });
            renderDefects(); autoSave();
        }
        function renderDefects() {
            const list = document.getElementById('defectsList');
            list.innerHTML = projectData.defects.map((d, i) => `
                <div class="card">
                    <div style="display:flex;justify-content:space-between;"><strong>í•˜ì #${i+1}</strong><button onclick="removeDefect(${i})">ğŸ—‘ï¸</button></div>
                    <div class="form-field"><input class="form-input" placeholder="ê³µê°„" value="${d.spaces.join(',')}" oninput="updateDefect(${i}, 'spaces', this.value)"></div>
                    <div class="form-field"><input class="form-input" placeholder="ìœ„ì¹˜" value="${d.locations.join(',')}" oninput="updateDefect(${i}, 'locations', this.value)"></div>
                    <div class="form-field"><input class="form-input" placeholder="ë‚´ìš©" value="${d.types.join(',')}" oninput="updateDefect(${i}, 'types', this.value)"></div>
                    <div class="form-field"><input class="form-input" placeholder="ì„¤ëª…" value="${d.description}" oninput="updateDefect(${i}, 'description', this.value)"></div>
                    <button class="btn btn-primary" onclick="openCamera('defect', ${i})">ğŸ“· ì‚¬ì§„ (${d.photos.length})</button>
                </div>
            `).join('');
        }
        function updateDefect(idx, field, val) {
            projectData.defects[idx][field] = field === 'description' ? val : val.split(',');
            autoSave();
        }
        function removeDefect(idx) { projectData.defects.splice(idx, 1); renderDefects(); autoSave(); }

        // 2. ì¥ë¹„
        function addEquipment() {
            projectData.equipment.push({ id: Date.now(), spaces: [], inspection: 'ì´ìƒì—†ìŒ', photos: {} });
            renderEquipment(); autoSave();
        }
        function renderEquipment() {
            const list = document.getElementById('equipmentList');
            list.innerHTML = projectData.equipment.map((e, i) => `
                <div class="card">
                    <div style="display:flex;justify-content:space-between;"><strong>ì¥ë¹„ #${i+1}</strong><button onclick="removeEquip(${i})">ğŸ—‘ï¸</button></div>
                    <div class="form-field"><input class="form-input" placeholder="ê³µê°„" value="${e.spaces.join(',')}" oninput="updateEquip(${i}, 'spaces', this.value)"></div>
                    <div class="form-field"><input class="form-input" value="${e.inspection}" oninput="updateEquip(${i}, 'inspection', this.value)"></div>
                    <div class="grid-2">
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ì¢Œì¸¡')">ì¢Œì¸¡</button>
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ìš°ì¸¡')">ìš°ì¸¡</button>
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ë°”ë‹¥1')">ë°”ë‹¥1</button>
                        <button class="btn btn-secondary" onclick="openCamera('equip', ${i}, 'ë°”ë‹¥2')">ë°”ë‹¥2</button>
                    </div>
                </div>
            `).join('');
        }
        function updateEquip(idx, field, val) {
            projectData.equipment[idx][field] = field === 'spaces' ? val.split(',') : val;
            autoSave();
        }
        function removeEquip(idx) { projectData.equipment.splice(idx, 1); renderEquipment(); autoSave(); }

        // 3. ê³µê¸°ì§ˆ
        function addAirQualityRoom() {
            projectData.airQuality.push({ id: Date.now(), name: 'ê³µê°„', radon: '', formaldehyde: '', vocs: '' });
            renderAirQuality(); autoSave();
        }
        function renderAirQuality() {
            const list = document.getElementById('airQualityList');
            list.innerHTML = projectData.airQuality.map((r, i) => `
                <div class="card">
                    <div style="display:flex;justify-content:space-between;">
                        <input class="form-input" style="width:60%" value="${r.name}" oninput="updateAir(${i}, 'name', this.value)">
                        <button onclick="removeAir(${i})">ğŸ—‘ï¸</button>
                    </div>
                    <div class="grid-2" style="margin-top:10px;">
                        <input type="number" class="form-input" placeholder="ë¼ëˆ" value="${r.radon}" oninput="updateAir(${i}, 'radon', this.value)">
                        <input type="number" class="form-input" placeholder="í¬ë¦„" value="${r.formaldehyde}" oninput="updateAir(${i}, 'formaldehyde', this.value)">
                        <input type="number" class="form-input" placeholder="VOCs" value="${r.vocs}" oninput="updateAir(${i}, 'vocs', this.value)">
                    </div>
                </div>
            `).join('');
        }
        function updateAir(idx, field, val) { projectData.airQuality[idx][field] = val; autoSave(); }
        function removeAir(idx) { projectData.airQuality.splice(idx, 1); renderAirQuality(); autoSave(); }

        // ==================== ì¹´ë©”ë¼ ====================
        let currentPhotoTarget = null;
        function openCamera(type, idx, subType) {
            currentPhotoTarget = { type, idx, subType };
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    document.getElementById('cameraPreview').srcObject = stream;
                    document.getElementById('cameraModal').classList.add('active');
                });
        }
        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const img = canvas.toDataURL('image/jpeg', 0.8);
            
            if(currentPhotoTarget.type === 'defect') projectData.defects[currentPhotoTarget.idx].photos.push(img);
            else if(currentPhotoTarget.type === 'equip') {
                if(!projectData.equipment[currentPhotoTarget.idx].photos) projectData.equipment[currentPhotoTarget.idx].photos = {};
                projectData.equipment[currentPhotoTarget.idx].photos[currentPhotoTarget.subType] = img;
            }
            else if(currentPhotoTarget.type === 'floorplan') {
                projectData.floorplan = img;
                document.getElementById('floorplanPreview').src = img;
                document.getElementById('floorplanPreview').style.display = 'block';
            }
            closeCameraModal(); autoSave();
        }
        function closeCameraModal() {
            const video = document.getElementById('cameraPreview');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('cameraModal').classList.remove('active');
        }
        function openFloorplanCamera() { currentPhotoTarget = { type: 'floorplan' }; openCamera(); }
        function openFloorplanGallery() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = evt => {
                    projectData.floorplan = evt.target.result;
                    document.getElementById('floorplanPreview').src = evt.target.result;
                    document.getElementById('floorplanPreview').style.display = 'block';
                    autoSave();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }
        function resetProject() {
            if(confirm('ì´ˆê¸°í™”?')) { localStorage.removeItem('thehomein_data'); location.reload(); }
        }

        // ==================== PDF ìƒì„± ë¡œì§ ====================
        function getPremiumLogo() {
            return `<div style="display:flex;align-items:center;gap:10px;"><svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 40 L50 10 L90 40" stroke="#10b981" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 32 V80 H40" stroke="#0ea5e9" stroke-width="8"/><path d="M80 32 V80 H60" stroke="#f43f5e" stroke-width="8"/><path d="M40 80 V60 C40 50 60 50 60 60 V80" stroke="#a855f7" stroke-width="8"/></svg><div style="font-family:'Malgun Gothic',sans-serif;font-weight:900;font-size:26px;color:#111827;">ë”í™ˆì ê²€</div></div>`;
        }

        function getGuideHeader(title, color) {
            return `<div style="display:flex;align-items:center;margin-bottom:30px;border-bottom:3px solid ${color};padding-bottom:15px;"><div><div style="font-size:12px;color:${color};font-weight:800;">THE HOME GUIDE</div><div style="font-size:22px;font-weight:900;color:#1f2937;">${title}</div></div></div>`;
        }

        window.generatePDF = async function() {
            if(!projectData.apartmentName) return alert('í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥ í•„ìš”');
            document.getElementById('loading').classList.add('active');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const W=210, H=297;

                // 1. í‘œì§€
                await addPage(doc, createSummaryPage(), W, H);
                
                // 2. í•˜ì ë¦¬ìŠ¤íŠ¸
                for(let i=12; i<projectData.defects.length; i+=18) {
                    doc.addPage(); await addPage(doc, createDefectListPage(i), W, H);
                }

                // 3. í•˜ì ì‚¬ì§„
                const defectsWithPhotos = projectData.defects.filter(d => d.photos.length > 0);
                for(let i=0; i<defectsWithPhotos.length; i+=3) {
                    doc.addPage(); await addPage(doc, await createDefectDetailPage(defectsWithPhotos.slice(i, i+3), i), W, H);
                }

                // 4. ì¥ë¹„ ì ê²€ (2ê°œì”©, 2x2 ê²©ì - ì´ˆì•ˆ ìŠ¤íƒ€ì¼)
                const equips = projectData.equipment.filter(e => Object.values(e.photos||{}).some(p=>p));
                equips.forEach((e, i) => e._idx = i+1);
                for(let i=0; i<equips.length; i+=2) {
                    doc.addPage(); await addPage(doc, createEquipmentPage(equips.slice(i, i+2)), W, H);
                }

                // 5. ê³µê¸°ì§ˆ
                if(projectData.airQuality.some(r => r.radon)) {
                    doc.addPage(); await addPage(doc, createAirQualityPage(), W, H);
                }

                // 6. ê°€ì´ë“œë¶
                doc.addPage(); await addPage(doc, createGuide1(), W, H);
                doc.addPage(); await addPage(doc, createGuide2(), W, H);
                doc.addPage(); await addPage(doc, createGuide3(), W, H);

                doc.save(`ë”í™ˆì ê²€_${projectData.apartmentName}.pdf`);
            } catch(e) { alert(e.message); }
            document.getElementById('loading').classList.remove('active');
        }

        // ì¥ë¹„ì ê²€ ë³„ë„ ì¶œë ¥ (ìˆ˜ì •ë¨: í†µí•©ê³¼ ë™ì¼í•˜ê²Œ 2ê°œì”© ì¶œë ¥)
        window.generateEquipmentOnlyPDF = async function() {
            if(!projectData.apartmentName) return alert('í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥ í•„ìš”');
            document.getElementById('loading').classList.add('active');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const W=210, H=297;
                
                const equips = projectData.equipment.filter(e => Object.values(e.photos||{}).some(p=>p));
                if(equips.length === 0) throw new Error("ì¶œë ¥í•  ì¥ë¹„ì ê²€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

                equips.forEach((e, i) => e._idx = i+1); // ìˆœë²ˆ í• ë‹¹

                // í†µí•©ë³¸ê³¼ ë™ì¼í•˜ê²Œ 2ê°œì”© ë£¨í”„
                for(let i=0; i<equips.length; i+=2) {
                    if(i > 0) doc.addPage();
                    await addPage(doc, createEquipmentPage(equips.slice(i, i+2)), W, H);
                }
                doc.save(`ì¥ë¹„ì ê²€_${projectData.apartmentName}.pdf`);
            } catch(e) { alert(e.message); }
            document.getElementById('loading').classList.remove('active');
        }

        async function addPage(doc, html, w, h) {
            const div = document.createElement('div');
            div.style.width='794px'; div.style.position='absolute'; div.style.left='-9999px'; div.innerHTML=html;
            document.body.appendChild(div);
            const canvas = await html2canvas(div, {scale:2, useCORS:true});
            document.body.removeChild(div);
            doc.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, w, h);
        }

        async function addWatermark(url, text) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width=img.width; c.height=img.height;
                    const ctx = c.getContext('2d');
                    ctx.drawImage(img,0,0);
                    ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(10,10,300,50);
                    ctx.fillStyle='white'; ctx.font='30px Arial'; ctx.fillText(text, 20, 45);
                    resolve(c.toDataURL('image/jpeg'));
                };
                img.src = url;
            });
        }

        // === HTML ìƒì„± í•¨ìˆ˜ë“¤ ===
        function createSummaryPage() {
            let rows = '';
            projectData.defects.slice(0, 12).forEach((d, i) => {
                rows += `<tr style="border-bottom:1px solid #e5e7eb"><td style="padding:9px;text-align:center;font-weight:800;color:#10b981;border-right:1px solid #e5e7eb;">${i+1}</td><td style="padding:9px;text-align:center;font-weight:700;border-right:1px solid #e5e7eb;">${(d.spaces||[]).join(',')}</td><td style="padding:9px;text-align:center;border-right:1px solid #e5e7eb;">${(d.locations||[]).join(',')}</td><td style="padding:9px;text-align:center;border-right:1px solid #e5e7eb;">${(d.types||[]).join(',')}</td><td style="padding:9px;">${d.description}</td></tr>`;
            });
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;"><div style="border-bottom:2px solid #10b981;padding-bottom:20px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:flex-end;">${getPremiumLogo()}<div style="font-size:28px;font-weight:900;">ì‚¬ì „ì ê²€ ê²°ê³¼ë³´ê³ ì„œ</div></div><div style="display:flex;gap:20px;margin-bottom:30px;height:280px;"><div style="flex:1;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:20px;"><h3 style="margin:0 0 15px 0;color:#10b981;">PROJECT INFO</h3><p><b>ì•„íŒŒíŠ¸:</b> ${projectData.apartmentName}</p><p><b>í˜¸ìˆ˜:</b> ${projectData.dong}ë™ ${projectData.ho}í˜¸</p><p><b>ì ê²€ì¼:</b> ${projectData.inspectionDate}</p><p><b>ê³ ê°ëª…:</b> ${projectData.customerName}</p><p><b>ì´ í•˜ì:</b> <span style="color:red">${projectData.defects.length}ê±´</span></p></div><div style="flex:1.4;border:1px solid #e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;">${projectData.floorplan?`<img src="${projectData.floorplan}" style="max-width:95%;max-height:95%;object-fit:contain;">`:'í‰ë©´ë„ ì—†ìŒ'}</div></div><table style="width:100%;border-collapse:collapse;font-size:11px;border:1px solid #e5e7eb;"><thead><tr style="background:#f9fafb;"><th style="padding:10px;">NO</th><th style="padding:10px;">ê³µê°„</th><th style="padding:10px;">ìœ„ì¹˜</th><th style="padding:10px;">ìœ í˜•</th><th style="padding:10px;">ë‚´ìš©</th></tr></thead><tbody>${rows}</tbody></table><div style="position:absolute;bottom:40px;width:100%;text-align:center;color:#999;font-size:11px;">${R_THEME.contact}</div></div>`;
        }

        function createDefectListPage(start) {
            let rows = '';
            projectData.defects.slice(start, start+18).forEach((d, i) => {
                rows += `<tr style="border-bottom:1px solid #e5e7eb"><td style="padding:11px;text-align:center;font-weight:800;color:#10b981;border-right:1px solid #e5e7eb;">${start+i+1}</td><td style="padding:11px;text-align:center;font-weight:700;border-right:1px solid #e5e7eb;">${(d.spaces||[]).join(',')}</td><td style="padding:11px;text-align:center;border-right:1px solid #e5e7eb;">${(d.locations||[]).join(',')}</td><td style="padding:11px;text-align:center;border-right:1px solid #e5e7eb;">${(d.types||[]).join(',')}</td><td style="padding:11px;">${d.description}</td></tr>`;
            });
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;"><div style="border-bottom:2px solid #f9fafb;padding-bottom:15px;margin-bottom:25px;display:flex;justify-content:space-between;"><h3>í•˜ì ì ê²€ ë‚´ì—­ ìƒì„¸</h3><div>${projectData.apartmentName}</div></div><table style="width:100%;border-collapse:collapse;font-size:12px;border:1px solid #e5e7eb;"><thead><tr style="background:#f9fafb;"><th style="padding:10px;">NO</th><th style="padding:10px;">ê³µê°„</th><th style="padding:10px;">ìœ„ì¹˜</th><th style="padding:10px;">ìœ í˜•</th><th style="padding:10px;">ë‚´ìš©</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        async function createDefectDetailPage(defects, start) {
            let html = '';
            for(let i=0; i<defects.length; i++) {
                const d = defects[i];
                const idx = start + i + 1;
                const mark = `${projectData.dong}ë™${projectData.ho}í˜¸_${idx}`;
                const p1 = d.photos[0] ? await addWatermark(d.photos[0], mark) : '';
                const p2 = d.photos[1] ? await addWatermark(d.photos[1], mark+'-1') : '';
                html += `<div style="margin-bottom:25px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;"><div style="padding:10px;background:#f9fafb;border-bottom:1px solid #e5e7eb;font-weight:bold;"><span style="color:white;background:#10b981;padding:2px 8px;border-radius:10px;margin-right:10px;">#${idx}</span>${(d.spaces||[]).join(',')} | ${d.description}</div><div style="display:flex;gap:2px;padding:2px;"><div style="flex:1;height:210px;background:white;display:flex;justify-content:center;">${p1?`<img src="${p1}" style="height:100%;object-fit:contain;">`:'No Photo'}</div><div style="flex:1;height:210px;background:white;display:flex;justify-content:center;">${p2?`<img src="${p2}" style="height:100%;object-fit:contain;">`:'No Photo'}</div></div></div>`;
            }
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;"><div style="border-bottom:2px solid #10b981;margin-bottom:30px;"><h3>í•˜ì ìƒì„¸ ë¦¬í¬íŠ¸ (ì‚¬ì§„)</h3></div>${html}</div>`;
        }

        // ì¥ë¹„ì ê²€ (2ê°œ/í˜ì´ì§€, 2x2 ê²©ì - ì´ˆì•ˆ ìŠ¤íƒ€ì¼)
        function createEquipmentPage(items) {
            let html = '';
            items.forEach(item => {
                const locs = ['ì¢Œì¸¡','ìš°ì¸¡','ë°”ë‹¥1','ë°”ë‹¥2'];
                const cols = ['#3498db','#e74c3c','#f39c12','#f39c12'];
                let grid = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">`;
                locs.forEach((l, i) => {
                    const p = item.photos ? item.photos[l] : null;
                    grid += `<div style="border:1px solid #eee;border-radius:4px;"><div style="background:${cols[i]}15;color:${cols[i]};text-align:center;padding:4px;font-size:11px;font-weight:bold;">${l}</div><div style="height:140px;display:flex;align-items:center;justify-content:center;">${p?`<img src="${p}" style="height:100%;object-fit:contain;">`:'<span style="color:#ccc;font-size:11px;">ë¯¸ì´¬ì˜</span>'}</div></div>`;
                });
                grid += `</div>`;
                html += `<div style="margin-bottom:30px;border:2px solid ${R_THEME.equipment};border-radius:8px;overflow:hidden;"><div style="background:${R_THEME.equipment};color:white;padding:8px 15px;display:flex;justify-content:space-between;"><span style="font-weight:bold;">#${String(item._idx).padStart(2,'0')} ${(item.spaces||[]).join(',')}</span><span style="font-size:12px;">ì¥ë¹„ì ê²€</span></div><div style="padding:10px;background:#f8fafc;border-bottom:1px solid #eee;">ê²°ê³¼: ${item.inspection}</div><div style="padding:10px;">${grid}</div></div>`;
            });
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;"><div style="border-bottom:2px solid ${R_THEME.equipment};margin-bottom:30px;"><h3>ì¥ë¹„ ì ê²€ ë¦¬í¬íŠ¸</h3></div>${html}</div>`;
        }

        // ê³µê¸°ì§ˆ
        function createAirQualityPage() {
            let rows = '';
            const valid = projectData.airQuality.filter(r => r.radon || r.formaldehyde || r.vocs);
            valid.forEach(r => {
                rows += `<tr style="border-bottom:1px solid #eee"><td style="padding:12px;background:#f9fafb;font-weight:bold;text-align:center;">${r.name}</td><td style="padding:12px;text-align:center;">${r.radon}</td><td style="padding:12px;text-align:center;">${r.formaldehyde}</td><td style="padding:12px;text-align:center;">${r.vocs}</td></tr>`;
            });
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;">${getGuideHeader('ì‹¤ë‚´ ê³µê¸°ì§ˆ ì¸¡ì • ê²°ê³¼', '#0ea5e9')}<table style="width:100%;border-collapse:collapse;border:1px solid #ddd;"><thead><tr style="background:#0f172a;color:white;"><th style="padding:12px;">ê³µê°„</th><th>ë¼ëˆ(Bq/mÂ³)</th><th>í¬ë¦„ì•Œë°íˆë“œ</th><th>ì´VOCs</th></tr></thead><tbody>${rows}</tbody></table><div style="margin-top:20px;padding:15px;background:#f0f9ff;border-radius:8px;"><strong>âš–ï¸ ê¶Œê³ ê¸°ì¤€:</strong> ë¼ëˆ 148ì´í•˜, í¬ë¦„ 0.21ì´í•˜, VOCs 0.5ì´í•˜</div></div>`;
        }

        // ê°€ì´ë“œë¶
        function createGuide1() {
            return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;">${getGuideHeader('í•˜ìë³´ìˆ˜ ì²­êµ¬ ê°€ì´ë“œ', '#ef4444')}<div style="display:flex;gap:20px;margin-bottom:40px;"><div style="flex:1;background:#fef2f2;padding:20px;border-radius:12px;"><h4>1. ê¸°ë¡</h4><p>ì‚¬ì§„ ì´¬ì˜ í•„ìˆ˜</p></div><div style="flex:1;background:#fff7ed;padding:20px;border-radius:12px;"><h4>2. ì ‘ìˆ˜</h4><p>ê´€ë¦¬ì‚¬ë¬´ì†Œ ì ‘ìˆ˜</p></div><div style="flex:1;background:#f0fdf4;padding:20px;border-radius:12px;"><h4>3. í™•ì¸</h4><p>ë³´ìˆ˜ í›„ í™•ì¸</p></div></div></div>`;
        }
        function createGuide2() { return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;">${getGuideHeader('ì‹¤ë‚´ ê³µê¸°ì§ˆ ê´€ë¦¬', '#10b981')}<h3>ë² ì´í¬ì•„ì›ƒ</h3><p>ë‚œë°©ìœ¼ë¡œ ìœ í•´ë¬¼ì§ˆ ë°°ì¶œ</p><h3>í™˜ê¸°</h3><p>í•˜ë£¨ 3íšŒ 30ë¶„ ì´ìƒ</p></div>`; }
        function createGuide3() { return `<div style="width:794px;height:1123px;background:white;padding:40px;font-family:'Malgun Gothic',sans-serif;">${getGuideHeader('ê²°ë¡œ ì˜ˆë°© ê°€ì´ë“œ', '#3b82f6')}<h3>ì˜ˆë°©ìˆ˜ì¹™</h3><ul><li>í™˜ê¸° ìì£¼ í•˜ê¸°</li><li>ê°€êµ¬ ë²½ì—ì„œ ë„ìš°ê¸°</li><li>ë¹¨ë˜ ì‹¤ë‚´ê±´ì¡° ìì œ</li></ul></div>`; }

    </script>
</body>
</html>