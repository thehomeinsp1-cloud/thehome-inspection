<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A1628">
    <meta name="google" content="notranslate">
    <title>뷰파인더 | 스마트 셀프 홈체크</title>
    
    <!-- Pretendard 폰트 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    
    <!-- jsPDF + html2canvas for PDF 생성 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            /* 민트 그린 다크 테마 */
            --primary: #0A1628;
            --primary-light: #1A2940;
            --accent: #00D4AA;
            --accent-light: #00E4BA;
            --accent-glow: rgba(0, 212, 170, 0.2);
            --warning: #FF6B6B;
            --success: #00D4AA;
            --text: #FFFFFF;
            --text-muted: #8892A0;
            --card-bg: rgba(26, 41, 64, 0.8);
            --card-border: rgba(0, 212, 170, 0.15);
            --overlay: rgba(10, 22, 40, 0.95);
            
            /* 사이즈 */
            --header-height: 56px;
            --nav-height: 64px;
            --radius: 12px;
            --radius-sm: 8px;
        }

        /* 라이트 모드 */
        :root.light-mode {
            --primary: #F0F4F8;
            --primary-light: #FFFFFF;
            --accent: #00B894;
            --accent-light: #00D4AA;
            --accent-glow: rgba(0, 184, 148, 0.15);
            --text: #1A202C;
            --text-muted: #718096;
            --card-bg: #FFFFFF;
            --card-border: rgba(0, 184, 148, 0.2);
            --overlay: rgba(240, 244, 248, 0.95);
        }

        :root.light-mode .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        :root.light-mode .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== 배경 효과 ==================== */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: -1;
        }

        /* ==================== 헤더 ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(10, 22, 40, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #00FFD4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-divider {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 300;
        }

        .logo-slogan {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tier-badge {
            padding: 6px 12px;
            background: var(--card-bg);
            border: 1px solid var(--accent);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-icon {
            font-size: 18px;
        }

        /* ==================== 메인 컨텐츠 ==================== */
        .main-content {
            padding-top: calc(var(--header-height) + 20px);
            padding-bottom: calc(var(--nav-height) + 30px);
            padding-left: 20px;
            padding-right: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ==================== 섹션 ==================== */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
        }

        .progress-percent {
            color: var(--accent);
            font-weight: 700;
        }

        .progress-bar {
            height: 8px;
            background: var(--primary-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00FFD4);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-card:active {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ==================== 가격표 섹션 ==================== */
        .pricing-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 24px;
        }

        .pricing-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .pricing-title {
            display: block;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .pricing-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .pricing-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .pricing-card {
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 14px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .pricing-card:active {
            transform: scale(0.98);
        }

        .pricing-card.current {
            border-color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
            cursor: default;
        }

        .pricing-card.popular {
            border-color: #FFB800;
            background: rgba(255, 184, 0, 0.1);
        }

        .pricing-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
        }

        .pricing-card.current .pricing-badge {
            background: var(--accent);
            color: var(--primary);
        }

        .pricing-card.popular .pricing-badge {
            background: #FFB800;
            color: var(--primary);
        }

        .pricing-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            margin-top: 4px;
        }

        .pricing-card.current .pricing-name {
            color: var(--accent);
        }

        .pricing-card.popular .pricing-name {
            color: #FFB800;
        }

        .pricing-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
        }

        .pricing-price span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .pricing-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .pricing-extra {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--card-border);
            font-size: 10px;
            color: var(--accent);
            font-weight: 500;
        }

        .pricing-contact {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding-top: 12px;
            border-top: 1px solid var(--card-border);
        }

        .pricing-contact a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        /* 애드온 섹션 */
        .addon-section {
            margin-top: 16px;
            padding: 14px;
            background: rgba(0, 212, 170, 0.08);
            border: 1px dashed var(--accent);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .addon-section:active {
            transform: scale(0.98);
            background: rgba(0, 212, 170, 0.15);
        }

        .addon-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .addon-badge {
            padding: 2px 6px;
            background: var(--accent);
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            color: var(--primary);
        }

        .addon-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .addon-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .addon-prices {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .addon-price {
            padding: 4px 8px;
            background: var(--primary-light);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .addon-price b {
            color: var(--accent);
            font-weight: 700;
        }

        /* ==================== 단계별 가이드 ==================== */
        .step-guide {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .step-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .step-guide-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .step-guide-hint {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            animation: pulse-hint 2s infinite;
        }

        @keyframes pulse-hint {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(0, 212, 170, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0); }
        }

        .step-cards {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-card {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 10px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step-card.current {
            background: rgba(0, 212, 170, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .step-card.completed {
            background: rgba(0, 212, 170, 0.1);
            border-color: var(--accent);
        }

        .step-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-card:active:not(.locked) {
            transform: scale(0.98);
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-card.locked .step-number {
            background: var(--text-muted);
        }

        .step-card.completed .step-number {
            background: var(--accent);
        }

        .step-content {
            flex: 1;
            min-width: 0;
        }

        .step-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        .step-status {
            font-size: 10px;
            color: var(--text-muted);
        }

        .step-card.current .step-status {
            color: var(--accent);
            font-weight: 600;
        }

        .step-card.completed .step-status {
            color: var(--accent);
        }

        .step-arrow {
            color: var(--text-muted);
            font-size: 12px;
            flex-shrink: 0;
        }

        /* STEP 배지 */
        .step-badge {
            background: var(--accent);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-right: 4px;
        }

        .step-badge.yellow {
            background: #FFB800;
            position: absolute;
            top: -8px;
            left: 12px;
        }

        .start-inspection-btn {
            position: relative;
        }

        /* ==================== 프로젝트 정보 카드 ==================== */
        .project-info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
        }

        .project-info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .project-info-icon {
            font-size: 18px;
        }

        .project-info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .project-info-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .project-input {
            padding: 12px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .project-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .project-input::placeholder {
            color: var(--text-muted);
        }

        .project-input::placeholder {
            color: var(--text-muted);
        }

        .project-input.full {
            width: 100%;
        }

        .project-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .project-input-row .project-input {
            width: 100%;
            box-sizing: border-box;
        }

        /* ==================== 체크리스트 (참고용) ==================== */
        .checklist-spaces {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checklist-space-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checklist-space-card:active {
            transform: scale(0.98);
        }

        .checklist-space-info {
            flex: 1;
        }

        .checklist-space-name {
            font-size: 15px;
            font-weight: 600;
        }

        .checklist-space-arrow {
            color: var(--text-muted);
            font-size: 18px;
        }

        .checklist-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checklist-detail-header h2 {
            flex: 1;
            font-size: 20px;
            font-weight: 700;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 참고용 체크리스트 스타일 */
        .checklist-reference-section {
            margin-bottom: 24px;
        }

        .checklist-position-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(0, 212, 170, 0.1);
            border-radius: 6px;
        }

        .checklist-reference-item {
            font-size: 13px;
            color: var(--text);
            line-height: 1.7;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        /* ==================== 하자점검 시작 버튼 ==================== */
        .start-inspection-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .start-inspection-btn:active {
            transform: scale(0.98);
        }

        .start-inspection-icon {
            font-size: 32px;
        }

        .start-inspection-content {
            flex: 1;
        }

        .start-inspection-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .start-inspection-desc {
            font-size: 13px;
            color: rgba(10, 22, 40, 0.7);
        }

        .start-inspection-arrow {
            font-size: 24px;
            color: var(--primary);
            font-weight: 700;
        }

        /* ==================== 점검 헤더 ==================== */
        .inspection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .inspection-count {
            padding: 8px 16px;
            background: var(--accent);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        /* ==================== 하자 기록 섹션 ==================== */
        .defect-list {
            margin-bottom: 24px;
        }

        .defect-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .defect-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .defect-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 12px;
            position: relative;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-right: 36px;
        }

        .defect-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            margin-right: 8px;
        }

        .defect-location {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .defect-type {
            padding: 4px 8px;
            background: rgba(255, 184, 0, 0.2);
            color: #FFB800;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .defect-photos {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .defect-photo {
            width: 70px;
            height: 70px;
            background: var(--primary-light);
            border-radius: 8px;
            object-fit: cover;
        }

        .defect-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .defect-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 107, 107, 0.15);
            border: none;
            border-radius: 8px;
            color: var(--warning);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .defect-delete-btn:active {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(0.95);
        }

        .add-defect-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .add-defect-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* ==================== 하단 네비게이션 ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            opacity: 1;
        }

        .nav-item.active .nav-icon {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* ==================== 하자 등록 전체 화면 ==================== */
        .defect-register-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .defect-register-screen.active {
            display: flex;
        }

        .defect-register-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid var(--card-border);
        }

        .defect-register-title {
            font-size: 18px;
            font-weight: 700;
        }

        .defect-register-close {
            width: 36px;
            height: 36px;
            background: var(--card-bg);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
        }

        .defect-register-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px;
        }

        .defect-register-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: rgba(10, 22, 40, 0.98);
            border-top: 1px solid var(--card-border);
            z-index: 1001;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ==================== 폼 요소 ==================== */
        .form-section {
            margin-bottom: 24px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .form-label-icon {
            font-size: 18px;
        }

        .form-sublabel {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: auto;
        }

        /* ==================== 사진 촬영 영역 ==================== */
        .photo-capture-area {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .photo-capture-box {
            flex: 1;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .photo-capture-box.far {
            border-color: var(--accent);
        }

        .photo-capture-box.near {
            border-color: #FFB800;
        }

        .photo-capture-box.has-photo {
            border-style: solid;
        }

        .photo-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-empty:active {
            transform: scale(0.98);
            background: rgba(0,0,0,0.05);
        }

        .photo-buttons {
            display: flex;
            border-top: 1px dashed var(--card-border);
        }

        .photo-capture-box.far .photo-buttons {
            border-color: var(--accent);
        }

        .photo-capture-box.near .photo-buttons {
            border-color: #FFB800;
        }

        .photo-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            background: var(--primary-light);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-btn:first-child {
            border-right: 1px solid var(--card-border);
        }

        .photo-capture-box.far .photo-btn.primary {
            background: var(--accent);
            color: var(--primary);
        }

        .photo-capture-box.near .photo-btn.primary {
            background: #FFB800;
            color: var(--primary);
        }

        .photo-btn:active {
            opacity: 0.8;
        }

        /* 사진 있을 때 버튼 */
        .photo-actions {
            display: flex;
            border-top: 1px solid var(--card-border);
        }

        .photo-action-btn {
            flex: 1;
            padding: 10px 6px;
            border: none;
            background: var(--primary-light);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid var(--card-border);
        }

        .photo-action-btn:last-child {
            border-right: none;
        }

        .photo-action-btn.delete {
            background: rgba(255, 100, 100, 0.2);
            color: #FF6B6B;
        }

        .photo-action-btn:active {
            opacity: 0.8;
        }

        /* ==================== 심플 사진 박스 (퀵모드 스타일) ==================== */
        .photo-capture-area-simple {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .photo-box-simple {
            flex: 1;
            aspect-ratio: 4/3;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .photo-box-simple:active {
            transform: scale(0.98);
        }

        .photo-box-simple.far {
            border-color: var(--accent);
        }

        .photo-box-simple.near {
            border-color: #FFB800;
        }

        .photo-box-simple.has-photo {
            border-style: solid;
        }

        .photo-box-simple.has-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .photo-box-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .photo-box-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .photo-box-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .photo-box-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .photo-box-simple.near .photo-box-badge {
            background: #FFB800;
        }

        .photo-box-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(255, 107, 107, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .gallery-buttons {
            display: flex;
            gap: 10px;
        }

        .gallery-btn {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .gallery-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .photo-image-wrapper {
            position: relative;
            flex: 1;
            min-height: 140px;
            overflow: hidden;
        }

        .photo-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-capture-box.has-photo.far {
            border-color: var(--accent);
        }

        .photo-capture-box.has-photo.near {
            border-color: #FFB800;
        }

        .photo-capture-icon {
            font-size: 28px;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        .photo-capture-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .photo-capture-sublabel {
            font-size: 10px;
            color: var(--text-muted);
        }

        .photo-capture-box.far .photo-capture-label {
            color: var(--accent);
        }

        .photo-capture-box.near .photo-capture-label {
            color: #FFB800;
        }

        .photo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        .photo-badge.far {
            background: rgba(0, 212, 170, 0.95);
            color: white;
        }

        .photo-badge.near {
            background: rgba(255, 184, 0, 0.95);
            color: white;
        }

        /* ==================== 터치 버튼 그리드 ==================== */
        .touch-btn-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .touch-btn {
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .touch-btn:active {
            transform: scale(0.95);
        }

        .touch-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
            font-weight: 700;
        }

        .touch-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 커스텀 공간 (삭제 가능) */
        .touch-btn.custom {
            position: relative;
            padding-right: 28px;
        }

        .touch-btn.custom .delete-custom {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            background: rgba(255, 107, 107, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 11px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .touch-btn.custom.selected .delete-custom {
            background: rgba(0, 0, 0, 0.3);
        }

        /* 공간 추가 버튼 */
        .add-space-btn {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            background: transparent;
            border: 1px dashed var(--card-border);
            border-radius: var(--radius);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-space-btn:active {
            background: var(--card-bg);
            border-color: var(--accent);
            color: var(--accent);
        }

        .selected-count {
            font-size: 12px;
            color: var(--accent);
            margin-left: auto;
        }

        /* ==================== 음성 입력 영역 ==================== */
        .voice-input-area {
            position: relative;
        }

        .voice-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            padding-right: 60px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
        }

        .voice-textarea::placeholder {
            color: var(--text-muted);
        }

        .voice-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .voice-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--primary-light);
            border-radius: 6px;
        }

        /* ==================== 저장 버튼 ==================== */
        .save-defect-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .save-defect-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .save-defect-btn:disabled {
            background: var(--card-bg);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ==================== 카메라 모달 ==================== */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-preview-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 카메라 가이드 제거됨 */

        .camera-guide-text {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .camera-guide-text.far {
            background: var(--accent);
            color: var(--primary);
        }

        .camera-guide-text.near {
            background: #FFB800;
            color: var(--primary);
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 30px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            background: rgba(0, 0, 0, 0.8);
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s ease;
        }

        .camera-btn:active {
            transform: scale(0.9);
        }

        .camera-btn.capture {
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
        }

        .camera-btn.close {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
        }

        .camera-btn.gallery {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
            font-size: 22px;
        }

        .camera-bottom-hint {
            display: flex;
            justify-content: center;
            gap: 80px;
            padding-bottom: 10px;
            background: rgba(0, 0, 0, 0.8);
        }

        .camera-bottom-hint span {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        /* 줌 컨트롤 제거됨 */

        /* 마커 캔버스 */
        .marker-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .marker-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 212, 170, 0.9);
            border-radius: 20px;
            color: #0A1628;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .marker-hint.hidden {
            opacity: 0;
        }

        .camera-btn.reset {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
            font-size: 20px;
        }

        /* ==================== 토스트 ==================== */
        .toast {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary-light);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 400;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* ==================== 사진 옵션 액션시트 ==================== */
        .photo-action-sheet {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3000;
            display: none;
        }

        .photo-action-sheet.active {
            display: block;
        }

        .photo-action-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .photo-action-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .photo-action-sheet.active .photo-action-content {
            transform: translateY(0);
        }

        .photo-action-title {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .photo-action-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-light);
            border: none;
            border-radius: var(--radius);
            color: var(--text);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            -webkit-tap-highlight-color: transparent;
        }

        .photo-action-btn:active {
            background: var(--card-border);
        }

        .photo-action-btn.cancel {
            background: transparent;
            color: var(--text-muted);
            margin-bottom: 0;
        }

        /* ==================== 업셀링 카드 ==================== */
        .upsell-card {
            background: linear-gradient(135deg, #1A2D4A, #0A1628);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .upsell-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 0% 0%, var(--accent-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(255, 107, 107, 0.1) 0%, transparent 50%);
        }

        .upsell-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--warning);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
        }

        .upsell-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
        }

        .upsell-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 16px;
            position: relative;
            line-height: 1.6;
        }

        .upsell-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: var(--primary);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
        }

        /* ==================== 리포트 섹션 ==================== */
        .report-project-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .report-project-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .report-project-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .report-project-row:first-child {
            padding-top: 0;
        }

        .report-project-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .report-project-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .report-info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .report-info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .report-info-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .report-input-group label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .report-input-group input {
            padding: 12px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .report-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .report-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .report-summary-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .report-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .report-summary-header span:first-child {
            font-size: 14px;
            color: var(--text-muted);
        }

        .report-summary-count {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
        }

        .report-summary-bar {
            height: 6px;
            background: var(--primary-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .report-summary-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00FFD4);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .report-summary-detail {
            display: flex;
            justify-content: space-around;
        }

        .report-stat {
            text-align: center;
        }

        .report-stat-value {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .report-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .report-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-btn {
            padding: 16px;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .report-btn.primary {
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            color: var(--primary);
        }

        .report-btn.secondary {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .report-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== 로딩 오버레이 ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 500;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--card-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text);
            font-size: 14px;
        }

        /* ==================== 튜토리얼 온보딩 ==================== */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }

        .tutorial-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .tutorial-slides {
            flex: 1;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .tutorial-slides::-webkit-scrollbar {
            display: none;
        }

        .tutorial-slide {
            min-width: 100%;
            scroll-snap-align: start;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
        }

        .tutorial-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .tutorial-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .tutorial-desc {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            max-width: 300px;
        }

        .tutorial-highlight {
            color: var(--accent);
            font-weight: 600;
        }

        .tutorial-image-box {
            width: 200px;
            height: 140px;
            background: var(--primary-light);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .tutorial-image-box .far-label,
        .tutorial-image-box .near-label {
            position: absolute;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .tutorial-image-box .far-label {
            top: 10px;
            left: 10px;
        }

        .tutorial-image-box .near-label {
            bottom: 10px;
            right: 10px;
            background: #FFB800;
        }

        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .tutorial-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
        }

        .tutorial-step-num {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .tutorial-step-text {
            font-size: 14px;
            color: var(--text);
        }

        .tutorial-bottom {
            padding: 20px 30px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .tutorial-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .tutorial-dot.active {
            opacity: 1;
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .tutorial-buttons {
            display: flex;
            gap: 12px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .tutorial-btn.skip {
            background: var(--primary-light);
            color: var(--text-muted);
            border: 1px solid var(--card-border);
        }

        .tutorial-btn.next {
            background: linear-gradient(135deg, var(--accent), #00A080);
            color: var(--primary);
        }

        .tutorial-btn:active {
            transform: scale(0.98);
        }

        .tutorial-tip-box {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 20px;
        }

        .tutorial-tip-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .tutorial-tip-content {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* ==================== 퀵모드 ==================== */
        .quick-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .quick-mode-overlay.active {
            display: flex;
        }

        .quick-mode-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .quick-mode-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .quick-mode-count {
            font-size: 14px;
            color: var(--text-muted);
        }

        .quick-mode-close {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-mode-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .quick-mode-photo-area {
            display: flex;
            gap: 12px;
        }

        .quick-mode-photo-box {
            flex: 1;
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .quick-mode-photo-box.has-photo {
            border-style: solid;
            border-color: var(--accent);
        }

        .quick-mode-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .quick-mode-photo-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-mode-photo-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .quick-mode-photo-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .quick-mode-photo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .quick-mode-photo-box.near .quick-mode-photo-badge {
            background: #FFB800;
        }

        .quick-mode-photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(255, 107, 107, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-mode-memo {
            width: 100%;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
        }

        .quick-mode-memo:focus {
            outline: none;
            border-color: var(--accent);
        }

        .quick-mode-memo::placeholder {
            color: var(--text-muted);
        }

        .quick-mode-space-select {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px;
        }

        .quick-mode-space-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .quick-mode-space-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-mode-space-chip {
            padding: 8px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-mode-space-chip.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .quick-mode-footer {
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--card-border);
            display: flex;
            gap: 12px;
        }

        .quick-mode-btn {
            flex: 1;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-mode-btn.save {
            background: linear-gradient(135deg, var(--accent), #00A080);
            color: var(--primary);
        }

        .quick-mode-btn.save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-mode-btn.continue {
            background: var(--card-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .quick-mode-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* 퀵모드 진입 버튼 */
        .quick-mode-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .quick-mode-entry-btn {
            flex: 1;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-mode-entry-btn.highlight {
            background: linear-gradient(135deg, #FFB800, #FF9500);
            border: none;
            color: #000;
        }

        .quick-mode-entry-btn:active {
            transform: scale(0.98);
        }

        .quick-mode-saved-list {
            margin-top: 16px;
        }

        .quick-mode-saved-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-mode-saved-badge {
            padding: 2px 8px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            border-radius: 10px;
        }

        /* ==================== 설정 메뉴 ==================== */
        .settings-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-sheet {
            background: var(--primary-light);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
        }

        .settings-close {
            width: 32px;
            height: 32px;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-item:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .settings-item.danger {
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .settings-item-icon {
            font-size: 24px;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .settings-item-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .settings-item.danger .settings-item-title {
            color: var(--warning);
        }

        /* ==================== 홈 퀵모드 버튼 ==================== */
        .home-mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .home-mode-btn {
            padding: 20px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: none;
        }

        .home-mode-btn.quick {
            background: linear-gradient(135deg, #FFB800, #FF9500);
            color: #000;
        }

        .home-mode-btn.detail {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .home-mode-btn:active {
            transform: scale(0.98);
        }

        .home-mode-btn-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .home-mode-btn-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .home-mode-btn-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        /* ==================== 빈 상태 개선 ==================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .empty-state-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .empty-state-btn:active {
            transform: scale(0.98);
        }

        /* ==================== 프로젝트 관리 ==================== */
        .project-selector {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-selector:active {
            transform: scale(0.99);
            background: var(--primary-light);
        }

        .project-selector-left {
            flex: 1;
            min-width: 0;
        }

        .project-selector-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .project-selector-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-icon {
            font-size: 18px;
            color: var(--accent);
        }

        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: flex-end;
        }

        .project-modal-overlay.active {
            display: flex;
        }

        .project-modal-sheet {
            background: var(--primary-light);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .project-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .project-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .project-item {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .project-item.active {
            border-color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
        }

        .project-item:active {
            transform: scale(0.98);
        }

        .project-item-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
        }

        .project-item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            padding-right: 60px;
        }

        .project-item-info {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .project-item-stats {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .project-stat {
            padding: 6px 12px;
            background: var(--primary-light);
            border-radius: 6px;
            font-size: 12px;
        }

        .project-stat-value {
            color: var(--accent);
            font-weight: 600;
            margin-right: 4px;
        }

        .project-delete-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 6px 12px;
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 6px;
            color: var(--warning);
            font-size: 12px;
            cursor: pointer;
        }

        .project-delete-btn:active {
            background: rgba(255, 107, 107, 0.3);
        }

        .project-add-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: calc(16px + env(safe-area-inset-bottom));
        }

        .project-add-btn:active {
            transform: scale(0.98);
        }

    </style>
</head>
<body>
    <!-- ==================== 튜토리얼 온보딩 ==================== -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-slides" id="tutorialSlides">
            <!-- 슬라이드 1: 환영 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">🏠</div>
                <h2 class="tutorial-title">뷰파인더에<br>오신 것을 환영합니다</h2>
                <p class="tutorial-desc">
                    신축 아파트 입주 전<br>
                    <span class="tutorial-highlight">셀프 하자점검</span>을 도와드려요
                </p>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">💡 알고 계셨나요?</div>
                    <div class="tutorial-tip-content">
                        입주 지정 기간 내 발견한 하자는<br>
                        시공사에서 무상으로 보수해줍니다
                    </div>
                </div>
            </div>

            <!-- 슬라이드 2: 사용 방법 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">📋</div>
                <h2 class="tutorial-title">간단한 3단계로<br>점검 완료</h2>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">1</span>
                        <span class="tutorial-step-text">아파트 정보 입력</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">2</span>
                        <span class="tutorial-step-text">하자 발견 시 사진 촬영</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">3</span>
                        <span class="tutorial-step-text">PDF 보고서 생성 및 제출</span>
                    </div>
                </div>
            </div>

            <!-- 슬라이드 3: 사진 촬영 팁 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">📸</div>
                <h2 class="tutorial-title">사진은 2장씩<br>촬영해주세요</h2>
                <div class="tutorial-image-box">
                    <span class="far-label">📸 원경</span>
                    <span style="font-size: 40px; opacity: 0.3;">🖼️</span>
                    <span class="near-label">🔍 근경</span>
                </div>
                <p class="tutorial-desc">
                    <span class="tutorial-highlight">원경</span>: 전체 위치가 보이게<br>
                    <span class="tutorial-highlight">근경</span>: 하자 부위 가까이서
                </p>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">💡 마커 기능</div>
                    <div class="tutorial-tip-content">
                        촬영 중 화면을 터치하면<br>
                        하자 위치에 마커가 표시됩니다
                    </div>
                </div>
            </div>

            <!-- 슬라이드 4: 시작 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">🚀</div>
                <h2 class="tutorial-title">준비 완료!</h2>
                <p class="tutorial-desc">
                    이제 <span class="tutorial-highlight">하자점검</span>을 시작해볼까요?<br><br>
                    발견된 하자는 사진과 함께 기록하고<br>
                    PDF 보고서로 제출하세요
                </p>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">🎯 프로 점검 서비스</div>
                    <div class="tutorial-tip-content">
                        직접 점검이 어려우시다면<br>
                        전문가 점검 서비스를 이용해보세요
                    </div>
                </div>
            </div>
        </div>

        <div class="tutorial-bottom">
            <div class="tutorial-dots" id="tutorialDots">
                <div class="tutorial-dot active"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
            </div>
            <div class="tutorial-buttons">
                <button class="tutorial-btn skip" id="tutorialSkip" onclick="closeTutorial()">건너뛰기</button>
                <button class="tutorial-btn next" id="tutorialNext" onclick="nextTutorialSlide()">다음</button>
            </div>
        </div>
    </div>

    <div class="bg-gradient"></div>

    <!-- ==================== 헤더 ==================== -->
    <header class="header">
        <div class="logo">
            <span class="logo-text">뷰파인더 🔍</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="openSettings()">⚙️</button>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                <span class="theme-icon" id="themeIcon">🌙</span>
            </button>
            <span class="tier-badge">셀프</span>
        </div>
    </header>

    <!-- ==================== 메인 컨텐츠 ==================== -->
    <main class="main-content">

        <!-- ==================== 홈 섹션 ==================== -->
        <section class="section active" id="homeSection">

            <!-- 프로젝트 선택기 -->
            <div class="project-selector" onclick="openProjectModal()">
                <div class="project-selector-left">
                    <div class="project-selector-label">현재 프로젝트</div>
                    <div class="project-selector-name" id="currentProjectName">새 프로젝트</div>
                </div>
                <div class="project-selector-icon">📁</div>
            </div>

            <!-- 단계별 가이드 -->
            <div class="step-guide">
                <div class="step-guide-header">
                    <span class="step-guide-title">진행 순서</span>
                    <span class="step-guide-hint" id="stepHint">정보를 입력해주세요</span>
                </div>
                <div class="step-cards">
                    <div class="step-card current" id="step1" onclick="scrollToElement('projectInfoCard')">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">정보 입력</div>
                            <div class="step-status" id="step1Status">시작</div>
                        </div>
                    </div>
                    <div class="step-arrow">―</div>
                    <div class="step-card locked" id="step2" onclick="showSection('defectSection')">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">하자 점검</div>
                            <div class="step-status" id="step2Status">대기</div>
                        </div>
                    </div>
                    <div class="step-arrow">―</div>
                    <div class="step-card locked" id="step3" onclick="showSection('reportSection')">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">리포트</div>
                            <div class="step-status" id="step3Status">대기</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 프로젝트 정보 입력 -->
            <div class="project-info-card" id="projectInfoCard">
                <div class="project-info-header">
                    <span class="project-info-title">점검 정보</span>
                </div>
                <div class="project-info-form">
                    <input type="text" id="apartmentName" class="project-input full" placeholder="아파트명 (예: 래미안 퍼스트하임)" />
                    <div class="project-input-row">
                        <input type="text" id="dongNumber" class="project-input" placeholder="동 (예: 101)" />
                        <input type="text" id="hoNumber" class="project-input" placeholder="호 (예: 1201)" />
                    </div>
                    <input type="date" id="inspectionDate" class="project-input full" />
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-title">발견된 하자</span>
                    <span class="progress-percent" id="defectCountHome">0건</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="totalProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- 점검 모드 선택 버튼 (홈) -->
            <div class="home-mode-buttons">
                <button class="home-mode-btn quick" onclick="openQuickMode()">
                    <div class="home-mode-btn-icon">⚡</div>
                    <div class="home-mode-btn-title">퀵모드</div>
                    <div class="home-mode-btn-desc">빠른 연속 촬영</div>
                </button>
                <button class="home-mode-btn detail" onclick="showSection('defectSection')">
                    <div class="home-mode-btn-icon">📝</div>
                    <div class="home-mode-btn-title">상세입력</div>
                    <div class="home-mode-btn-desc">꼼꼼한 기록</div>
                </button>
            </div>

            <div class="quick-actions">
                <div class="action-card" onclick="showSection('checklistSection')">
                    <div class="action-icon">✅</div>
                    <div class="action-title">체크리스트</div>
                    <div class="action-desc">점검 가이드</div>
                </div>
                <div class="action-card" onclick="showSection('equipmentSection')">
                    <div class="action-icon">🔧</div>
                    <div class="action-title">장비 가이드</div>
                    <div class="action-desc">사용법 안내</div>
                </div>
                <div class="action-card" onclick="showSection('reportSection')">
                    <div class="action-icon">📊</div>
                    <div class="action-title">리포트</div>
                    <div class="action-desc" id="defectCount">0건 발견</div>
                </div>
            </div>

            <!-- 서비스 가격표 -->
            <div class="pricing-section">
                <div class="pricing-header">
                    <span class="pricing-title">서비스 안내</span>
                    <span class="pricing-subtitle">나에게 맞는 점검 서비스를 선택하세요</span>
                </div>
                
                <div class="pricing-cards">
                    <div class="pricing-card current">
                        <div class="pricing-badge">현재 이용중</div>
                        <div class="pricing-name">셀프</div>
                        <div class="pricing-price">3.9<span>만원</span></div>
                        <div class="pricing-desc">PRO키트 대여 (1시간)<br/>앱 이용권 + 결과 리포트</div>
                        <div class="pricing-extra">+1시간 추가 시 1만원</div>
                    </div>
                    
                    <div class="pricing-card" onclick="showUpgradeModal('assist')">
                        <div class="pricing-name">어시스트</div>
                        <div class="pricing-price">6.9<span>만원</span></div>
                        <div class="pricing-desc">셀프 포함<br/>+ 매니저 현장 보조 (1시간)</div>
                    </div>
                    
                    <div class="pricing-card popular" onclick="showUpgradeModal('pro')">
                        <div class="pricing-badge">인기</div>
                        <div class="pricing-name">프로</div>
                        <div class="pricing-price">8.9<span>만원</span></div>
                        <div class="pricing-desc">셀프 포함<br/>+ 건축전문가 동행 (1시간)</div>
                    </div>
                    
                    <div class="pricing-card" onclick="showUpgradeModal('onecare')">
                        <div class="pricing-name">원스톱</div>
                        <div class="pricing-price">견적가</div>
                        <div class="pricing-desc">프로 포함<br/>+ 입주청소/줄눈 패키지</div>
                    </div>
                </div>
                
                <!-- 하자 접수 대행 애드온 -->
                <div class="addon-section" onclick="requestAddon()">
                    <div class="addon-header">
                        <span class="addon-badge">ADD-ON</span>
                        <span class="addon-title">하자 접수 대행</span>
                    </div>
                    <div class="addon-desc">건설사 하자접수 시스템 등록 대행</div>
                    <div class="addon-prices">
                        <span class="addon-price">30건↓ <b>2만</b></span>
                        <span class="addon-price">50건↓ <b>3만</b></span>
                        <span class="addon-price">70건↓ <b>5만</b></span>
                        <span class="addon-price">100건↓ <b>6만</b></span>
                        <span class="addon-price">150건↑ <b>7만</b></span>
                    </div>
                </div>
                
                <div class="pricing-contact">
                    업그레이드 문의 <a href="tel:010-9985-0128">010-9985-0128</a>
                </div>
            </div>
        </section>

        <!-- ==================== 하자점검 섹션 (통합) ==================== -->
        <section class="section" id="defectSection">
            <div class="inspection-header">
                <div>
                    <h2 style="font-size: 20px; font-weight: 700;">하자점검</h2>
                    <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">발견된 하자를 기록하세요</p>
                </div>
                <div class="inspection-count" id="inspectionCount">0건</div>
            </div>

            <!-- 퀵모드 진입 -->
            <div class="quick-mode-entry">
                <button class="quick-mode-entry-btn highlight" onclick="openQuickMode()">
                    ⚡ 퀵모드
                </button>
                <button class="quick-mode-entry-btn" onclick="openDefectRegister()">
                    📝 상세입력
                </button>
            </div>
            
            <div class="defect-list" id="defectList">
                <div class="empty-state">
                    <div class="empty-state-icon">📷</div>
                    <div class="empty-state-title">아직 발견된 하자가 없습니다</div>
                    <div class="empty-state-desc">
                        퀵모드로 빠르게 촬영하거나<br>
                        상세입력으로 꼼꼼히 기록해보세요
                    </div>
                    <button class="empty-state-btn" onclick="openQuickMode()">⚡ 퀵모드 시작</button>
                </div>
            </div>
            
            <button class="add-defect-btn" onclick="openDefectRegister()" ontouchend="openDefectRegister()">
                <span>+</span> 하자 추가
            </button>
        </section>

        <!-- ==================== 체크리스트 섹션 ==================== -->
        <section class="section" id="checklistSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">점검 참고용 체크리스트</h2>
            <p style="font-size: 13px; color: #999; margin-bottom: 20px;">더홈점검에서 제공하는 무료 셀프점검 자료입니다.</p>
            
            <div class="checklist-spaces" id="checklistSpaces">
                <!-- 동적 생성 -->
            </div>
        </section>

        <!-- ==================== 체크리스트 상세 ==================== -->
        <section class="section" id="checklistDetailSection">
            <div class="checklist-detail-header">
                <button class="back-btn" onclick="showSection('checklistSection')">←</button>
                <h2 id="checklistDetailTitle" style="flex: 1;">거실</h2>
            </div>
            
            <div id="checklistItems">
                <!-- 동적 생성 -->
            </div>
        </section>

        <!-- ==================== 장비 가이드 섹션 ==================== -->
        <section class="section" id="equipmentSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">장비 사용 가이드</h2>
            <div id="equipmentList"></div>
        </section>

        <!-- ==================== 리포트 섹션 ==================== -->
        <section class="section" id="reportSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">점검 결과 리포트</h2>
            
            <!-- 하자 없을 때 안내 -->
            <div id="reportEmptyState" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <div class="empty-state-title">등록된 하자가 없습니다</div>
                    <div class="empty-state-desc">
                        하자를 발견하고 사진을 촬영하면<br>
                        PDF 보고서를 생성할 수 있습니다
                    </div>
                    <button class="empty-state-btn" onclick="showSection('defectSection')">🔍 점검 시작하기</button>
                </div>
            </div>
            
            <!-- 하자 있을 때 리포트 내용 -->
            <div id="reportContent">
                <!-- 프로젝트 정보 표시 -->
                <div class="report-project-card">
                    <div class="report-project-row">
                        <span class="report-project-label">아파트</span>
                        <span class="report-project-value" id="reportAptName">-</span>
                    </div>
                    <div class="report-project-row">
                        <span class="report-project-label">동/호수</span>
                        <span class="report-project-value" id="reportDongHo">-</span>
                    </div>
                    <div class="report-project-row">
                        <span class="report-project-label">점검일</span>
                        <span class="report-project-value" id="reportDate">-</span>
                    </div>
                </div>
                
                <!-- 점검 요약 -->
                <div class="report-summary-card">
                    <div class="report-summary-header">
                        <span>발견된 하자</span>
                        <span class="report-summary-count" id="reportDefectCount">0건</span>
                    </div>
                    <div class="report-summary-bar">
                        <div class="report-summary-fill" id="reportProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="report-summary-detail">
                        <div class="report-stat">
                            <span class="report-stat-value" id="reportPhotoCount">0</span>
                            <span class="report-stat-label">촬영 사진</span>
                        </div>
                    </div>
                </div>

                <!-- 보고서 생성 버튼들 -->
                <div class="report-actions">
                    <button class="report-btn primary" onclick="generatePDF()">
                        PDF 보고서 생성
                    </button>
                    <button class="report-btn secondary" onclick="shareReport()">
                        공유하기
                    </button>
                </div>
            </div>
            
            <!-- 업셀링 -->
            <div class="upsell-card" style="margin-top: 24px;">
                <span class="upsell-badge">PRO</span>
                <h3 class="upsell-title">전문가 점검이 필요하신가요?</h3>
                <p class="upsell-desc">숨은 하자까지 전문가가 확인해드립니다</p>
                <button class="upsell-btn" onclick="showUpgradeModal('pro')">프로 점검 신청 →</button>
            </div>
        </section>

    </main>

    <!-- ==================== 하단 네비게이션 ==================== -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showSection('homeSection')" data-section="homeSection">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">홈</span>
        </div>
        <div class="nav-item" onclick="showSection('defectSection')" data-section="defectSection">
            <span class="nav-icon">🔍</span>
            <span class="nav-label">점검</span>
        </div>
        <div class="nav-item" onclick="showSection('reportSection')" data-section="reportSection">
            <span class="nav-icon">📊</span>
            <span class="nav-label">리포트</span>
        </div>
    </nav>

    <!-- ==================== 하자 등록 전체화면 ==================== -->
    <div class="defect-register-screen" id="defectRegisterScreen">
        <div class="defect-register-header">
            <h2 class="defect-register-title">하자 추가</h2>
            <button class="defect-register-close" onclick="closeDefectRegister()">✕</button>
        </div>
        
        <div class="defect-register-body">
            <!-- 사진 촬영 (퀵모드 스타일) -->
            <div class="form-section">
                <div class="form-label">
                    사진 촬영
                    <span class="form-sublabel">필수 2장</span>
                </div>
                <div class="photo-capture-area-simple">
                    <div class="photo-box-simple far" id="photoBoxFar" onclick="openCamera('far')">
                        <span class="photo-box-icon">📸</span>
                        <span class="photo-box-label">원경</span>
                        <span class="photo-box-hint">멀리서 전체</span>
                    </div>
                    <div class="photo-box-simple near" id="photoBoxNear" onclick="openCamera('near')">
                        <span class="photo-box-icon">🔍</span>
                        <span class="photo-box-label">근경</span>
                        <span class="photo-box-hint">가까이서 상세</span>
                    </div>
                </div>
                <!-- 갤러리 버튼 -->
                <div class="gallery-buttons">
                    <button class="gallery-btn" onclick="openGallery('far')">🖼️ 원경 갤러리</button>
                    <button class="gallery-btn" onclick="openGallery('near')">🖼️ 근경 갤러리</button>
                </div>
            </div>

            <!-- 공간 선택 -->
            <div class="form-section">
                <div class="form-label">
                    공간 선택
                    <span class="form-sublabel selected-count" id="spaceCount">0/4 선택</span>
                </div>
                <div class="touch-btn-grid" id="spaceButtons">
                    <!-- 동적 생성 -->
                </div>
                <button class="add-space-btn" onclick="addCustomSpace()">+ 공간 추가</button>
            </div>

            <!-- 하자 내용 -->
            <div class="form-section">
                <div class="form-label">
                    하자 내용
                </div>
                <div class="voice-input-area">
                    <textarea class="voice-textarea" id="defectDescription" placeholder="하자 내용을 입력하세요"></textarea>
                </div>
                <div class="voice-hint">
                    키보드 음성입력 버튼으로 입력할 수 있습니다
                </div>
            </div>
        </div>

        <div class="defect-register-footer">
            <button class="save-defect-btn" id="saveDefectBtn" onclick="saveDefect()" ontouchend="saveDefect()">
                + 하자 추가
            </button>
        </div>
    </div>

    <!-- ==================== 퀵모드 오버레이 ==================== -->
    <div class="quick-mode-overlay" id="quickModeOverlay">
        <div class="quick-mode-header">
            <div>
                <div class="quick-mode-title">⚡ 퀵모드</div>
                <div class="quick-mode-count" id="quickModeCount">저장: 0건</div>
            </div>
            <button class="quick-mode-close" onclick="closeQuickMode()">✕</button>
        </div>
        
        <div class="quick-mode-body">
            <div class="quick-mode-photo-area">
                <div class="quick-mode-photo-box far" id="quickPhotoFar" onclick="openQuickCamera('far')">
                    <span class="quick-mode-photo-icon">📸</span>
                    <span class="quick-mode-photo-label">원경</span>
                    <span class="quick-mode-photo-hint">멀리서 전체</span>
                </div>
                <div class="quick-mode-photo-box near" id="quickPhotoNear" onclick="openQuickCamera('near')">
                    <span class="quick-mode-photo-icon">🔍</span>
                    <span class="quick-mode-photo-label">근경</span>
                    <span class="quick-mode-photo-hint">가까이서 상세</span>
                </div>
            </div>
            
            <!-- 퀵모드 갤러리 버튼 -->
            <div style="display: flex; gap: 10px;">
                <button style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); color: var(--text); font-size: 14px; cursor: pointer;" onclick="openQuickGallery('far')">🖼️ 원경 갤러리</button>
                <button style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); color: var(--text); font-size: 14px; cursor: pointer;" onclick="openQuickGallery('near')">🖼️ 근경 갤러리</button>
            </div>

            <div class="quick-mode-space-select">
                <div class="quick-mode-space-label">공간 선택 <span id="quickSpaceCount" style="color: var(--accent);">0/4 선택</span></div>
                <div class="touch-btn-grid" id="quickSpaceChips">
                    <!-- 동적 생성 -->
                </div>
                <button class="add-space-btn" onclick="addCustomSpace()">+ 공간 추가</button>
            </div>

            <textarea class="quick-mode-memo" id="quickModeMemo" placeholder="메모 (선택사항)&#10;예: 거실 창문 틀 스크래치"></textarea>
        </div>

        <div class="quick-mode-footer">
            <button class="quick-mode-btn continue" onclick="saveAndContinueQuick()">
                저장 후 계속 📸
            </button>
            <button class="quick-mode-btn save" id="quickSaveBtn" onclick="saveAndCloseQuick()" disabled>
                저장 ✓
            </button>
        </div>
    </div>

    <!-- ==================== 카메라 모달 ==================== -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-preview-container">
            <video id="cameraPreview" autoplay playsinline muted></video>
            <canvas id="markerCanvas" class="marker-canvas"></canvas>
            <div class="camera-guide-text" id="cameraGuideText">원경 촬영 - 멀리서 전체</div>
            
            <div class="marker-hint" id="markerHint">터치하여 마커 표시</div>
            
            <!-- 줌 레벨 표시 -->
            <div id="zoomLevel" style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); padding: 6px 14px; background: rgba(0, 0, 0, 0.6); border-radius: 16px; color: white; font-size: 13px; font-weight: 600;">1.0x</div>
        </div>
        
        <div class="camera-controls">
            <button class="camera-btn close" onclick="closeCamera()">✕</button>
            <button class="camera-btn capture" onclick="capturePhoto()">📸</button>
            <button class="camera-btn reset" onclick="resetMarkers()">↺</button>
        </div>
        <div class="camera-bottom-hint">
        </div>
    </div>

    <!-- ==================== 토스트 ==================== -->
    <div class="toast" id="toast">저장되었습니다</div>

    <!-- ==================== 사진 옵션 액션시트 ==================== -->
    <div class="photo-action-sheet" id="photoActionSheet">
        <div class="photo-action-overlay" onclick="closePhotoOptions()"></div>
        <div class="photo-action-content">
            <div class="photo-action-title" id="photoActionTitle">원경 사진</div>
            <button class="photo-action-btn" onclick="selectPhotoOption('camera')">
                <span>📸</span> 촬영하기
            </button>
            <button class="photo-action-btn" onclick="selectPhotoOption('gallery')">
                <span>🖼️</span> 갤러리에서 선택
            </button>
            <button class="photo-action-btn cancel" onclick="closePhotoOptions()">
                취소
            </button>
        </div>
    </div>

    <!-- ==================== 프로젝트 모달 ==================== -->
    <div class="project-modal-overlay" id="projectModalOverlay" onclick="closeProjectModal(event)">
        <div class="project-modal-sheet" onclick="event.stopPropagation()">
            <div class="project-modal-header">
                <span class="project-modal-title">프로젝트 관리</span>
                <button class="settings-close" onclick="closeProjectModal()">✕</button>
            </div>
            
            <div class="project-modal-body" id="projectList">
                <!-- 동적 생성 -->
            </div>
            
            <div style="padding: 16px;">
                <button class="project-add-btn" onclick="createNewProject()">
                    <span>+</span> 새 프로젝트 만들기
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 설정 메뉴 ==================== -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings(event)">
        <div class="settings-sheet" onclick="event.stopPropagation()">
            <div class="settings-header">
                <span class="settings-title">설정</span>
                <button class="settings-close" onclick="closeSettings()">✕</button>
            </div>
            
            <div class="settings-item" onclick="resetTutorial()">
                <span class="settings-item-icon">📖</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">튜토리얼 다시보기</div>
                    <div class="settings-item-desc">앱 사용법 가이드를 다시 볼 수 있어요</div>
                </div>
            </div>
            
            <div class="settings-item" onclick="exportData()">
                <span class="settings-item-icon">💾</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">데이터 백업</div>
                    <div class="settings-item-desc">현재 점검 데이터를 파일로 저장</div>
                </div>
            </div>
            
            <div class="settings-item" onclick="importData()">
                <span class="settings-item-icon">📂</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">데이터 복원</div>
                    <div class="settings-item-desc">백업 파일에서 데이터 불러오기</div>
                </div>
            </div>
            
            <div class="settings-item danger" onclick="resetAllData()">
                <span class="settings-item-icon">🗑️</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">전체 초기화</div>
                    <div class="settings-item-desc">모든 점검 데이터를 삭제합니다</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: var(--card-bg); border-radius: var(--radius); text-align: center;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">뷰파인더 v2.0</div>
                <div style="font-size: 12px; color: var(--text-muted);">© 2024 더홈점검</div>
            </div>
        </div>
    </div>

    <!-- ==================== 로딩 오버레이 ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">PDF 생성 중...</div>
    </div>

    <!-- ==================== 캔버스 (사진 압축용) ==================== -->
    <canvas id="photoCanvas" style="display: none;"></canvas>

    <script>
        // ==================== 데이터 ====================
        // ==================== 데이터 구조 ====================
        const APP_DATA = {
            currentProjectId: null,
            projects: []
        };

        // 프로젝트 생성 헬퍼
        function createEmptyProject() {
            return {
                id: 'proj_' + Date.now(),
                name: '새 프로젝트',
                apartmentName: '',
                dong: '',
                ho: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                defects: [],
                customSpaces: [],
                checkedItems: {}
            };
        }

        // 체크리스트 데이터 (참고용)
        const CHECKLIST_DATA = {
            entrance: {
                name: '현관/전실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 정등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '현관문/몰딩(점검창치) - 밀폐불량, 조립상태, 파손, 오염, 도어클로저 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손'
                    ],
                    floor: [
                        '타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '현관디딤석 - 부착상태, 파손, 오염'
                    ]
                }
            },
            livingroom: {
                name: '거실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 정등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '아트월(타일/MDF) - 부착상태, 단차, 파손, 오염',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '월패드/조절기(난방장치) - 부착상태, 파손, 작동상태, 화질불량, 연동불량',
                        '도배 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            bedroom: {
                name: '침실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 정등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '출입문/몰딩(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '가구류(붙박이장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '도배 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            kitchen: {
                name: '주방/식당',
                positions: {
                    ceiling: [
                        '전등/스핑기구 - 정등불량, 부착상태, 파손',
                        '확산소화기(조리시설 상부) - 설치상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '가구류(붙박이장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '조리기기류(콕탑, 후드) - 부착상태, 파손, 작동불량',
                        '싱크대/상판 - 부착상태, 파손, 실리콘 상태',
                        '수선류 - 급수, 누수, 배수상태',
                        '도배 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            bathroom: {
                name: '욕실/화장실',
                positions: {
                    ceiling: [
                        '전등 - 정등불량, 부착상태, 파손',
                        '환풍기 - 작동상태, 부착상태, 파손',
                        '전장재 - 부착상태, 단차, 파손, 오염',
                        '점검구 내부(배관, 천정) - 누수, 시공상태, 오염'
                    ],
                    wall: [
                        '출입문/몰딩/점금장치 - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(욕실장, 거울) - 부착상태, 파손, 오염, 개폐불양, 고정불량, 작동불량',
                        '변기 - 고정상태, 파손, 오염, 누수, 악취, 배수상태',
                        '세면대/욕조/수전류/사워기 - 부착상태, 파손, 오염, 작동상태, 누수, 악취, 배수상태',
                        '사워부스(설치시) - 고정상태, 파손, 오염, 개폐불량(유리문 설치시)',
                        '수건/휴지걸이/코너선반 - 고정상태, 파손, 오염',
                        '젠다이(석재선반) - 고정상태, 파손, 오염',
                        '벽타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구 - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            dressroom: {
                name: '드레스룸/알파룸',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 정등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '출입문/몰딩/점금장치 - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(선반, 수납장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '도배 - 오염, 공팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            balcony: {
                name: '발코니',
                positions: {
                    ceiling: [
                        '전등/스핑기구 - 정등불량, 부착상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '수전 - 급수, 누수, 배수상태',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구(수전 있는경우) - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            utility: {
                name: '다용도실/보일러실',
                positions: {
                    ceiling: [
                        '전등/스핑기구 - 정등불량, 부착상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '창호/유리(점금장치) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '난간대 - 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(선반, 보조주방) - 부착상태, 파손, 오염, 개폐불양, 선반/부품 미시공',
                        '수전 - 급수, 누수, 배수상태',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구(수전 있는경우) - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            outdoor: {
                name: '실외기실',
                positions: {
                    ceiling: [
                        '전등/스핑기구 - 정등불량, 부착상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/창호(배기창) - 고정상태, 파손, 오염, 개폐/점금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ]
                }
            },
            evacuation: {
                name: '대피공간',
                positions: {
                    ceiling: [
                        '전등 - 정등불량, 부착상태, 파손',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/창호(점금장치) - 고정상태, 파손, 오염, 밀폐/개폐/점금기능 불량',
                        '도장 - 오염, 공팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ]
                }
            },
            etc: {
                name: '기타사항',
                items: [
                    { category: '설비', items: ['분전반/동신함 - 작동불량, 부착상태, 파손, 오염', '난방온수분배기 - 고정상태, 누수, 소음, 파손, 오염', '전열교환기(세대 환기장치) - 작동불량, 부착상태, 파손, 오염'] },
                    { category: '공용부', items: ['주출입구, 계단실, 엘리베이터홀, 외벽, 주차장, 도로, 조경시설'] }
                ]
            }
        };

        // 기본 공간 목록 (더홈점검 동일)
        const DEFAULT_SPACES = [
            '현관', '안방', '침실1', '침실2', '침실3', '침실4', 
            '복도', '거실', '주방', '팬트리', '외부', '알파룸',
            '발코니', '대피공간', '실외기실', '파우더룸', 
            '드레스룸', '공용욕실', '부부욕실'
        ];

        // ==================== 현재 등록 중인 하자 ====================
        let currentDefect = {
            spaces: [],
            description: '',
            photos: { far: null, near: null }
        };

        // ==================== 카메라 관련 (더홈점검 동일) ====================
        let cameraStream = null;
        let currentPhotoType = null; // 'far' or 'near'
        let currentZoom = 1.0;
        let markers = [];
        let markerCanvas = null;
        let markerCtx = null;

        // ==================== 체크리스트 ====================
        let currentChecklistSpace = null;

        function renderChecklistSpaces() {
            const container = document.getElementById('checklistSpaces');
            
            container.innerHTML = Object.keys(CHECKLIST_DATA).map(key => {
                const space = CHECKLIST_DATA[key];
                
                return `
                    <div class="checklist-space-card" onclick="openChecklistDetail('${key}')">
                        <div class="checklist-space-info">
                            <div class="checklist-space-name">${space.name}</div>
                        </div>
                        <div class="checklist-space-arrow">→</div>
                    </div>
                `;
            }).join('');
        }

        function openChecklistDetail(spaceKey) {
            currentChecklistSpace = spaceKey;
            const space = CHECKLIST_DATA[spaceKey];
            
            document.getElementById('checklistDetailTitle').textContent = space.name;
            renderChecklistItems();
            showSection('checklistDetailSection');
        }

        function renderChecklistItems() {
            const space = CHECKLIST_DATA[currentChecklistSpace];
            const container = document.getElementById('checklistItems');
            
            // 기타사항 처리
            if (currentChecklistSpace === 'etc') {
                container.innerHTML = space.items.map(section => `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">${section.category}</div>
                        ${section.items.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                `).join('');
                return;
            }
            
            // 일반 공간 처리 (위치: 천장, 벽면, 바닥)
            const positions = space.positions;
            container.innerHTML = `
                ${positions.ceiling ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">천장</div>
                        ${positions.ceiling.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${positions.wall ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">벽면</div>
                        ${positions.wall.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${positions.floor ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">바닥</div>
                        ${positions.floor.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        // ==================== 테마 (다크/라이트 모드) ====================
        function initTheme() {
            const savedTheme = localStorage.getItem('viewfinder_theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '☀️';
            }
        }

        function toggleTheme() {
            const root = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (root.classList.contains('light-mode')) {
                root.classList.remove('light-mode');
                themeIcon.textContent = '🌙';
                localStorage.setItem('viewfinder_theme', 'dark');
            } else {
                root.classList.add('light-mode');
                themeIcon.textContent = '☀️';
                localStorage.setItem('viewfinder_theme', 'light');
            }
        }

        // 페이지 로드 시 테마 적용 (깜빡임 방지)
        initTheme();

        // ==================== 튜토리얼 ====================
        let currentTutorialSlide = 0;
        const totalTutorialSlides = 4;

        function initTutorial() {
            // 이미 튜토리얼을 봤는지 확인
            const tutorialSeen = localStorage.getItem('viewfinder_tutorial_seen');
            if (tutorialSeen) {
                document.getElementById('tutorialOverlay').classList.add('hidden');
                return;
            }
            
            // 튜토리얼 슬라이드 스크롤 이벤트
            const slides = document.getElementById('tutorialSlides');
            slides.addEventListener('scroll', () => {
                const slideWidth = slides.clientWidth;
                const scrollLeft = slides.scrollLeft;
                currentTutorialSlide = Math.round(scrollLeft / slideWidth);
                updateTutorialDots();
                updateTutorialButtons();
            });
        }

        function updateTutorialDots() {
            const dots = document.querySelectorAll('.tutorial-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentTutorialSlide);
            });
        }

        function updateTutorialButtons() {
            const skipBtn = document.getElementById('tutorialSkip');
            const nextBtn = document.getElementById('tutorialNext');
            
            if (currentTutorialSlide === totalTutorialSlides - 1) {
                skipBtn.style.display = 'none';
                nextBtn.textContent = '시작하기 🚀';
                nextBtn.style.flex = '1';
            } else {
                skipBtn.style.display = 'block';
                nextBtn.textContent = '다음';
                nextBtn.style.flex = '1';
            }
        }

        function nextTutorialSlide() {
            if (currentTutorialSlide >= totalTutorialSlides - 1) {
                closeTutorial();
                return;
            }
            
            currentTutorialSlide++;
            const slides = document.getElementById('tutorialSlides');
            slides.scrollTo({
                left: slides.clientWidth * currentTutorialSlide,
                behavior: 'smooth'
            });
        }

        function closeTutorial() {
            localStorage.setItem('viewfinder_tutorial_seen', 'true');
            const overlay = document.getElementById('tutorialOverlay');
            overlay.classList.add('hidden');
            
            // 완전히 숨긴 후 DOM에서 제거 (성능)
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // 튜토리얼 다시보기 (설정에서 사용 가능)
        function resetTutorial() {
            closeSettings();
            localStorage.removeItem('viewfinder_tutorial_seen');
            location.reload();
        }

        // ==================== 설정 메뉴 ====================
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
        }

        function closeSettings(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        // 데이터 백업
        function exportData() {
            const exportObj = {
                version: '2.1',
                exportDate: new Date().toISOString(),
                currentProjectId: APP_DATA.currentProjectId,
                projects: APP_DATA.projects
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `viewfinder_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast(`프로젝트 ${APP_DATA.projects.length}개가 백업됩니다`);
            closeSettings();
        }

        // 데이터 복원
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // v2.1 프로젝트 배열 형식
                        if (data.projects && Array.isArray(data.projects)) {
                            if (confirm(`프로젝트 ${data.projects.length}개를 복원하시겠습니까?\n\n현재 데이터는 삭제됩니다.`)) {
                                APP_DATA.projects = data.projects;
                                APP_DATA.currentProjectId = data.currentProjectId || data.projects[0].id;
                                saveData();
                                loadCurrentProject();
                                showToast('데이터가 복원되었습니다');
                                closeSettings();
                            }
                        }
                        // 구 버전 (단일 프로젝트)
                        else if (data.defects) {
                            if (confirm(`${data.defects.length}건의 하자 데이터를 현재 프로젝트에 복원하시겠습니까?`)) {
                                const proj = getCurrentProject();
                                proj.defects = data.defects;
                                saveData();
                                renderDefectList();
                                loadCurrentProject();
                                showToast('데이터가 복원되었습니다');
                                closeSettings();
                            }
                        } else {
                            showToast('유효하지 않은 백업 파일입니다', 'error');
                        }
                    } catch (err) {
                        showToast('파일을 읽을 수 없습니다', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 전체 초기화
        function resetAllData() {
            if (!confirm(`정말 모든 프로젝트(${APP_DATA.projects.length}개)를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;
            if (!confirm('마지막 확인입니다.\n모든 하자 사진과 기록이 삭제됩니다.')) return;
            
            // 새 프로젝트 생성
            const newProj = createEmptyProject();
            APP_DATA.projects = [newProj];
            APP_DATA.currentProjectId = newProj.id;
            saveData();
            
            // UI 초기화
            loadCurrentProject();
            closeSettings();
            showToast('모든 데이터가 초기화되었습니다');
        }

        // 퀵모드 갤러리
        function openQuickGallery(type) {
            currentPhotoType = type;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        // ==================== 퀵모드 ====================
        let quickModeData = {
            photos: { far: null, near: null },
            spaces: [],
            memo: ''
        };
        let isQuickMode = false;

        function openQuickMode() {
            isQuickMode = true;
            resetQuickModeData();
            renderQuickSpaceChips();
            updateQuickModeCount();
            document.getElementById('quickModeOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeQuickMode() {
            isQuickMode = false;
            document.getElementById('quickModeOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function resetQuickModeData() {
            quickModeData = {
                photos: { far: null, near: null },
                spaces: [],
                memo: ''
            };
            
            // UI 초기화
            const farBox = document.getElementById('quickPhotoFar');
            const nearBox = document.getElementById('quickPhotoNear');
            
            farBox.innerHTML = `
                <span class="quick-mode-photo-icon">📸</span>
                <span class="quick-mode-photo-label">원경</span>
                <span class="quick-mode-photo-hint">멀리서 전체</span>
            `;
            farBox.classList.remove('has-photo');
            farBox.onclick = () => openQuickCamera('far');
            
            nearBox.innerHTML = `
                <span class="quick-mode-photo-icon">🔍</span>
                <span class="quick-mode-photo-label">근경</span>
                <span class="quick-mode-photo-hint">가까이서 상세</span>
            `;
            nearBox.classList.remove('has-photo');
            nearBox.onclick = () => openQuickCamera('near');
            
            document.getElementById('quickModeMemo').value = '';
            document.getElementById('quickSpaceCount').textContent = '0/4 선택';
            renderQuickSpaceChips();
            updateQuickSaveButton();
        }

        function renderQuickSpaceChips() {
            const container = document.getElementById('quickSpaceChips');
            const customSpaces = getCurrentProject().customSpaces || [];
            const allSpaces = [...DEFAULT_SPACES, ...customSpaces];
            
            container.innerHTML = allSpaces.map(space => {
                const isCustom = customSpaces.includes(space);
                const isSelected = quickModeData.spaces.includes(space);
                const isDisabled = quickModeData.spaces.length >= 4 && !isSelected;
                
                return `
                    <button class="touch-btn ${isSelected ? 'selected' : ''} ${isCustom ? 'custom' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                            onclick="toggleQuickSpace('${space}')">
                        ${space}
                        ${isCustom ? `<span class="delete-custom" onclick="event.stopPropagation(); deleteCustomSpace('${space}')">✕</span>` : ''}
                    </button>
                `;
            }).join('');
        }

        function toggleQuickSpace(space) {
            const idx = quickModeData.spaces.indexOf(space);
            if (idx > -1) {
                quickModeData.spaces.splice(idx, 1);
            } else {
                if (quickModeData.spaces.length >= 4) {
                    showToast('최대 4개까지 선택 가능합니다', 'error');
                    return;
                }
                quickModeData.spaces.push(space);
            }
            document.getElementById('quickSpaceCount').textContent = `${quickModeData.spaces.length}/4 선택`;
            renderQuickSpaceChips();
        }

        function openQuickCamera(type) {
            currentPhotoType = type;
            openCamera(type);
        }

        function updateQuickPhotoBox(type, imageData) {
            const box = document.getElementById(type === 'far' ? 'quickPhotoFar' : 'quickPhotoNear');
            const label = type === 'far' ? '원경' : '근경';
            
            quickModeData.photos[type] = imageData;
            
            box.innerHTML = `
                <img src="${imageData}" alt="${label}">
                <span class="quick-mode-photo-badge">${label}</span>
                <button class="quick-mode-photo-delete" onclick="event.stopPropagation(); deleteQuickPhoto('${type}')">✕</button>
            `;
            box.classList.add('has-photo');
            box.onclick = () => openQuickCamera(type);
            
            updateQuickSaveButton();
        }

        function deleteQuickPhoto(type) {
            quickModeData.photos[type] = null;
            
            const box = document.getElementById(type === 'far' ? 'quickPhotoFar' : 'quickPhotoNear');
            const icon = type === 'far' ? '📸' : '🔍';
            const label = type === 'far' ? '원경' : '근경';
            const hint = type === 'far' ? '멀리서 전체' : '가까이서 상세';
            
            box.innerHTML = `
                <span class="quick-mode-photo-icon">${icon}</span>
                <span class="quick-mode-photo-label">${label}</span>
                <span class="quick-mode-photo-hint">${hint}</span>
            `;
            box.classList.remove('has-photo');
            box.onclick = () => openQuickCamera(type);
            
            updateQuickSaveButton();
        }

        function updateQuickSaveButton() {
            const btn = document.getElementById('quickSaveBtn');
            const hasPhotos = quickModeData.photos.far || quickModeData.photos.near;
            btn.disabled = !hasPhotos;
        }

        function updateQuickModeCount() {
            document.getElementById('quickModeCount').textContent = `저장: ${getCurrentProject().defects.length}건`;
        }

        function saveQuickDefect() {
            if (!quickModeData.photos.far && !quickModeData.photos.near) {
                showToast('사진을 1장 이상 촬영해주세요');
                return false;
            }

            const memo = document.getElementById('quickModeMemo').value.trim();
            
            const newDefect = {
                id: Date.now(),
                spaces: quickModeData.spaces.length > 0 ? quickModeData.spaces : ['미지정'],
                locations: [],
                types: [],
                detailLocation: '',
                description: memo || '퀵모드 촬영',
                photos: [quickModeData.photos.far, quickModeData.photos.near].filter(p => p)
            };

            getCurrentProject().defects.push(newDefect);
            saveData();
            renderDefectList();
            updateQuickModeCount();
            
            return true;
        }

        function saveAndContinueQuick() {
            if (saveQuickDefect()) {
                showToast('저장 완료! 계속 촬영하세요');
                resetQuickModeData();
                
                // 자동으로 원경 카메라 열기
                setTimeout(() => {
                    openQuickCamera('far');
                }, 300);
            }
        }

        function saveAndCloseQuick() {
            if (saveQuickDefect()) {
                showToast('저장 완료!');
                closeQuickMode();
            }
        }

        // ==================== 초기화 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 튜토리얼 초기화
            initTutorial();
            
            loadData();
            renderSpaceButtons();
            renderDefectList();
            renderEquipmentList();
            renderChecklistSpaces();
            initProjectInfoListeners();
            
            // 오늘 날짜 기본값
            const dateInput = document.getElementById('inspectionDate');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // 단계 가이드 초기화 (데이터 로드 후)
            setTimeout(updateStepGuide, 500);
            
            // 홈 하자 개수 업데이트
            updateHomeDefectCount();
        });
        
        function updateHomeDefectCount() {
            const count = getCurrentProject().defects.length;
            document.getElementById('defectCountHome').textContent = count + '건';
            document.getElementById('defectCount').textContent = count + '건 발견';
            
            // 진행바 업데이트
            const progressBar = document.getElementById('totalProgressBar');
            progressBar.style.width = Math.min(count * 5, 100) + '%';
        }

        // 프로젝트 정보 자동 저장
        function initProjectInfoListeners() {
            const inputs = ['apartmentName', 'dongNumber', 'hoNumber', 'inspectionDate'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        saveProjectInfo();
                        updateStepGuide();
                    });
                    el.addEventListener('blur', () => {
                        saveProjectInfo();
                        updateStepGuide();
                    });
                    el.addEventListener('input', updateStepGuide);
                }
            });
        }

        function saveProjectInfo() {
            const proj = getCurrentProject();
            proj.apartmentName = document.getElementById('apartmentName').value;
            proj.dong = document.getElementById('dongNumber').value;
            proj.ho = document.getElementById('hoNumber').value;
            proj.inspectionDate = document.getElementById('inspectionDate').value;
            
            // 프로젝트 이름 자동 업데이트
            if (proj.apartmentName) {
                proj.name = `${proj.apartmentName} ${proj.dong}동 ${proj.ho}호`;
            }
            
            updateProjectSelector();
            saveData();
        }

        // 단계별 가이드 업데이트
        function updateStepGuide() {
            const aptName = document.getElementById('apartmentName').value.trim();
            const dong = document.getElementById('dongNumber').value.trim();
            const ho = document.getElementById('hoNumber').value.trim();
            const defectCount = getCurrentProject().defects.length;
            
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step1Status = document.getElementById('step1Status');
            const step2Status = document.getElementById('step2Status');
            const step3Status = document.getElementById('step3Status');
            const stepHint = document.getElementById('stepHint');
            
            // Step 1: 정보 입력 체크
            const isStep1Complete = aptName && dong && ho;
            
            // Step 2: 하자 점검 체크
            const isStep2Complete = defectCount > 0;
            
            if (isStep1Complete && isStep2Complete) {
                // 3단계: 리포트 생성 가능
                step1.className = 'step-card completed';
                step2.className = 'step-card completed';
                step3.className = 'step-card current';
                
                step1Status.textContent = '완료';
                step2Status.textContent = `${defectCount}건`;
                step3Status.textContent = '진행';
                
                stepHint.textContent = '리포트 생성 가능';
            } else if (isStep1Complete) {
                // 2단계: 하자 점검
                step1.className = 'step-card completed';
                step2.className = 'step-card current';
                step3.className = 'step-card locked';
                
                step1Status.textContent = '완료';
                step2Status.textContent = defectCount > 0 ? `${defectCount}건` : '진행';
                step3Status.textContent = '대기';
                
                stepHint.textContent = '하자점검을 진행하세요';
            } else {
                // 1단계: 정보 입력
                step1.className = 'step-card current';
                step2.className = 'step-card locked';
                step3.className = 'step-card locked';
                
                step1Status.textContent = '시작';
                step2Status.textContent = '대기';
                step3Status.textContent = '대기';
                
                stepHint.textContent = '정보를 입력하세요';
            }
        }

        // 요소로 스크롤
        function scrollToElement(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.animation = 'highlight-pulse 1s ease';
                setTimeout(() => el.style.animation = '', 1000);
            }
        }

        // ==================== IndexedDB 저장/로드 ====================
        const DB_NAME = 'viewfinder_db';
        const DB_VERSION = 1;
        const STORE_NAME = 'app_data';
        let db = null;

        // IndexedDB 초기화
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        // 데이터 저장 (IndexedDB)
        // ==================== 프로젝트 관리 ====================
        function getCurrentProject() {
            if (!APP_DATA.currentProjectId || APP_DATA.projects.length === 0) {
                // 첫 프로젝트가 없으면 생성
                const newProj = createEmptyProject();
                APP_DATA.projects.push(newProj);
                APP_DATA.currentProjectId = newProj.id;
                saveData();
            }
            
            const proj = APP_DATA.projects.find(p => p.id === APP_DATA.currentProjectId);
            if (!proj) {
                // 현재 프로젝트가 없으면 첫 번째 프로젝트 사용
                APP_DATA.currentProjectId = APP_DATA.projects[0].id;
                return APP_DATA.projects[0];
            }
            return proj;
        }

        function openProjectModal() {
            renderProjectList();
            document.getElementById('projectModalOverlay').classList.add('active');
        }

        function closeProjectModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('projectModalOverlay').classList.remove('active');
        }

        function renderProjectList() {
            const container = document.getElementById('projectList');
            
            if (APP_DATA.projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">📁</div>
                        <p>아직 프로젝트가 없습니다</p>
                        <p style="font-size: 13px; margin-top: 8px;">새 프로젝트를 만들어보세요</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = APP_DATA.projects.map(proj => {
                const isActive = proj.id === APP_DATA.currentProjectId;
                const defectCount = proj.defects.length;
                const photoCount = proj.defects.reduce((sum, d) => sum + d.photos.filter(p => p).length, 0);
                
                return `
                    <div class="project-item ${isActive ? 'active' : ''}" onclick="switchProject('${proj.id}')">
                        ${isActive ? '<div class="project-item-badge">사용중</div>' : ''}
                        <div class="project-item-name">${proj.name}</div>
                        <div class="project-item-info">
                            <span>${proj.apartmentName || '미입력'}</span>
                            ${proj.dong && proj.ho ? `<span>${proj.dong}동 ${proj.ho}호</span>` : ''}
                        </div>
                        <div class="project-item-stats">
                            <div class="project-stat">
                                <span class="project-stat-value">${defectCount}</span>하자
                            </div>
                            <div class="project-stat">
                                <span class="project-stat-value">${photoCount}</span>사진
                            </div>
                            <div class="project-stat">
                                <span class="project-stat-value">${new Date(proj.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${!isActive ? `<button class="project-delete-btn" onclick="event.stopPropagation(); deleteProject('${proj.id}')">삭제</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function createNewProject() {
            const newProj = createEmptyProject();
            const name = prompt('프로젝트 이름을 입력하세요:', `${newProj.apartmentName || '프로젝트'} ${APP_DATA.projects.length + 1}`);
            
            if (!name) return;
            
            newProj.name = name;
            APP_DATA.projects.push(newProj);
            APP_DATA.currentProjectId = newProj.id;
            saveData();
            
            // UI 업데이트
            loadCurrentProject();
            renderProjectList();
            updateProjectSelector();
            showToast('새 프로젝트가 생성되었습니다');
        }

        function switchProject(projectId) {
            if (APP_DATA.currentProjectId === projectId) {
                closeProjectModal();
                return;
            }
            
            APP_DATA.currentProjectId = projectId;
            saveData();
            
            // UI 전체 새로고침
            loadCurrentProject();
            closeProjectModal();
            showToast('프로젝트가 전환되었습니다');
        }

        function deleteProject(projectId) {
            if (APP_DATA.projects.length === 1) {
                showToast('마지막 프로젝트는 삭제할 수 없습니다', 'error');
                return;
            }
            
            const proj = APP_DATA.projects.find(p => p.id === projectId);
            if (!confirm(`"${proj.name}" 프로젝트를 삭제하시겠습니까?\n\n하자 ${proj.defects.length}건이 함께 삭제됩니다.`)) {
                return;
            }
            
            APP_DATA.projects = APP_DATA.projects.filter(p => p.id !== projectId);
            
            // 현재 프로젝트였다면 첫 번째 프로젝트로 전환
            if (APP_DATA.currentProjectId === projectId) {
                APP_DATA.currentProjectId = APP_DATA.projects[0].id;
                loadCurrentProject();
            }
            
            saveData();
            renderProjectList();
            updateProjectSelector();
            showToast('프로젝트가 삭제되었습니다');
        }

        function updateProjectSelector() {
            const proj = getCurrentProject();
            const name = proj.name || (proj.apartmentName ? `${proj.apartmentName} ${proj.dong}동 ${proj.ho}호` : '새 프로젝트');
            document.getElementById('currentProjectName').textContent = name;
        }

        function loadCurrentProject() {
            const proj = getCurrentProject();
            
            // 프로젝트 정보 폼에 로드
            document.getElementById('apartmentName').value = proj.apartmentName || '';
            document.getElementById('dongNumber').value = proj.dong || '';
            document.getElementById('hoNumber').value = proj.ho || '';
            document.getElementById('inspectionDate').value = proj.inspectionDate || new Date().toISOString().split('T')[0];
            
            // 리스트 렌더링
            renderDefectList();
            renderChecklistSpaces();
            updateStepGuide();
            updateProjectSelector();
            updateHomeDefectCount();
        }

        // ==================== 데이터 저장/불러오기 ====================
        function saveData() {
            if (!db) {
                console.warn('DB not initialized');
                return;
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const dataToSave = {
                    id: 'main',
                    ...APP_DATA
                };
                
                store.put(dataToSave);
                
                transaction.onerror = (e) => {
                    console.error('저장 오류:', e);
                    showToast('저장 중 오류가 발생했습니다', 'error');
                };
                
                updateCounts();
            } catch (err) {
                console.error('saveData 오류:', err);
                showToast('저장 중 오류가 발생했습니다', 'error');
            }
        }

        // 데이터 로드 (IndexedDB)
        async function loadData() {
            try {
                await initDB();
                
                // localStorage에서 마이그레이션 시도
                const oldData = localStorage.getItem('viewfinder_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        Object.assign(APP_DATA, parsed);
                        saveData(); // IndexedDB로 저장
                        localStorage.removeItem('viewfinder_data'); // 기존 데이터 삭제
                        console.log('localStorage에서 IndexedDB로 마이그레이션 완료');
                    } catch (e) {
                        console.warn('마이그레이션 실패:', e);
                    }
                }
                
                // IndexedDB에서 로드
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('main');
                
                request.onsuccess = () => {
                    if (request.result) {
                        const { id, ...data } = request.result;
                        
                        // 기존 데이터 구조 확인 및 마이그레이션
                        if (data.defects && !data.projects) {
                            console.log('기존 데이터를 프로젝트 구조로 마이그레이션');
                            const firstProject = createEmptyProject();
                            firstProject.defects = data.defects || [];
                            firstProject.customSpaces = data.customSpaces || [];
                            firstProject.checkedItems = data.checkedItems || {};
                            
                            if (data.projectInfo) {
                                firstProject.apartmentName = data.projectInfo.apartmentName || '';
                                firstProject.dong = data.projectInfo.dong || '';
                                firstProject.ho = data.projectInfo.ho || '';
                                firstProject.inspectionDate = data.projectInfo.inspectionDate || new Date().toISOString().split('T')[0];
                                firstProject.name = firstProject.apartmentName ? 
                                    `${firstProject.apartmentName} ${firstProject.dong}동 ${firstProject.ho}호` : 
                                    '프로젝트 1';
                            }
                            
                            APP_DATA.projects = [firstProject];
                            APP_DATA.currentProjectId = firstProject.id;
                            saveData(); // 마이그레이션된 데이터 저장
                        } else {
                            Object.assign(APP_DATA, data);
                        }
                        
                        // 프로젝트가 없으면 생성
                        if (!APP_DATA.projects || APP_DATA.projects.length === 0) {
                            const newProj = createEmptyProject();
                            APP_DATA.projects = [newProj];
                            APP_DATA.currentProjectId = newProj.id;
                            saveData();
                        }
                        
                        // 현재 프로젝트 로드
                        loadCurrentProject();
                    }
                    updateCounts();
                };
                
                request.onerror = () => {
                    console.error('로드 오류:', request.error);
                    
                    // 로드 실패 시 첫 프로젝트 생성
                    const newProj = createEmptyProject();
                    APP_DATA.projects = [newProj];
                    APP_DATA.currentProjectId = newProj.id;
                    loadCurrentProject();
                    updateCounts();
                };
                
            } catch (err) {
                console.error('loadData 오류:', err);
                updateCounts();
            }
        }

        function updateCounts() {
            const count = getCurrentProject().defects.length;
            document.getElementById('defectCount').textContent = `${count}건 발견`;
            document.getElementById('defectCountHome').textContent = `${count}건`;
            document.getElementById('reportDefectCount').textContent = `${count}건`;
            document.getElementById('inspectionCount').textContent = `${count}건`;
            
            // 촬영 사진 수
            const photoCount = getCurrentProject().defects.reduce((sum, d) => {
                return sum + (d.photos ? d.photos.filter(p => p).length : 0);
            }, 0);
            const reportPhoto = document.getElementById('reportPhotoCount');
            if (reportPhoto) reportPhoto.textContent = photoCount;
            
            // 프로그레스 바 (최대 20건 기준)
            const progress = Math.min(count * 5, 100);
            document.getElementById('totalProgressBar').style.width = `${progress}%`;
            
            const reportBar = document.getElementById('reportProgressBar');
            if (reportBar) reportBar.style.width = `${progress}%`;
        }

        // ==================== 섹션 전환 ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            if (sectionId === 'homeSection') {
                document.querySelector('.nav-item').classList.add('active');
            }
            
            // 리포트 섹션 표시 시 프로젝트 정보 업데이트
            if (sectionId === 'reportSection') {
                updateReportProjectInfo();
                updateReportEmptyState();
            }
        }
        
        function updateReportEmptyState() {
            const emptyState = document.getElementById('reportEmptyState');
            const reportContent = document.getElementById('reportContent');
            
            if (getCurrentProject().defects.length === 0) {
                emptyState.style.display = 'block';
                reportContent.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                reportContent.style.display = 'block';
            }
        }
        
        function updateReportProjectInfo() {
            const aptName = document.getElementById('apartmentName').value || '-';
            const dong = document.getElementById('dongNumber').value || '-';
            const ho = document.getElementById('hoNumber').value || '-';
            const date = document.getElementById('inspectionDate').value || '-';
            
            document.getElementById('reportAptName').textContent = aptName;
            document.getElementById('reportDongHo').textContent = (dong !== '-' && ho !== '-') ? `${dong}동 ${ho}호` : '-';
            document.getElementById('reportDate').textContent = date;
            
            // 통계 업데이트
            const defectCount = getCurrentProject().defects.length;
            const photoCount = getCurrentProject().defects.reduce((sum, d) => sum + d.photos.filter(p => p).length, 0);
            
            document.getElementById('reportDefectCount').textContent = defectCount + '건';
            document.getElementById('reportPhotoCount').textContent = photoCount;
            document.getElementById('reportProgressBar').style.width = Math.min(defectCount * 5, 100) + '%';
        }

        // ==================== 하자 등록 화면 ====================
        function openDefectRegister() {
            // 초기화
            currentDefect = {
                spaces: [],
                description: '',
                photos: { far: null, near: null }
            };
            
            renderSpaceButtons();
            resetPhotoBoxes();
            document.getElementById('defectDescription').value = '';
            document.getElementById('spaceCount').textContent = '0/4 선택';
            
            document.getElementById('defectRegisterScreen').classList.add('active');
        }

        function closeDefectRegister() {
            document.getElementById('defectRegisterScreen').classList.remove('active');
        }

        // ==================== 공간 버튼 렌더링 ====================
        function renderSpaceButtons() {
            const container = document.getElementById('spaceButtons');
            const customSpaces = getCurrentProject().customSpaces || [];
            const allSpaces = [...DEFAULT_SPACES, ...customSpaces];
            
            container.innerHTML = allSpaces.map(space => {
                const isCustom = customSpaces.includes(space);
                const isSelected = currentDefect.spaces.includes(space);
                const isDisabled = currentDefect.spaces.length >= 4 && !isSelected;
                
                return `
                    <button class="touch-btn ${isSelected ? 'selected' : ''} ${isCustom ? 'custom' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                            onclick="toggleSpace('${space}')">
                        ${space}
                        ${isCustom ? `<span class="delete-custom" onclick="event.stopPropagation(); deleteCustomSpace('${space}')">✕</span>` : ''}
                    </button>
                `;
            }).join('');
        }

        function toggleSpace(space) {
            const idx = currentDefect.spaces.indexOf(space);
            if (idx > -1) {
                currentDefect.spaces.splice(idx, 1);
            } else {
                if (currentDefect.spaces.length >= 4) {
                    showToast('최대 4개까지 선택 가능합니다', 'error');
                    return;
                }
                currentDefect.spaces.push(space);
            }
            document.getElementById('spaceCount').textContent = `${currentDefect.spaces.length}/4 선택`;
            renderSpaceButtons();
        }

        // ==================== 커스텀 공간 추가/삭제 ====================
        function addCustomSpace() {
            const name = prompt('추가할 공간 이름을 입력하세요:');
            if (!name || !name.trim()) return;
            
            const spaceName = name.trim();
            const proj = getCurrentProject();
            
            // 중복 체크
            if (DEFAULT_SPACES.includes(spaceName) || (proj.customSpaces && proj.customSpaces.includes(spaceName))) {
                showToast('이미 존재하는 공간입니다', 'error');
                return;
            }
            
            // 프로젝트에 커스텀 공간 추가
            if (!proj.customSpaces) proj.customSpaces = [];
            proj.customSpaces.push(spaceName);
            saveData();
            
            // 양쪽 UI 갱신
            renderSpaceButtons();
            renderQuickSpaceChips();
            
            showToast(`"${spaceName}" 공간이 추가되었습니다`);
        }

        function deleteCustomSpace(space) {
            if (!confirm(`"${space}" 공간을 삭제하시겠습니까?`)) return;
            
            const proj = getCurrentProject();
            proj.customSpaces = (proj.customSpaces || []).filter(s => s !== space);
            
            // 현재 선택에서도 제거
            currentDefect.spaces = currentDefect.spaces.filter(s => s !== space);
            quickModeData.spaces = quickModeData.spaces.filter(s => s !== space);
            
            saveData();
            
            // 양쪽 UI 갱신
            renderSpaceButtons();
            renderQuickSpaceChips();
            document.getElementById('spaceCount').textContent = `${currentDefect.spaces.length}/4 선택`;
            document.getElementById('quickSpaceCount').textContent = `${quickModeData.spaces.length}/4 선택`;
            
            showToast(`"${space}" 공간이 삭제되었습니다`);
        }

        // ==================== 사진 박스 초기화 ====================
        function resetPhotoBoxes() {
            const farBox = document.getElementById('photoBoxFar');
            const nearBox = document.getElementById('photoBoxNear');
            
            farBox.innerHTML = `
                <span class="photo-box-icon">📸</span>
                <span class="photo-box-label">원경</span>
                <span class="photo-box-hint">멀리서 전체</span>
            `;
            farBox.classList.remove('has-photo');
            farBox.onclick = () => openCamera('far');
            
            nearBox.innerHTML = `
                <span class="photo-box-icon">🔍</span>
                <span class="photo-box-label">근경</span>
                <span class="photo-box-hint">가까이서 상세</span>
            `;
            nearBox.classList.remove('has-photo');
            nearBox.onclick = () => openCamera('near');
        }

        // ==================== 카메라 ====================
        async function openCamera(photoType) {
            if (!photoType) return; // 안전장치
            currentPhotoType = photoType;
            currentZoom = 1.0;
            markers = [];
            
            const guideText = document.getElementById('cameraGuideText');
            if (photoType === 'far') {
                guideText.textContent = '원경 촬영 - 멀리서 전체';
                guideText.className = 'camera-guide-text far';
            } else {
                guideText.textContent = '근경 촬영 - 가까이서 상세';
                guideText.className = 'camera-guide-text near';
            }
            
            try {
                // 카메라 API 지원 확인
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('카메라 미지원');
                }
                
                // 디바이스별 최적화
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                let constraints = {
                    video: { facingMode: 'environment' },
                    audio: false
                };
                
                // iOS: 중간 해상도 (메모리 최적화)
                if (isIOS) {
                    constraints.video.width = { ideal: 1280 };
                    constraints.video.height = { ideal: 720 };
                } else {
                    constraints.video.width = { ideal: 1920 };
                    constraints.video.height = { ideal: 1080 };
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                
                // iOS Safari 필수 속성
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');
                video.muted = true;
                
                // 비디오 로드 대기
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(resolve);
                    };
                    setTimeout(resolve, 3000);
                });
                
                // 줌 초기화
                video.style.transform = 'scale(1)';
                const zoomLabel = document.getElementById('zoomLevel');
                if (zoomLabel) zoomLabel.textContent = '1.0x';
                
                // 마커 캔버스 초기화
                markerCanvas = document.getElementById('markerCanvas');
                markerCtx = markerCanvas.getContext('2d');
                
                // 카메라 모달 먼저 표시
                document.getElementById('cameraModal').classList.add('active');
                document.getElementById('markerHint').classList.remove('hidden');
                
                // 비디오 렌더링 후 마커 캔버스 크기 재설정
                setTimeout(() => {
                    resizeMarkerCanvas();
                }, 100);
                
                // 추가로 500ms 후에도 한번 더 (안전장치)
                setTimeout(() => {
                    resizeMarkerCanvas();
                }, 500);
                
                // 컨텍스트 메뉴 차단 (Google Lens 방지)
                video.addEventListener('contextmenu', preventEvent, { passive: false });
                
                // 터치 이벤트 설정
                setupTouchEvents(video);
                
                // 3초 후 힌트 숨김
                setTimeout(() => {
                    document.getElementById('markerHint').classList.add('hidden');
                }, 3000);
                
            } catch (err) {
                console.error('카메라 오류:', err);
                
                // 권한 거부 또는 카메라 없음
                if (err.name === 'NotAllowedError') {
                    showToast('카메라 권한이 필요합니다. 설정에서 권한을 허용해주세요.', 'error');
                } else if (err.name === 'NotFoundError') {
                    showToast('카메라를 찾을 수 없습니다.', 'error');
                } else {
                    showToast('카메라를 실행할 수 없습니다.', 'error');
                }
            }
        }

        function preventEvent(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }

        // 터치 이벤트 설정 (핀치줌 + 마커)
        function setupTouchEvents(video) {
            const container = video.parentElement;
            let initialDistance = 0;
            let initialZoom = 1.0;
            let touchStartTime = 0;
            
            const getDistance = (touch1, touch2) => {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            };
            
            container.ontouchstart = (e) => {
                touchStartTime = Date.now();
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialZoom = currentZoom;
                    e.preventDefault();
                }
            };
            
            container.ontouchmove = (e) => {
                if (e.touches.length === 2) {
                    const newDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = newDistance / initialDistance;
                    applyZoom(initialZoom * scale);
                    e.preventDefault();
                }
            };
            
            container.ontouchend = (e) => {
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 200 && e.changedTouches.length === 1 && markers.length < 10) {
                    const touch = e.changedTouches[0];
                    const rect = container.getBoundingClientRect();
                    const x = (touch.clientX - rect.left) / rect.width;
                    const y = (touch.clientY - rect.top) / rect.height;
                    addMarker(x, y);
                }
            };
        }

        function applyZoom(zoom) {
            currentZoom = Math.max(1.0, Math.min(zoom, 5.0));
            const video = document.getElementById('cameraPreview');
            video.style.transform = `scale(${currentZoom})`;
            const zoomLabel = document.getElementById('zoomLevel');
            if (zoomLabel) zoomLabel.textContent = `${currentZoom.toFixed(1)}x`;
        }

        function resizeMarkerCanvas() {
            if (!markerCanvas) return;
            const video = document.getElementById('cameraPreview');
            const rect = video.getBoundingClientRect();
            markerCanvas.width = rect.width;
            markerCanvas.height = rect.height;
            redrawMarkers();
        }

        function addMarker(x, y) {
            markers.push({ x, y });
            redrawMarkers();
            document.getElementById('markerHint').classList.add('hidden');
            
            // 피드백
            if (markers.length === 1) {
                showToast(`마커 ${markers.length}개 추가됨 (최대 10개)`);
            }
        }

        function redrawMarkers() {
            if (!markerCtx || !markerCanvas) return;
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            
            markers.forEach((marker, idx) => {
                const x = marker.x * markerCanvas.width;
                const y = marker.y * markerCanvas.height;
                
                // 외곽 원 (그림자 효과)
                markerCtx.beginPath();
                markerCtx.arc(x, y, 26, 0, Math.PI * 2);
                markerCtx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                markerCtx.lineWidth = 5;
                markerCtx.stroke();
                
                // 메인 원 (빨간색 - 라이브 프리뷰)
                markerCtx.beginPath();
                markerCtx.arc(x, y, 24, 0, Math.PI * 2);
                markerCtx.strokeStyle = '#FF0000';
                markerCtx.lineWidth = 4;
                markerCtx.stroke();
                
                // 중앙 점
                markerCtx.beginPath();
                markerCtx.arc(x, y, 6, 0, Math.PI * 2);
                markerCtx.fillStyle = '#FF0000';
                markerCtx.fill();
                
                // 번호 배경
                markerCtx.beginPath();
                markerCtx.arc(x, y - 35, 12, 0, Math.PI * 2);
                markerCtx.fillStyle = '#FF0000';
                markerCtx.fill();
                
                // 번호 텍스트
                markerCtx.font = 'bold 14px sans-serif';
                markerCtx.fillStyle = '#FFFFFF';
                markerCtx.textAlign = 'center';
                markerCtx.textBaseline = 'middle';
                markerCtx.fillText(idx + 1, x, y - 35);
            });
        }

        function resetMarkers() {
            markers = [];
            redrawMarkers();
            showToast('마커가 초기화되었습니다');
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraPreview');
            if (video) video.style.transform = 'scale(1)';
            document.getElementById('cameraModal').classList.remove('active');
        }

        function adjustZoom(delta) {
            applyZoom(currentZoom + delta);
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d', { alpha: false });
            
            // 디바이스별 최적화 (더홈점검 동일)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const maxSize = isIOS ? 1280 : 1920;
            const quality = isIOS ? 0.8 : 0.85;
            
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // 최대 너비 제한
            if (width > maxSize) {
                height = Math.round(height * maxSize / width);
                width = maxSize;
            }
            
            // iOS 메모리 제한
            const maxPixels = isIOS ? 4096 * 4096 : 8192 * 8192;
            if (width * height > maxPixels) {
                const scale = Math.sqrt(maxPixels / (width * height));
                width = Math.floor(width * scale);
                height = Math.floor(height * scale);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // 배경 흰색
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            
            // 고품질 렌더링
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // 줌 적용하여 캡처
            if (currentZoom > 1) {
                const zoomedWidth = video.videoWidth / currentZoom;
                const zoomedHeight = video.videoHeight / currentZoom;
                const sx = (video.videoWidth - zoomedWidth) / 2;
                const sy = (video.videoHeight - zoomedHeight) / 2;
                ctx.drawImage(video, sx, sy, zoomedWidth, zoomedHeight, 0, 0, width, height);
            } else {
                ctx.drawImage(video, 0, 0, width, height);
            }
            
            // 마커 그리기
            if (markers.length > 0) {
                markers.forEach((marker, idx) => {
                    const x = marker.x * width;
                    const y = marker.y * height;
                    
                    // 외곽 원 (더 크게)
                    ctx.beginPath();
                    ctx.arc(x, y, 40, 0, Math.PI * 2);
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 6;
                    ctx.stroke();
                    
                    // 중앙 점 (더 크게)
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#FF0000';
                    ctx.fill();
                    
                    // 번호 배경 (흰색 원)
                    ctx.beginPath();
                    ctx.arc(x, y - 50, 20, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.fill();
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // 번호 텍스트 (더 크게)
                    ctx.font = 'bold 24px sans-serif';
                    ctx.fillStyle = '#FF0000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(idx + 1, x, y - 50);
                });
            }
            
            const imageData = canvas.toDataURL('image/jpeg', quality);
            
            // 퀵모드인 경우 퀵모드 UI 업데이트
            if (isQuickMode) {
                updateQuickPhotoBox(currentPhotoType, imageData);
                closeCamera();
                return;
            }
            
            // 일반 모드: 사진 저장
            currentDefect.photos[currentPhotoType] = imageData;
            
            // UI 업데이트
            updatePhotoBox(currentPhotoType, imageData);
            
            closeCamera();
        }

        function updatePhotoBox(photoType, imageData) {
            const box = document.getElementById(photoType === 'far' ? 'photoBoxFar' : 'photoBoxNear');
            const label = photoType === 'far' ? '원경' : '근경';
            
            box.innerHTML = `
                <img src="${imageData}" alt="${label}">
                <span class="photo-box-badge">${label}</span>
                <button class="photo-box-delete" onclick="event.stopPropagation(); deletePhoto('${photoType}')">✕</button>
            `;
            box.classList.add('has-photo');
            box.onclick = () => openCamera(photoType);
        }

        function retakePhoto(photoType) {
            currentDefect.photos[photoType] = null;
            openCamera(photoType);
        }

        function reattachPhoto(photoType) {
            currentDefect.photos[photoType] = null;
            openGallery(photoType);
        }

        function deletePhoto(photoType) {
            currentDefect.photos[photoType] = null;
            
            const box = document.getElementById(photoType === 'far' ? 'photoBoxFar' : 'photoBoxNear');
            const icon = photoType === 'far' ? '📸' : '🔍';
            const label = photoType === 'far' ? '원경' : '근경';
            const hint = photoType === 'far' ? '멀리서 전체' : '가까이서 상세';
            
            box.innerHTML = `
                <span class="photo-box-icon">${icon}</span>
                <span class="photo-box-label">${label}</span>
                <span class="photo-box-hint">${hint}</span>
            `;
            box.classList.remove('has-photo');
            box.onclick = () => openCamera(photoType);
        }

        // 갤러리 폴백
        function openGallery(photoType) {
            if (!photoType) return; // 안전장치
            currentPhotoType = photoType;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        function openGalleryFromCamera() {
            // 카메라 닫고 갤러리 열기
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        // ==================== 사진 옵션 액션시트 ====================
        let pendingPhotoType = null;

        function showPhotoOptions(photoType) {
            pendingPhotoType = photoType;
            const title = photoType === 'far' ? '원경 사진 (멀리서)' : '근경 사진 (가까이서)';
            document.getElementById('photoActionTitle').textContent = title;
            document.getElementById('photoActionSheet').classList.add('active');
        }

        function closePhotoOptions() {
            document.getElementById('photoActionSheet').classList.remove('active');
            pendingPhotoType = null;
        }

        function selectPhotoOption(option) {
            const photoType = pendingPhotoType; // 먼저 저장
            closePhotoOptions();
            
            if (!photoType) return;
            
            if (option === 'camera') {
                openCamera(photoType);
            } else if (option === 'gallery') {
                openGallery(photoType);
            }
        }

        // ==================== 이미지 압축 (더홈점검 동일) ====================
        async function compressImage(input, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                try {
                    // 디바이스 감지
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    
                    // iOS 최적화
                    if (isIOS) {
                        maxWidth = Math.min(maxWidth, 1280);
                        quality = Math.min(quality, 0.8);
                    }
                    
                    const img = new Image();
                    
                    img.onerror = () => reject(new Error('이미지 로드 실패'));
                    
                    img.onload = () => {
                        try {
                            const canvas = document.getElementById('photoCanvas');
                            const ctx = canvas.getContext('2d', { alpha: false });
                            
                            let width = img.width;
                            let height = img.height;
                            
                            // 최대 너비 제한
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            // iOS 메모리 제한
                            const maxPixels = isIOS ? 4096 * 4096 : 8192 * 8192;
                            if (width * height > maxPixels) {
                                const scale = Math.sqrt(maxPixels / (width * height));
                                width = Math.floor(width * scale);
                                height = Math.floor(height * scale);
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // 배경 흰색 (투명 PNG 처리)
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, width, height);
                            
                            // 고품질 렌더링
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        } catch (err) {
                            reject(err);
                        }
                    };
                    
                    img.src = input;
                } catch (err) {
                    reject(err);
                }
            });
        }
        
        // 갤러리 선택 핸들러 (async로 변경)
        async function handleGallerySelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!currentPhotoType) return;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const compressed = await compressImage(event.target.result, 1280, 0.8);
                        
                        // 퀵모드인 경우 퀵모드 UI 업데이트
                        if (isQuickMode) {
                            updateQuickPhotoBox(currentPhotoType, compressed);
                            showToast('사진이 첨부되었습니다');
                            return;
                        }
                        
                        // 일반 모드
                        currentDefect.photos[currentPhotoType] = compressed;
                        updatePhotoBox(currentPhotoType, compressed);
                        showToast('사진이 첨부되었습니다');
                    } catch (err) {
                        console.error('압축 오류:', err);
                        showToast('이미지 처리 중 오류가 발생했습니다', 'error');
                    }
                };
                reader.readAsDataURL(file);
            } catch (err) {
                showToast('파일을 읽을 수 없습니다', 'error');
            }
        }

        // ==================== 하자 저장 ====================
        function saveDefect() {
            // 유효성 검사
            if (!currentDefect.photos.far || !currentDefect.photos.near) {
                showToast('원경/근경 사진 2장을 모두 촬영해주세요', 'error');
                return;
            }
            
            if (currentDefect.spaces.length === 0) {
                showToast('공간을 1개 이상 선택해주세요', 'error');
                return;
            }
            
            // 설명 가져오기
            currentDefect.description = document.getElementById('defectDescription').value;
            
            // 자동 설명 생성 (입력 없을 경우)
            if (!currentDefect.description && currentDefect.spaces.length > 0) {
                currentDefect.description = currentDefect.spaces.join(', ') + ' 하자';
            }
            
            // 저장
            const defect = {
                id: Date.now(),
                spaces: [...currentDefect.spaces],
                description: currentDefect.description,
                photos: [currentDefect.photos.far, currentDefect.photos.near],
                createdAt: new Date().toISOString()
            };
            
            getCurrentProject().defects.push(defect);
            saveData();
            
            closeDefectRegister();
            renderDefectList();
            showToast('하자가 추가되었습니다!');
        }

        // ==================== 하자 목록 렌더링 ====================
        function renderDefectList() {
            const container = document.getElementById('defectList');
            
            if (getCurrentProject().defects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📷</div>
                        <div class="empty-state-title">아직 발견된 하자가 없습니다</div>
                        <div class="empty-state-desc">
                            퀵모드로 빠르게 촬영하거나<br>
                            상세입력으로 꼼꼼히 기록해보세요
                        </div>
                        <button class="empty-state-btn" onclick="openQuickMode()">⚡ 퀵모드 시작</button>
                    </div>
                `;
                updateStepGuide();
                updateHomeDefectCount();
                return;
            }
            
            container.innerHTML = getCurrentProject().defects.map((defect, index) => `
                <div class="defect-card">
                    <button class="defect-delete-btn" onclick="event.stopPropagation(); deleteDefect(${defect.id})">🗑️</button>
                    <div class="defect-header">
                        <span class="defect-number">${index + 1}</span>
                        <span class="defect-location">${defect.spaces.join(', ') || '미지정'}</span>
                    </div>
                    <div class="defect-photos">
                        ${defect.photos[0] ? `<img src="${defect.photos[0]}" class="defect-photo" alt="원경">` : ''}
                        ${defect.photos[1] ? `<img src="${defect.photos[1]}" class="defect-photo" alt="근경">` : ''}
                    </div>
                    ${defect.description ? `<div class="defect-desc">${defect.description}</div>` : ''}
                </div>
            `).join('');
            
            updateStepGuide();
            updateHomeDefectCount();
        }

        function deleteDefect(id) {
            if (!confirm('이 하자를 삭제하시겠습니까?')) return;
            
            const idx = getCurrentProject().defects.findIndex(d => d.id === id);
            if (idx > -1) {
                getCurrentProject().defects.splice(idx, 1);
                saveData();
                renderDefectList();
                updateStepGuide();
                showToast('삭제되었습니다');
            }
        }

        // ==================== 장비 가이드 ====================
        function renderEquipmentList() {
            const equipment = [
                { name: '열화상 카메라', icon: '🔥', desc: '결로, 누수, 단열 불량 확인' },
                { name: '라돈 측정기', icon: '☢️', desc: '실내 라돈 농도 측정' },
                { name: '레이저 레벨기', icon: '📐', desc: '바닥/벽 수평 확인' },
                { name: '공기질 측정기', icon: '💨', desc: 'PM2.5, CO2, TVOC 측정' }
            ];
            
            document.getElementById('equipmentList').innerHTML = equipment.map(eq => `
                <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #00A080); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">${eq.icon}</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${eq.name}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${eq.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== 리포트/공유 ====================
        function showLoading(text = 'PDF 생성 중...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // 프로젝트 정보 가져오기
        function getProjectInfo() {
            return {
                apartmentName: document.getElementById('apartmentName').value || '미입력',
                dong: document.getElementById('dongNumber').value || '-',
                ho: document.getElementById('hoNumber').value || '-',
                inspectionDate: document.getElementById('inspectionDate').value || new Date().toISOString().split('T')[0]
            };
        }

        // PDF 생성 메인 함수
        async function generatePDF() {
            const projectInfo = getProjectInfo();
            
            // 유효성 검사
            if (!projectInfo.apartmentName || projectInfo.apartmentName === '미입력') {
                showToast('아파트명을 입력해주세요', 'error');
                return;
            }
            
            if (getCurrentProject().defects.length === 0) {
                if (!confirm('발견된 하자가 없습니다. 그래도 보고서를 생성하시겠습니까?')) {
                    return;
                }
            }

            showLoading('PDF 보고서 생성 중...');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210;
                const pageHeight = 297;

                // 1페이지: 표지
                const coverHTML = createCoverPage(projectInfo);
                await addHTMLPageToPDF(doc, coverHTML, pageWidth, pageHeight);

                // 2페이지~: 하자 목록 (있는 경우)
                if (getCurrentProject().defects.length > 0) {
                    doc.addPage();
                    const listHTML = createDefectListPage(projectInfo);
                    await addHTMLPageToPDF(doc, listHTML, pageWidth, pageHeight);

                    // 하자 상세 페이지 (3개씩)
                    for (let i = 0; i < getCurrentProject().defects.length; i += 3) {
                        doc.addPage();
                        const batch = getCurrentProject().defects.slice(i, i + 3);
                        const detailHTML = createDefectDetailPage(batch, i, projectInfo);
                        await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                    }
                }

                // 파일 저장
                const filename = `뷰파인더_${projectInfo.apartmentName}_${projectInfo.dong}동${projectInfo.ho}호_${projectInfo.inspectionDate}.pdf`;
                
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    const pdfBlob = doc.output('blob');
                    const blobUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                } else {
                    doc.save(filename);
                }

                hideLoading();
                showToast('PDF 보고서가 생성되었습니다!');

            } catch (error) {
                console.error('PDF 생성 오류:', error);
                hideLoading();
                showToast('PDF 생성 중 오류가 발생했습니다', 'error');
            }
        }

        // HTML을 PDF에 추가
        async function addHTMLPageToPDF(doc, htmlContent, pageWidth, pageHeight) {
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '794px';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = '#ffffff';
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });

            document.body.removeChild(tempDiv);

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * pageWidth) / canvas.width;
            
            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
        }

        // 표지 페이지 생성
        function createCoverPage(projectInfo) {
            const defectCount = getCurrentProject().defects.length;
            
            // 촬영된 사진 수 계산
            const photoCount = getCurrentProject().defects.reduce((sum, defect) => {
                return sum + (defect.photos ? defect.photos.filter(p => p).length : 0);
            }, 0);
            
            return `
                <div style="width: 794px; height: 1123px; background: #ffffff; font-family: 'Malgun Gothic', sans-serif; position: relative; box-sizing: border-box;">
                    
                    <!-- 상단 라인 -->
                    <div style="height: 4px; background: #2c5282;"></div>
                    
                    <!-- 메인 컨텐츠 -->
                    <div style="padding: 80px 60px 50px 60px;">
                        
                        <!-- 타이틀 -->
                        <div style="text-align: center; margin-bottom: 60px;">
                            <h1 style="font-size: 36px; font-weight: 700; color: #222; margin: 0 0 20px 0; line-height: 1.3;">
                                입주 전 하자점검 보고서
                            </h1>
                            <div style="font-size: 16px; color: #666; font-weight: 500;">
                                ${projectInfo.apartmentName}
                            </div>
                        </div>
                        
                        <!-- 프로젝트 정보 -->
                        <div style="border-top: 2px solid #2c5282; border-bottom: 2px solid #2c5282; padding: 35px 0; margin-bottom: 50px;">
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: flex;">
                                    <span style="width: 130px; color: #666; font-size: 15px; font-weight: 500;">동 / 호수</span>
                                    <span style="font-size: 17px; font-weight: 700; color: #222;">${projectInfo.dong}동 ${projectInfo.ho}호</span>
                                </div>
                                <div style="display: flex;">
                                    <span style="width: 130px; color: #666; font-size: 15px; font-weight: 500;">점검일자</span>
                                    <span style="font-size: 17px; font-weight: 700; color: #222;">${projectInfo.inspectionDate}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 점검 결과 통계 -->
                        <div style="display: flex; gap: 20px; margin-bottom: 50px;">
                            <div style="flex: 1; border: 2px solid #2c5282; padding: 30px; text-align: center;">
                                <div style="font-size: 52px; font-weight: 800; color: #2c5282; margin-bottom: 10px;">${defectCount}</div>
                                <div style="font-size: 15px; color: #555; font-weight: 600;">발견된 하자</div>
                            </div>
                            <div style="flex: 1; border: 2px solid #e0e0e0; padding: 30px; text-align: center;">
                                <div style="font-size: 52px; font-weight: 800; color: #2c5282; margin-bottom: 10px;">${photoCount}</div>
                                <div style="font-size: 15px; color: #555; font-weight: 600;">촬영된 사진</div>
                            </div>
                        </div>
                        
                        <!-- 중요 안내사항 -->
                        <div style="border: 2px solid #2c5282; padding: 25px; margin-bottom: 20px;">
                            <div style="font-size: 15px; color: #2c5282; font-weight: 700; margin-bottom: 15px;">중요 안내사항</div>
                            <div style="font-size: 13px; color: #444; line-height: 1.9; font-weight: 500;">
                                • 본 보고서는 시공사 하자 접수 시 증빙자료로 활용하시기 바랍니다.<br/>
                                • 하자담보책임기간 내 주기적인 점검과 관리가 필요합니다.<br/>
                                • 발견된 하자는 빠른 시일 내에 시공사에 접수하시기 바랍니다.
                            </div>
                        </div>
                        
                        <!-- 서비스 안내 -->
                        <div style="background: #f8f8f8; padding: 20px; border-left: 4px solid #2c5282;">
                            <div style="font-size: 12px; color: #666; line-height: 1.7; font-weight: 500;">
                                본 보고서는 더홈점검 셀프점검 서비스를 통해 작성되었습니다.<br/>
                                전문가 점검이 필요하시면 더홈점검 프로 서비스를 이용해주세요.
                            </div>
                        </div>
                    </div>
                    
                    <!-- 하단 푸터 -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 60px; border-top: 1px solid #ddd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 16px; font-weight: 700; color: #2c5282;">THE HOME INSPECTION</div>
                            <div style="text-align: right; font-size: 12px; color: #666; font-weight: 500; line-height: 1.5;">
                                대표: 1668-5222 | 직통: 010-9985-0128
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 하자 목록 페이지 생성
        function createDefectListPage(projectInfo) {
            let tableRows = '';
            
            getCurrentProject().defects.forEach((defect, idx) => {
                const spaces = defect.spaces.join(', ') || '-';
                const desc = defect.description || '-';
                
                tableRows += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px 4px; text-align: center; font-weight: bold; color: #000; font-size: 13px; vertical-align: middle; border-right: 1px solid #e0e0e0;">${idx + 1}</td>
                        <td style="padding: 10px 8px; text-align: center; color: #000; font-weight: 600; font-size: 13px; vertical-align: middle; border-right: 1px solid #e0e0e0;">${spaces}</td>
                        <td style="padding: 10px 8px; color: #000; font-weight: 500; font-size: 12px; word-break: break-word; white-space: normal; line-height: 1.5; vertical-align: middle;">${desc}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="width: 794px; min-height: 1123px; max-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 35px; position: relative; box-sizing: border-box; overflow: hidden;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 18px; color: #000; border-bottom: 3px solid #00D4AA; padding-bottom: 8px; font-weight: 700;">📋 하자점검 목록 (총 ${getCurrentProject().defects.length}건)</h3>
                        <p style="margin: 5px 0 12px 0; font-size: 13px; color: #333; font-weight: 500;">${projectInfo.apartmentName} ${projectInfo.dong}동 ${projectInfo.ho}호</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 13px; margin-bottom: 60px;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #999;">
                                <th style="padding: 12px 4px; width: 8%; color: #000; font-size: 13px; font-weight: bold; border-right: 1px solid #e0e0e0;">No</th>
                                <th style="padding: 12px 4px; width: 20%; color: #000; font-size: 13px; font-weight: bold; border-right: 1px solid #e0e0e0;">공간</th>
                                <th style="padding: 12px 6px; width: 72%; color: #000; font-size: 13px; font-weight: bold;">하자 내용</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>

                    <div style="position: absolute; bottom: 20px; left: 35px; right: 35px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 11px; color: #333; text-align: center;">
                        <div>뷰파인더 | 스마트 셀프 홈체크 플랫폼 | 더홈점검</div>
                    </div>
                </div>
            `;
        }

        // 하자 상세 페이지 생성 (더홈점검 동일)
        function createDefectDetailPage(defects, startIndex, projectInfo) {
            let contentHTML = '';
            
            defects.forEach((defect, idx) => {
                const globalIndex = startIndex + idx + 1;
                const spaces = defect.spaces.join(', ') || '미지정';
                const description = defect.description || '';
                const farPhoto = defect.photos[0] || '';
                const nearPhoto = defect.photos[1] || '';
                
                // 배지 색상 (샘플과 동일)
                const badgeColor = '#00D4AA';
                
                contentHTML += `
                    <div style="margin-bottom: 30px; page-break-inside: avoid;">
                        <!-- 하자 번호, 공간, 내용 (한 줄 배치) -->
                        <div style="background: #f5f5f5; padding: 12px 15px; margin-bottom: 12px; border-left: 4px solid ${badgeColor};">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="background: ${badgeColor}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; flex-shrink: 0;">
                                    #${String(globalIndex).padStart(2, '0')}
                                </div>
                                <div style="font-size: 14px; color: #333; font-weight: 700; flex-shrink: 0;">
                                    ${spaces}
                                </div>
                                ${description ? `
                                    <div style="font-size: 14px; color: #000; font-weight: 700; flex: 1;">
                                        ${description}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- 사진 가로 배치 (크기 확대) -->
                        <div style="display: flex; gap: 12px;">
                            <!-- 원경 -->
                            <div style="flex: 1; position: relative;">
                                ${farPhoto ? `
                                    <div style="position: relative; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden; background: #fafafa;">
                                        <img src="${farPhoto}" style="width: 100%; height: 340px; object-fit: cover; display: block;" />
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: #10B981; color: white; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                            원경
                                        </div>
                                    </div>
                                ` : `
                                    <div style="width: 100%; height: 340px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">
                                        사진 없음
                                    </div>
                                `}
                            </div>

                            <!-- 근경 -->
                            <div style="flex: 1; position: relative;">
                                ${nearPhoto ? `
                                    <div style="position: relative; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden; background: #fafafa;">
                                        <img src="${nearPhoto}" style="width: 100%; height: 340px; object-fit: cover; display: block;" />
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: #10B981; color: white; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                            근경
                                        </div>
                                    </div>
                                ` : `
                                    <div style="width: 100%; height: 340px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">
                                        사진 없음
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 35px 40px 60px 40px; box-sizing: border-box; position: relative;">
                    <!-- 헤더 -->
                    <div style="border-bottom: 3px solid #00D4AA; padding-bottom: 15px; margin-bottom: 25px;">
                        <h2 style="margin: 0 0 8px 0; font-size: 20px; color: #333; font-weight: 700;">하자 상세 리포트 (사진)</h2>
                        <p style="margin: 0; font-size: 13px; color: #666;">${projectInfo.apartmentName} ${projectInfo.dong}동 ${projectInfo.ho}호</p>
                    </div>

                    ${contentHTML}

                    <!-- 하단 -->
                    <div style="position: absolute; bottom: 20px; left: 40px; right: 40px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 10px; color: #999; text-align: center;">
                        <div>THE HOME INSPECTION | 대표: 1668-5222 | 직통: 010-9985-0128</div>
                    </div>
                </div>
            `;
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: '뷰파인더 점검 결과',
                    text: `점검 완료! 발견된 하자: ${getCurrentProject().defects.length}건`,
                    url: window.location.href
                });
            } else {
                showToast('공유 기능을 지원하지 않는 브라우저입니다');
            }
        }

        function showUpgradeModal() {
            showToast('서비스 업그레이드 문의: 010-9985-0128');
        }

        function requestAddon() {
            if (confirm('하자 접수 대행 서비스를 신청하시겠습니까?\n\n전화 연결로 이동합니다.')) {
                window.location.href = 'tel:010-9985-0128';
            }
        }

        // ==================== 토스트 ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (type === 'error' ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
