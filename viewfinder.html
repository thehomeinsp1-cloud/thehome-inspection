<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A1628">
    <meta name="google" content="notranslate">
    <title>뷰파인더 | 스마트 셀프 홈체크</title>
    
    <!-- Pretendard 폰트 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    
    <!-- jsPDF + html2canvas for PDF 생성 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- JSZip for ZIP 다운로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- ExcelJS for 엑셀 생성 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <style>
        :root {
            /* 민트 그린 다크 테마 */
            --primary: #0A1628;
            --primary-light: #1A2940;
            --accent: #00D4AA;
            --accent-light: #00E4BA;
            --accent-glow: rgba(0, 212, 170, 0.2);
            --warning: #FF6B6B;
            --success: #00D4AA;
            --text: #FFFFFF;
            --text-muted: #8892A0;
            --card-bg: rgba(26, 41, 64, 0.8);
            --card-border: rgba(0, 212, 170, 0.15);
            --overlay: rgba(10, 22, 40, 0.95);
            
            /* 사이즈 */
            --header-height: 56px;
            --nav-height: 64px;
            --radius: 12px;
            --radius-sm: 8px;
        }

        /* 라이트 모드 */
        :root.light-mode {
            --primary: #F0F4F8;
            --primary-light: #FFFFFF;
            --accent: #00B894;
            --accent-light: #00D4AA;
            --accent-glow: rgba(0, 184, 148, 0.15);
            --text: #1A202C;
            --text-muted: #718096;
            --card-bg: #FFFFFF;
            --card-border: rgba(0, 184, 148, 0.2);
            --overlay: rgba(240, 244, 248, 0.95);
        }

        :root.light-mode .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        :root.light-mode .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== 배경 효과 ==================== */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: -1;
        }

        /* ==================== 헤더 ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(10, 22, 40, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #00FFD4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-divider {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 300;
        }

        .logo-slogan {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tier-badge {
            padding: 6px 12px;
            background: var(--card-bg);
            border: 1px solid var(--accent);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-icon {
            font-size: 18px;
        }

        /* ==================== 메인 컨텐츠 ==================== */
        .main-content {
            padding-top: calc(var(--header-height) + 20px);
            padding-bottom: calc(var(--nav-height) + 30px);
            padding-left: 20px;
            padding-right: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ==================== 섹션 ==================== */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
        }

        .progress-percent {
            color: var(--accent);
            font-weight: 700;
        }

        .progress-bar {
            height: 8px;
            background: var(--primary-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00FFD4);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-card:active {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ==================== 가격표 섹션 ==================== */
        .pricing-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 24px;
        }

        .pricing-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .pricing-title {
            display: block;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .pricing-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .pricing-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .pricing-card {
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 14px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .pricing-card:active {
            transform: scale(0.98);
        }

        .pricing-card.current {
            border-color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
            cursor: default;
        }

        .pricing-card.popular {
            border-color: #FFB800;
            background: rgba(255, 184, 0, 0.1);
        }

        .pricing-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
        }

        .pricing-card.current .pricing-badge {
            background: var(--accent);
            color: var(--primary);
        }

        .pricing-card.popular .pricing-badge {
            background: #FFB800;
            color: var(--primary);
        }

        .pricing-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            margin-top: 4px;
        }

        .pricing-card.current .pricing-name {
            color: var(--accent);
        }

        .pricing-card.popular .pricing-name {
            color: #FFB800;
        }

        .pricing-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
        }

        .pricing-price span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .pricing-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .pricing-extra {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--card-border);
            font-size: 10px;
            color: var(--accent);
            font-weight: 500;
        }

        .pricing-contact {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding-top: 12px;
            border-top: 1px solid var(--card-border);
        }

        .pricing-contact a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        /* 애드온 섹션 */
        .addon-section {
            margin-top: 16px;
            padding: 14px;
            background: rgba(0, 212, 170, 0.08);
            border: 1px dashed var(--accent);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .addon-section:active {
            transform: scale(0.98);
            background: rgba(0, 212, 170, 0.15);
        }

        .addon-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .addon-badge {
            padding: 2px 6px;
            background: var(--accent);
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            color: var(--primary);
        }

        .addon-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .addon-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .addon-prices {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .addon-price {
            padding: 4px 8px;
            background: var(--primary-light);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .addon-price b {
            color: var(--accent);
            font-weight: 700;
        }

        /* ==================== 단계별 가이드 ==================== */
        .step-guide {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .step-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .step-guide-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .step-guide-hint {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            animation: pulse-hint 2s infinite;
        }

        @keyframes pulse-hint {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(0, 212, 170, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0); }
        }

        .step-cards {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-card {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 10px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step-card.current {
            background: rgba(0, 212, 170, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .step-card.completed {
            background: rgba(0, 212, 170, 0.1);
            border-color: var(--accent);
        }

        .step-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-card:active:not(.locked) {
            transform: scale(0.98);
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-card.locked .step-number {
            background: var(--text-muted);
        }

        .step-card.completed .step-number {
            background: var(--accent);
        }

        .step-content {
            flex: 1;
            min-width: 0;
        }

        .step-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        .step-status {
            font-size: 10px;
            color: var(--text-muted);
        }

        .step-card.current .step-status {
            color: var(--accent);
            font-weight: 600;
        }

        .step-card.completed .step-status {
            color: var(--accent);
        }

        .step-arrow {
            color: var(--text-muted);
            font-size: 12px;
            flex-shrink: 0;
        }

        /* STEP 배지 */
        .step-badge {
            background: var(--accent);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-right: 4px;
        }

        .step-badge.yellow {
            background: #FFB800;
            position: absolute;
            top: -8px;
            left: 12px;
        }

        .start-inspection-btn {
            position: relative;
        }

        /* ==================== 프로젝트 정보 카드 ==================== */
        .project-info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
        }

        .project-info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .project-info-icon {
            font-size: 18px;
        }

        .project-info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .project-info-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .project-input {
            padding: 12px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .project-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .project-input::placeholder {
            color: var(--text-muted);
        }

        .project-input::placeholder {
            color: var(--text-muted);
        }

        .project-input.full {
            width: 100%;
        }

        .project-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .project-input-row .project-input {
            width: 100%;
            box-sizing: border-box;
        }

        /* ==================== 체크리스트 (참고용) ==================== */
        .checklist-spaces {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checklist-space-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checklist-space-card:active {
            transform: scale(0.98);
        }

        .checklist-space-info {
            flex: 1;
        }

        .checklist-space-name {
            font-size: 15px;
            font-weight: 600;
        }

        .checklist-space-arrow {
            color: var(--text-muted);
            font-size: 18px;
        }

        .checklist-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checklist-detail-header h2 {
            flex: 1;
            font-size: 20px;
            font-weight: 700;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 참고용 체크리스트 스타일 */
        .checklist-reference-section {
            margin-bottom: 24px;
        }

        .checklist-position-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(0, 212, 170, 0.1);
            border-radius: 6px;
        }

        .checklist-reference-item {
            font-size: 13px;
            color: var(--text);
            line-height: 1.7;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        /* ==================== 하자점검 시작 버튼 ==================== */
        .start-inspection-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .start-inspection-btn:active {
            transform: scale(0.98);
        }

        .start-inspection-icon {
            font-size: 32px;
        }

        .start-inspection-content {
            flex: 1;
        }

        .start-inspection-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .start-inspection-desc {
            font-size: 13px;
            color: rgba(10, 22, 40, 0.7);
        }

        .start-inspection-arrow {
            font-size: 24px;
            color: var(--primary);
            font-weight: 700;
        }

        /* ==================== 점검 헤더 ==================== */
        .inspection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .inspection-count {
            padding: 8px 16px;
            background: var(--accent);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        /* ==================== 하자 기록 섹션 ==================== */
        .defect-list {
            margin-bottom: 24px;
        }

        .defect-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .defect-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .defect-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 12px;
            position: relative;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-right: 36px;
        }

        .defect-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            margin-right: 8px;
        }

        .defect-location {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .defect-detail {
            font-size: 12px;
            color: var(--accent);
            font-weight: 500;
            margin-left: 8px;
        }

        .defect-type {
            padding: 4px 8px;
            background: rgba(255, 184, 0, 0.2);
            color: #FFB800;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .defect-photos {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .defect-photo {
            width: 70px;
            height: 70px;
            background: var(--primary-light);
            border-radius: 8px;
            object-fit: cover;
        }

        .defect-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .defect-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 107, 107, 0.15);
            border: none;
            border-radius: 8px;
            color: var(--warning);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .defect-delete-btn:active {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(0.95);
        }

        .add-defect-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .add-defect-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* ==================== 하단 네비게이션 ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            opacity: 1;
        }

        .nav-item.active .nav-icon {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* ==================== 하자 등록 전체 화면 ==================== */
        .defect-register-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .defect-register-screen.active {
            display: flex;
        }

        .defect-register-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid var(--card-border);
        }

        .defect-register-title {
            font-size: 18px;
            font-weight: 700;
        }

        .defect-register-close {
            width: 36px;
            height: 36px;
            background: var(--card-bg);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
        }

        .defect-register-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px;
        }

        .defect-register-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: rgba(10, 22, 40, 0.98);
            border-top: 1px solid var(--card-border);
            z-index: 1001;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ==================== 폼 요소 ==================== */
        .form-section {
            margin-bottom: 24px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .form-label-icon {
            font-size: 18px;
        }

        .form-sublabel {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: auto;
        }

        /* ==================== 사진 촬영 영역 ==================== */
        .photo-capture-area {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .photo-capture-box {
            flex: 1;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .photo-capture-box.far {
            border-color: var(--accent);
        }

        .photo-capture-box.near {
            border-color: #FFB800;
        }

        .photo-capture-box.has-photo {
            border-style: solid;
        }

        .photo-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-empty:active {
            transform: scale(0.98);
            background: rgba(0,0,0,0.05);
        }

        .photo-buttons {
            display: flex;
            border-top: 1px dashed var(--card-border);
        }

        .photo-capture-box.far .photo-buttons {
            border-color: var(--accent);
        }

        .photo-capture-box.near .photo-buttons {
            border-color: #FFB800;
        }

        .photo-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            background: var(--primary-light);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-btn:first-child {
            border-right: 1px solid var(--card-border);
        }

        .photo-capture-box.far .photo-btn.primary {
            background: var(--accent);
            color: var(--primary);
        }

        .photo-capture-box.near .photo-btn.primary {
            background: #FFB800;
            color: var(--primary);
        }

        .photo-btn:active {
            opacity: 0.8;
        }

        /* 사진 있을 때 버튼 */
        .photo-actions {
            display: flex;
            border-top: 1px solid var(--card-border);
        }

        .photo-action-btn {
            flex: 1;
            padding: 10px 6px;
            border: none;
            background: var(--primary-light);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid var(--card-border);
        }

        .photo-action-btn:last-child {
            border-right: none;
        }

        .photo-action-btn.delete {
            background: rgba(255, 100, 100, 0.2);
            color: #FF6B6B;
        }

        .photo-action-btn:active {
            opacity: 0.8;
        }

        /* ==================== 심플 사진 박스 (퀵모드 스타일) ==================== */
        .photo-capture-area-simple {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .photo-box-simple {
            flex: 1;
            aspect-ratio: 4/3;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .photo-box-simple:active {
            transform: scale(0.98);
        }

        .photo-box-simple.far {
            border-color: var(--accent);
        }

        .photo-box-simple.near {
            border-color: #FFB800;
        }

        .photo-box-simple.has-photo {
            border-style: solid;
        }

        .photo-box-simple.has-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .photo-box-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .photo-box-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .photo-box-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .photo-box-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .photo-box-simple.near .photo-box-badge {
            background: #FFB800;
        }

        .photo-box-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(255, 107, 107, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .gallery-buttons {
            display: flex;
            gap: 10px;
        }

        .gallery-btn {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .gallery-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .photo-image-wrapper {
            position: relative;
            flex: 1;
            min-height: 140px;
            overflow: hidden;
        }

        .photo-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-capture-box.has-photo.far {
            border-color: var(--accent);
        }

        .photo-capture-box.has-photo.near {
            border-color: #FFB800;
        }

        .photo-capture-icon {
            font-size: 28px;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        .photo-capture-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .photo-capture-sublabel {
            font-size: 10px;
            color: var(--text-muted);
        }

        .photo-capture-box.far .photo-capture-label {
            color: var(--accent);
        }

        .photo-capture-box.near .photo-capture-label {
            color: #FFB800;
        }

        .photo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        .photo-badge.far {
            background: rgba(0, 212, 170, 0.95);
            color: white;
        }

        .photo-badge.near {
            background: rgba(255, 184, 0, 0.95);
            color: white;
        }

        /* ==================== 터치 버튼 그리드 ==================== */
        .touch-btn-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .touch-btn {
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .touch-btn:active {
            transform: scale(0.95);
        }

        .touch-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
            font-weight: 700;
        }

        .touch-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 커스텀 공간 (삭제 가능) */
        .touch-btn.custom {
            position: relative;
            padding-right: 28px;
        }

        .touch-btn.custom .delete-custom {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            background: rgba(255, 107, 107, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 11px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .touch-btn.custom.selected .delete-custom {
            background: rgba(0, 0, 0, 0.3);
        }

        /* 공간 추가 버튼 */
        .add-space-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: transparent;
            border: 1px dashed var(--card-border);
            border-radius: var(--radius);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-space-btn:active {
            background: var(--card-bg);
            border-color: var(--accent);
            color: var(--accent);
        }

        .selected-count {
            font-size: 12px;
            color: var(--accent);
            margin-left: auto;
        }

        /* ==================== 음성 입력 영역 ==================== */
        .voice-input-area {
            position: relative;
        }

        .voice-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            padding-right: 60px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
        }

        .voice-textarea::placeholder {
            color: var(--text-muted);
        }

        .voice-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .voice-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--primary-light);
            border-radius: 6px;
        }

        /* ==================== 저장 버튼 ==================== */
        .save-defect-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .save-defect-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .save-defect-btn:disabled {
            background: var(--card-bg);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ==================== 카메라 모달 ==================== */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-preview-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 카메라 가이드 제거됨 */

        .camera-guide-text {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .camera-guide-text.far {
            background: var(--accent);
            color: var(--primary);
        }

        .camera-guide-text.near {
            background: #FFB800;
            color: var(--primary);
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 30px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            background: rgba(0, 0, 0, 0.8);
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s ease;
        }

        .camera-btn:active {
            transform: scale(0.9);
        }

        .camera-btn.capture {
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
        }

        .camera-btn.close {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
        }

        .camera-btn.gallery {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
            font-size: 22px;
        }

        .camera-bottom-hint {
            display: flex;
            justify-content: center;
            gap: 80px;
            padding-bottom: 10px;
            background: rgba(0, 0, 0, 0.8);
        }

        .camera-bottom-hint span {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        /* 줌 컨트롤 제거됨 */

        /* 마커 캔버스 */
        .marker-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .marker-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 212, 170, 0.9);
            border-radius: 20px;
            color: #0A1628;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .marker-hint.hidden {
            opacity: 0;
        }

        .camera-btn.reset {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            color: white;
            font-size: 20px;
        }

        /* ==================== 토스트 ==================== */
        .toast {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary-light);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 400;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* ==================== 사진 옵션 액션시트 ==================== */
        .photo-action-sheet {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3000;
            display: none;
        }

        .photo-action-sheet.active {
            display: block;
        }

        .photo-action-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .photo-action-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .photo-action-sheet.active .photo-action-content {
            transform: translateY(0);
        }

        .photo-action-title {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .photo-action-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-light);
            border: none;
            border-radius: var(--radius);
            color: var(--text);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            -webkit-tap-highlight-color: transparent;
        }

        .photo-action-btn:active {
            background: var(--card-border);
        }

        .photo-action-btn.cancel {
            background: transparent;
            color: var(--text-muted);
            margin-bottom: 0;
        }

        /* ==================== 업셀링 카드 ==================== */
        .upsell-card {
            background: linear-gradient(135deg, #1A2D4A, #0A1628);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .upsell-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 0% 0%, var(--accent-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(255, 107, 107, 0.1) 0%, transparent 50%);
        }

        .upsell-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--warning);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
        }

        .upsell-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
        }

        .upsell-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 16px;
            position: relative;
            line-height: 1.6;
        }

        .upsell-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: var(--primary);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
        }

        /* ==================== 리포트 섹션 ==================== */
        .report-project-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .report-project-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .report-project-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .report-project-row:first-child {
            padding-top: 0;
        }

        .report-project-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .report-project-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .report-info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .report-info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .report-info-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .report-input-group label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .report-input-group input {
            padding: 12px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .report-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .report-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .report-summary-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .report-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .report-summary-header span:first-child {
            font-size: 14px;
            color: var(--text-muted);
        }

        .report-summary-count {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
        }

        .report-summary-bar {
            height: 6px;
            background: var(--primary-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .report-summary-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00FFD4);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .report-summary-detail {
            display: flex;
            justify-content: space-around;
        }

        .report-stat {
            text-align: center;
        }

        .report-stat-value {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .report-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .report-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-btn {
            padding: 16px;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .report-btn.primary {
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            color: var(--primary);
        }

        .report-btn.secondary {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .report-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== 이메일 전송 섹션 ==================== */
        .email-send-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 180, 148, 0.05));
            border: 2px solid var(--accent);
            border-radius: 16px;
        }

        .email-send-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .email-send-icon {
            font-size: 32px;
        }

        .email-send-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .email-send-desc {
            font-size: 13px;
            color: var(--text-muted);
        }

        .email-send-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00B894);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .email-send-btn:active {
            transform: scale(0.98);
        }

        /* ==================== 로딩 오버레이 ==================== */

        /* ==================== 카카오톡 인앱브라우저 감지 ==================== */
        .inapp-browser-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .inapp-browser-overlay.active {
            display: flex;
        }

        .inapp-browser-popup {
            background: var(--primary-light);
            border-radius: 20px;
            padding: 30px 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            border: 2px solid var(--accent);
        }

        .inapp-browser-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .inapp-browser-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 12px 0;
        }

        .inapp-browser-desc {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
            margin: 0 0 24px 0;
        }

        .inapp-browser-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .inapp-browser-btn {
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }

        .inapp-browser-btn:active {
            transform: scale(0.98);
        }

        .inapp-browser-btn.primary {
            background: linear-gradient(135deg, var(--accent), #00B894);
            color: #000;
        }

        .inapp-browser-btn.secondary {
            background: var(--card-bg);
            color: var(--text-muted);
            border: 1px solid var(--card-border);
        }

        .inapp-browser-manual {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            text-align: left;
        }

        .inapp-browser-manual-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }

        .inapp-browser-manual-step {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .inapp-browser-manual-step:last-child {
            margin-bottom: 0;
        }

        .inapp-browser-manual-step .step-num {
            width: 22px;
            height: 22px;
            background: var(--accent);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .inapp-browser-manual-step b {
            color: var(--text);
        }

        /* 홈화면 추가 안내 스타일 */
        .add-home-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .add-home-step {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 14px;
            text-align: left;
        }

        .add-home-step-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
        }

        /* ==================== 라이선스 인증 화면 ==================== */
        .license-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, #0D2137 100%);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .license-overlay.active {
            display: flex;
        }

        .license-container {
            width: 100%;
            max-width: 400px;
        }

        .license-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .license-logo {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .license-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
            margin: 0 0 8px 0;
        }

        .license-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        .license-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--card-border);
        }

        .license-input-section {
            margin-bottom: 20px;
        }

        .license-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }

        .license-input {
            width: 100%;
            padding: 16px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: var(--primary);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            color: var(--text);
            outline: none;
            transition: all 0.2s ease;
        }

        .license-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.2);
        }

        .license-input::placeholder {
            color: var(--text-muted);
            letter-spacing: 2px;
            font-size: 16px;
        }

        .license-input-hint {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
        }

        .license-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
        }

        .license-btn.primary {
            background: linear-gradient(135deg, var(--accent), #00B894);
            color: #000;
        }

        .license-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .license-btn.secondary {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--card-border);
        }

        .license-error {
            padding: 12px;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            color: #FF6B6B;
            font-size: 13px;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }

        .license-error.show {
            display: block;
        }

        .license-contact {
            text-align: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }

        .license-contact p {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0 0 8px 0;
        }

        .license-contact a {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        /* 라이선스 상태 카드 */
        .license-status-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .license-status-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .license-status-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .license-status-info {
            background: var(--primary);
            border-radius: 12px;
            padding: 16px;
        }

        .license-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .license-info-row:last-child {
            border-bottom: none;
        }

        .license-info-row.highlight {
            background: rgba(0, 212, 170, 0.1);
            margin: 8px -16px -16px -16px;
            padding: 12px 16px;
            border-radius: 0 0 12px 12px;
            border-bottom: none;
        }

        .license-info-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .license-info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .license-info-row.highlight .license-info-value {
            color: var(--accent);
            font-size: 16px;
        }

        /* ==================== 로딩 오버레이 본체 ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 500;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--card-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text);
            font-size: 14px;
        }

        /* ==================== 온보딩 랜딩 ==================== */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .onboarding-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .onboarding-scroll {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 히어로 섹션 */
        .onboarding-hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 60px 24px;
            position: relative;
        }

        .onboarding-badge {
            display: inline-block;
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .onboarding-title {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 20px;
            color: var(--text);
        }

        .onboarding-title .highlight {
            color: var(--accent);
        }

        .onboarding-desc {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            max-width: 300px;
        }

        .onboarding-scroll-hint {
            position: absolute;
            bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .scroll-arrow {
            font-size: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }

        /* 섹션 공통 */
        .onboarding-section {
            padding: 60px 24px;
            border-top: 1px solid var(--card-border);
        }

        .onboarding-section-title {
            font-size: 24px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 32px;
            color: var(--text);
        }

        /* 특징 그리드 */
        .onboarding-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .onboarding-feature {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
        }

        .onboarding-feature-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .onboarding-feature-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .onboarding-feature-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* 단계 */
        .onboarding-steps {
            max-width: 350px;
            margin: 0 auto;
        }

        .onboarding-step {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .onboarding-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 20px;
            top: 48px;
            width: 2px;
            height: calc(100% - 10px);
            background: linear-gradient(to bottom, var(--accent), transparent);
        }

        .onboarding-step-num {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--accent), #00B894);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .onboarding-step-content {
            padding-top: 4px;
        }

        .onboarding-step-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .onboarding-step-desc {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* 촬영 팁 카드 */
        .onboarding-tip-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            max-width: 350px;
            margin: 0 auto;
        }

        .onboarding-photo-guide {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .photo-guide-item {
            text-align: center;
        }

        .photo-guide-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .photo-guide-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .photo-guide-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .photo-guide-plus {
            font-size: 24px;
            color: var(--text-muted);
        }

        .onboarding-tip-note {
            background: rgba(0, 212, 170, 0.1);
            border-radius: 10px;
            padding: 12px;
            font-size: 13px;
            color: var(--text);
            text-align: center;
        }

        /* 가격 */
        .onboarding-pricing {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 350px;
            margin: 0 auto 24px;
        }

        .onboarding-price-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .onboarding-price-card.featured {
            border-color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
        }

        .price-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: var(--accent);
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }

        .price-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            width: 70px;
        }

        .price-amount {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
        }

        .price-amount span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .price-desc {
            flex: 1;
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }

        /* 애드온 */
        .onboarding-addon {
            background: rgba(255, 184, 0, 0.1);
            border: 2px dashed rgba(255, 184, 0, 0.5);
            border-radius: 14px;
            padding: 16px;
            max-width: 350px;
            margin: 0 auto;
            text-align: center;
        }

        .addon-label {
            display: inline-block;
            background: #FFB800;
            color: #000;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .addon-title {
            font-size: 16px;
            font-weight: 700;
            color: #FFB800;
            margin-bottom: 12px;
        }

        .addon-prices {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .addon-prices span {
            background: var(--card-bg);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .addon-prices b {
            color: #FFB800;
        }

        /* CTA 섹션 */
        .onboarding-cta {
            background: linear-gradient(135deg, var(--accent), #00B894);
            padding: 60px 24px;
            text-align: center;
        }

        .onboarding-cta-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .onboarding-cta-desc {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 28px;
        }

        .onboarding-start-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--primary);
            color: var(--text);
            padding: 18px 48px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .onboarding-start-btn:active {
            transform: scale(0.95);
        }

        .onboarding-contact {
            margin-top: 20px;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
        }

        .onboarding-contact a {
            color: var(--primary);
            font-weight: 700;
            text-decoration: none;
        }

        /* 레거시 튜토리얼 호환 */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }

        .tutorial-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .tutorial-slides {
            flex: 1;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .tutorial-slides::-webkit-scrollbar {
            display: none;
        }

        .tutorial-slide {
            min-width: 100%;
            scroll-snap-align: start;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
        }

        .tutorial-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .tutorial-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .tutorial-desc {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            max-width: 300px;
        }

        .tutorial-highlight {
            color: var(--accent);
            font-weight: 600;
        }

        .tutorial-image-box {
            width: 200px;
            height: 140px;
            background: var(--primary-light);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .tutorial-image-box .far-label,
        .tutorial-image-box .near-label {
            position: absolute;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .tutorial-image-box .far-label {
            top: 10px;
            left: 10px;
        }

        .tutorial-image-box .near-label {
            bottom: 10px;
            right: 10px;
            background: #FFB800;
        }

        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .tutorial-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
        }

        .tutorial-step-num {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .tutorial-step-text {
            font-size: 14px;
            color: var(--text);
        }

        .tutorial-bottom {
            padding: 20px 30px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .tutorial-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .tutorial-dot.active {
            opacity: 1;
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .tutorial-buttons {
            display: flex;
            gap: 12px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .tutorial-btn.skip {
            background: var(--primary-light);
            color: var(--text-muted);
            border: 1px solid var(--card-border);
        }

        .tutorial-btn.next {
            background: linear-gradient(135deg, var(--accent), #00A080);
            color: var(--primary);
        }

        .tutorial-btn:active {
            transform: scale(0.98);
        }

        .tutorial-tip-box {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 20px;
        }

        .tutorial-tip-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .tutorial-tip-content {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* 튜토리얼 - 퀵모드 vs 상세입력 박스 */
        .tutorial-mode-box {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .tutorial-mode {
            flex: 1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

        .tutorial-mode-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .tutorial-mode-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
        }

        .tutorial-mode-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* 튜토리얼 - 체크리스트 미리보기 */
        .tutorial-checklist-preview {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 14px;
            margin: 16px 0;
        }

        .tutorial-checklist-item {
            font-size: 13px;
            color: var(--text);
            padding: 8px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .tutorial-checklist-item:last-child {
            border-bottom: none;
        }

        /* 튜토리얼 - 기능 리스트 */
        .tutorial-feature-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .tutorial-feature {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            text-align: center;
        }

        /* 튜토리얼 - 시작 요약 */
        .tutorial-start-summary {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }

        .tutorial-start-item {
            font-size: 13px;
            color: var(--text);
            padding: 8px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .tutorial-start-item:last-child {
            border-bottom: none;
        }

        /* 튜토리얼 - 마커 데모 */
        .tutorial-marker-demo {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 24px 0;
        }

        .tutorial-marker-demo .marker-circle {
            width: 40px;
            height: 40px;
            border: 3px solid var(--accent);
            border-radius: 50%;
            animation: markerPulse 1.5s ease-in-out infinite;
        }

        .tutorial-marker-demo .marker-circle:nth-child(2) {
            animation-delay: 0.3s;
        }

        .tutorial-marker-demo .marker-circle:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes markerPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* ==================== 퀵모드 ==================== */
        .quick-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .quick-mode-overlay.active {
            display: flex;
        }

        .quick-mode-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .quick-mode-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .quick-mode-count {
            font-size: 14px;
            color: var(--text-muted);
        }

        .quick-mode-close {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 진행 바 스타일 */
        .quick-step-bar {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 184, 148, 0.05));
            border-bottom: 1px solid var(--card-border);
        }

        .quick-step-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin-bottom: 12px;
        }

        .quick-step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .quick-step-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 212, 170, 0.2);
        }

        .quick-step-dot.completed {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .quick-step-line {
            width: 40px;
            height: 3px;
            background: var(--card-border);
            transition: background 0.3s ease;
        }

        .quick-step-line.completed {
            background: var(--accent);
        }

        .quick-step-guide {
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            animation: pulseText 2s ease-in-out infinite;
        }

        @keyframes pulseText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 홈 진행 바 스타일 (간소화) */
        .home-step-bar-mini {
            display: flex;
            justify-content: center;
            padding: 12px 0;
            margin-bottom: 12px;
        }

        .home-step-bar-mini .home-step-progress {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 0;
        }

        .home-step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .home-step-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.2);
            transform: scale(1.1);
        }

        .home-step-dot.completed {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .home-step-line {
            width: 40px;
            height: 3px;
            background: var(--card-border);
            transition: background 0.3s ease;
        }

        .home-step-line.completed {
            background: var(--accent);
        }

        /* 플로우 카드 가이드 */
        .flow-card-guide {
            padding: 10px 15px;
            margin: 0 -15px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 184, 148, 0.05));
            border-bottom: 1px solid var(--card-border);
            font-size: 13px;
            color: var(--accent);
            font-weight: 500;
            display: none;
        }

        .flow-card.home-section-active .flow-card-guide {
            display: block;
            animation: pulseText 2s ease-in-out infinite;
        }

        /* 홈 섹션 활성화/비활성화 */
        .flow-card.home-section-dimmed {
            opacity: 0.4;
            pointer-events: none;
            transform: scale(0.98);
        }

        .flow-card.home-section-active {
            opacity: 1;
            pointer-events: auto;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        /* 섹션 스타일 */
        .quick-section {
            transition: all 0.3s ease;
        }

        .quick-section.dimmed {
            opacity: 0.4;
            pointer-events: none;
        }

        .quick-section.dimmed .touch-btn,
        .quick-section.dimmed .quick-mode-memo {
            pointer-events: none;
        }

        .quick-section.active {
            opacity: 1;
            pointer-events: auto;
        }

        .quick-section-optional-label {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding: 8px 0;
            border-top: 1px dashed var(--card-border);
            margin-bottom: 8px;
        }

        .quick-mode-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .quick-mode-photo-area {
            display: flex;
            gap: 12px;
        }

        .quick-mode-photo-box {
            flex: 1;
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .quick-mode-photo-box.has-photo {
            border-style: solid;
            border-color: var(--accent);
        }

        .quick-mode-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .quick-mode-photo-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-mode-photo-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .quick-mode-photo-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .quick-mode-photo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }

        .quick-mode-photo-box.near .quick-mode-photo-badge {
            background: #FFB800;
        }

        .quick-mode-photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(255, 107, 107, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-mode-memo {
            width: 100%;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
        }

        .quick-mode-memo:focus {
            outline: none;
            border-color: var(--accent);
        }

        .quick-mode-memo::placeholder {
            color: var(--text-muted);
        }

        .quick-mode-space-select {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px;
        }

        .quick-mode-space-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .quick-mode-space-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-mode-space-chip {
            padding: 8px 14px;
            background: var(--primary-light);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-mode-space-chip.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .quick-mode-footer {
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--card-border);
            display: flex;
            gap: 12px;
        }

        .quick-mode-btn {
            flex: 1;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-mode-btn.save {
            background: linear-gradient(135deg, var(--accent), #00A080);
            color: var(--primary);
        }

        .quick-mode-btn.save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-mode-btn.continue {
            background: var(--card-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .quick-mode-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* 퀵모드 진입 버튼 */
        .quick-mode-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .quick-mode-entry-btn {
            flex: 1;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-mode-entry-btn.highlight {
            background: linear-gradient(135deg, #FFB800, #FF9500);
            border: none;
            color: #000;
        }

        .quick-mode-entry-btn:active {
            transform: scale(0.98);
        }

        .quick-mode-saved-list {
            margin-top: 16px;
        }

        .quick-mode-saved-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-mode-saved-badge {
            padding: 2px 8px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            border-radius: 10px;
        }

        /* ==================== 설정 메뉴 ==================== */
        .settings-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-sheet {
            background: var(--primary-light);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
        }

        .settings-close {
            width: 32px;
            height: 32px;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-item:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .settings-item.danger {
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .settings-item-icon {
            font-size: 24px;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .settings-item-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .settings-item.danger .settings-item-title {
            color: var(--warning);
        }

        /* 설정 - 라이선스 정보 */
        .settings-license-info {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 184, 148, 0.05));
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-license-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .settings-license-icon {
            font-size: 20px;
        }

        .settings-license-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
        }

        .settings-license-details {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
        }

        .settings-license-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 6px 0;
        }

        .settings-license-row:first-child {
            padding-top: 0;
        }

        .settings-license-row:last-child {
            padding-bottom: 0;
        }

        .settings-license-row span:first-child {
            color: var(--text-muted);
        }

        .settings-license-row span:last-child {
            font-weight: 600;
            color: var(--text);
        }

        /* ==================== 이메일 전송 모달 ==================== */
        #emailSendModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #emailSendModal.active {
            display: flex;
        }

        #emailSendModal .modal-content {
            background: var(--primary-light);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #emailSendModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--card-border);
        }

        #emailSendModal .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .email-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--card-border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .email-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .email-input::placeholder {
            color: var(--text-muted);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .checkbox-text {
            font-size: 14px;
            color: var(--text);
        }

        .send-email-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #00B894);
            color: #000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, opacity 0.2s;
        }

        .send-email-btn:active {
            transform: scale(0.98);
        }

        .send-email-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ==================== 홈 퀵모드 버튼 ==================== */
        .home-mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .home-mode-btn {
            padding: 20px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: none;
        }

        .home-mode-btn.quick {
            background: linear-gradient(135deg, #FFB800, #FF9500);
            color: #000;
        }

        .home-mode-btn.detail {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .home-mode-btn:active {
            transform: scale(0.98);
        }

        .home-mode-btn-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .home-mode-btn-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .home-mode-btn-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        /* ==================== 빈 상태 개선 ==================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .empty-state-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .empty-state-btn:active {
            transform: scale(0.98);
        }

        /* ==================== 메인 플로우 카드 ==================== */
        .flow-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .flow-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .flow-step-badge {
            background: linear-gradient(135deg, var(--accent), #00B894);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
        }

        .flow-step-title {
            flex: 1;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }

        .flow-step-status {
            font-size: 13px;
            color: var(--text-muted);
            background: var(--primary-light);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .flow-step-status.done {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent);
        }

        .flow-card-body {
            padding: 16px;
        }

        .flow-action-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.15), rgba(0, 184, 148, 0.1));
            border: 2px solid var(--accent);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flow-action-btn:active {
            transform: scale(0.98);
            background: rgba(0, 212, 170, 0.25);
        }

        .flow-action-icon {
            font-size: 32px;
        }

        .flow-action-text {
            flex: 1;
            text-align: left;
        }

        .flow-action-text strong {
            display: block;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }

        .flow-action-text small {
            font-size: 12px;
            color: var(--text-muted);
        }

        .flow-action-arrow {
            font-size: 20px;
            color: var(--accent);
            font-weight: 700;
        }

        .flow-defect-preview {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .flow-defect-preview:empty {
            display: none;
        }

        .flow-defect-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--card-border);
            flex-shrink: 0;
        }

        .flow-defect-more {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: var(--primary-light);
            border: 2px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* 보조 메뉴 섹션 */
        .sub-menu-section {
            margin: 24px 0;
            padding-top: 20px;
            border-top: 1px solid var(--card-border);
        }

        .sub-menu-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .sub-menu-buttons {
            display: flex;
            gap: 12px;
        }

        .sub-menu-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-menu-btn:active {
            transform: scale(0.98);
            background: var(--primary-light);
        }

        .sub-menu-btn span {
            font-size: 18px;
        }

        /* ==================== 프로젝트 관리 ==================== */
        .project-selector {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-selector:active {
            transform: scale(0.99);
            background: var(--primary-light);
        }

        .project-selector-left {
            flex: 1;
            min-width: 0;
        }

        .project-selector-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .project-selector-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-icon {
            font-size: 18px;
            color: var(--accent);
        }

        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: flex-end;
        }

        .project-modal-overlay.active {
            display: flex;
        }

        .project-modal-sheet {
            background: var(--primary-light);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .project-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .project-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .project-item {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .project-item.active {
            border-color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
        }

        .project-item:active {
            transform: scale(0.98);
        }

        .project-item-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            background: var(--accent);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
        }

        .project-item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            padding-right: 60px;
        }

        .project-item-info {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .project-item-stats {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .project-stat {
            padding: 6px 12px;
            background: var(--primary-light);
            border-radius: 6px;
            font-size: 12px;
        }

        .project-stat-value {
            color: var(--accent);
            font-weight: 600;
            margin-right: 4px;
        }

        .project-delete-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 6px 12px;
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 6px;
            color: var(--warning);
            font-size: 12px;
            cursor: pointer;
        }

        .project-delete-btn:active {
            background: rgba(255, 107, 107, 0.3);
        }

        .project-add-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00A080);
            border: none;
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: calc(16px + env(safe-area-inset-bottom));
        }

        .project-add-btn:active {
            transform: scale(0.98);
        }

    </style>
</head>
<body>
    <!-- ==================== 온보딩 랜딩 ==================== -->
    <div class="onboarding-overlay" id="tutorialOverlay">
        <div class="onboarding-scroll">
            <!-- 히어로 섹션 -->
            <section class="onboarding-hero">
                <span class="onboarding-badge">✨ 셀프 하자점검 앱</span>
                <h1 class="onboarding-title">
                    신축 아파트 하자<br>
                    <span class="highlight">직접 찾고 기록</span>하세요
                </h1>
                <p class="onboarding-desc">
                    체계적인 하자 기록부터 PDF 보고서 생성,<br>
                    하자접수 대행까지 한 번에
                </p>
                <div class="onboarding-scroll-hint">
                    <span>아래로 스크롤</span>
                    <span class="scroll-arrow">↓</span>
                </div>
            </section>

            <!-- 특징 섹션 -->
            <section class="onboarding-section">
                <h2 class="onboarding-section-title">왜 뷰파인더인가요?</h2>
                <div class="onboarding-features">
                    <div class="onboarding-feature">
                        <div class="onboarding-feature-icon">📸</div>
                        <div class="onboarding-feature-title">원경 + 근경 촬영</div>
                        <div class="onboarding-feature-desc">하자 위치와 상세 모습을 2장으로 체계적으로 기록</div>
                    </div>
                    <div class="onboarding-feature">
                        <div class="onboarding-feature-icon">⚡</div>
                        <div class="onboarding-feature-title">퀵모드</div>
                        <div class="onboarding-feature-desc">발견 즉시 빠르게 촬영, 상세 정보는 나중에</div>
                    </div>
                    <div class="onboarding-feature">
                        <div class="onboarding-feature-icon">📄</div>
                        <div class="onboarding-feature-title">PDF 보고서</div>
                        <div class="onboarding-feature-desc">전문적인 형식의 보고서, 시공사 제출용으로 완벽</div>
                    </div>
                    <div class="onboarding-feature">
                        <div class="onboarding-feature-icon">📧</div>
                        <div class="onboarding-feature-title">간편 전송</div>
                        <div class="onboarding-feature-desc">이메일 한 번으로 전체 자료 전송</div>
                    </div>
                </div>
            </section>

            <!-- 사용 방법 섹션 -->
            <section class="onboarding-section">
                <h2 class="onboarding-section-title">이렇게 사용하세요</h2>
                <div class="onboarding-steps">
                    <div class="onboarding-step">
                        <div class="onboarding-step-num">1</div>
                        <div class="onboarding-step-content">
                            <div class="onboarding-step-title">정보 입력</div>
                            <div class="onboarding-step-desc">아파트명, 동호수, 점검일 입력</div>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <div class="onboarding-step-num">2</div>
                        <div class="onboarding-step-content">
                            <div class="onboarding-step-title">하자 촬영</div>
                            <div class="onboarding-step-desc">발견한 하자를 원경/근경으로 촬영</div>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <div class="onboarding-step-num">3</div>
                        <div class="onboarding-step-content">
                            <div class="onboarding-step-title">보고서 생성</div>
                            <div class="onboarding-step-desc">버튼 하나로 PDF 보고서 완성</div>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <div class="onboarding-step-num">4</div>
                        <div class="onboarding-step-content">
                            <div class="onboarding-step-title">자료 전송</div>
                            <div class="onboarding-step-desc">이메일로 간편하게 전송</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 촬영 팁 섹션 -->
            <section class="onboarding-section">
                <h2 class="onboarding-section-title">📸 촬영 팁</h2>
                <div class="onboarding-tip-card">
                    <div class="onboarding-photo-guide">
                        <div class="photo-guide-item">
                            <div class="photo-guide-icon">🖼️</div>
                            <div class="photo-guide-label">원경</div>
                            <div class="photo-guide-desc">전체 위치가 보이게</div>
                        </div>
                        <div class="photo-guide-plus">+</div>
                        <div class="photo-guide-item">
                            <div class="photo-guide-icon">🔍</div>
                            <div class="photo-guide-label">근경</div>
                            <div class="photo-guide-desc">하자 부위 가까이서</div>
                        </div>
                    </div>
                    <div class="onboarding-tip-note">
                        💡 촬영 중 화면 터치 → 하자 위치에 마커 표시
                    </div>
                </div>
            </section>

            <!-- 서비스 안내 섹션 -->
            <section class="onboarding-section">
                <h2 class="onboarding-section-title">서비스 안내</h2>
                <div class="onboarding-pricing">
                    <div class="onboarding-price-card featured">
                        <div class="price-badge">추천</div>
                        <div class="price-name">Self</div>
                        <div class="price-amount">4.9<span>만원~</span></div>
                        <div class="price-desc">PRO키트 대여 (3시간) + 앱 이용권</div>
                    </div>
                    <div class="onboarding-price-card">
                        <div class="price-badge">BEST</div>
                        <div class="price-name">Assist</div>
                        <div class="price-amount">7.9<span>만원</span></div>
                        <div class="price-desc">+ 매니저 현장 방문</div>
                    </div>
                    <div class="onboarding-price-card">
                        <div class="price-name">Pro</div>
                        <div class="price-amount">9.9<span>만원~</span></div>
                        <div class="price-desc">+ 건축전문가 동행</div>
                    </div>
                </div>
                <div class="onboarding-addon">
                    <div class="addon-label">ADD-ON</div>
                    <div class="addon-title">하자접수 대행</div>
                    <div class="addon-prices">
                        <span>50건↓ <b>3만</b></span>
                        <span>100건↓ <b>5만</b></span>
                        <span>100건↑ <b>6만~</b></span>
                    </div>
                </div>
            </section>

            <!-- CTA 섹션 -->
            <section class="onboarding-cta">
                <h2 class="onboarding-cta-title">지금 바로 시작하세요</h2>
                <p class="onboarding-cta-desc">입주 점검, 뷰파인더와 함께라면 어렵지 않아요</p>
                <button class="onboarding-start-btn" onclick="showTutorial()">
                    🚀 사용법 보기
                </button>
            </section>
        </div>
    </div>

    <!-- ==================== 튜토리얼 (사용법) ==================== -->
    <div class="tutorial-overlay" id="tutorialSlideOverlay">
        <div class="tutorial-slides" id="tutorialSlides">
            <!-- 슬라이드 1: 환영 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">👋</div>
                <h2 class="tutorial-title">사용법을<br>알려드릴게요</h2>
                <p class="tutorial-desc">
                    간단한 사용법만 익히면<br>
                    바로 점검을 시작할 수 있어요
                </p>
            </div>

            <!-- 슬라이드 2: 정보 입력 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">🏠</div>
                <h2 class="tutorial-title">아파트 정보 입력</h2>
                <p class="tutorial-desc">
                    <span class="tutorial-highlight">홈</span> 탭에서<br>
                    아파트명, 동호수, 점검일을 입력하세요
                </p>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">💡 팁</div>
                    <div class="tutorial-tip-content">
                        여러 세대를 점검할 땐<br>
                        프로젝트를 추가로 만드세요
                    </div>
                </div>
            </div>

            <!-- 슬라이드 3: 촬영 방법 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">📸</div>
                <h2 class="tutorial-title">하자 촬영하기</h2>
                <div class="tutorial-steps" style="text-align: left; margin-top: 20px;">
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">1</span>
                        <span class="tutorial-step-text">하자 발견 → 촬영 버튼</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">2</span>
                        <span class="tutorial-step-text">원경 촬영 (전체 위치)</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">3</span>
                        <span class="tutorial-step-text">근경 촬영 (하자 부위)</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-num">4</span>
                        <span class="tutorial-step-text">저장 → 다음 하자로</span>
                    </div>
                </div>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">💡 팁</div>
                    <div class="tutorial-tip-content">
                        저장 후 자동으로 다음 촬영이 시작돼요
                    </div>
                </div>
            </div>

            <!-- 슬라이드 4: 사진 2장 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">📸</div>
                <h2 class="tutorial-title">사진은 2장씩</h2>
                <div class="tutorial-image-box">
                    <span class="far-label">📸 원경</span>
                    <span style="font-size: 40px; opacity: 0.3;">🖼️</span>
                    <span class="near-label">🔍 근경</span>
                </div>
                <p class="tutorial-desc">
                    <span class="tutorial-highlight">원경</span>: 전체 위치가 보이게<br>
                    <span class="tutorial-highlight">근경</span>: 하자 부위 가까이서
                </p>
            </div>

            <!-- 슬라이드 5: 마커 기능 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">👆</div>
                <h2 class="tutorial-title">마커로 표시하세요</h2>
                <p class="tutorial-desc">
                    촬영 중 화면을 <span class="tutorial-highlight">터치</span>하면<br>
                    하자 위치에 마커가 표시됩니다
                </p>
                <div class="tutorial-marker-demo">
                    <div class="marker-circle"></div>
                    <div class="marker-circle"></div>
                    <div class="marker-circle"></div>
                </div>
                <div class="tutorial-tip-box">
                    <div class="tutorial-tip-title">💡 팁</div>
                    <div class="tutorial-tip-content">
                        마커는 사진에 함께 저장돼요
                    </div>
                </div>
            </div>

            <!-- 슬라이드 6: 리포트 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">📄</div>
                <h2 class="tutorial-title">보고서 생성 & 전송</h2>
                <p class="tutorial-desc">
                    점검이 끝나면 <span class="tutorial-highlight">리포트</span> 탭에서
                </p>
                <div class="tutorial-feature-list">
                    <div class="tutorial-feature">📄 PDF 보고서 생성</div>
                    <div class="tutorial-feature">📦 전체 자료 다운로드</div>
                    <div class="tutorial-feature">📧 이메일로 전송</div>
                </div>
            </div>

            <!-- 슬라이드 7: 시작 -->
            <div class="tutorial-slide">
                <div class="tutorial-icon">🚀</div>
                <h2 class="tutorial-title">준비 완료!</h2>
                <p class="tutorial-desc">
                    이제 점검을 시작해볼까요?
                </p>
                <div class="tutorial-start-summary">
                    <div class="tutorial-start-item">✓ 홈에서 정보 입력</div>
                    <div class="tutorial-start-item">✓ 하자 발견 → 촬영 버튼</div>
                    <div class="tutorial-start-item">✓ 사진 2장씩 (원경+근경)</div>
                    <div class="tutorial-start-item">✓ 리포트에서 전송</div>
                </div>
            </div>
        </div>

        <div class="tutorial-bottom">
            <div class="tutorial-dots" id="tutorialDots">
                <div class="tutorial-dot active"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
            </div>
            <div class="tutorial-buttons">
                <button class="tutorial-btn skip" id="tutorialSkip" onclick="closeTutorial()">건너뛰기</button>
                <button class="tutorial-btn next" id="tutorialNext" onclick="nextTutorialSlide()">다음</button>
            </div>
        </div>
    </div>

    <div class="bg-gradient"></div>

    <!-- ==================== 헤더 ==================== -->
    <header class="header">
        <div class="logo">
            <span class="logo-text">뷰파인더 🔍</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="openSettings()">⚙️</button>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                <span class="theme-icon" id="themeIcon">🌙</span>
            </button>
            <span class="tier-badge">Self</span>
        </div>
    </header>

    <!-- ==================== 메인 컨텐츠 ==================== -->
    <main class="main-content">

        <!-- ==================== 홈 섹션 ==================== -->
        <section class="section active" id="homeSection">

            <!-- 홈 진행 바 (간소화) -->
            <div class="home-step-bar-mini">
                <div class="home-step-progress">
                    <div class="home-step-dot active" data-step="1">1</div>
                    <div class="home-step-line"></div>
                    <div class="home-step-dot" data-step="2">2</div>
                    <div class="home-step-line"></div>
                    <div class="home-step-dot" data-step="3">3</div>
                </div>
            </div>

            <!-- 프로젝트 선택기 -->
            <div class="project-selector" onclick="openProjectModal()">
                <div class="project-selector-left">
                    <div class="project-selector-label">현재 프로젝트</div>
                    <div class="project-selector-name" id="currentProjectName">새 프로젝트</div>
                </div>
                <div class="project-selector-icon">📁</div>
            </div>

            <!-- ========== 메인 플로우: 3단계 카드 ========== -->
            
            <!-- STEP 1: 점검 정보 -->
            <div class="flow-card home-section-active" id="flowCard1">
                <div class="flow-card-header">
                    <div class="flow-step-badge">STEP 1</div>
                    <div class="flow-step-title">점검 정보</div>
                    <div class="flow-step-status" id="flow1Status">⏳ 입력 필요</div>
                </div>
                <div class="flow-card-guide" id="flowCard1Guide">
                    💡 아파트명을 입력하면 다음 단계로 진행됩니다
                </div>
                <div class="flow-card-body">
                    <input type="text" id="apartmentName" class="project-input full" placeholder="아파트명 (예: 래미안 퍼스트하임)" />
                    <div class="project-input-row">
                        <input type="text" id="dongNumber" class="project-input" placeholder="동 (예: 101)" />
                        <input type="text" id="hoNumber" class="project-input" placeholder="호 (예: 1201)" />
                    </div>
                    <input type="date" id="inspectionDate" class="project-input full" />
                </div>
            </div>

            <!-- STEP 2: 하자 촬영 -->
            <div class="flow-card home-section-dimmed" id="flowCard2">
                <div class="flow-card-header">
                    <div class="flow-step-badge">STEP 2</div>
                    <div class="flow-step-title">하자 촬영</div>
                    <div class="flow-step-status" id="flow2Status">0건</div>
                </div>
                <div class="flow-card-guide" id="flowCard2Guide">
                    💡 하자를 발견하면 촬영 버튼을 눌러주세요
                </div>
                <div class="flow-card-body">
                    <button class="flow-action-btn" onclick="openQuickMode()">
                        <span class="flow-action-icon">📸</span>
                        <span class="flow-action-text">
                            <strong>촬영 시작</strong>
                            <small>원경 + 근경 사진 촬영</small>
                        </span>
                        <span class="flow-action-arrow">→</span>
                    </button>
                    <div class="flow-defect-preview" id="defectPreview">
                        <!-- 최근 하자 미리보기 -->
                    </div>
                </div>
            </div>

            <!-- STEP 3: 리포트 생성 -->
            <div class="flow-card home-section-dimmed" id="flowCard3">
                <div class="flow-card-header">
                    <div class="flow-step-badge">STEP 3</div>
                    <div class="flow-step-title">리포트 생성</div>
                    <div class="flow-step-status" id="flow3Status">대기</div>
                </div>
                <div class="flow-card-guide" id="flowCard3Guide">
                    💡 PDF 보고서를 생성하고 이메일로 전송하세요
                </div>
                <div class="flow-card-body">
                    <button class="flow-action-btn" onclick="showSection('reportSection')" id="reportFlowBtn">
                        <span class="flow-action-icon">📄</span>
                        <span class="flow-action-text">
                            <strong>리포트 보기</strong>
                            <small>PDF 생성 및 이메일 전송</small>
                        </span>
                        <span class="flow-action-arrow">→</span>
                    </button>
                </div>
            </div>

            <!-- ========== 보조 메뉴 ========== -->
            <div class="sub-menu-section">
                <div class="sub-menu-title">📚 참고 자료</div>
                <div class="sub-menu-buttons">
                    <button class="sub-menu-btn" onclick="showSection('checklistSection')">
                        <span>✅</span> 체크리스트
                    </button>
                    <button class="sub-menu-btn" onclick="showSection('equipmentSection')">
                        <span>🔧</span> 장비 가이드
                    </button>
                </div>
            </div>

            <!-- 서비스 가격표 -->
            <div class="pricing-section">
                <div class="pricing-header">
                    <span class="pricing-title">서비스 안내</span>
                    <span class="pricing-subtitle">나에게 맞는 점검 서비스를 선택하세요</span>
                </div>
                
                <div class="pricing-cards">
                    <div class="pricing-card current">
                        <div class="pricing-badge">현재 이용중</div>
                        <div class="pricing-name">Self</div>
                        <div class="pricing-price">4.9<span>만원~</span></div>
                        <div class="pricing-desc">PRO키트 대여 (3시간)<br/>앱 이용권 (3일) + PDF 리포트</div>
                        <div class="pricing-extra">3시간 초과 시 시간당 1만원</div>
                    </div>
                    
                    <div class="pricing-card popular" onclick="showUpgradeModal('assist')">
                        <div class="pricing-badge">BEST</div>
                        <div class="pricing-name">Assist</div>
                        <div class="pricing-price">7.9<span>만원</span></div>
                        <div class="pricing-desc">Self 포함<br/>+ 매니저 현장 방문 (1시간)</div>
                    </div>
                    
                    <div class="pricing-card" onclick="showUpgradeModal('pro')">
                        <div class="pricing-name">Pro</div>
                        <div class="pricing-price">9.9<span>만원~</span></div>
                        <div class="pricing-desc">Self 포함<br/>+ 건축전문가 동행 (1시간)</div>
                        <div class="pricing-extra">34평 미만 기준</div>
                    </div>
                    
                    <div class="pricing-card" onclick="showUpgradeModal('onecare')">
                        <div class="pricing-name">One-Stop</div>
                        <div class="pricing-price">견적문의</div>
                        <div class="pricing-desc">Pro 포함<br/>+ 입주청소/줄눈/코팅 패키지</div>
                    </div>
                </div>
                
                <!-- 하자 접수 대행 애드온 -->
                <div class="addon-section" onclick="requestAddon()">
                    <div class="addon-header">
                        <span class="addon-badge">ADD-ON</span>
                        <span class="addon-title">하자 접수 대행</span>
                    </div>
                    <div class="addon-desc">건설사 하자접수 시스템 등록 대행</div>
                    <div class="addon-prices">
                        <span class="addon-price">50건↓ <b>3만</b></span>
                        <span class="addon-price">100건↓ <b>5만</b></span>
                        <span class="addon-price">100건↑ <b>6만~</b></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== 하자점검 섹션 (통합) ==================== -->
        <section class="section" id="defectSection">
            <div class="inspection-header">
                <div>
                    <h2 style="font-size: 20px; font-weight: 700;">하자점검</h2>
                    <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">발견된 하자를 기록하세요</p>
                </div>
                <div class="inspection-count" id="inspectionCount">0건</div>
            </div>

            <!-- 하자 촬영 버튼 -->
            <div class="quick-mode-entry">
                <button class="quick-mode-entry-btn highlight" onclick="openQuickMode()" style="flex: 1;">
                    📸 하자 촬영하기
                </button>
            </div>
            
            <div class="defect-list" id="defectList">
                <div class="empty-state">
                    <div class="empty-state-icon">📷</div>
                    <div class="empty-state-title">아직 발견된 하자가 없습니다</div>
                    <div class="empty-state-desc">
                        하자를 발견하면 촬영 버튼을 눌러<br>
                        원경/근경 사진을 찍어주세요
                    </div>
                    <button class="empty-state-btn" onclick="openQuickMode()">📸 촬영 시작</button>
                </div>
            </div>
            
            <button class="add-defect-btn" onclick="openQuickMode()" ontouchend="openQuickMode()">
                <span>+</span> 하자 촬영
            </button>
        </section>

        <!-- ==================== 체크리스트 섹션 ==================== -->
        <section class="section" id="checklistSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">점검 참고용 체크리스트</h2>
            <p style="font-size: 13px; color: #999; margin-bottom: 20px;">뷰파인더에서 제공하는 셀프점검 자료입니다.</p>
            
            <div class="checklist-spaces" id="checklistSpaces">
                <!-- 동적 생성 -->
            </div>
        </section>

        <!-- ==================== 체크리스트 상세 ==================== -->
        <section class="section" id="checklistDetailSection">
            <div class="checklist-detail-header">
                <button class="back-btn" onclick="showSection('checklistSection')">←</button>
                <h2 id="checklistDetailTitle" style="flex: 1;">거실</h2>
            </div>
            
            <div id="checklistItems">
                <!-- 동적 생성 -->
            </div>
        </section>

        <!-- ==================== 장비 가이드 섹션 ==================== -->
        <section class="section" id="equipmentSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">장비 사용 가이드</h2>
            <div id="equipmentList"></div>
        </section>

        <!-- ==================== 리포트 섹션 ==================== -->
        <section class="section" id="reportSection">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">점검 결과 리포트</h2>
            
            <!-- 하자 없을 때 안내 -->
            <div id="reportEmptyState" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <div class="empty-state-title">등록된 하자가 없습니다</div>
                    <div class="empty-state-desc">
                        하자를 발견하고 사진을 촬영하면<br>
                        PDF 보고서를 생성할 수 있습니다
                    </div>
                    <button class="empty-state-btn" onclick="showSection('defectSection')">🔍 점검 시작하기</button>
                </div>
            </div>
            
            <!-- 하자 있을 때 리포트 내용 -->
            <div id="reportContent">
                <!-- 프로젝트 정보 표시 -->
                <div class="report-project-card">
                    <div class="report-project-row">
                        <span class="report-project-label">아파트</span>
                        <span class="report-project-value" id="reportAptName">-</span>
                    </div>
                    <div class="report-project-row">
                        <span class="report-project-label">동/호수</span>
                        <span class="report-project-value" id="reportDongHo">-</span>
                    </div>
                    <div class="report-project-row">
                        <span class="report-project-label">점검일</span>
                        <span class="report-project-value" id="reportDate">-</span>
                    </div>
                </div>
                
                <!-- 점검 요약 -->
                <div class="report-summary-card">
                    <div class="report-summary-header">
                        <span>발견된 하자</span>
                        <span class="report-summary-count" id="reportDefectCount">0건</span>
                    </div>
                    <div class="report-summary-bar">
                        <div class="report-summary-fill" id="reportProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="report-summary-detail">
                        <div class="report-stat">
                            <span class="report-stat-value" id="reportPhotoCount">0</span>
                            <span class="report-stat-label">촬영 사진</span>
                        </div>
                    </div>
                </div>

                <!-- 보고서 생성 버튼들 -->
                <div class="report-actions">
                    <button class="report-btn primary" onclick="generatePDF()">
                        PDF 보고서 생성
                    </button>
                    <button class="report-btn secondary" onclick="downloadAllData()">
                        📦 전체 다운로드
                    </button>
                </div>
                
                <!-- 이메일 전송 섹션 -->
                <div class="email-send-section">
                    <div class="email-send-header">
                        <span class="email-send-icon">📧</span>
                        <div>
                            <div class="email-send-title">하자접수 대행 요청</div>
                            <div class="email-send-desc">전체 자료를 이메일로 전송합니다</div>
                        </div>
                    </div>
                    <button class="email-send-btn" onclick="openEmailSendModal()">
                        이메일로 전송하기 →
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- ==================== 하단 네비게이션 ==================== -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showSection('homeSection')" data-section="homeSection">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">홈</span>
        </div>
        <div class="nav-item" onclick="showSection('defectSection')" data-section="defectSection">
            <span class="nav-icon">🔍</span>
            <span class="nav-label">점검</span>
        </div>
        <div class="nav-item" onclick="showSection('reportSection')" data-section="reportSection">
            <span class="nav-icon">📊</span>
            <span class="nav-label">리포트</span>
        </div>
    </nav>

    <!-- ==================== 퀵모드 오버레이 ==================== -->
    <div class="quick-mode-overlay" id="quickModeOverlay">
        <div class="quick-mode-header">
            <div>
                <div class="quick-mode-title">📸 하자 촬영</div>
                <div class="quick-mode-count" id="quickModeCount">저장: 0건</div>
            </div>
            <button class="quick-mode-close" onclick="closeQuickMode()">✕</button>
        </div>
        
        <!-- 진행 바 -->
        <div class="quick-step-bar">
            <div class="quick-step-progress">
                <div class="quick-step-dot active" data-step="1">1</div>
                <div class="quick-step-line"></div>
                <div class="quick-step-dot" data-step="2">2</div>
                <div class="quick-step-line"></div>
                <div class="quick-step-dot" data-step="3">3</div>
            </div>
            <div class="quick-step-guide" id="quickStepGuide">
                📸 원경 사진을 촬영하세요
            </div>
        </div>
        
        <div class="quick-mode-body">
            <!-- 사진 촬영 섹션 -->
            <div class="quick-section" id="quickSectionPhoto" data-step="1">
                <div class="quick-mode-photo-area">
                    <div class="quick-mode-photo-box far" id="quickPhotoFar" onclick="openQuickCamera('far')">
                        <span class="quick-mode-photo-icon">📸</span>
                        <span class="quick-mode-photo-label">원경</span>
                        <span class="quick-mode-photo-hint">멀리서 전체</span>
                    </div>
                    <div class="quick-mode-photo-box near" id="quickPhotoNear" onclick="openQuickCamera('near')">
                        <span class="quick-mode-photo-icon">🔍</span>
                        <span class="quick-mode-photo-label">근경</span>
                        <span class="quick-mode-photo-hint">가까이서 상세</span>
                    </div>
                </div>
                
                <!-- 퀵모드 갤러리 버튼 -->
                <div style="display: flex; gap: 10px;">
                    <button style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); color: var(--text); font-size: 14px; cursor: pointer;" onclick="openQuickGallery('far')">🖼️ 원경 갤러리</button>
                    <button style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); color: var(--text); font-size: 14px; cursor: pointer;" onclick="openQuickGallery('near')">🖼️ 근경 갤러리</button>
                </div>
            </div>

            <!-- 공간 선택 섹션 -->
            <div class="quick-section dimmed" id="quickSectionSpace" data-step="2">
                <div class="quick-mode-space-select">
                    <div class="quick-mode-space-label">공간 선택 <span id="quickSpaceCount" style="color: var(--accent);">0/4 선택</span></div>
                    <div class="touch-btn-grid" id="quickSpaceChips">
                        <!-- 동적 생성 -->
                    </div>
                    <button class="add-space-btn" onclick="addCustomSpace()">+ 공간 추가</button>
                </div>
            </div>

            <!-- 선택사항 섹션 -->
            <div class="quick-section dimmed" id="quickSectionOptional" data-step="3">
                <div class="quick-section-optional-label">▼ 선택사항 (생략 가능)</div>
                
                <div class="quick-mode-space-select">
                    <div class="quick-mode-space-label">위치 선택 <span id="quickLocationCount" style="color: var(--accent);">0/4 선택</span></div>
                    <div class="touch-btn-grid" id="quickLocationChips">
                        <!-- 동적 생성 -->
                    </div>
                </div>

                <div class="quick-mode-space-select">
                    <div class="quick-mode-space-label">하자유형 선택 <span id="quickDefectTypeCount" style="color: var(--accent);">0/4 선택</span></div>
                    <div class="touch-btn-grid" id="quickDefectTypeChips">
                        <!-- 동적 생성 -->
                    </div>
                </div>

                <div class="quick-mode-space-select">
                    <div class="quick-mode-space-label">하자내용</div>
                    <textarea class="quick-mode-memo" id="quickModeMemo" placeholder="선택 항목이 자동으로 입력됩니다"></textarea>
                </div>
            </div>
        </div>

        <div class="quick-mode-footer">
            <button class="quick-mode-btn continue" onclick="saveAndContinueQuick()">
                저장 → 다음 촬영 📸
            </button>
            <button class="quick-mode-btn save" id="quickSaveBtn" onclick="saveAndCloseQuick()" disabled>
                저장 완료 ✓
            </button>
        </div>
    </div>

    <!-- ==================== 카메라 모달 ==================== -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-preview-container">
            <video id="cameraPreview" autoplay playsinline muted></video>
            <canvas id="markerCanvas" class="marker-canvas"></canvas>
            <div class="camera-guide-text" id="cameraGuideText">원경 촬영 - 멀리서 전체</div>
            
            <div class="marker-hint" id="markerHint">터치하여 마커 표시</div>
            
            <!-- 줌 레벨 표시 -->
            <div id="zoomLevel" style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); padding: 6px 14px; background: rgba(0, 0, 0, 0.6); border-radius: 16px; color: white; font-size: 13px; font-weight: 600;">1.0x</div>
        </div>
        
        <div class="camera-controls">
            <button class="camera-btn close" onclick="closeCamera()">✕</button>
            <button class="camera-btn capture" onclick="capturePhoto()">📸</button>
            <button class="camera-btn reset" onclick="resetMarkers()">↺</button>
        </div>
        <div class="camera-bottom-hint">
        </div>
    </div>

    <!-- ==================== 토스트 ==================== -->
    <div class="toast" id="toast">저장되었습니다</div>

    <!-- ==================== 사진 옵션 액션시트 ==================== -->
    <div class="photo-action-sheet" id="photoActionSheet">
        <div class="photo-action-overlay" onclick="closePhotoOptions()"></div>
        <div class="photo-action-content">
            <div class="photo-action-title" id="photoActionTitle">원경 사진</div>
            <button class="photo-action-btn" onclick="selectPhotoOption('camera')">
                <span>📸</span> 촬영하기
            </button>
            <button class="photo-action-btn" onclick="selectPhotoOption('gallery')">
                <span>🖼️</span> 갤러리에서 선택
            </button>
            <button class="photo-action-btn cancel" onclick="closePhotoOptions()">
                취소
            </button>
        </div>
    </div>

    <!-- ==================== 프로젝트 모달 ==================== -->
    <div class="project-modal-overlay" id="projectModalOverlay" onclick="closeProjectModal(event)">
        <div class="project-modal-sheet" onclick="event.stopPropagation()">
            <div class="project-modal-header">
                <span class="project-modal-title">프로젝트 관리</span>
                <button class="settings-close" onclick="closeProjectModal()">✕</button>
            </div>
            
            <div class="project-modal-body" id="projectList">
                <!-- 동적 생성 -->
            </div>
            
            <div style="padding: 16px;">
                <button class="project-add-btn" onclick="createNewProject()">
                    <span>+</span> 새 프로젝트 만들기
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 설정 메뉴 ==================== -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings(event)">
        <div class="settings-sheet" onclick="event.stopPropagation()">
            <div class="settings-header">
                <span class="settings-title">설정</span>
                <button class="settings-close" onclick="closeSettings()">✕</button>
            </div>
            
            <!-- 라이선스 정보 -->
            <div class="settings-license-info" id="settingsLicenseInfo">
                <div class="settings-license-header">
                    <span class="settings-license-icon">🔐</span>
                    <span class="settings-license-title">이용권 정보</span>
                </div>
                <div class="settings-license-details" id="settingsLicenseDetails">
                    <div class="settings-license-row">
                        <span>상태</span>
                        <span id="settingsLicenseStatus">-</span>
                    </div>
                    <div class="settings-license-row">
                        <span>남은 시간</span>
                        <span id="settingsLicenseRemaining">-</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-item" onclick="resetTutorial()">
                <span class="settings-item-icon">📖</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">튜토리얼 다시보기</div>
                    <div class="settings-item-desc">앱 사용법 가이드를 다시 볼 수 있어요</div>
                </div>
            </div>
            
            <div class="settings-item danger" onclick="resetAllData()">
                <span class="settings-item-icon">🗑️</span>
                <div class="settings-item-content">
                    <div class="settings-item-title">전체 초기화</div>
                    <div class="settings-item-desc">모든 점검 데이터를 삭제합니다</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: var(--card-bg); border-radius: var(--radius); text-align: center;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">뷰파인더 v2.0</div>
                <div style="font-size: 12px; color: var(--text-muted);">© 2024 뷰파인더</div>
            </div>
        </div>
    </div>

    <!-- ==================== 이메일 전송 모달 ==================== -->
    <div class="modal-overlay" id="emailSendModal" onclick="closeEmailModal(event)">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="margin: 0; font-size: 18px;" id="emailModalTitle">📧 하자접수 대행 요청</h3>
                <button class="modal-close" onclick="closeEmailModal()">✕</button>
            </div>
            
            <!-- Step 1: 업로드 시작 -->
            <div class="modal-body" style="padding: 20px;" id="emailStep1">
                <p style="margin: 0 0 16px 0; font-size: 14px; color: var(--text-muted); line-height: 1.6;">
                    전체 자료(PDF+엑셀+사진)를 클라우드에 업로드하고<br>뷰파인더에 하자접수 대행을 요청합니다.
                </p>
                
                <!-- 메인 수신자: 뷰파인더 -->
                <div style="margin-bottom: 16px; padding: 14px; background: rgba(0, 212, 170, 0.1); border: 1px solid var(--accent); border-radius: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">📬</span>
                        <div>
                            <div style="font-size: 13px; font-weight: 700; color: var(--text);">뷰파인더 하자접수팀</div>
                            <div style="font-size: 12px; color: var(--accent);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8ee8e1f6ede2fbecfdcee9e3efe7e2a0ede1e3">[email&#160;protected]</a></div>
                        </div>
                    </div>
                </div>
                
                <!-- 추가 수신자 (선택) -->
                <div style="margin-bottom: 16px; padding-top: 16px; border-top: 1px solid var(--card-border);">
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
                        📎 추가 수신자 <span style="font-weight: 400; color: var(--text-muted);">(선택사항)</span>
                    </label>
                    <input type="email" id="recipientEmail" class="email-input" placeholder="본인 또는 시공사 이메일" autocomplete="email">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">
                        본인 보관용이나 시공사에도 전송하려면 입력하세요
                    </div>
                </div>
                
                <button class="send-email-btn" onclick="uploadAndSendEmail()">
                    <span>☁️</span> 업로드 및 이메일 전송
                </button>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--card-bg); border-radius: 8px; font-size: 11px; color: var(--text-muted); line-height: 1.6;">
                    💡 클라우드에 업로드 → 다운로드 링크 자동 생성 → 이메일 전송
                </div>
            </div>
            
            <!-- Step 2: 완료 -->
            <div class="modal-body" style="padding: 20px; display: none;" id="emailStep2">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">✅</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px;">업로드 완료!</div>
                    <div style="font-size: 13px; color: var(--text-muted);">이메일 앱에서 전송해주세요</div>
                </div>
                
                <button class="send-email-btn" onclick="openEmailApp()" style="background: linear-gradient(135deg, var(--accent), #00B894);">
                    <span>📧</span> 이메일 앱 열기
                </button>
                
                <div style="margin-top: 16px; padding: 14px; background: var(--card-bg); border-radius: 10px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">📎 클라우드 링크</div>
                    <div style="font-size: 13px; color: var(--accent); word-break: break-all;" id="driveLink">-</div>
                </div>
                
                <div style="margin-top: 12px; padding: 14px; background: var(--card-bg); border-radius: 10px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">📮 받는 사람</div>
                    <div style="font-size: 14px; color: var(--accent); font-weight: 600;">뷰파인더 하자접수팀</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;" id="emailRecipientDisplay"></div>
                </div>
                
                <button class="send-email-btn" onclick="copyDriveLink()" style="margin-top: 12px; background: linear-gradient(135deg, #6366F1, #4F46E5);">
                    <span>📋</span> 링크 복사
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 카카오톡 인앱브라우저 감지 팝업 ==================== -->
    <div class="inapp-browser-overlay" id="inappBrowserOverlay">
        <div class="inapp-browser-popup">
            <div class="inapp-browser-icon">⚠️</div>
            <h2 class="inapp-browser-title">외부 브라우저에서 열어주세요</h2>
            <p class="inapp-browser-desc">
                카카오톡 내에서는 카메라, 저장 등<br>
                일부 기능이 제한됩니다.
            </p>
            
            <div class="inapp-browser-buttons">
                <button class="inapp-browser-btn primary" onclick="openInExternalBrowser()">
                    🌐 외부 브라우저로 열기
                </button>
                <button class="inapp-browser-btn secondary" onclick="closeInappOverlay()">
                    그냥 계속하기
                </button>
            </div>
            
            <div class="inapp-browser-manual">
                <div class="inapp-browser-manual-title">버튼이 작동하지 않으면:</div>
                <div class="inapp-browser-manual-step">
                    <span class="step-num">1</span>
                    <span>우측 상단 <b>⋮</b> 또는 <b>···</b> 메뉴 클릭</span>
                </div>
                <div class="inapp-browser-manual-step">
                    <span class="step-num">2</span>
                    <span><b>"다른 브라우저로 열기"</b> 선택</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 홈화면 추가 안내 오버레이 ==================== -->
    <div class="inapp-browser-overlay" id="addToHomeOverlay">
        <div class="inapp-browser-popup">
            <div class="inapp-browser-icon">📱</div>
            <h2 class="inapp-browser-title">홈 화면에 추가하세요!</h2>
            <p class="inapp-browser-desc">
                앱처럼 바로 실행할 수 있어요.<br>
                더 빠르고 편리하게 사용하세요.
            </p>
            
            <div class="add-home-steps">
                <div class="add-home-step" id="addHomeStepAndroid">
                    <div class="add-home-step-title">📍 Android (Chrome)</div>
                    <div class="inapp-browser-manual-step">
                        <span class="step-num">1</span>
                        <span>우측 상단 <b>⋮</b> 메뉴 클릭</span>
                    </div>
                    <div class="inapp-browser-manual-step">
                        <span class="step-num">2</span>
                        <span><b>"홈 화면에 추가"</b> 선택</span>
                    </div>
                </div>
                <div class="add-home-step" id="addHomeStepIOS">
                    <div class="add-home-step-title">📍 iPhone (Safari)</div>
                    <div class="inapp-browser-manual-step">
                        <span class="step-num">1</span>
                        <span>하단 <b>공유 버튼 (□↑)</b> 클릭</span>
                    </div>
                    <div class="inapp-browser-manual-step">
                        <span class="step-num">2</span>
                        <span><b>"홈 화면에 추가"</b> 선택</span>
                    </div>
                </div>
            </div>
            
            <div class="inapp-browser-buttons">
                <button class="inapp-browser-btn primary" onclick="closeAddToHomeOverlay()">
                    확인했어요 👍
                </button>
                <button class="inapp-browser-btn secondary" onclick="closeAddToHomeOverlay(true)">
                    다시 보지 않기
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 라이선스 인증 화면 ==================== -->
    <div class="license-overlay" id="licenseOverlay">
        <div class="license-container">
            <div class="license-header">
                <div class="license-logo">🔍</div>
                <h1 class="license-title">뷰파인더</h1>
                <p class="license-subtitle">스마트 셀프 홈체크</p>
            </div>
            
            <!-- 인증 입력 화면 -->
            <div class="license-content" id="licenseInputView">
                <div class="license-input-section">
                    <label class="license-label">🔐 이용권 코드를 입력하세요</label>
                    <input type="text" 
                           id="licenseCodeInput" 
                           class="license-input" 
                           placeholder="예: ABCD-1234"
                           maxlength="9"
                           autocomplete="off"
                           autocapitalize="characters">
                    <div class="license-input-hint">대여 시 받은 8자리 코드를 입력해주세요</div>
                </div>
                
                <button class="license-btn primary" id="licenseVerifyBtn" onclick="verifyLicenseCode()">
                    인증하기
                </button>
                
                <div class="license-error" id="licenseError"></div>
                
                <div class="license-contact">
                    <p>코드를 분실하셨나요?</p>
                    <a href="tel:010-0000-0000">📞 고객센터 문의</a>
                </div>
            </div>
            
            <!-- 인증 완료 / 상태 화면 -->
            <div class="license-content" id="licenseStatusView" style="display: none;">
                <div class="license-status-card">
                    <div class="license-status-icon" id="licenseStatusIcon">✅</div>
                    <div class="license-status-title" id="licenseStatusTitle">이용권 활성화</div>
                    <div class="license-status-info">
                        <div class="license-info-row">
                            <span class="license-info-label">고객명</span>
                            <span class="license-info-value" id="licenseName">-</span>
                        </div>
                        <div class="license-info-row">
                            <span class="license-info-label">아파트</span>
                            <span class="license-info-value" id="licenseApartment">-</span>
                        </div>
                        <div class="license-info-row">
                            <span class="license-info-label">이용기간</span>
                            <span class="license-info-value" id="licensePeriod">-</span>
                        </div>
                        <div class="license-info-row highlight">
                            <span class="license-info-label">남은시간</span>
                            <span class="license-info-value" id="licenseRemaining">-</span>
                        </div>
                    </div>
                </div>
                
                <button class="license-btn primary" onclick="startApp()">
                    시작하기 →
                </button>
                
                <button class="license-btn secondary" onclick="showLicenseInput()">
                    다른 코드 입력
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== 로딩 오버레이 ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">PDF 생성 중...</div>
    </div>

    <!-- ==================== 캔버스 (사진 압축용) ==================== -->
    <canvas id="photoCanvas" style="display: none;"></canvas>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ==================== 라이선스 관리 시스템 ====================
        
        // 설정 - 구글시트 Apps Script 웹앱 URL
        const LICENSE_API_URL = 'https://script.google.com/macros/s/AKfycbzf-TjQar5a6tgzNlK2xQOdflhnnejt0KWwUVCl_rk7nJ8H4TDJGpVccDIs46CbxmdK6A/exec';
        
        // 라이선스 상태
        let licenseData = null;
        
        // 기기 ID 생성/조회
        function getDeviceId() {
            let deviceId = localStorage.getItem('vf_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('vf_device_id', deviceId);
            }
            return deviceId;
        }
        
        // 저장된 라이선스 코드 조회
        function getSavedLicenseCode() {
            return localStorage.getItem('vf_license_code');
        }
        
        // 라이선스 코드 저장
        function saveLicenseCode(code) {
            localStorage.setItem('vf_license_code', code);
        }
        
        // 라이선스 코드 삭제
        function clearLicenseCode() {
            localStorage.removeItem('vf_license_code');
        }
        
        // 앱 시작 시 라이선스 체크
        async function checkLicenseOnStart() {
            // API URL이 설정되지 않은 경우 라이선스 체크 스킵 (개발 모드)
            if (!LICENSE_API_URL) {
                console.log('License API URL not configured - skipping license check');
                return;
            }
            
            const savedCode = getSavedLicenseCode();
            const deviceId = getDeviceId();
            
            if (!savedCode) {
                // 저장된 코드 없음 - 인증 화면 표시
                showLicenseOverlay();
                return;
            }
            
            // 저장된 코드로 상태 확인
            try {
                const response = await fetch(`${LICENSE_API_URL}?action=check&code=${encodeURIComponent(savedCode)}&deviceId=${encodeURIComponent(deviceId)}`);
                const result = await response.json();
                
                if (result.success) {
                    licenseData = result.license;
                    // 유효한 라이선스 - 앱 시작
                    hideLicenseOverlay();
                } else {
                    // 무효/만료 - 인증 화면 표시
                    showLicenseOverlay();
                    if (result.expired) {
                        showLicenseError('이용 기간이 만료되었습니다. 연장이 필요하시면 고객센터로 문의해주세요.');
                    }
                }
            } catch (error) {
                console.error('License check error:', error);
                // 네트워크 오류 시 오프라인 모드로 진행 (저장된 코드가 있으면)
                hideLicenseOverlay();
            }
        }
        
        // 라이선스 코드 인증
        async function verifyLicenseCode() {
            const codeInput = document.getElementById('licenseCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showLicenseError('인증코드를 입력해주세요');
                return;
            }
            
            if (!LICENSE_API_URL) {
                showLicenseError('라이선스 서버가 설정되지 않았습니다');
                return;
            }
            
            const deviceId = getDeviceId();
            const btn = document.getElementById('licenseVerifyBtn');
            
            btn.disabled = true;
            btn.textContent = '확인 중...';
            hideLicenseError();
            
            try {
                // 1단계: 코드 검증 및 활성화 (GET으로 통합)
                const response = await fetch(
                    `${LICENSE_API_URL}?action=activate&code=${encodeURIComponent(code)}&deviceId=${encodeURIComponent(deviceId)}`,
                    { method: 'GET' }
                );
                const result = await response.json();
                
                if (result.success) {
                    // 코드 저장
                    saveLicenseCode(code);
                    licenseData = result.license;
                    
                    // 상태 화면 표시
                    showLicenseStatus(result.license);
                } else {
                    showLicenseError(result.error || '유효하지 않은 코드입니다');
                }
            } catch (error) {
                console.error('License verification error:', error);
                showLicenseError('서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.');
            }
            
            btn.disabled = false;
            btn.textContent = '인증하기';
        }
        
        // 라이선스 상태 화면 표시
        function showLicenseStatus(license) {
            document.getElementById('licenseInputView').style.display = 'none';
            document.getElementById('licenseStatusView').style.display = 'block';
            
            document.getElementById('licenseName').textContent = license.name || '-';
            document.getElementById('licenseApartment').textContent = license.apartment || '-';
            document.getElementById('licensePeriod').textContent = 
                license.startDate && license.endDate 
                    ? `${license.startDate.split(' ')[0]} ~ ${license.endDate.split(' ')[0]}`
                    : '-';
            document.getElementById('licenseRemaining').textContent = license.remaining || '-';
        }
        
        // 코드 입력 화면 표시
        function showLicenseInput() {
            document.getElementById('licenseInputView').style.display = 'block';
            document.getElementById('licenseStatusView').style.display = 'none';
            document.getElementById('licenseCodeInput').value = '';
            hideLicenseError();
        }
        
        // 라이선스 오버레이 표시
        function showLicenseOverlay() {
            document.getElementById('licenseOverlay').classList.add('active');
        }
        
        // 라이선스 오버레이 숨김
        function hideLicenseOverlay() {
            document.getElementById('licenseOverlay').classList.remove('active');
        }
        
        // 에러 표시
        function showLicenseError(message) {
            const errorEl = document.getElementById('licenseError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        // 에러 숨김
        function hideLicenseError() {
            document.getElementById('licenseError').classList.remove('show');
        }
        
        // 앱 시작
        function startApp() {
            hideLicenseOverlay();
        }
        
        // 코드 입력 시 자동 하이픈 추가
        document.addEventListener('DOMContentLoaded', function() {
            const codeInput = document.getElementById('licenseCodeInput');
            if (codeInput) {
                codeInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                    if (value.length > 4) {
                        value = value.slice(0, 4) + '-' + value.slice(4, 8);
                    }
                    e.target.value = value;
                });
            }
        });

        // ==================== 카카오톡 인앱브라우저 감지 ====================
        function checkInAppBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            
            // 카카오톡, 네이버, 인스타그램, 페이스북 등 인앱브라우저 감지
            const inAppBrowsers = [
                'kakaotalk',    // 카카오톡
                'naver',        // 네이버
                'instagram',    // 인스타그램
                'fbav',         // 페이스북
                'fb_iab',       // 페이스북
                'twitter',      // 트위터
                'line'          // 라인
            ];
            
            const isInApp = inAppBrowsers.some(browser => ua.includes(browser));
            
            // 이미 안내 받은 경우 다시 표시하지 않음
            const alreadyWarned = sessionStorage.getItem('inappWarned');
            
            if (isInApp && !alreadyWarned) {
                document.getElementById('inappBrowserOverlay').classList.add('active');
            } else if (!isInApp) {
                // 일반 브라우저에서 홈화면 추가 안내 체크
                checkAddToHomePrompt();
            }
        }
        
        // 홈화면 추가 안내
        function checkAddToHomePrompt() {
            // 이미 PWA로 실행 중이면 표시하지 않음
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                 window.navigator.standalone === true;
            if (isStandalone) return;
            
            // "다시 보지 않기" 선택한 경우
            const neverShow = localStorage.getItem('addToHomeNeverShow');
            if (neverShow) return;
            
            // 이번 세션에서 이미 본 경우
            const alreadyShown = sessionStorage.getItem('addToHomeShown');
            if (alreadyShown) return;
            
            // 첫 방문 후 2초 뒤에 표시 (UX 개선)
            setTimeout(() => {
                showAddToHomeOverlay();
            }, 2000);
        }
        
        function showAddToHomeOverlay() {
            // OS 구분 없이 둘 다 표시
            document.getElementById('addToHomeOverlay').classList.add('active');
            sessionStorage.setItem('addToHomeShown', 'true');
        }
        
        function closeAddToHomeOverlay(neverShow = false) {
            document.getElementById('addToHomeOverlay').classList.remove('active');
            if (neverShow) {
                localStorage.setItem('addToHomeNeverShow', 'true');
            }
        }
        
        // 외부 브라우저로 열기
        function openInExternalBrowser() {
            const currentUrl = window.location.href;
            
            // Android intent 방식 (Chrome)
            const isAndroid = /android/i.test(navigator.userAgent);
            const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
            
            if (isAndroid) {
                // Chrome으로 열기 시도
                window.location.href = 'intent://' + currentUrl.replace(/https?:\/\//, '') + '#Intent;scheme=https;package=com.android.chrome;end';
            } else if (isIOS) {
                // Safari로 열기 (iOS에서는 제한적)
                // x-web-search 또는 googlechrome 스킴 시도
                window.location.href = 'x-safari-' + currentUrl;
            }
            
            // 일정 시간 후에도 열리지 않으면 안내
            setTimeout(() => {
                alert('자동 열기가 안 될 경우:\n\n우측 상단 ⋮ 메뉴 → "다른 브라우저로 열기"를 선택해주세요.');
            }, 1500);
        }
        
        // 팝업 닫기
        function closeInappOverlay() {
            document.getElementById('inappBrowserOverlay').classList.remove('active');
            sessionStorage.setItem('inappWarned', 'true');
        }

        // ==================== 데이터 ====================
        // ==================== 데이터 구조 ====================
        const APP_DATA = {
            currentProjectId: null,
            projects: []
        };

        // 프로젝트 생성 헬퍼
        function createEmptyProject() {
            return {
                id: 'proj_' + Date.now(),
                name: '새 프로젝트',
                apartmentName: '',
                dong: '',
                ho: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                defects: [],
                customSpaces: [],
                checkedItems: {}
            };
        }

        // 체크리스트 데이터 (참고용)
        const CHECKLIST_DATA = {
            entrance: {
                name: '현관/전실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 점등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '현관문/몰딩(잠금장치) - 밀폐불량, 조립상태, 파손, 오염, 도어클로저 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손'
                    ],
                    floor: [
                        '타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '현관디딤석 - 부착상태, 파손, 오염'
                    ]
                }
            },
            livingroom: {
                name: '거실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 점등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '아트월(타일/MDF) - 부착상태, 단차, 파손, 오염',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '월패드/조절기(난방장치) - 부착상태, 파손, 작동상태, 화질불량, 연동불량',
                        '도배 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            bedroom: {
                name: '침실',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 점등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '출입문/몰딩(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '가구류(붙박이장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '도배 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            kitchen: {
                name: '주방/식당',
                positions: {
                    ceiling: [
                        '전등/스프링클러 - 점등불량, 부착상태, 파손',
                        '확산소화기(조리시설 상부) - 설치상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손(대기전력 스위치 작동상태)',
                        '가구류(붙박이장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '조리기기류(쿡탑, 후드) - 부착상태, 파손, 작동불량',
                        '싱크대/상판 - 부착상태, 파손, 실리콘 상태',
                        '수전류 - 급수, 누수, 배수상태',
                        '도배 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            bathroom: {
                name: '욕실/화장실',
                positions: {
                    ceiling: [
                        '전등 - 점등불량, 부착상태, 파손',
                        '환풍기 - 작동상태, 부착상태, 파손',
                        '천장재 - 부착상태, 단차, 파손, 오염',
                        '점검구 내부(배관, 천장) - 누수, 시공상태, 오염'
                    ],
                    wall: [
                        '출입문/몰딩/잠금장치 - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(욕실장, 거울) - 부착상태, 파손, 오염, 개폐불량, 고정불량, 작동불량',
                        '변기 - 고정상태, 파손, 오염, 누수, 악취, 배수상태',
                        '세면대/욕조/수전류/샤워기 - 부착상태, 파손, 오염, 작동상태, 누수, 악취, 배수상태',
                        '샤워부스(설치시) - 고정상태, 파손, 오염, 개폐불량(유리문 설치시)',
                        '수건/휴지걸이/코너선반 - 고정상태, 파손, 오염',
                        '젠다이(석재선반) - 고정상태, 파손, 오염',
                        '벽타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구 - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            dressroom: {
                name: '드레스룸/알파룸',
                positions: {
                    ceiling: [
                        '전등/센서(화재감지기) - 점등불량, 부착상태, 파손',
                        '도배/도장/몰딩 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    wall: [
                        '출입문/몰딩/잠금장치 - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(선반, 수납장) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '도배 - 오염, 곰팡이, 시공불량, 파손'
                    ],
                    floor: [
                        '걸레받이 - 부착상태, 이음불량, 파손, 오염',
                        '마감재(마루/타일) - 들뜸, 단차, 수평불량, 오염, 파손'
                    ]
                }
            },
            balcony: {
                name: '발코니',
                positions: {
                    ceiling: [
                        '전등/스프링클러 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '수전 - 급수, 누수, 배수상태',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구(수전 있는 경우) - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            utility: {
                name: '다용도실/보일러실',
                positions: {
                    ceiling: [
                        '전등/스프링클러 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '창호/유리(잠금장치) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '난간대 - 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '가구류(선반, 보조주방) - 부착상태, 파손, 오염, 개폐불량, 선반/부품 미시공',
                        '수전 - 급수, 누수, 배수상태',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손',
                        '배수구(수전 있는 경우) - 물고임, 배수불량, 악취, 파손'
                    ]
                }
            },
            outdoor: {
                name: '실외기실',
                positions: {
                    ceiling: [
                        '전등/스프링클러 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/창호(배기창) - 고정상태, 파손, 오염, 개폐/잠금기능 불량',
                        '스위치/콘센트 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ]
                }
            },
            evacuation: {
                name: '대피공간',
                positions: {
                    ceiling: [
                        '전등 - 점등불량, 부착상태, 파손',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    wall: [
                        '출입문/몰딩/창호(잠금장치) - 고정상태, 파손, 오염, 밀폐/개폐/잠금기능 불량',
                        '도장 - 오염, 곰팡이, 시공불량, 균열'
                    ],
                    floor: [
                        '바닥타일 - 들뜸, 단차, 줄눈불량, 오염, 파손'
                    ]
                }
            },
            etc: {
                name: '기타사항',
                items: [
                    { category: '설비', items: ['분전반/통신함 - 작동불량, 부착상태, 파손, 오염', '난방온수분배기 - 고정상태, 누수, 소음, 파손, 오염', '전열교환기(세대 환기장치) - 작동불량, 부착상태, 파손, 오염'] },
                    { category: '공용부', items: ['주출입구, 계단실, 엘리베이터홀, 외벽, 주차장, 도로, 조경시설'] }
                ]
            }
        };

        // 기본 공간 목록
        const DEFAULT_SPACES = [
            '현관', '현관창고', '안방', '침실1', '침실2', '침실3', '침실4', 
            '복도', '거실', '주방', '팬트리', '다용도실', '외부', '알파룸',
            '발코니', '대피공간', '실외기실', '파우더룸', 
            '드레스룸', '공용욕실', '부부욕실'
        ];

        // 기본 위치 목록
        const DEFAULT_LOCATIONS = [
            '벽', '바닥', '천장', '도배', '가구', '창', '문', '짝', '틀', '타일', '도장', '줄눈', '코킹'
        ];

        // 기본 하자내용 목록
        const DEFAULT_DEFECT_TYPES = [
            '손상', '찍힘', '들뜸', '오염', '틈새', '단차', '돌출', '마감', '고정', '작동', '수평/수직', '전체', '다수', '불량', '미시공'
        ];

        // ==================== 카메라 관련 ====================
        let cameraStream = null;
        let currentPhotoType = null; // 'far' or 'near'
        let currentZoom = 1.0;
        let markers = [];
        let markerCanvas = null;
        let markerCtx = null;

        // ==================== 체크리스트 ====================
        let currentChecklistSpace = null;

        function renderChecklistSpaces() {
            const container = document.getElementById('checklistSpaces');
            
            container.innerHTML = Object.keys(CHECKLIST_DATA).map(key => {
                const space = CHECKLIST_DATA[key];
                
                return `
                    <div class="checklist-space-card" onclick="openChecklistDetail('${key}')">
                        <div class="checklist-space-info">
                            <div class="checklist-space-name">${space.name}</div>
                        </div>
                        <div class="checklist-space-arrow">→</div>
                    </div>
                `;
            }).join('');
        }

        function openChecklistDetail(spaceKey) {
            currentChecklistSpace = spaceKey;
            const space = CHECKLIST_DATA[spaceKey];
            
            document.getElementById('checklistDetailTitle').textContent = space.name;
            renderChecklistItems();
            showSection('checklistDetailSection');
        }

        function renderChecklistItems() {
            const space = CHECKLIST_DATA[currentChecklistSpace];
            const container = document.getElementById('checklistItems');
            
            // 기타사항 처리
            if (currentChecklistSpace === 'etc') {
                container.innerHTML = space.items.map(section => `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">${section.category}</div>
                        ${section.items.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                `).join('');
                return;
            }
            
            // 일반 공간 처리 (위치: 천장, 벽면, 바닥)
            const positions = space.positions;
            container.innerHTML = `
                ${positions.ceiling ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">천장</div>
                        ${positions.ceiling.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${positions.wall ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">벽면</div>
                        ${positions.wall.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${positions.floor ? `
                    <div class="checklist-reference-section">
                        <div class="checklist-position-title">바닥</div>
                        ${positions.floor.map(item => `
                            <div class="checklist-reference-item">${item}</div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        // ==================== 테마 (다크/라이트 모드) ====================
        function initTheme() {
            const savedTheme = localStorage.getItem('viewfinder_theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '☀️';
            }
        }

        function toggleTheme() {
            const root = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (root.classList.contains('light-mode')) {
                root.classList.remove('light-mode');
                themeIcon.textContent = '🌙';
                localStorage.setItem('viewfinder_theme', 'dark');
            } else {
                root.classList.add('light-mode');
                themeIcon.textContent = '☀️';
                localStorage.setItem('viewfinder_theme', 'light');
            }
        }

        // 페이지 로드 시 테마 적용 (깜빡임 방지)
        initTheme();

        // ==================== 온보딩 & 튜토리얼 ====================
        let currentTutorialSlide = 0;
        const totalTutorialSlides = 7;

        function initTutorial() {
            // 이미 튜토리얼을 봤는지 확인
            const tutorialSeen = localStorage.getItem('viewfinder_tutorial_seen');
            const landingOverlay = document.getElementById('tutorialOverlay');
            const tutorialOverlay = document.getElementById('tutorialSlideOverlay');
            
            if (tutorialSeen) {
                // 둘 다 숨기기
                landingOverlay.classList.add('hidden');
                landingOverlay.style.display = 'none';
                tutorialOverlay.classList.add('hidden');
                tutorialOverlay.style.display = 'none';
                return;
            }
            
            // 랜딩 페이지 표시, 튜토리얼은 숨김
            landingOverlay.classList.remove('hidden');
            tutorialOverlay.classList.add('hidden');
            tutorialOverlay.style.display = 'none';
            
            // 튜토리얼 슬라이드 스크롤 이벤트
            const slides = document.getElementById('tutorialSlides');
            if (slides) {
                slides.addEventListener('scroll', () => {
                    const slideWidth = slides.clientWidth;
                    const scrollLeft = slides.scrollLeft;
                    currentTutorialSlide = Math.round(scrollLeft / slideWidth);
                    updateTutorialDots();
                    updateTutorialButtons();
                });
            }
        }

        // 랜딩에서 튜토리얼로 전환
        function showTutorial() {
            const landingOverlay = document.getElementById('tutorialOverlay');
            const tutorialOverlay = document.getElementById('tutorialSlideOverlay');
            
            // 랜딩 숨기기
            landingOverlay.classList.add('hidden');
            landingOverlay.style.display = 'none';
            
            // 튜토리얼 표시
            tutorialOverlay.style.display = 'flex';
            tutorialOverlay.classList.remove('hidden');
            
            // 초기화
            currentTutorialSlide = 0;
            const slides = document.getElementById('tutorialSlides');
            if (slides) {
                slides.scrollTo({ left: 0, behavior: 'instant' });
            }
            updateTutorialDots();
            updateTutorialButtons();
        }

        function updateTutorialDots() {
            const dots = document.querySelectorAll('#tutorialSlideOverlay .tutorial-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentTutorialSlide);
            });
        }

        function updateTutorialButtons() {
            const skipBtn = document.getElementById('tutorialSkip');
            const nextBtn = document.getElementById('tutorialNext');
            
            if (currentTutorialSlide === totalTutorialSlides - 1) {
                skipBtn.style.display = 'none';
                nextBtn.textContent = '시작하기 🚀';
                nextBtn.style.flex = '1';
            } else {
                skipBtn.style.display = 'block';
                nextBtn.textContent = '다음';
                nextBtn.style.flex = '1';
            }
        }

        function nextTutorialSlide() {
            if (currentTutorialSlide >= totalTutorialSlides - 1) {
                closeTutorial();
                return;
            }
            
            currentTutorialSlide++;
            const slides = document.getElementById('tutorialSlides');
            slides.scrollTo({
                left: slides.clientWidth * currentTutorialSlide,
                behavior: 'smooth'
            });
        }

        function closeTutorial() {
            localStorage.setItem('viewfinder_tutorial_seen', 'true');
            
            // 랜딩 숨기기
            const landingOverlay = document.getElementById('tutorialOverlay');
            landingOverlay.classList.add('hidden');
            landingOverlay.style.display = 'none';
            
            // 튜토리얼 숨기기
            const tutorialOverlay = document.getElementById('tutorialSlideOverlay');
            tutorialOverlay.classList.add('hidden');
            setTimeout(() => {
                tutorialOverlay.style.display = 'none';
            }, 300);
        }

        // 튜토리얼 다시보기 (설정에서 사용 가능)
        function resetTutorial() {
            closeSettings();
            localStorage.removeItem('viewfinder_tutorial_seen');
            location.reload();
        }

        // ==================== 설정 메뉴 ====================
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            updateSettingsLicenseInfo();
        }
        
        function updateSettingsLicenseInfo() {
            const statusEl = document.getElementById('settingsLicenseStatus');
            const remainingEl = document.getElementById('settingsLicenseRemaining');
            const infoSection = document.getElementById('settingsLicenseInfo');
            
            if (!LICENSE_API_URL) {
                // 라이선스 시스템 미설정 시 숨김
                if (infoSection) infoSection.style.display = 'none';
                return;
            }
            
            if (infoSection) infoSection.style.display = 'block';
            
            if (licenseData) {
                statusEl.textContent = '✅ 이용중';
                statusEl.style.color = 'var(--accent)';
                remainingEl.textContent = licenseData.remaining || '-';
            } else {
                statusEl.textContent = '❌ 미인증';
                statusEl.style.color = 'var(--warning)';
                remainingEl.textContent = '-';
            }
        }

        function closeSettings(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        // 전체 자료 다운로드 (PDF + 엑셀 + 사진 ZIP)
        async function downloadAllData() {
            const proj = getCurrentProject();
            
            if (proj.defects.length === 0) {
                showToast('다운로드할 하자 데이터가 없습니다', 'error');
                return;
            }
            
            closeSettings();
            showLoading('전체 자료 생성 중...');
            
            try {
                const zip = new JSZip();
                const projectInfo = {
                    apartmentName: proj.apartmentName || '미입력',
                    dong: proj.dong || '',
                    ho: proj.ho || '',
                    inspectionDate: proj.inspectionDate || new Date().toISOString().split('T')[0]
                };
                const folderName = `${projectInfo.apartmentName}_${projectInfo.dong}동${projectInfo.ho}호`;
                
                // 1. PDF 생성
                updateLoadingText('PDF 생성 중...');
                const pdfBlob = await generatePDFBlob(projectInfo);
                zip.file(`${folderName}_하자점검보고서.pdf`, pdfBlob);
                
                // 2. 엑셀 생성
                updateLoadingText('엑셀 생성 중...');
                const excelBlob = await generateExcelBlob(projectInfo);
                zip.file(`${folderName}_하자목록.xlsx`, excelBlob);
                
                // 3. 사진 폴더 생성
                updateLoadingText('사진 저장 중...');
                const photosFolder = zip.folder('사진');
                
                for (let i = 0; i < proj.defects.length; i++) {
                    const defect = proj.defects[i];
                    const spaces = defect.spaces.join('_') || '미지정';
                    const prefix = `${String(i + 1).padStart(2, '0')}_${spaces}`;
                    
                    // 원경 사진
                    if (defect.photos && defect.photos[0]) {
                        const farData = defect.photos[0].split(',')[1];
                        photosFolder.file(`${prefix}_원경.jpg`, farData, { base64: true });
                    }
                    
                    // 근경 사진
                    if (defect.photos && defect.photos[1]) {
                        const nearData = defect.photos[1].split(',')[1];
                        photosFolder.file(`${prefix}_근경.jpg`, nearData, { base64: true });
                    }
                }
                
                // 4. ZIP 다운로드
                updateLoadingText('ZIP 파일 생성 중...');
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                const filename = `${folderName}_${projectInfo.inspectionDate}_전체자료.zip`;
                
                // 다운로드
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                hideLoading();
                showToast('전체 자료가 다운로드되었습니다!');
                
            } catch (error) {
                console.error('ZIP 생성 오류:', error);
                hideLoading();
                showToast('자료 생성 중 오류가 발생했습니다', 'error');
            }
        }
        
        // PDF Blob 생성 (ZIP용)
        async function generatePDFBlob(projectInfo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = 210;
            const pageHeight = 297;
            
            // 표지
            const coverHTML = createCoverPage(projectInfo);
            await addHTMLPageToPDF(doc, coverHTML, pageWidth, pageHeight);
            
            // 하자 목록
            if (getCurrentProject().defects.length > 0) {
                const defectsPerListPage = 18;
                const totalDefects = getCurrentProject().defects.length;
                const totalListPages = Math.ceil(totalDefects / defectsPerListPage);
                
                for (let page = 0; page < totalListPages; page++) {
                    doc.addPage();
                    const startIdx = page * defectsPerListPage;
                    const endIdx = Math.min(startIdx + defectsPerListPage, totalDefects);
                    const listHTML = createDefectListPage(projectInfo, startIdx, endIdx, page + 1, totalListPages);
                    await addHTMLPageToPDF(doc, listHTML, pageWidth, pageHeight);
                }
                
                // 상세 페이지
                for (let i = 0; i < getCurrentProject().defects.length; i += 2) {
                    doc.addPage();
                    const batch = getCurrentProject().defects.slice(i, i + 2);
                    const detailHTML = createDefectDetailPage(batch, i, projectInfo);
                    await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                }
            }
            
            return doc.output('blob');
        }
        
        // 엑셀 Blob 생성 (ZIP용)
        async function generateExcelBlob(projectInfo) {
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet('하자목록');
            
            // 컬럼 설정 (위치, 하자유형 추가)
            sheet.columns = [
                { header: 'No', key: 'no', width: 8 },
                { header: '공간', key: 'space', width: 20 },
                { header: '위치', key: 'location', width: 20 },
                { header: '하자유형', key: 'defectType', width: 20 },
                { header: '하자내용', key: 'description', width: 40 },
                { header: '사진수', key: 'photoCount', width: 10 }
            ];
            
            // 헤더 스타일
            const headerRow = sheet.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C5282' } };
            headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
            headerRow.height = 25;
            
            // 데이터 추가
            getCurrentProject().defects.forEach((defect, idx) => {
                const photoCount = defect.photos ? defect.photos.filter(p => p).length : 0;
                // 기존 데이터 호환성
                const spaces = defect.spaces || [];
                const locations = defect.locations || [];
                const defectTypes = defect.defectTypes || [];
                
                sheet.addRow({
                    no: idx + 1,
                    space: spaces.join(' ') || '-',
                    location: locations.join(' ') || '-',
                    defectType: defectTypes.join(' ') || '-',
                    description: defect.description || '-',
                    photoCount: photoCount
                });
            });
            
            // 데이터 행 스타일
            for (let i = 2; i <= getCurrentProject().defects.length + 1; i++) {
                const row = sheet.getRow(i);
                row.alignment = { vertical: 'middle', wrapText: true };
                row.height = 25;
                
                // 줄무늬
                if (i % 2 === 0) {
                    row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F7FA' } };
                }
            }
            
            // 테두리
            sheet.eachRow((row, rowNumber) => {
                row.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
            });
            
            // 프로젝트 정보 시트 추가
            const infoSheet = workbook.addWorksheet('점검정보');
            infoSheet.addRow(['아파트명', projectInfo.apartmentName]);
            infoSheet.addRow(['동/호수', `${projectInfo.dong}동 ${projectInfo.ho}호`]);
            infoSheet.addRow(['점검일자', projectInfo.inspectionDate]);
            infoSheet.addRow(['총 하자수', getCurrentProject().defects.length]);
            
            infoSheet.getColumn(1).width = 15;
            infoSheet.getColumn(2).width = 30;
            
            return await workbook.xlsx.writeBuffer();
        }
        
        // 로딩 텍스트 업데이트
        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.textContent = text;
        }

        // ==================== Cloudflare R2 업로드 기능 ====================
        const WORKER_URL = 'https://viewfinder-upload.foxclubs.workers.dev';
        const R2_PUBLIC_URL = 'https://pub-000852c19e344917ba211199fea99add.r2.dev';
        
        // R2에 파일 업로드 (Worker 경유)
        async function uploadToR2(blob, filename) {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('filename', filename);
            
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Upload Error:', errorText);
                throw new Error('업로드 실패: ' + response.status);
            }
            
            const result = await response.json();
            
            return {
                fileName: result.filename,
                downloadUrl: result.url
            };
        }

        // ==================== 이메일 전송 기능 ====================
        // 뷰파인더 이메일
        const COMPANY_EMAIL = 'foxclubs@gmail.com';
        
        // 이메일 준비 데이터 저장용
        let preparedEmailData = {
            pdfBlob: null,
            pdfFilename: '',
            mailtoUrl: '',
            recipientEmail: ''
        };
        
        // 이메일 모달 열기
        function openEmailSendModal() {
            const proj = getCurrentProject();
            
            if (proj.defects.length === 0) {
                showToast('전송할 하자 데이터가 없습니다', 'error');
                return;
            }
            
            closeSettings();
            
            // Step1 표시, Step2 숨기기
            document.getElementById('emailStep1').style.display = 'block';
            document.getElementById('emailStep2').style.display = 'none';
            document.getElementById('emailModalTitle').textContent = '📧 자료 전송하기';
            
            document.getElementById('emailSendModal').classList.add('active');
            document.getElementById('recipientEmail').focus();
        }
        
        // 이메일 모달 닫기
        function closeEmailModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('emailSendModal').classList.remove('active');
            document.getElementById('recipientEmail').value = '';
            
            // 데이터 초기화
            preparedEmailData = { pdfBlob: null, pdfFilename: '', mailtoUrl: '', recipientEmail: '' };
        }
        
        // 이메일 유효성 검사
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        // 클라우드 업로드 후 이메일 전송
        async function uploadAndSendEmail() {
            const additionalEmail = document.getElementById('recipientEmail').value.trim();
            
            // 추가 이메일 유효성 검사 (입력했을 경우만)
            if (additionalEmail && !isValidEmail(additionalEmail)) {
                showToast('올바른 이메일 형식이 아닙니다', 'error');
                document.getElementById('recipientEmail').focus();
                return;
            }
            
            const proj = getCurrentProject();
            const projectInfo = {
                apartmentName: proj.apartmentName || '미입력',
                dong: proj.dong || '',
                ho: proj.ho || '',
                inspectionDate: proj.inspectionDate || new Date().toISOString().split('T')[0]
            };
            const folderName = `${projectInfo.apartmentName}_${projectInfo.dong}동${projectInfo.ho}호`;
            
            // 모달 숨기고 로딩 표시
            document.getElementById('emailSendModal').classList.remove('active');
            showLoading('전체 자료 생성 중...');
            
            try {
                const zip = new JSZip();
                
                // 1. PDF 생성
                updateLoadingText('PDF 생성 중...');
                const pdfBlob = await generatePDFBlob(projectInfo);
                zip.file(`${folderName}_하자점검보고서.pdf`, pdfBlob);
                
                // 2. 엑셀 생성
                updateLoadingText('엑셀 생성 중...');
                const excelBlob = await generateExcelBlob(projectInfo);
                zip.file(`${folderName}_하자목록.xlsx`, excelBlob);
                
                // 3. 사진 폴더 생성
                updateLoadingText('사진 저장 중...');
                const photosFolder = zip.folder('사진');
                
                for (let i = 0; i < proj.defects.length; i++) {
                    const defect = proj.defects[i];
                    const spaces = defect.spaces.join('_') || '미지정';
                    const prefix = `${String(i + 1).padStart(2, '0')}_${spaces}`;
                    
                    if (defect.photos && defect.photos[0]) {
                        const farData = defect.photos[0].split(',')[1];
                        photosFolder.file(`${prefix}_원경.jpg`, farData, { base64: true });
                    }
                    
                    if (defect.photos && defect.photos[1]) {
                        const nearData = defect.photos[1].split(',')[1];
                        photosFolder.file(`${prefix}_근경.jpg`, nearData, { base64: true });
                    }
                }
                
                // 4. ZIP 생성
                updateLoadingText('ZIP 파일 생성 중...');
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                // 5. Cloudflare R2 업로드
                updateLoadingText('클라우드 업로드 중...');
                const filename = `${folderName}_${projectInfo.inspectionDate}_전체자료.zip`;
                const uploadResult = await uploadToR2(zipBlob, filename);
                
                // 하자 요약 생성
                const defectSummary = proj.defects.slice(0, 5).map((d, i) => 
                    `${i + 1}. ${d.spaces.join(', ') || '미지정'}: ${d.description || '-'}`
                ).join('\n');
                const moreText = proj.defects.length > 5 ? `\n... 외 ${proj.defects.length - 5}건` : '';
                
                // 사진 수 계산
                const photoCount = proj.defects.reduce((sum, d) => 
                    sum + (d.photos ? d.photos.filter(p => p).length : 0), 0);
                
                // mailto URL 생성 (다운로드 링크 포함)
                const subject = encodeURIComponent(`[하자접수대행 요청] ${projectInfo.apartmentName} ${projectInfo.dong}동 ${projectInfo.ho}호`);
                const body = encodeURIComponent(
                    `안녕하세요.\n\n` +
                    `하자접수 대행을 요청드립니다.\n\n` +
                    `■ 점검 정보\n` +
                    `- 아파트: ${projectInfo.apartmentName}\n` +
                    `- 동/호수: ${projectInfo.dong}동 ${projectInfo.ho}호\n` +
                    `- 점검일: ${projectInfo.inspectionDate}\n` +
                    `- 발견 하자: ${proj.defects.length}건\n` +
                    `- 촬영 사진: ${photoCount}장\n\n` +
                    `■ 하자 요약\n${defectSummary}${moreText}\n\n` +
                    `■ 자료 다운로드 링크\n${uploadResult.downloadUrl}\n\n` +
                    `(PDF보고서 + 엑셀목록 + 원본사진 포함)\n\n` +
                    `--\n뷰파인더 | 스마트 셀프 홈체크`
                );
                
                // 뷰파인더 메인 + 추가 수신자
                let finalRecipients = COMPANY_EMAIL;
                let additionalDisplay = '';
                
                if (additionalEmail) {
                    finalRecipients = `${COMPANY_EMAIL},${additionalEmail}`;
                    additionalDisplay = `+ ${additionalEmail}`;
                }
                
                // 준비 데이터 저장
                preparedEmailData = {
                    driveUrl: uploadResult.downloadUrl,
                    mailtoUrl: `mailto:${finalRecipients}?subject=${subject}&body=${body}`,
                    additionalEmail: additionalDisplay,
                    defectCount: proj.defects.length,
                    photoCount: photoCount
                };
                
                hideLoading();
                
                // Step 2로 전환
                document.getElementById('emailStep1').style.display = 'none';
                document.getElementById('emailStep2').style.display = 'block';
                document.getElementById('emailModalTitle').textContent = '✅ 업로드 완료!';
                document.getElementById('driveLink').textContent = uploadResult.downloadUrl;
                document.getElementById('emailRecipientDisplay').textContent = additionalDisplay;
                
                document.getElementById('emailSendModal').classList.add('active');
                
                showToast('클라우드 업로드 완료!');
                
            } catch (error) {
                console.error('업로드 오류:', error);
                hideLoading();
                showToast('업로드 중 오류가 발생했습니다: ' + error.message, 'error');
                document.getElementById('emailSendModal').classList.add('active');
            }
        }
        
        // 드라이브 링크 복사
        function copyDriveLink() {
            if (preparedEmailData.driveUrl) {
                navigator.clipboard.writeText(preparedEmailData.driveUrl).then(() => {
                    showToast('링크가 복사되었습니다!');
                }).catch(() => {
                    // 클립보드 API 실패 시 대체 방법
                    const textArea = document.createElement('textarea');
                    textArea.value = preparedEmailData.driveUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('링크가 복사되었습니다!');
                });
            }
        }
        
        // 기존 prepareEmailData는 유지 (로컬 ZIP 다운로드용)
        async function prepareEmailData() {
            // uploadAndSendEmail로 리다이렉트
            await uploadAndSendEmail();
        }
        
        // Step 2: ZIP 다운로드 (로컬용 - 백업)
        function downloadPreparedPDF() {
            if (!preparedEmailData.zipBlob) {
                showToast('자료가 준비되지 않았습니다', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(preparedEmailData.zipBlob);
            link.download = preparedEmailData.zipFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('전체 자료가 다운로드되었습니다!');
        }
        
        // Step 2: 이메일 앱 열기 (사용자 직접 클릭 - 팝업 차단 우회)
        function openEmailApp() {
            if (!preparedEmailData.mailtoUrl) {
                showToast('이메일 정보가 준비되지 않았습니다', 'error');
                return;
            }
            
            window.location.href = preparedEmailData.mailtoUrl;
        }
        
        // Blob을 Base64로 변환
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // 전체 초기화
        function resetAllData() {
            if (!confirm(`정말 모든 프로젝트(${APP_DATA.projects.length}개)를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;
            if (!confirm('마지막 확인입니다.\n모든 하자 사진과 기록이 삭제됩니다.')) return;
            
            // 새 프로젝트 생성
            const newProj = createEmptyProject();
            APP_DATA.projects = [newProj];
            APP_DATA.currentProjectId = newProj.id;
            saveData();
            
            // UI 초기화
            loadCurrentProject();
            closeSettings();
            showToast('모든 데이터가 초기화되었습니다');
        }

        // 퀵모드 갤러리
        function openQuickGallery(type) {
            currentPhotoType = type;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        // ==================== 퀵모드 ====================
        let quickModeData = {
            photos: { far: null, near: null },
            spaces: [],
            locations: [],
            defectTypes: [],
            memo: ''
        };
        let isQuickMode = false;
        let editingDefectId = null;

        function openQuickMode() {
            isQuickMode = true;
            resetQuickModeData();
            renderQuickSpaceChips();
            renderQuickLocationChips();
            renderQuickDefectTypeChips();
            updateQuickModeCount();
            updateQuickStepProgress();
            document.getElementById('quickModeOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeQuickMode() {
            isQuickMode = false;
            document.getElementById('quickModeOverlay').classList.remove('active');
            document.body.style.overflow = '';
            
            // 수정 모드였으면 원복
            if (editingDefectId) {
                editingDefectId = null;
                document.querySelector('.quick-mode-btn.continue').textContent = '저장 → 다음 촬영 📸';
                document.querySelector('.quick-mode-btn.continue').onclick = saveAndContinueQuick;
                document.querySelector('.quick-mode-btn.save').style.display = '';
                document.querySelector('.quick-mode-title').textContent = '📸 하자 촬영';
            }
        }

        function resetQuickModeData() {
            quickModeData = {
                photos: { far: null, near: null },
                spaces: [],
                locations: [],
                defectTypes: [],
                memo: ''
            };
            
            // UI 초기화
            const farBox = document.getElementById('quickPhotoFar');
            const nearBox = document.getElementById('quickPhotoNear');
            
            farBox.innerHTML = `
                <span class="quick-mode-photo-icon">📸</span>
                <span class="quick-mode-photo-label">원경</span>
                <span class="quick-mode-photo-hint">멀리서 전체</span>
            `;
            farBox.classList.remove('has-photo');
            farBox.onclick = () => openQuickCamera('far');
            
            nearBox.innerHTML = `
                <span class="quick-mode-photo-icon">🔍</span>
                <span class="quick-mode-photo-label">근경</span>
                <span class="quick-mode-photo-hint">가까이서 상세</span>
            `;
            nearBox.classList.remove('has-photo');
            nearBox.onclick = () => openQuickCamera('near');
            
            document.getElementById('quickModeMemo').value = '';
            document.getElementById('quickSpaceCount').textContent = '0/4 선택';
            document.getElementById('quickLocationCount').textContent = '0/4 선택';
            document.getElementById('quickDefectTypeCount').textContent = '0/4 선택';
            renderQuickSpaceChips();
            renderQuickLocationChips();
            renderQuickDefectTypeChips();
            updateQuickSaveButton();
        }

        function renderQuickSpaceChips() {
            const container = document.getElementById('quickSpaceChips');
            const customSpaces = getCurrentProject().customSpaces || [];
            const allSpaces = [...DEFAULT_SPACES, ...customSpaces];
            
            container.innerHTML = allSpaces.map(space => {
                const isCustom = customSpaces.includes(space);
                const isSelected = quickModeData.spaces.includes(space);
                const isDisabled = quickModeData.spaces.length >= 4 && !isSelected;
                
                return `
                    <button class="touch-btn ${isSelected ? 'selected' : ''} ${isCustom ? 'custom' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                            onclick="toggleQuickSpace('${space}')">
                        ${space}
                        ${isCustom ? `<span class="delete-custom" onclick="event.stopPropagation(); deleteCustomSpace('${space}')">✕</span>` : ''}
                    </button>
                `;
            }).join('');
        }

        function toggleQuickSpace(space) {
            const idx = quickModeData.spaces.indexOf(space);
            if (idx > -1) {
                quickModeData.spaces.splice(idx, 1);
            } else {
                if (quickModeData.spaces.length >= 4) {
                    showToast('최대 4개까지 선택 가능합니다', 'error');
                    return;
                }
                quickModeData.spaces.push(space);
            }
            document.getElementById('quickSpaceCount').textContent = `${quickModeData.spaces.length}/4 선택`;
            renderQuickSpaceChips();
            updateAutoDescription();
            updateQuickStepProgress();
        }

        // 퀵모드 위치 칩 렌더링
        function renderQuickLocationChips() {
            const container = document.getElementById('quickLocationChips');
            if (!container) return;
            
            container.innerHTML = DEFAULT_LOCATIONS.map(location => {
                const isSelected = quickModeData.locations.includes(location);
                const isDisabled = quickModeData.locations.length >= 4 && !isSelected;
                
                return `
                    <button class="touch-btn ${isSelected ? 'selected' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                            onclick="toggleQuickLocation('${location}')">
                        ${location}
                    </button>
                `;
            }).join('');
        }

        function toggleQuickLocation(location) {
            const idx = quickModeData.locations.indexOf(location);
            if (idx > -1) {
                quickModeData.locations.splice(idx, 1);
            } else {
                if (quickModeData.locations.length >= 4) {
                    showToast('최대 4개까지 선택 가능합니다', 'error');
                    return;
                }
                quickModeData.locations.push(location);
            }
            document.getElementById('quickLocationCount').textContent = `${quickModeData.locations.length}/4 선택`;
            renderQuickLocationChips();
            updateAutoDescription();
        }

        // 퀵모드 하자내용 칩 렌더링
        function renderQuickDefectTypeChips() {
            const container = document.getElementById('quickDefectTypeChips');
            if (!container) return;
            
            container.innerHTML = DEFAULT_DEFECT_TYPES.map(defectType => {
                const isSelected = quickModeData.defectTypes.includes(defectType);
                const isDisabled = quickModeData.defectTypes.length >= 4 && !isSelected;
                
                return `
                    <button class="touch-btn ${isSelected ? 'selected' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                            onclick="toggleQuickDefectType('${defectType}')">
                        ${defectType}
                    </button>
                `;
            }).join('');
        }

        function toggleQuickDefectType(defectType) {
            const idx = quickModeData.defectTypes.indexOf(defectType);
            if (idx > -1) {
                quickModeData.defectTypes.splice(idx, 1);
            } else {
                if (quickModeData.defectTypes.length >= 4) {
                    showToast('최대 4개까지 선택 가능합니다', 'error');
                    return;
                }
                quickModeData.defectTypes.push(defectType);
            }
            document.getElementById('quickDefectTypeCount').textContent = `${quickModeData.defectTypes.length}/4 선택`;
            renderQuickDefectTypeChips();
            updateAutoDescription();
        }

        // 자동 하자내용 업데이트
        function updateAutoDescription() {
            const spacePart = quickModeData.spaces.length > 0 ? quickModeData.spaces.join(' ') : '';
            const locationPart = quickModeData.locations.length > 0 ? quickModeData.locations.join(' ') : '';
            const typePart = quickModeData.defectTypes.length > 0 ? quickModeData.defectTypes.join(' ') : '';
            
            const description = [spacePart, locationPart, typePart].filter(p => p).join(' ');
            document.getElementById('quickModeMemo').value = description;
        }

        function openQuickCamera(type) {
            currentPhotoType = type;
            openCamera(type);
        }

        function updateQuickPhotoBox(type, imageData) {
            const box = document.getElementById(type === 'far' ? 'quickPhotoFar' : 'quickPhotoNear');
            const label = type === 'far' ? '원경' : '근경';
            
            quickModeData.photos[type] = imageData;
            
            box.innerHTML = `
                <img src="${imageData}" alt="${label}">
                <span class="quick-mode-photo-badge">${label}</span>
                <button class="quick-mode-photo-delete" onclick="event.stopPropagation(); deleteQuickPhoto('${type}')">✕</button>
            `;
            box.classList.add('has-photo');
            box.onclick = () => openQuickCamera(type);
            
            updateQuickSaveButton();
            updateQuickStepProgress();
        }

        function deleteQuickPhoto(type) {
            quickModeData.photos[type] = null;
            
            const box = document.getElementById(type === 'far' ? 'quickPhotoFar' : 'quickPhotoNear');
            const icon = type === 'far' ? '📸' : '🔍';
            const label = type === 'far' ? '원경' : '근경';
            const hint = type === 'far' ? '멀리서 전체' : '가까이서 상세';
            
            box.innerHTML = `
                <span class="quick-mode-photo-icon">${icon}</span>
                <span class="quick-mode-photo-label">${label}</span>
                <span class="quick-mode-photo-hint">${hint}</span>
            `;
            box.classList.remove('has-photo');
            box.onclick = () => openQuickCamera(type);
            
            updateQuickSaveButton();
            updateQuickStepProgress();
        }

        function updateQuickSaveButton() {
            const btn = document.getElementById('quickSaveBtn');
            // 원경+근경 둘 다 있어야 저장 가능
            const hasBothPhotos = quickModeData.photos.far && quickModeData.photos.near;
            btn.disabled = !hasBothPhotos;
        }

        // 단계별 진행 업데이트
        function updateQuickStepProgress() {
            const hasFar = quickModeData.photos.far;
            const hasNear = quickModeData.photos.near;
            const hasBothPhotos = hasFar && hasNear;
            const hasSpace = quickModeData.spaces.length > 0;
            
            // 현재 단계 계산 (원경+근경 둘 다 필수)
            let currentStep = 1;
            if (hasBothPhotos && hasSpace) {
                currentStep = 3;
            } else if (hasBothPhotos) {
                currentStep = 2;
            }
            
            // 진행 바 업데이트
            const dots = document.querySelectorAll('.quick-step-dot');
            const lines = document.querySelectorAll('.quick-step-line');
            
            dots.forEach((dot, idx) => {
                const step = idx + 1;
                dot.classList.remove('active', 'completed');
                if (step < currentStep) {
                    dot.classList.add('completed');
                    dot.innerHTML = '✓';
                } else if (step === currentStep) {
                    dot.classList.add('active');
                    dot.innerHTML = step;
                } else {
                    dot.innerHTML = step;
                }
            });
            
            lines.forEach((line, idx) => {
                if (idx < currentStep - 1) {
                    line.classList.add('completed');
                } else {
                    line.classList.remove('completed');
                }
            });
            
            // 가이드 메시지 업데이트 (상세하게)
            const guideEl = document.getElementById('quickStepGuide');
            let guideMsg = '';
            
            if (!hasFar && !hasNear) {
                guideMsg = '📸 원경 사진을 먼저 촬영하세요';
            } else if (hasFar && !hasNear) {
                guideMsg = '🔍 근경 사진을 촬영하세요';
            } else if (!hasFar && hasNear) {
                guideMsg = '📸 원경 사진을 촬영하세요';
            } else if (hasBothPhotos && !hasSpace) {
                guideMsg = '📍 하자가 발견된 공간을 선택하세요';
            } else {
                guideMsg = '✅ 저장하거나 추가 정보를 입력하세요';
            }
            guideEl.textContent = guideMsg;
            
            // 섹션 활성화/비활성화
            const sectionPhoto = document.getElementById('quickSectionPhoto');
            const sectionSpace = document.getElementById('quickSectionSpace');
            const sectionOptional = document.getElementById('quickSectionOptional');
            
            // 사진 섹션: 항상 활성화
            sectionPhoto.classList.remove('dimmed');
            sectionPhoto.classList.add('active');
            
            // 공간 섹션: 원경+근경 둘 다 있어야 활성화
            if (hasBothPhotos) {
                sectionSpace.classList.remove('dimmed');
                sectionSpace.classList.add('active');
            } else {
                sectionSpace.classList.add('dimmed');
                sectionSpace.classList.remove('active');
            }
            
            // 선택사항 섹션: 공간 선택 후 활성화
            if (hasBothPhotos && hasSpace) {
                sectionOptional.classList.remove('dimmed');
                sectionOptional.classList.add('active');
            } else {
                sectionOptional.classList.add('dimmed');
                sectionOptional.classList.remove('active');
            }
        }

        function updateQuickModeCount() {
            document.getElementById('quickModeCount').textContent = `저장: ${getCurrentProject().defects.length}건`;
        }

        function saveQuickDefect() {
            // 원경+근경 둘 다 필수
            if (!quickModeData.photos.far || !quickModeData.photos.near) {
                if (!quickModeData.photos.far && !quickModeData.photos.near) {
                    showToast('원경과 근경 사진을 모두 촬영해주세요', 'error');
                } else if (!quickModeData.photos.far) {
                    showToast('원경 사진을 촬영해주세요', 'error');
                } else {
                    showToast('근경 사진을 촬영해주세요', 'error');
                }
                return false;
            }

            const memo = document.getElementById('quickModeMemo').value.trim();
            
            // 자동 설명 생성 - 공간 + 위치 + 하자내용 조합
            let autoDescription = '하자 촬영';
            if (quickModeData.spaces.length > 0 || quickModeData.locations.length > 0 || quickModeData.defectTypes.length > 0) {
                const spacePart = quickModeData.spaces.length > 0 ? quickModeData.spaces.join(' ') : '';
                const locationPart = quickModeData.locations.length > 0 ? quickModeData.locations.join(' ') : '';
                const typePart = quickModeData.defectTypes.length > 0 ? quickModeData.defectTypes.join(' ') : '';
                autoDescription = [spacePart, locationPart, typePart].filter(p => p).join(' ');
            }
            
            const newDefect = {
                id: Date.now(),
                spaces: quickModeData.spaces.length > 0 ? quickModeData.spaces : ['미지정'],
                locations: quickModeData.locations.length > 0 ? quickModeData.locations : [],
                defectTypes: quickModeData.defectTypes.length > 0 ? quickModeData.defectTypes : [],
                description: memo || autoDescription,
                photos: [quickModeData.photos.far, quickModeData.photos.near].filter(p => p)
            };

            getCurrentProject().defects.push(newDefect);
            saveData();
            renderDefectList();
            updateQuickModeCount();
            
            return true;
        }

        function saveAndContinueQuick() {
            if (saveQuickDefect()) {
                const count = getCurrentProject().defects.length;
                showToast(`#${count} 저장완료! 원경부터 촬영하세요 📸`);
                resetQuickModeData();
                
                // 바로 원경 카메라 열기 (연속 촬영)
                setTimeout(() => {
                    openQuickCamera('far');
                }, 500);
            }
        }

        function saveAndCloseQuick() {
            if (saveQuickDefect()) {
                const count = getCurrentProject().defects.length;
                showToast(`#${count} 저장 완료!`);
                closeQuickMode();
                
                // 하자점검 탭으로 이동하여 목록 확인
                switchTab('defect');
            }
        }

        // ==================== 초기화 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 라이선스 체크 (설정된 경우에만)
            checkLicenseOnStart();
            
            // 카카오톡 인앱브라우저 감지
            checkInAppBrowser();
            
            // 튜토리얼 초기화
            initTutorial();
            
            loadData();
            renderDefectList();
            renderEquipmentList();
            renderChecklistSpaces();
            initProjectInfoListeners();
            
            // 오늘 날짜 기본값
            const dateInput = document.getElementById('inspectionDate');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // 단계 가이드 초기화 (데이터 로드 후)
            setTimeout(updateStepGuide, 500);
            
            // 홈 하자 개수 업데이트
            updateHomeDefectCount();
        });
        
        function updateHomeDefectCount() {
            const count = getCurrentProject().defects.length;
            const defects = getCurrentProject().defects;
            
            // 플로우 카드 상태 업데이트
            const flow2Status = document.getElementById('flow2Status');
            if (flow2Status) {
                flow2Status.textContent = count > 0 ? `${count}건 완료` : '0건';
                flow2Status.className = count > 0 ? 'flow-step-status done' : 'flow-step-status';
            }
            
            // 하자 미리보기 업데이트
            const preview = document.getElementById('defectPreview');
            if (preview) {
                if (count === 0) {
                    preview.innerHTML = '';
                } else {
                    const showCount = Math.min(count, 4);
                    let html = '';
                    for (let i = 0; i < showCount; i++) {
                        const photo = defects[i].photos[0] || defects[i].photos[1];
                        if (photo) {
                            html += `<img src="${photo}" class="flow-defect-thumb" alt="하자 ${i+1}">`;
                        }
                    }
                    if (count > 4) {
                        html += `<div class="flow-defect-more">+${count - 4}</div>`;
                    }
                    preview.innerHTML = html;
                }
            }
            
            // 리포트 상태 업데이트
            const flow3Status = document.getElementById('flow3Status');
            if (flow3Status) {
                flow3Status.textContent = count > 0 ? '생성 가능' : '대기';
                flow3Status.className = count > 0 ? 'flow-step-status done' : 'flow-step-status';
            }
            
            // 홈 스텝 진행 업데이트
            updateHomeStepProgress();
        }

        // 홈 화면 단계별 진행 업데이트
        function updateHomeStepProgress() {
            const proj = getCurrentProject();
            const hasInfo = proj.apartmentName && proj.apartmentName.trim() !== '';
            const hasDefects = proj.defects && proj.defects.length > 0;
            
            // 현재 단계 계산
            let currentStep = 1;
            if (hasInfo && hasDefects) {
                currentStep = 3;
            } else if (hasInfo) {
                currentStep = 2;
            }
            
            // 진행 바 업데이트
            const dots = document.querySelectorAll('.home-step-dot');
            const lines = document.querySelectorAll('.home-step-line');
            
            dots.forEach((dot, idx) => {
                const step = idx + 1;
                dot.classList.remove('active', 'completed');
                if (step < currentStep) {
                    dot.classList.add('completed');
                    dot.innerHTML = '✓';
                } else if (step === currentStep) {
                    dot.classList.add('active');
                    dot.innerHTML = step;
                } else {
                    dot.innerHTML = step;
                }
            });
            
            lines.forEach((line, idx) => {
                if (idx < currentStep - 1) {
                    line.classList.add('completed');
                } else {
                    line.classList.remove('completed');
                }
            });
            
            // 플로우 카드 활성화/비활성화
            const flowCard1 = document.getElementById('flowCard1');
            const flowCard2 = document.getElementById('flowCard2');
            const flowCard3 = document.getElementById('flowCard3');
            
            // STEP 1: 항상 활성화
            flowCard1.classList.remove('home-section-dimmed');
            flowCard1.classList.add('home-section-active');
            if (hasInfo) {
                flowCard1.classList.remove('home-section-active');
            }
            
            // STEP 2: 정보 입력 후 활성화
            if (hasInfo) {
                flowCard2.classList.remove('home-section-dimmed');
                flowCard2.classList.add('home-section-active');
                if (hasDefects) {
                    flowCard2.classList.remove('home-section-active');
                }
            } else {
                flowCard2.classList.add('home-section-dimmed');
                flowCard2.classList.remove('home-section-active');
            }
            
            // STEP 3: 하자 1건 이상 후 활성화
            if (hasDefects) {
                flowCard3.classList.remove('home-section-dimmed');
                flowCard3.classList.add('home-section-active');
            } else {
                flowCard3.classList.add('home-section-dimmed');
                flowCard3.classList.remove('home-section-active');
            }
            
            // STEP 1 상태 표시
            const flow1Status = document.getElementById('flow1Status');
            if (flow1Status) {
                flow1Status.textContent = hasInfo ? '✓ 입력 완료' : '⏳ 입력 필요';
                flow1Status.className = hasInfo ? 'flow-step-status done' : 'flow-step-status';
            }
        }

        // 프로젝트 정보 자동 저장
        function initProjectInfoListeners() {
            const inputs = ['apartmentName', 'dongNumber', 'hoNumber', 'inspectionDate'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        saveProjectInfo();
                        updateStepGuide();
                        updateHomeStepProgress();
                    });
                    el.addEventListener('blur', () => {
                        saveProjectInfo();
                        updateStepGuide();
                        updateHomeStepProgress();
                    });
                    el.addEventListener('input', () => {
                        updateStepGuide();
                        updateHomeStepProgress();
                    });
                }
            });
        }

        function saveProjectInfo() {
            const proj = getCurrentProject();
            proj.apartmentName = document.getElementById('apartmentName').value;
            proj.dong = document.getElementById('dongNumber').value;
            proj.ho = document.getElementById('hoNumber').value;
            proj.inspectionDate = document.getElementById('inspectionDate').value;
            
            // 프로젝트 이름 자동 업데이트
            if (proj.apartmentName) {
                proj.name = `${proj.apartmentName} ${proj.dong}동 ${proj.ho}호`;
            }
            
            updateProjectSelector();
            saveData();
        }

        // 플로우 가이드 업데이트
        function updateStepGuide() {
            const aptName = document.getElementById('apartmentName').value.trim();
            const dong = document.getElementById('dongNumber').value.trim();
            const ho = document.getElementById('hoNumber').value.trim();
            const defectCount = getCurrentProject().defects.length;
            
            // Step 1: 정보 입력 상태
            const flow1Status = document.getElementById('flow1Status');
            const isStep1Complete = aptName && dong && ho;
            
            if (flow1Status) {
                if (isStep1Complete) {
                    flow1Status.textContent = '✓ 완료';
                    flow1Status.className = 'flow-step-status done';
                } else if (aptName || dong || ho) {
                    flow1Status.textContent = '⏳ 입력 중';
                    flow1Status.className = 'flow-step-status';
                } else {
                    flow1Status.textContent = '⏳ 입력 필요';
                    flow1Status.className = 'flow-step-status';
                }
            }
            
            // 나머지는 updateHomeDefectCount에서 처리
            updateHomeDefectCount();
        }

        // 요소로 스크롤
        function scrollToElement(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.animation = 'highlight-pulse 1s ease';
                setTimeout(() => el.style.animation = '', 1000);
            }
        }

        // ==================== IndexedDB 저장/로드 ====================
        const DB_NAME = 'viewfinder_db';
        const DB_VERSION = 1;
        const STORE_NAME = 'app_data';
        let db = null;

        // IndexedDB 초기화
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        // 데이터 저장 (IndexedDB)
        // ==================== 프로젝트 관리 ====================
        function getCurrentProject() {
            if (!APP_DATA.currentProjectId || APP_DATA.projects.length === 0) {
                // 첫 프로젝트가 없으면 생성
                const newProj = createEmptyProject();
                APP_DATA.projects.push(newProj);
                APP_DATA.currentProjectId = newProj.id;
                saveData();
            }
            
            const proj = APP_DATA.projects.find(p => p.id === APP_DATA.currentProjectId);
            if (!proj) {
                // 현재 프로젝트가 없으면 첫 번째 프로젝트 사용
                APP_DATA.currentProjectId = APP_DATA.projects[0].id;
                return APP_DATA.projects[0];
            }
            return proj;
        }

        function openProjectModal() {
            renderProjectList();
            document.getElementById('projectModalOverlay').classList.add('active');
        }

        function closeProjectModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('projectModalOverlay').classList.remove('active');
        }

        function renderProjectList() {
            const container = document.getElementById('projectList');
            
            if (APP_DATA.projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">📁</div>
                        <p>아직 프로젝트가 없습니다</p>
                        <p style="font-size: 13px; margin-top: 8px;">새 프로젝트를 만들어보세요</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = APP_DATA.projects.map(proj => {
                const isActive = proj.id === APP_DATA.currentProjectId;
                const defectCount = proj.defects.length;
                const photoCount = proj.defects.reduce((sum, d) => sum + d.photos.filter(p => p).length, 0);
                
                return `
                    <div class="project-item ${isActive ? 'active' : ''}" onclick="switchProject('${proj.id}')">
                        ${isActive ? '<div class="project-item-badge">사용중</div>' : ''}
                        <div class="project-item-name">${proj.name}</div>
                        <div class="project-item-info">
                            <span>${proj.apartmentName || '미입력'}</span>
                            ${proj.dong && proj.ho ? `<span>${proj.dong}동 ${proj.ho}호</span>` : ''}
                        </div>
                        <div class="project-item-stats">
                            <div class="project-stat">
                                <span class="project-stat-value">${defectCount}</span>하자
                            </div>
                            <div class="project-stat">
                                <span class="project-stat-value">${photoCount}</span>사진
                            </div>
                            <div class="project-stat">
                                <span class="project-stat-value">${new Date(proj.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${!isActive ? `<button class="project-delete-btn" onclick="event.stopPropagation(); deleteProject('${proj.id}')">삭제</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function createNewProject() {
            const newProj = createEmptyProject();
            const name = prompt('프로젝트 이름을 입력하세요:', `${newProj.apartmentName || '프로젝트'} ${APP_DATA.projects.length + 1}`);
            
            if (!name) return;
            
            newProj.name = name;
            APP_DATA.projects.push(newProj);
            APP_DATA.currentProjectId = newProj.id;
            saveData();
            
            // UI 업데이트
            loadCurrentProject();
            renderProjectList();
            updateProjectSelector();
            showToast('새 프로젝트가 생성되었습니다');
        }

        function switchProject(projectId) {
            if (APP_DATA.currentProjectId === projectId) {
                closeProjectModal();
                return;
            }
            
            APP_DATA.currentProjectId = projectId;
            saveData();
            
            // UI 전체 새로고침
            loadCurrentProject();
            closeProjectModal();
            showToast('프로젝트가 전환되었습니다');
        }

        function deleteProject(projectId) {
            if (APP_DATA.projects.length === 1) {
                showToast('마지막 프로젝트는 삭제할 수 없습니다', 'error');
                return;
            }
            
            const proj = APP_DATA.projects.find(p => p.id === projectId);
            if (!confirm(`"${proj.name}" 프로젝트를 삭제하시겠습니까?\n\n하자 ${proj.defects.length}건이 함께 삭제됩니다.`)) {
                return;
            }
            
            APP_DATA.projects = APP_DATA.projects.filter(p => p.id !== projectId);
            
            // 현재 프로젝트였다면 첫 번째 프로젝트로 전환
            if (APP_DATA.currentProjectId === projectId) {
                APP_DATA.currentProjectId = APP_DATA.projects[0].id;
                loadCurrentProject();
            }
            
            saveData();
            renderProjectList();
            updateProjectSelector();
            showToast('프로젝트가 삭제되었습니다');
        }

        function updateProjectSelector() {
            const proj = getCurrentProject();
            const name = proj.name || (proj.apartmentName ? `${proj.apartmentName} ${proj.dong}동 ${proj.ho}호` : '새 프로젝트');
            document.getElementById('currentProjectName').textContent = name;
        }

        function loadCurrentProject() {
            const proj = getCurrentProject();
            
            // 프로젝트 정보 폼에 로드
            document.getElementById('apartmentName').value = proj.apartmentName || '';
            document.getElementById('dongNumber').value = proj.dong || '';
            document.getElementById('hoNumber').value = proj.ho || '';
            document.getElementById('inspectionDate').value = proj.inspectionDate || new Date().toISOString().split('T')[0];
            
            // 리스트 렌더링
            renderDefectList();
            renderChecklistSpaces();
            updateStepGuide();
            updateProjectSelector();
            updateHomeDefectCount();
        }

        // ==================== 데이터 저장/불러오기 ====================
        function saveData() {
            if (!db) {
                console.warn('DB not initialized');
                return;
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const dataToSave = {
                    id: 'main',
                    ...APP_DATA
                };
                
                store.put(dataToSave);
                
                transaction.onerror = (e) => {
                    console.error('저장 오류:', e);
                    showToast('저장 중 오류가 발생했습니다', 'error');
                };
                
                updateCounts();
            } catch (err) {
                console.error('saveData 오류:', err);
                showToast('저장 중 오류가 발생했습니다', 'error');
            }
        }

        // 데이터 로드 (IndexedDB)
        async function loadData() {
            try {
                await initDB();
                
                // localStorage에서 마이그레이션 시도
                const oldData = localStorage.getItem('viewfinder_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        Object.assign(APP_DATA, parsed);
                        saveData(); // IndexedDB로 저장
                        localStorage.removeItem('viewfinder_data'); // 기존 데이터 삭제
                        console.log('localStorage에서 IndexedDB로 마이그레이션 완료');
                    } catch (e) {
                        console.warn('마이그레이션 실패:', e);
                    }
                }
                
                // IndexedDB에서 로드
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('main');
                
                request.onsuccess = () => {
                    if (request.result) {
                        const { id, ...data } = request.result;
                        
                        // 기존 데이터 구조 확인 및 마이그레이션
                        if (data.defects && !data.projects) {
                            console.log('기존 데이터를 프로젝트 구조로 마이그레이션');
                            const firstProject = createEmptyProject();
                            firstProject.defects = data.defects || [];
                            firstProject.customSpaces = data.customSpaces || [];
                            firstProject.checkedItems = data.checkedItems || {};
                            
                            if (data.projectInfo) {
                                firstProject.apartmentName = data.projectInfo.apartmentName || '';
                                firstProject.dong = data.projectInfo.dong || '';
                                firstProject.ho = data.projectInfo.ho || '';
                                firstProject.inspectionDate = data.projectInfo.inspectionDate || new Date().toISOString().split('T')[0];
                                firstProject.name = firstProject.apartmentName ? 
                                    `${firstProject.apartmentName} ${firstProject.dong}동 ${firstProject.ho}호` : 
                                    '프로젝트 1';
                            }
                            
                            APP_DATA.projects = [firstProject];
                            APP_DATA.currentProjectId = firstProject.id;
                            saveData(); // 마이그레이션된 데이터 저장
                        } else {
                            Object.assign(APP_DATA, data);
                        }
                        
                        // 프로젝트가 없으면 생성
                        if (!APP_DATA.projects || APP_DATA.projects.length === 0) {
                            const newProj = createEmptyProject();
                            APP_DATA.projects = [newProj];
                            APP_DATA.currentProjectId = newProj.id;
                            saveData();
                        }
                        
                        // 현재 프로젝트 로드
                        loadCurrentProject();
                    }
                    updateCounts();
                };
                
                request.onerror = () => {
                    console.error('로드 오류:', request.error);
                    
                    // 로드 실패 시 첫 프로젝트 생성
                    const newProj = createEmptyProject();
                    APP_DATA.projects = [newProj];
                    APP_DATA.currentProjectId = newProj.id;
                    loadCurrentProject();
                    updateCounts();
                };
                
            } catch (err) {
                console.error('loadData 오류:', err);
                updateCounts();
            }
        }

        function updateCounts() {
            const count = getCurrentProject().defects.length;
            
            // 요소가 있으면 업데이트 (null 체크)
            const defectCountEl = document.getElementById('defectCount');
            if (defectCountEl) defectCountEl.textContent = `${count}건 발견`;
            
            const defectCountHomeEl = document.getElementById('defectCountHome');
            if (defectCountHomeEl) defectCountHomeEl.textContent = `${count}건`;
            
            const reportDefectCountEl = document.getElementById('reportDefectCount');
            if (reportDefectCountEl) reportDefectCountEl.textContent = `${count}건`;
            
            const inspectionCountEl = document.getElementById('inspectionCount');
            if (inspectionCountEl) inspectionCountEl.textContent = `${count}건`;
            
            // 촬영 사진 수
            const photoCount = getCurrentProject().defects.reduce((sum, d) => {
                return sum + (d.photos ? d.photos.filter(p => p).length : 0);
            }, 0);
            const reportPhoto = document.getElementById('reportPhotoCount');
            if (reportPhoto) reportPhoto.textContent = photoCount;
            
            // 프로그레스 바 (최대 20건 기준)
            const progress = Math.min(count * 5, 100);
            const totalProgressBar = document.getElementById('totalProgressBar');
            if (totalProgressBar) totalProgressBar.style.width = `${progress}%`;
            
            const reportBar = document.getElementById('reportProgressBar');
            if (reportBar) reportBar.style.width = `${progress}%`;
        }

        // ==================== 섹션 전환 ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            if (sectionId === 'homeSection') {
                document.querySelector('.nav-item').classList.add('active');
            }
            
            // 리포트 섹션 표시 시 프로젝트 정보 업데이트
            if (sectionId === 'reportSection') {
                updateReportProjectInfo();
                updateReportEmptyState();
            }
        }
        
        function updateReportEmptyState() {
            const emptyState = document.getElementById('reportEmptyState');
            const reportContent = document.getElementById('reportContent');
            
            if (getCurrentProject().defects.length === 0) {
                emptyState.style.display = 'block';
                reportContent.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                reportContent.style.display = 'block';
            }
        }
        
        function updateReportProjectInfo() {
            const aptName = document.getElementById('apartmentName').value || '-';
            const dong = document.getElementById('dongNumber').value || '-';
            const ho = document.getElementById('hoNumber').value || '-';
            const date = document.getElementById('inspectionDate').value || '-';
            
            const reportAptName = document.getElementById('reportAptName');
            if (reportAptName) reportAptName.textContent = aptName;
            
            const reportDongHo = document.getElementById('reportDongHo');
            if (reportDongHo) reportDongHo.textContent = (dong !== '-' && ho !== '-') ? `${dong}동 ${ho}호` : '-';
            
            const reportDate = document.getElementById('reportDate');
            if (reportDate) reportDate.textContent = date;
            
            // 통계 업데이트
            const defectCount = getCurrentProject().defects.length;
            const photoCount = getCurrentProject().defects.reduce((sum, d) => sum + d.photos.filter(p => p).length, 0);
            
            const reportDefectCount = document.getElementById('reportDefectCount');
            if (reportDefectCount) reportDefectCount.textContent = defectCount + '건';
            
            const reportPhotoCount = document.getElementById('reportPhotoCount');
            if (reportPhotoCount) reportPhotoCount.textContent = photoCount;
            
            const reportProgressBar = document.getElementById('reportProgressBar');
            if (reportProgressBar) reportProgressBar.style.width = Math.min(defectCount * 5, 100) + '%';
        }

        // ==================== 하자 등록 화면 ====================
        // ==================== 커스텀 공간 추가/삭제 ====================
        function addCustomSpace() {
            const name = prompt('추가할 공간 이름을 입력하세요:');
            if (!name || !name.trim()) return;
            
            const spaceName = name.trim();
            const proj = getCurrentProject();
            
            // 중복 체크
            if (DEFAULT_SPACES.includes(spaceName) || (proj.customSpaces && proj.customSpaces.includes(spaceName))) {
                showToast('이미 존재하는 공간입니다', 'error');
                return;
            }
            
            // 프로젝트에 커스텀 공간 추가
            if (!proj.customSpaces) proj.customSpaces = [];
            proj.customSpaces.push(spaceName);
            saveData();
            
            // 퀵모드 UI 갱신
            renderQuickSpaceChips();
            
            showToast(`"${spaceName}" 공간이 추가되었습니다`);
        }

        function deleteCustomSpace(space) {
            if (!confirm(`"${space}" 공간을 삭제하시겠습니까?`)) return;
            
            const proj = getCurrentProject();
            proj.customSpaces = (proj.customSpaces || []).filter(s => s !== space);
            
            // 현재 선택에서도 제거
            quickModeData.spaces = quickModeData.spaces.filter(s => s !== space);
            
            saveData();
            
            // 퀵모드 UI 갱신
            renderQuickSpaceChips();
            document.getElementById('quickSpaceCount').textContent = `${quickModeData.spaces.length}/4 선택`;
            
            showToast(`"${space}" 공간이 삭제되었습니다`);
        }

        // ==================== 카메라 ====================
        async function openCamera(photoType) {
            if (!photoType) return; // 안전장치
            currentPhotoType = photoType;
            currentZoom = 1.0;
            markers = [];
            
            const guideText = document.getElementById('cameraGuideText');
            if (photoType === 'far') {
                guideText.textContent = '원경 촬영 - 멀리서 전체';
                guideText.className = 'camera-guide-text far';
            } else {
                guideText.textContent = '근경 촬영 - 가까이서 상세';
                guideText.className = 'camera-guide-text near';
            }
            
            try {
                // 카메라 API 지원 확인
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('카메라 미지원');
                }
                
                // 디바이스별 최적화
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                let constraints = {
                    video: { facingMode: 'environment' },
                    audio: false
                };
                
                // iOS: 중간 해상도 (메모리 최적화)
                if (isIOS) {
                    constraints.video.width = { ideal: 1280 };
                    constraints.video.height = { ideal: 720 };
                } else {
                    constraints.video.width = { ideal: 1920 };
                    constraints.video.height = { ideal: 1080 };
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                
                // iOS Safari 필수 속성
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');
                video.muted = true;
                
                // 비디오 로드 대기
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(resolve);
                    };
                    setTimeout(resolve, 3000);
                });
                
                // 줌 초기화
                video.style.transform = 'scale(1)';
                const zoomLabel = document.getElementById('zoomLevel');
                if (zoomLabel) zoomLabel.textContent = '1.0x';
                
                // 마커 캔버스 초기화
                markerCanvas = document.getElementById('markerCanvas');
                markerCtx = markerCanvas.getContext('2d');
                
                // 카메라 모달 먼저 표시
                document.getElementById('cameraModal').classList.add('active');
                document.getElementById('markerHint').classList.remove('hidden');
                
                // 비디오 렌더링 후 마커 캔버스 크기 재설정
                setTimeout(() => {
                    resizeMarkerCanvas();
                }, 100);
                
                // 추가로 500ms 후에도 한번 더 (안전장치)
                setTimeout(() => {
                    resizeMarkerCanvas();
                }, 500);
                
                // 컨텍스트 메뉴 차단 (Google Lens 방지)
                video.addEventListener('contextmenu', preventEvent, { passive: false });
                
                // 터치 이벤트 설정
                setupTouchEvents(video);
                
                // 3초 후 힌트 숨김
                setTimeout(() => {
                    document.getElementById('markerHint').classList.add('hidden');
                }, 3000);
                
            } catch (err) {
                console.error('카메라 오류:', err);
                
                // 권한 거부 또는 카메라 없음
                if (err.name === 'NotAllowedError') {
                    showToast('카메라 권한이 필요합니다. 설정에서 권한을 허용해주세요.', 'error');
                } else if (err.name === 'NotFoundError') {
                    showToast('카메라를 찾을 수 없습니다.', 'error');
                } else {
                    showToast('카메라를 실행할 수 없습니다.', 'error');
                }
            }
        }

        function preventEvent(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }

        // 터치 이벤트 설정 (핀치줌 + 마커)
        function setupTouchEvents(video) {
            const container = video.parentElement;
            let initialDistance = 0;
            let initialZoom = 1.0;
            let touchStartTime = 0;
            
            const getDistance = (touch1, touch2) => {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            };
            
            container.ontouchstart = (e) => {
                touchStartTime = Date.now();
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialZoom = currentZoom;
                    e.preventDefault();
                }
            };
            
            container.ontouchmove = (e) => {
                if (e.touches.length === 2) {
                    const newDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = newDistance / initialDistance;
                    applyZoom(initialZoom * scale);
                    e.preventDefault();
                }
            };
            
            container.ontouchend = (e) => {
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 200 && e.changedTouches.length === 1 && markers.length < 10) {
                    const touch = e.changedTouches[0];
                    const rect = container.getBoundingClientRect();
                    const x = (touch.clientX - rect.left) / rect.width;
                    const y = (touch.clientY - rect.top) / rect.height;
                    addMarker(x, y);
                }
            };
        }

        function applyZoom(zoom) {
            currentZoom = Math.max(1.0, Math.min(zoom, 5.0));
            const video = document.getElementById('cameraPreview');
            video.style.transform = `scale(${currentZoom})`;
            const zoomLabel = document.getElementById('zoomLevel');
            if (zoomLabel) zoomLabel.textContent = `${currentZoom.toFixed(1)}x`;
        }

        function resizeMarkerCanvas() {
            if (!markerCanvas) return;
            const video = document.getElementById('cameraPreview');
            const rect = video.getBoundingClientRect();
            markerCanvas.width = rect.width;
            markerCanvas.height = rect.height;
            redrawMarkers();
        }

        function addMarker(x, y) {
            markers.push({ x, y });
            redrawMarkers();
            document.getElementById('markerHint').classList.add('hidden');
            
            // 피드백
            if (markers.length === 1) {
                showToast(`마커 ${markers.length}개 추가됨 (최대 10개)`);
            }
        }

        function redrawMarkers() {
            if (!markerCtx || !markerCanvas) return;
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            
            markers.forEach((marker, idx) => {
                const x = marker.x * markerCanvas.width;
                const y = marker.y * markerCanvas.height;
                
                // 외곽 그림자
                markerCtx.beginPath();
                markerCtx.arc(x, y, 32, 0, Math.PI * 2);
                markerCtx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                markerCtx.lineWidth = 6;
                markerCtx.stroke();
                
                // 메인 원 (빨간색)
                markerCtx.beginPath();
                markerCtx.arc(x, y, 28, 0, Math.PI * 2);
                markerCtx.strokeStyle = '#FF0000';
                markerCtx.lineWidth = 5;
                markerCtx.stroke();
                
                // 십자선
                markerCtx.beginPath();
                markerCtx.moveTo(x - 12, y);
                markerCtx.lineTo(x + 12, y);
                markerCtx.moveTo(x, y - 12);
                markerCtx.lineTo(x, y + 12);
                markerCtx.strokeStyle = '#FF0000';
                markerCtx.lineWidth = 3;
                markerCtx.stroke();
                
                // 번호 배경
                markerCtx.beginPath();
                markerCtx.arc(x, y - 40, 14, 0, Math.PI * 2);
                markerCtx.fillStyle = '#FF0000';
                markerCtx.fill();
                markerCtx.strokeStyle = '#FFFFFF';
                markerCtx.lineWidth = 2;
                markerCtx.stroke();
                
                // 번호 텍스트
                markerCtx.font = 'bold 16px sans-serif';
                markerCtx.fillStyle = '#FFFFFF';
                markerCtx.textAlign = 'center';
                markerCtx.textBaseline = 'middle';
                markerCtx.fillText(idx + 1, x, y - 40);
            });
        }

        function resetMarkers() {
            markers = [];
            redrawMarkers();
            showToast('마커가 초기화되었습니다');
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraPreview');
            if (video) video.style.transform = 'scale(1)';
            document.getElementById('cameraModal').classList.remove('active');
        }

        function adjustZoom(delta) {
            applyZoom(currentZoom + delta);
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d', { alpha: false });
            
            // 디바이스별 최적화
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const maxSize = isIOS ? 1280 : 1920;
            const quality = isIOS ? 0.8 : 0.85;
            
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // 최대 너비 제한
            if (width > maxSize) {
                height = Math.round(height * maxSize / width);
                width = maxSize;
            }
            
            // iOS 메모리 제한
            const maxPixels = isIOS ? 4096 * 4096 : 8192 * 8192;
            if (width * height > maxPixels) {
                const scale = Math.sqrt(maxPixels / (width * height));
                width = Math.floor(width * scale);
                height = Math.floor(height * scale);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // 배경 흰색
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            
            // 고품질 렌더링
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // 줌 적용하여 캡처
            if (currentZoom > 1) {
                const zoomedWidth = video.videoWidth / currentZoom;
                const zoomedHeight = video.videoHeight / currentZoom;
                const sx = (video.videoWidth - zoomedWidth) / 2;
                const sy = (video.videoHeight - zoomedHeight) / 2;
                ctx.drawImage(video, sx, sy, zoomedWidth, zoomedHeight, 0, 0, width, height);
            } else {
                ctx.drawImage(video, 0, 0, width, height);
            }
            
            // 마커 그리기 (더 크고 두껍게)
            if (markers.length > 0) {
                markers.forEach((marker, idx) => {
                    const x = marker.x * width;
                    const y = marker.y * height;
                    
                    // 외곽 그림자 (가시성 향상)
                    ctx.beginPath();
                    ctx.arc(x, y, 55, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.lineWidth = 12;
                    ctx.stroke();
                    
                    // 메인 원 (빨간색, 더 두껍게)
                    ctx.beginPath();
                    ctx.arc(x, y, 50, 0, Math.PI * 2);
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    
                    // 십자선 (하자 위치 명확히 표시)
                    ctx.beginPath();
                    ctx.moveTo(x - 20, y);
                    ctx.lineTo(x + 20, y);
                    ctx.moveTo(x, y - 20);
                    ctx.lineTo(x, y + 20);
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    
                    // 번호 배경 (흰색 원, 더 크게)
                    ctx.beginPath();
                    ctx.arc(x, y - 65, 26, 0, Math.PI * 2);
                    ctx.fillStyle = '#FF0000';
                    ctx.fill();
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    
                    // 번호 텍스트 (더 크게)
                    ctx.font = 'bold 28px sans-serif';
                    ctx.fillStyle = '#FFFFFF';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(idx + 1, x, y - 65);
                });
            }
            
            const imageData = canvas.toDataURL('image/jpeg', quality);
            
            // 퀵모드 UI 업데이트
            updateQuickPhotoBox(currentPhotoType, imageData);
            closeCamera();
        }

        // 갤러리 폴백
        function openGallery(photoType) {
            if (!photoType) return; // 안전장치
            currentPhotoType = photoType;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        function openGalleryFromCamera() {
            // 카메라 닫고 갤러리 열기
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleGallerySelect;
            input.click();
        }

        // ==================== 사진 옵션 액션시트 ====================
        let pendingPhotoType = null;

        function showPhotoOptions(photoType) {
            pendingPhotoType = photoType;
            const title = photoType === 'far' ? '원경 사진 (멀리서)' : '근경 사진 (가까이서)';
            document.getElementById('photoActionTitle').textContent = title;
            document.getElementById('photoActionSheet').classList.add('active');
        }

        function closePhotoOptions() {
            document.getElementById('photoActionSheet').classList.remove('active');
            pendingPhotoType = null;
        }

        function selectPhotoOption(option) {
            const photoType = pendingPhotoType; // 먼저 저장
            closePhotoOptions();
            
            if (!photoType) return;
            
            if (option === 'camera') {
                openCamera(photoType);
            } else if (option === 'gallery') {
                openGallery(photoType);
            }
        }

        // ==================== 이미지 압축 ====================
        async function compressImage(input, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                try {
                    // 디바이스 감지
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    
                    // iOS 최적화
                    if (isIOS) {
                        maxWidth = Math.min(maxWidth, 1280);
                        quality = Math.min(quality, 0.8);
                    }
                    
                    const img = new Image();
                    
                    img.onerror = () => reject(new Error('이미지 로드 실패'));
                    
                    img.onload = () => {
                        try {
                            const canvas = document.getElementById('photoCanvas');
                            const ctx = canvas.getContext('2d', { alpha: false });
                            
                            let width = img.width;
                            let height = img.height;
                            
                            // 최대 너비 제한
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            // iOS 메모리 제한
                            const maxPixels = isIOS ? 4096 * 4096 : 8192 * 8192;
                            if (width * height > maxPixels) {
                                const scale = Math.sqrt(maxPixels / (width * height));
                                width = Math.floor(width * scale);
                                height = Math.floor(height * scale);
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // 배경 흰색 (투명 PNG 처리)
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, width, height);
                            
                            // 고품질 렌더링
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        } catch (err) {
                            reject(err);
                        }
                    };
                    
                    img.src = input;
                } catch (err) {
                    reject(err);
                }
            });
        }
        
        // 갤러리 선택 핸들러 (async로 변경)
        async function handleGallerySelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!currentPhotoType) return;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const compressed = await compressImage(event.target.result, 1280, 0.8);
                        
                        // 퀵모드인 경우 퀵모드 UI 업데이트
                        if (isQuickMode) {
                            updateQuickPhotoBox(currentPhotoType, compressed);
                            showToast('사진이 첨부되었습니다');
                            return;
                        }
                        
                        // 일반 모드
                        currentDefect.photos[currentPhotoType] = compressed;
                        updatePhotoBox(currentPhotoType, compressed);
                        showToast('사진이 첨부되었습니다');
                    } catch (err) {
                        console.error('압축 오류:', err);
                        showToast('이미지 처리 중 오류가 발생했습니다', 'error');
                    }
                };
                reader.readAsDataURL(file);
            } catch (err) {
                showToast('파일을 읽을 수 없습니다', 'error');
            }
        }

        // ==================== 하자 목록 렌더링 ====================
        function renderDefectList() {
            const container = document.getElementById('defectList');
            
            if (getCurrentProject().defects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📷</div>
                        <div class="empty-state-title">아직 발견된 하자가 없습니다</div>
                        <div class="empty-state-desc">
                            하자를 발견하면 촬영 버튼을 눌러<br>
                            원경/근경 사진을 찍어주세요
                        </div>
                        <button class="empty-state-btn" onclick="openQuickMode()">📸 촬영 시작</button>
                    </div>
                `;
                updateStepGuide();
                updateHomeDefectCount();
                return;
            }
            
            container.innerHTML = getCurrentProject().defects.map((defect, index) => {
                // 기존 데이터 호환성 처리
                const spaces = defect.spaces || [];
                const locations = defect.locations || [];
                const defectTypes = defect.defectTypes || [];
                
                // 위치 + 하자내용 조합 표시
                const detailParts = [...locations, ...defectTypes];
                const detailText = detailParts.length > 0 ? detailParts.join(' ') : '';
                
                return `
                <div class="defect-card" onclick="openDefectEdit(${defect.id})">
                    <button class="defect-delete-btn" onclick="event.stopPropagation(); deleteDefect(${defect.id})">🗑️</button>
                    <div class="defect-header">
                        <span class="defect-number">${index + 1}</span>
                        <span class="defect-location">${spaces.join(' ') || '미지정'}</span>
                        ${detailText ? `<span class="defect-detail">${detailText}</span>` : ''}
                    </div>
                    <div class="defect-photos">
                        ${defect.photos[0] ? `<img src="${defect.photos[0]}" class="defect-photo" alt="원경">` : ''}
                        ${defect.photos[1] ? `<img src="${defect.photos[1]}" class="defect-photo" alt="근경">` : ''}
                    </div>
                    ${defect.description ? `<div class="defect-desc">${defect.description}</div>` : ''}
                </div>
            `}).join('');
            
            updateStepGuide();
            updateHomeDefectCount();
        }

        function deleteDefect(id) {
            if (!confirm('이 하자를 삭제하시겠습니까?')) return;
            
            const idx = getCurrentProject().defects.findIndex(d => d.id === id);
            if (idx > -1) {
                getCurrentProject().defects.splice(idx, 1);
                saveData();
                renderDefectList();
                updateStepGuide();
                showToast('삭제되었습니다');
            }
        }

        // ==================== 하자 수정 ====================
        function openDefectEdit(id) {
            const defect = getCurrentProject().defects.find(d => d.id === id);
            if (!defect) return;
            
            editingDefectId = id;
            
            // 기존 데이터 호환성
            const spaces = defect.spaces || [];
            const locations = defect.locations || [];
            const defectTypes = defect.defectTypes || [];
            
            // quickModeData에 로드
            quickModeData = {
                photos: { 
                    far: defect.photos[0] || null, 
                    near: defect.photos[1] || null 
                },
                spaces: [...spaces],
                locations: [...locations],
                defectTypes: [...defectTypes],
                memo: defect.description || ''
            };
            
            // UI 열기
            document.getElementById('quickModeOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // 사진 표시
            if (quickModeData.photos.far) {
                updateQuickPhotoBox('far', quickModeData.photos.far);
            }
            if (quickModeData.photos.near) {
                updateQuickPhotoBox('near', quickModeData.photos.near);
            }
            
            // 선택 상태 렌더링
            renderQuickSpaceChips();
            renderQuickLocationChips();
            renderQuickDefectTypeChips();
            
            // 카운트 업데이트
            document.getElementById('quickSpaceCount').textContent = `${spaces.length}/4 선택`;
            document.getElementById('quickLocationCount').textContent = `${locations.length}/4 선택`;
            document.getElementById('quickDefectTypeCount').textContent = `${defectTypes.length}/4 선택`;
            
            // 하자내용 표시
            document.getElementById('quickModeMemo').value = defect.description || '';
            
            // 버튼 텍스트 변경
            document.querySelector('.quick-mode-btn.continue').textContent = '수정 완료 ✓';
            document.querySelector('.quick-mode-btn.continue').onclick = saveDefectEdit;
            document.querySelector('.quick-mode-btn.save').style.display = 'none';
            
            // 타이틀 변경
            document.querySelector('.quick-mode-title').textContent = '📝 하자 수정';
            
            updateQuickModeCount();
        }

        function saveDefectEdit() {
            if (!editingDefectId) return;
            
            const defect = getCurrentProject().defects.find(d => d.id === editingDefectId);
            if (!defect) return;
            
            // 데이터 업데이트
            defect.spaces = quickModeData.spaces.length > 0 ? quickModeData.spaces : ['미지정'];
            defect.locations = quickModeData.locations || [];
            defect.defectTypes = quickModeData.defectTypes || [];
            defect.description = document.getElementById('quickModeMemo').value.trim() || '하자 촬영';
            defect.photos = [quickModeData.photos.far, quickModeData.photos.near].filter(p => p);
            
            saveData();
            closeDefectEdit();
            renderDefectList();
            showToast('수정 완료!');
        }

        function closeDefectEdit() {
            editingDefectId = null;
            
            // 버튼 원복
            document.querySelector('.quick-mode-btn.continue').textContent = '저장 → 다음 촬영 📸';
            document.querySelector('.quick-mode-btn.continue').onclick = saveAndContinueQuick;
            document.querySelector('.quick-mode-btn.save').style.display = '';
            
            // 타이틀 원복
            document.querySelector('.quick-mode-title').textContent = '📸 하자 촬영';
            
            closeQuickMode();
            resetQuickModeData();
        }

        // ==================== 장비 가이드 ====================
        function renderEquipmentList() {
            const equipment = [
                { 
                    name: '열화상 카메라', 
                    icon: '🔥', 
                    desc: '결로, 누수, 단열 불량 확인',
                    guide: {
                        purpose: '벽체, 창호, 바닥의 온도 차이를 시각화하여 단열 불량, 결로 위험 구간, 누수 의심 부위를 탐지합니다.',
                        howToUse: [
                            '실내외 온도차가 클수록 정확도 상승 (겨울철 난방 가동 시 최적)',
                            '창문, 출입문 주변의 외기 침투 여부 확인',
                            '천장/벽면의 온도 변화로 누수 가능성 탐지',
                            '바닥 난방 시 온수 배관 위치 및 균일성 확인'
                        ],
                        checkPoints: [
                            '창호 프레임 접합부 (열교 현상)',
                            '외벽과 내벽이 만나는 코너 (결로 취약)',
                            '욕실/발코니 인접 벽면 (누수 의심)',
                            '바닥 전체 (난방 불균형 체크)'
                        ],
                        tips: '촬영 전 난방을 1~2시간 가동하고, 창문과 문을 닫아 실내 온도를 안정시킨 후 측정하세요.',
                        standards: '인접 구역 대비 3°C 이상 온도차 발생 시 하자 의심'
                    }
                },
                { 
                    name: '라돈 측정기', 
                    icon: '☢️', 
                    desc: '실내 라돈 농도 측정',
                    guide: {
                        purpose: '지반에서 방출되는 방사성 기체인 라돈의 실내 농도를 측정하여 거주 안전성을 확인합니다.',
                        howToUse: [
                            '측정기를 바닥에서 1m 높이에 설치',
                            '창문과 문을 닫고 환기 중단 상태에서 측정',
                            '최소 24시간~48시간 연속 측정 권장',
                            '거실, 안방, 화장실 등 주요 공간에서 측정'
                        ],
                        checkPoints: [
                            '거실 (주요 거주 공간)',
                            '안방 및 침실 (수면 공간)',
                            '화장실 (배관 관통부 주변)',
                            '환기가 어려운 밀폐된 공간'
                        ],
                        tips: '측정 중에는 환기를 하지 않고, 가능하면 난방을 가동하여 실제 거주 환경과 유사하게 설정하세요.',
                        standards: '국내 권고 기준: 148 Bq/m³ (4 pCi/L) 이하 / WHO 권고: 100 Bq/m³ 이하'
                    }
                },
                { 
                    name: '레이저 레벨기', 
                    icon: '📐', 
                    desc: '바닥/벽 수평 확인',
                    guide: {
                        purpose: '바닥과 벽면의 수평/수직 상태를 정밀하게 측정하여 시공 품질을 확인합니다.',
                        howToUse: [
                            '레벨기를 바닥에 안정적으로 설치하고 수평 맞춤',
                            '360° 레이저 라인으로 전체 공간 스캔',
                            '줄자로 바닥과 레이저 라인 간 높이차 측정',
                            '벽면 수직도는 상하 레이저 점 거리로 확인'
                        ],
                        checkPoints: [
                            '거실 및 방 바닥 전체 (기울기 확인)',
                            '욕실, 발코니 바닥 (배수 구배 확인)',
                            '문틀 및 창틀 (수직/수평 확인)',
                            '붙박이장, 신발장 설치면 (수평도)'
                        ],
                        tips: '바닥재 시공 전 측정이 가장 정확하며, 완공 후에는 여러 지점에서 줄자로 높이차를 측정하세요.',
                        standards: '바닥 기울기: 3m당 3mm 이내 / 벽면 수직도: 3m당 3mm 이내'
                    }
                }
            ];
            
            document.getElementById('equipmentList').innerHTML = equipment.map((eq, idx) => {
                // guide가 있는 장비만 아코디언 형태로 표시
                if (eq.guide) {
                    return `
                    <div class="equipment-card" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); margin-bottom: 12px; overflow: hidden;">
                        <div style="padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer;" onclick="toggleEquipmentGuide(${idx})">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #00A080); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">${eq.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${eq.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${eq.desc}</div>
                            </div>
                            <div style="color: var(--accent); font-size: 18px; transition: transform 0.3s;" id="eqArrow${idx}">▼</div>
                        </div>
                        <div id="eqGuide${idx}" style="display: none; padding: 0 16px 16px 16px; border-top: 1px solid var(--card-border);">
                            <div style="padding-top: 16px;">
                                <!-- 용도 -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <span>🎯</span> 측정 목적
                                    </div>
                                    <div style="font-size: 13px; color: var(--text); line-height: 1.6; padding-left: 4px;">
                                        ${eq.guide.purpose}
                                    </div>
                                </div>
                                
                                <!-- 사용법 -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <span>📖</span> 사용 방법
                                    </div>
                                    <div style="padding-left: 4px;">
                                        ${eq.guide.howToUse.map(item => `
                                            <div style="font-size: 12px; color: var(--text); margin-bottom: 6px; display: flex; gap: 8px; line-height: 1.5;">
                                                <span style="color: var(--accent);">•</span>
                                                <span>${item}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- 점검 포인트 -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <span>📍</span> 주요 점검 포인트
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding-left: 4px;">
                                        ${eq.guide.checkPoints.map(point => `
                                            <div style="font-size: 11px; color: var(--text); background: var(--primary); padding: 8px 10px; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                                                <span style="color: var(--accent);">✓</span>
                                                <span>${point}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- 팁 -->
                                <div style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 180, 148, 0.05)); border-radius: 8px; padding: 12px;">
                                    <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                        <span>💡</span> 전문가 팁
                                    </div>
                                    <div style="font-size: 12px; color: var(--text); line-height: 1.6;">
                                        ${eq.guide.tips}
                                    </div>
                                </div>
                                
                                <!-- 기준 -->
                                <div style="background: var(--primary); border-radius: 8px; padding: 12px; border-left: 3px solid var(--accent);">
                                    <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                        <span>📊</span> 판정 기준
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted); line-height: 1.5;">
                                        ${eq.guide.standards}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                } else {
                    // guide가 없는 장비는 간단하게 표시
                    return `
                    <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #00A080); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">${eq.icon}</div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${eq.name}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${eq.desc}</div>
                        </div>
                    </div>
                    `;
                }
            }).join('');
        }
        
        // 장비 가이드 토글 함수
        function toggleEquipmentGuide(idx) {
            const guide = document.getElementById('eqGuide' + idx);
            const arrow = document.getElementById('eqArrow' + idx);
            
            if (guide.style.display === 'none') {
                guide.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                guide.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // ==================== 리포트/공유 ====================
        function showLoading(text = 'PDF 생성 중...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // 프로젝트 정보 가져오기
        function getProjectInfo() {
            return {
                apartmentName: document.getElementById('apartmentName').value || '미입력',
                dong: document.getElementById('dongNumber').value || '-',
                ho: document.getElementById('hoNumber').value || '-',
                inspectionDate: document.getElementById('inspectionDate').value || new Date().toISOString().split('T')[0]
            };
        }

        // PDF 생성 메인 함수
        async function generatePDF() {
            const projectInfo = getProjectInfo();
            
            // 유효성 검사
            if (!projectInfo.apartmentName || projectInfo.apartmentName === '미입력') {
                showToast('아파트명을 입력해주세요', 'error');
                return;
            }
            
            if (getCurrentProject().defects.length === 0) {
                if (!confirm('발견된 하자가 없습니다. 그래도 보고서를 생성하시겠습니까?')) {
                    return;
                }
            }

            showLoading('PDF 보고서 생성 중...');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210;
                const pageHeight = 297;

                // 1페이지: 표지
                const coverHTML = createCoverPage(projectInfo);
                await addHTMLPageToPDF(doc, coverHTML, pageWidth, pageHeight);

                // 2페이지~: 하자 목록 (있는 경우) - 페이지당 최대 15개
                if (getCurrentProject().defects.length > 0) {
                    const defectsPerListPage = 18; // 페이지당 하자 개수
                    const totalDefects = getCurrentProject().defects.length;
                    const totalListPages = Math.ceil(totalDefects / defectsPerListPage);
                    
                    for (let page = 0; page < totalListPages; page++) {
                        doc.addPage();
                        const startIdx = page * defectsPerListPage;
                        const endIdx = Math.min(startIdx + defectsPerListPage, totalDefects);
                        const listHTML = createDefectListPage(projectInfo, startIdx, endIdx, page + 1, totalListPages);
                        await addHTMLPageToPDF(doc, listHTML, pageWidth, pageHeight);
                    }

                    // 하자 상세 페이지 (2개씩)
                    for (let i = 0; i < getCurrentProject().defects.length; i += 2) {
                        doc.addPage();
                        const batch = getCurrentProject().defects.slice(i, i + 2);
                        const detailHTML = createDefectDetailPage(batch, i, projectInfo);
                        await addHTMLPageToPDF(doc, detailHTML, pageWidth, pageHeight);
                    }
                }

                // 파일 저장
                const filename = `뷰파인더_${projectInfo.apartmentName}_${projectInfo.dong}동${projectInfo.ho}호_${projectInfo.inspectionDate}.pdf`;
                
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    const pdfBlob = doc.output('blob');
                    const blobUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                } else {
                    doc.save(filename);
                }

                hideLoading();
                showToast('PDF 보고서가 생성되었습니다!');

            } catch (error) {
                console.error('PDF 생성 오류:', error);
                hideLoading();
                showToast('PDF 생성 중 오류가 발생했습니다', 'error');
            }
        }

        // HTML을 PDF에 추가
        async function addHTMLPageToPDF(doc, htmlContent, pageWidth, pageHeight) {
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '794px';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = '#ffffff';
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });

            document.body.removeChild(tempDiv);

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * pageWidth) / canvas.width;
            
            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
        }

        // 표지 페이지 생성
        function createCoverPage(projectInfo) {
            const defectCount = getCurrentProject().defects.length;
            
            // 촬영된 사진 수 계산
            const photoCount = getCurrentProject().defects.reduce((sum, defect) => {
                return sum + (defect.photos ? defect.photos.filter(p => p).length : 0);
            }, 0);
            
            return `
                <div style="width: 794px; height: 1123px; background: #ffffff; font-family: 'Malgun Gothic', sans-serif; position: relative; box-sizing: border-box; padding: 40px;">
                    
                    <!-- 외곽 테두리 -->
                    <div style="border: 6px solid #2c5282; height: 100%; position: relative; padding: 50px;">
                        
                        <!-- 상단 장식 라인 -->
                        <div style="position: absolute; top: 20px; left: 50px; right: 50px; height: 3px; background: linear-gradient(90deg, transparent, #00D4AA, #2c5282, #00D4AA, transparent);"></div>
                        
                        <!-- 메인 타이틀 -->
                        <div style="text-align: center; margin-top: 60px; margin-bottom: 50px;">
                            <div style="font-size: 18px; color: #00D4AA; font-weight: 600; letter-spacing: 8px; margin-bottom: 20px;">HOME INSPECTION REPORT</div>
                            <h1 style="font-size: 42px; font-weight: 800; color: #2c5282; margin: 0; line-height: 1.2;">
                                하자점검 보고서
                            </h1>
                        </div>
                        
                        <!-- 점검 결과 통계 -->
                        <div style="display: flex; gap: 30px; margin: 50px 20px;">
                            <div style="flex: 1; border: 4px solid #2c5282; border-radius: 12px; padding: 35px 20px; text-align: center; background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);">
                                <div style="font-size: 56px; font-weight: 800; color: #2c5282; margin-bottom: 8px;">${defectCount}</div>
                                <div style="font-size: 16px; color: #555; font-weight: 700;">발견된 하자</div>
                            </div>
                            <div style="flex: 1; border: 4px solid #00D4AA; border-radius: 12px; padding: 35px 20px; text-align: center; background: linear-gradient(180deg, #f0fdf9 0%, #ffffff 100%);">
                                <div style="font-size: 56px; font-weight: 800; color: #00D4AA; margin-bottom: 8px;">${photoCount}</div>
                                <div style="font-size: 16px; color: #555; font-weight: 700;">촬영된 사진</div>
                            </div>
                        </div>
                        
                        <!-- 중요 안내사항 -->
                        <div style="margin: 40px 20px; border-left: 5px solid #2c5282; background: #f8fafc; padding: 25px 30px;">
                            <div style="font-size: 15px; color: #2c5282; font-weight: 700; margin-bottom: 15px;">📋 안내사항</div>
                            <div style="font-size: 13px; color: #444; line-height: 2; font-weight: 500;">
                                • 본 보고서는 시공사 하자 접수 시 증빙자료로 활용하시기 바랍니다.<br/>
                                • 하자담보책임기간 내 주기적인 점검과 관리가 필요합니다.<br/>
                                • 발견된 하자는 빠른 시일 내에 시공사에 접수하시기 바랍니다.
                            </div>
                        </div>
                        
                        <!-- 하단 프로젝트 정보 -->
                        <div style="position: absolute; bottom: 80px; left: 50px; right: 50px;">
                            <div style="border-top: 3px solid #2c5282; border-bottom: 3px solid #2c5282; padding: 25px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="text-align: left;">
                                        <div style="font-size: 13px; color: #888; margin-bottom: 5px;">아파트명</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #222;">${projectInfo.apartmentName}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 13px; color: #888; margin-bottom: 5px;">동 / 호수</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #222;">${projectInfo.dong}동 ${projectInfo.ho}호</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 13px; color: #888; margin-bottom: 5px;">점검일자</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #222;">${projectInfo.inspectionDate}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 하단 장식 라인 -->
                        <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; height: 3px; background: linear-gradient(90deg, transparent, #00D4AA, #2c5282, #00D4AA, transparent);"></div>
                    </div>
                    
                    <!-- 하단 푸터 (테두리 밖) -->
                    <div style="position: absolute; bottom: 10px; left: 40px; right: 40px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 14px; font-weight: 700; color: #2c5282;">THE HOME INSPECTION</div>
                        <div style="font-size: 11px; color: #888;">뷰파인더 | 스마트 셀프 홈체크</div>
                    </div>
                </div>
            `;
        }

        // 하자 목록 페이지 생성
        function createDefectListPage(projectInfo, startIdx = 0, endIdx = null, currentPage = 1, totalPages = 1) {
            const defects = getCurrentProject().defects;
            const end = endIdx || defects.length;
            let tableRows = '';
            
            for (let idx = startIdx; idx < end; idx++) {
                const defect = defects[idx];
                // 기존 데이터 호환성
                const spaces = (defect.spaces || []).join(' ') || '-';
                const locations = (defect.locations || []).join(' ') || '';
                const defectTypes = (defect.defectTypes || []).join(' ') || '';
                const desc = defect.description || '-';
                const rowBg = idx % 2 === 0 ? '#ffffff' : '#f5f7fa';
                
                // 위치+하자유형 조합
                const detail = [locations, defectTypes].filter(p => p).join(' ') || '-';
                
                tableRows += `
                    <tr style="border-bottom: 1px solid #d0d5dd; background: ${rowBg};">
                        <td style="padding: 10px 6px; text-align: center; font-weight: 700; color: #2c5282; font-size: 13px; vertical-align: middle; border-right: 1px solid #d0d5dd;">${idx + 1}</td>
                        <td style="padding: 10px 8px; text-align: center; color: #333; font-weight: 600; font-size: 12px; vertical-align: middle; border-right: 1px solid #d0d5dd;">${spaces}</td>
                        <td style="padding: 10px 8px; text-align: center; color: #00A896; font-weight: 600; font-size: 12px; vertical-align: middle; border-right: 1px solid #d0d5dd;">${detail}</td>
                        <td style="padding: 10px 10px; color: #222; font-weight: 500; font-size: 12px; word-break: break-word; white-space: normal; line-height: 1.4; vertical-align: middle;">${desc}</td>
                    </tr>
                `;
            }
            
            const pageIndicator = totalPages > 1 ? ` (${currentPage}/${totalPages})` : '';
            
            return `
                <div style="width: 794px; height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 30px 35px; position: relative; box-sizing: border-box; overflow: hidden;">
                    <!-- 헤더 -->
                    <div style="margin-bottom: 15px; border-bottom: 4px solid #2c5282; padding-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <h3 style="margin: 0 0 6px 0; font-size: 20px; color: #2c5282; font-weight: 700;">📋 하자점검 목록${pageIndicator}</h3>
                                <p style="margin: 0; font-size: 13px; color: #555; font-weight: 500;">${projectInfo.apartmentName} ${projectInfo.dong}동 ${projectInfo.ho}호</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #888;">점검일자</div>
                                <div style="font-size: 14px; color: #333; font-weight: 600;">${projectInfo.inspectionDate}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 테이블 -->
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #2c5282;">
                        <thead>
                            <tr style="background: #e8f4fc; border-bottom: 2px solid #2c5282;">
                                <th style="padding: 10px 6px; width: 6%; color: #2c5282; font-size: 13px; font-weight: 700; border-right: 1px solid #2c5282;">No</th>
                                <th style="padding: 10px 6px; width: 14%; color: #2c5282; font-size: 13px; font-weight: 700; border-right: 1px solid #2c5282;">공간</th>
                                <th style="padding: 10px 6px; width: 20%; color: #2c5282; font-size: 13px; font-weight: 700; border-right: 1px solid #2c5282;">위치/유형</th>
                                <th style="padding: 10px 8px; width: 60%; color: #2c5282; font-size: 13px; font-weight: 700;">하자 내용</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    
                    <!-- 총 건수 표시 -->
                    <div style="margin-top: 12px; text-align: right; font-size: 13px; color: #666;">
                        총 <span style="font-weight: 700; color: #2c5282;">${defects.length}</span>건
                    </div>

                    <!-- 하단 푸터 -->
                    <div style="position: absolute; bottom: 20px; left: 35px; right: 35px; padding-top: 10px; border-top: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; font-weight: 600; color: #2c5282;">THE HOME INSPECTION</div>
                        <div style="font-size: 11px; color: #888;">뷰파인더 | 스마트 셀프 홈체크</div>
                    </div>
                </div>
            `;
        }

        // 하자 상세 페이지 생성
        function createDefectDetailPage(defects, startIndex, projectInfo) {
            let contentHTML = '';
            
            defects.forEach((defect, idx) => {
                const globalIndex = startIndex + idx + 1;
                // 기존 데이터 호환성
                const spaces = (defect.spaces || []).join(' ') || '미지정';
                const locations = (defect.locations || []).join(' ') || '';
                const defectTypes = (defect.defectTypes || []).join(' ') || '';
                const description = defect.description || '';
                const farPhoto = defect.photos[0] || '';
                const nearPhoto = defect.photos[1] || '';
                
                // 위치/유형 조합
                const detail = [locations, defectTypes].filter(p => p).join(' ');
                
                // 배지 색상 (샘플과 동일)
                const badgeColor = '#00D4AA';
                
                contentHTML += `
                    <div style="margin-bottom: 30px; page-break-inside: avoid;">
                        <!-- 하자 번호, 공간, 위치/유형, 내용 (한 줄 배치) -->
                        <div style="background: #f5f5f5; padding: 12px 15px; margin-bottom: 12px; border-left: 4px solid ${badgeColor};">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <div style="background: ${badgeColor}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; flex-shrink: 0;">
                                    #${String(globalIndex).padStart(2, '0')}
                                </div>
                                <div style="font-size: 14px; color: #333; font-weight: 700; flex-shrink: 0;">
                                    ${spaces}
                                </div>
                                ${detail ? `
                                    <div style="font-size: 13px; color: #00A896; font-weight: 600; flex-shrink: 0;">
                                        ${detail}
                                    </div>
                                ` : ''}
                                ${description ? `
                                    <div style="font-size: 14px; color: #000; font-weight: 700; flex: 1;">
                                        ${description}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- 사진 가로 배치 (크기 확대) -->
                        <div style="display: flex; gap: 12px;">
                            <!-- 원경 -->
                            <div style="flex: 1; position: relative;">
                                ${farPhoto ? `
                                    <div style="position: relative; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden; background: #fafafa;">
                                        <img src="${farPhoto}" style="width: 100%; height: 340px; object-fit: cover; display: block;" />
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: #10B981; color: white; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                            원경
                                        </div>
                                    </div>
                                ` : `
                                    <div style="width: 100%; height: 340px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">
                                        사진 없음
                                    </div>
                                `}
                            </div>

                            <!-- 근경 -->
                            <div style="flex: 1; position: relative;">
                                ${nearPhoto ? `
                                    <div style="position: relative; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden; background: #fafafa;">
                                        <img src="${nearPhoto}" style="width: 100%; height: 340px; object-fit: cover; display: block;" />
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: #10B981; color: white; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                            근경
                                        </div>
                                    </div>
                                ` : `
                                    <div style="width: 100%; height: 340px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">
                                        사진 없음
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div style="width: 794px; min-height: 1123px; background: white; font-family: 'Malgun Gothic', sans-serif; padding: 35px 40px 60px 40px; box-sizing: border-box; position: relative;">
                    <!-- 헤더 -->
                    <div style="border-bottom: 3px solid #00D4AA; padding-bottom: 15px; margin-bottom: 25px;">
                        <h2 style="margin: 0 0 8px 0; font-size: 20px; color: #333; font-weight: 700;">하자 상세 리포트 (사진)</h2>
                        <p style="margin: 0; font-size: 13px; color: #666;">${projectInfo.apartmentName} ${projectInfo.dong}동 ${projectInfo.ho}호</p>
                    </div>

                    ${contentHTML}

                    <!-- 하단 -->
                    <div style="position: absolute; bottom: 20px; left: 40px; right: 40px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 10px; color: #999; text-align: center;">
                        <div>뷰파인더 | ViewFinder</div>
                    </div>
                </div>
            `;
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: '뷰파인더 점검 결과',
                    text: `점검 완료! 발견된 하자: ${getCurrentProject().defects.length}건`,
                    url: window.location.href
                });
            } else {
                showToast('공유 기능을 지원하지 않는 브라우저입니다');
            }
        }

        function showUpgradeModal() {
            showToast('서비스 업그레이드는 앱 내에서 확인하세요');
        }

        function requestAddon() {
            showToast('하자 접수 대행 서비스를 이용하려면 이메일로 자료를 전송해주세요');
        }

        // ==================== 토스트 ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (type === 'error' ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
